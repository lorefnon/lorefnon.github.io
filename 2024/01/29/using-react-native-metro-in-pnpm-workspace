<!DOCTYPE html><html class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><title>Lorefnon | Blog | Using react-native (metro) in a pnpm workspace</title><meta property="og:title" content="Lorefnon | Blog | Using react-native (metro) in a pnpm workspace"><meta property="og:description" content="Ramblings on Web Development and software architecture"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="icon" href="/images/favicon/favicon.ico"><script data-goatcounter="https://analytics.lorefnon.com/count" async src="https://analytics.lorefnon.com/count.js"></script><script src="https://unpkg.com/htmx.org@1.7.0/dist/htmx.min.js" defer></script><script src="https://unpkg.com/dompurify@2.3.6/dist/purify.min.js" defer></script><script src="/js/blog.js" defer></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Icicles of Thought" type="application/atom+xml">
</head><body class="blog-body" hx-boost="true"><div class="blog-summary"><a class="primary-link" href="/" hx-boost="false"><h1 class="header-text">Gaurab Paul</h1><h2 class="header-text">Polyglot software developer &amp; consultant passionate about web development, distributed systems and open source technologies</h2></a><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a></div></div></div><div class="blog-sidebar"><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a><div class="blog-support-arrow"></div><p class="support-text body-text">Support my blog and open-source work</p></div></div><h1 class="header-text">Tags</h1><ul class="tag-list"><li class="body-text"><a class="tag-link" href="/tags/react-native/"><img src="/images/tag.svg">react-native</a></li><li class="body-text"><a class="tag-link" href="/tags/metro-bundler/"><img src="/images/tag.svg">metro-bundler</a></li></ul></div><div class="blog-header blog-post-header"><div class="blog-post-header-inner"><div class="header-text">Using react-native (metro) in a pnpm workspace</div><div class="posted-date sub-header-text" title="2024-01-28">Posted &nbsp;10 days ago</div><hr class="blog-header-separator"></div></div><div class="blog-main"><div class="page-content"><p>For quite a while, <a href="https://metrobundler.dev/" target="_blank" rel="noopener external nofollow noreferrer">metro</a> and <a href="https://pnpm.io/" target="_blank" rel="noopener external nofollow noreferrer">pnpm</a> didn&#39;t play well with each other. Usually workarounds involved <a href="https://pnpm.io/npmrc#shamefully-hoist" target="_blank" rel="noopener external nofollow noreferrer">&quot;shamefully-hoisting&quot;</a> which negated many benefits of pnpm.</p>
<p>However, recently metro has added support for symlinks (though marked unstable as of this writing) which makes it possible for us to use a react-native + metro project with pnpm. </p>
<p>There are a few considerations though:</p>
<ol>
<li><p>You may need to install some additional dev dependencies which didn&#39;t before. </p>
<p> There are some dependencies which the RN project generated by the scaffolder uses, but doesn&#39;t depend on directly. They are just assumed to be available due to hoisting behavior of npm. </p>
<p> pnpm adopts a more principled stance towards dependency hosting, which IMHO is better. So, you will need directly depend on these packages.</p>
 <pre><code class="hljs sh">pnpm i -D @react-native/gradle-plugin @react-native-community/cli-platform-android @react-native-community/cli</code></pre>

<p> Be mindful of versions if you are updating an older project that is not yet updated to use latest RN.</p>
</li>
<li><p>Metro still needs to be aware of all source roots. This is an issue if we are also using pnpm workspaces.</p>
<p> While the bundler can follow symlinks, we still need to explicitly register all the root directories which may contain bundled files (including the symlink targets) through the rather weirdly named <code>watchFolders</code>.</p>
<p> From the <a href="https://metrobundler.dev/docs/configuration/" target="_blank" rel="noopener external nofollow noreferrer">official docs</a></p>
<blockquote>
<p>Despite the naming of this option, it isn&#39;t related solely to 
file watching. Even in an offline build (for example, in CI), 
all files must be visible to Metro through the combination of watchFolders
and projectRoot.</p>
</blockquote>
<p> So let&#39;s say your RN project depends on another module in the pnpm workspace called <code>shared</code>, we need the following in <code>metro.config.js</code>:</p>
 <pre><code class="hljs js"><span class="hljs-variable language_">module</span>.<span class="hljs-property">exports</span> = <span class="hljs-title function_">mergeConfig</span>(defaultConfig, &#123;
    <span class="hljs-comment">// ... other config</span>
    <span class="hljs-attr">watchFolders</span>: [
        __dirname,
        path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;../../node_modules&quot;</span>), <span class="hljs-comment">// Should resolve to top level node_modules</span>
        path.<span class="hljs-title function_">resolve</span>(__dirname, <span class="hljs-string">&quot;../shared&quot;</span>), <span class="hljs-comment">// Any other modules the RN project depends on</span>
    ],
&#125;</code></pre>

<p> As shown above, we also need to add the top level <code>node_modules</code> folder where pnpm will install the dependencies.</p>
</li>
</ol>
<p>And that is pretty much all that is needed.</p>
</div><div class="post-comments"><!-- .comments-target--></div><div class="post-comments" style="margin-top: 10px;"><div id="remark42"></div></div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>Â© 2022 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p></div></body></html>