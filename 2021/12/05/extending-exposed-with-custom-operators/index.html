<!DOCTYPE html><html class="no-js"><head> <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><meta property="og:title" content="Gaurab Paul | Blog"><meta property="og:description" content="Ramblings on Web Development and software architecture"><meta name="generator" content="Hexo 5.4.0"></head><body class="blog-body" hx-boost="true"><a class="blog-summary" href="/" hx-boost="false"><h1 class="header-text">ICICLES OF THOUGHT</h1><h2 class="header-text">Ramblings on Web Development and Software Architecture</h2></a><div class="blog-sidebar"><span class="posted-date header-text" title="2021-12-05">Posted &nbsp;2 days ago</span><hr><h1 class="header-text">Tags</h1><ul class="tag-list"><li class="body-text"><a class="tag-link" href="/tags/Database/"><img src="/images/tag.svg">Database</a></li><li class="body-text"><a class="tag-link" href="/tags/Exposed/"><img src="/images/tag.svg">Exposed</a></li></ul></div><div class="blog-header"><div class="blog-header-inner header-text">Extending Exposed with new function expressions</div></div><div class="blog-main"><div class="page-content"><p><a href="https://github.com/JetBrains/Exposed" target="_blank" rel="noopener external nofollow noreferrer">Exposed</a> is a nice ORM for Kotlin by <a href="https://github.com/Tapac" target="_blank" rel="noopener external nofollow noreferrer">Andrey Tarashevskiy</a> from <a href="https://www.jetbrains.com/" target="_blank" rel="noopener external nofollow noreferrer">Jetbrains</a>. Though, not an offically supported product by Jetbrains it has a good following in the Kotlin community. </p>
<p>I recently got involved in a project using Exposed and discovered that the set of database level functions that are mapped by Exposed is quite small. However, the library makes it easy to add support for the missing functions, which is what this post outlines. </p>
<p>Let&#39;s say we want to support product of two columns. We can support this by extending the <code>ExpressionWithColumnType</code> class.</p>
<pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Product</span>&lt;<span class="hljs-type">T</span>&gt;</span>(
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> expr1: ExpressionWithColumnType&lt;T&gt;,
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> expr2: ExpressionWithColumnType&lt;T&gt;
): ExpressionWithColumnType&lt;T&gt;() &#123;
    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> columnType: IColumnType
        <span class="hljs-keyword">get</span>() = expr1.columnType

    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">toQueryBuilder</span><span class="hljs-params">(queryBuilder: <span class="hljs-type">QueryBuilder</span>)</span></span> &#123;
        queryBuilder.append(<span class="hljs-string">&quot;(&quot;</span>, expr1, <span class="hljs-string">&quot;*&quot;</span>, expr2, <span class="hljs-string">&quot;)&quot;</span>)
    &#125;
&#125;</code></pre>

<p>This accepts two columns (Column class extends ExpressionWithColumnType too) of same type, and constructs the expression for multiplying these column values. </p>
<p>While this class can be used directly, it is often convenient to also write an extension method that enables us to chain the operations similar to other exposed functions. </p>
<pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;T&gt;</span> ExpressionWithColumnType<span class="hljs-type">&lt;T&gt;</span>.<span class="hljs-title">product</span><span class="hljs-params">(expr: <span class="hljs-type">ExpressionWithColumnType</span>&lt;<span class="hljs-type">T</span>&gt;)</span></span> =
    Product(<span class="hljs-keyword">this</span>, expr)</code></pre>

<p>So now, we can easily use this in our code as: </p>
<pre><code class="hljs kotlin">DesginationTable
    .slice(
        DesignationTable.name,
        DesginationTable.employeeCount.product(DesginationTable.salary)
    )
    .groupBy(DesignationTable.name)
    .toList()</code></pre>

<p>It is usually also convenient to use an alias to retrieve aggregated values: </p>
<pre><code class="hljs kotlin"><span class="hljs-keyword">data</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DesignationSalaryDTO</span></span>(
    <span class="hljs-keyword">val</span> name: String,
    <span class="hljs-keyword">val</span> totalSalary: <span class="hljs-built_in">Double</span>
)

<span class="hljs-keyword">val</span> totalSalary = DesginationTable.employeeCount.product(DesginationTable.salary).alias(<span class="hljs-string">&quot;total_salary&quot;</span>)

<span class="hljs-keyword">val</span> salaryRow DesginationTable
    .slice(
        DesignationTable.name, 
        <span class="hljs-comment">// We can use the alias in our slice</span>
        totalSalary
    )
    .groupBy(DesignationTable.name)
    .map &#123; resultRow -&gt;
        <span class="hljs-comment">// Map results to a DTO</span>
        DesignationSalaryDTO(
            name = DesignationTable.name,
            <span class="hljs-comment">// We can use the same alias when retrieving the column value</span>
            totalSalary = resultRow[totalSalary]
        )
    &#125;</code></pre>

<p>This illustrates how we can nicely add our extension functions for operations that the library does not support, and use them in pretty much the same way as built in expression composition functions. </p>
</div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>Â© 2021 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p><hr><p>Header Image credit:<a href="https://www.pexels.com/photo/stainless-steel-lamp-788855/" target="_blank" rel="noreferrer noopener">Nikita Khandelwal</a></p></div><script src="https://unpkg.com/htmx.org@1.6.0/dist/htmx.min.js"></script><script src="/js/blog.js"></script></body></html>