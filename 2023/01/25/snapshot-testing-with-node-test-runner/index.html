<!DOCTYPE html><html class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><title>Lorefnon | Blog | Snapshot testing with node test runner (node:test)</title><meta property="og:title" content="Lorefnon | Blog | Snapshot testing with node test runner (node:test)"><meta property="og:description" content="Ramblings on Web Development and software architecture"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="icon" href="/images/favicon/favicon.ico"><script data-goatcounter="https://analytics.lorefnon.com/count" async src="https://analytics.lorefnon.com/count.js"></script><script src="https://unpkg.com/htmx.org@1.7.0/dist/htmx.min.js" defer></script><script src="https://unpkg.com/dompurify@2.3.6/dist/purify.min.js" defer></script><script src="/js/blog.js" defer></script><meta name="generator" content="Hexo 6.2.0"></head><body class="blog-body" hx-boost="true"><div class="blog-summary"><a class="primary-link" href="/" hx-boost="false"><h1 class="header-text">Gaurab Paul</h1><h2 class="header-text">Polyglot software developer &amp; consultant passionate about web development, distributed systems and open source technologies</h2></a><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a></div></div></div><div class="blog-sidebar"><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a><div class="blog-support-arrow"></div><p class="support-text body-text">Support my blog and open-source work</p></div></div><h1 class="header-text">Tags</h1><ul class="tag-list"><li class="body-text"><a class="tag-link" href="/tags/Javascript/"><img src="/images/tag.svg">Javascript</a></li><li class="body-text"><a class="tag-link" href="/tags/Node-js/"><img src="/images/tag.svg">Node.js</a></li></ul></div><div class="blog-header blog-post-header"><div class="blog-post-header-inner"><div class="header-text">Snapshot testing with node test runner (node:test)</div><div class="posted-date sub-header-text" title="2023-01-25">Posted &nbsp;7 months ago</div><hr class="blog-header-separator"></div></div><div class="blog-main"><div class="page-content"><p>While there are a lot of popular test runners in node.js ecosystem, like jest, mocha etc. node has recently introduced a built in test runner available as <code>test</code> package in the standard library. The <a href="https://nodejs.org/api/test.html" target="_blank" rel="noopener external nofollow noreferrer">official documentation</a> describe the usage, and it should look familiar to people coming from most popular testing libraries.</p>
<pre><code class="hljs ts"><span class="hljs-keyword">import</span> &#123; describe, it &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;node:test&quot;</span>;
<span class="hljs-keyword">import</span> assert <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;node:assert&quot;</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;A thing&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
  <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;should work&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
    assert.<span class="hljs-title function_">strictEqual</span>(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>);
  &#125;);
&#125;);</code></pre>

<p>However, one aspect that it does not handle currently is snapshot testing. </p>
<p>As popularised by <a href="https://jestjs.io/" target="_blank" rel="noopener external nofollow noreferrer">Jest</a>, snapshot testing is a convenient mechanism to ensure that certain computed values don&#39;t change across test runs by storing the result on first run and comparing with the stored value in subsequent runs. <a href="https://jestjs.io/docs/snapshot-testing" target="_blank" rel="noopener external nofollow noreferrer">Jest docs</a> explain the concept in more detail.</p>
<p>Fortuantely, using the library  <a href="https://www.npmjs.com/package/snap-shot-core" target="_blank" rel="noopener external nofollow noreferrer">snap-shot-core</a> we can easily integrate snapshot testing with <code>node:test</code> without needing to switch to another testing library.</p>
<pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Snap</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;snap-shot-core&quot;</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;User insertion&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
    <span class="hljs-title function_">it</span>(<span class="hljs-string">&#x27;inserts new row&#x27;</span>, <span class="hljs-keyword">async</span> () =&gt; &#123;
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">createUser</span>(&#123;
            <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>
        &#125;)
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">findByEmail</span>(<span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>)
        <span class="hljs-title class_">Snap</span>.<span class="hljs-title function_">core</span>(&#123;
            <span class="hljs-attr">what</span>: user,
            <span class="hljs-attr">file</span>: __filename,
            <span class="hljs-attr">specName</span>: <span class="hljs-string">&#x27;inserts new row&#x27;</span>
        &#125;)
    &#125;)
&#125;)</code></pre>

<p>This will write a snapshot file if not present, or validate against once if present. </p>
<p>Note that one caveat here is that, being a standalone library we needed to explicitly specify the specName.</p>
<p>If using the <code>test</code> function from <code>node:test</code>, we have access to the test name through <code>testContext.name</code>, which we can pass to this lib. </p>
<pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Snap</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;snap-shot-core&quot;</span>

<span class="hljs-title function_">test</span>(<span class="hljs-string">&#x27;user insertion&#x27;</span>, <span class="hljs-function">(<span class="hljs-params">testCtx</span>) =&gt;</span> &#123;
    <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">createUser</span>(&#123;
        <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>
    &#125;)
    <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">findByEmail</span>(<span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>)
    <span class="hljs-title class_">Snap</span>.<span class="hljs-title function_">core</span>(&#123;
        <span class="hljs-attr">what</span>: user,
        <span class="hljs-attr">file</span>: __filename,
        <span class="hljs-attr">specName</span>: testCtx.<span class="hljs-property">name</span>
    &#125;)
&#125;)</code></pre>

<p>However, for BDD style tests, we don&#39;t have the test context injected. One convenient solution to prevent the spec names from getting out of sync is to use named functions. </p>
<pre><code class="hljs ts"><span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;User insertion&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
    <span class="hljs-title function_">it</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">insertsNewRow</span>(<span class="hljs-params"></span>) &#123; <span class="hljs-comment">// &lt;-- Spec name inferred from function name</span>
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">createUser</span>(&#123;
            <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>
        &#125;)
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">findByEmail</span>(<span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>)
        <span class="hljs-title class_">Snap</span>.<span class="hljs-title function_">core</span>(&#123;
            <span class="hljs-attr">what</span>: user,
            <span class="hljs-attr">file</span>: __filename,
            <span class="hljs-attr">specName</span>: insertsNewRow.<span class="hljs-property">name</span>
        &#125;)
    &#125;)
&#125;)</code></pre>

<p>Lastly, if our test files are ES modules, we won&#39;t have access to <code>__filename</code>. We can instead use the <code>fileURLToPath</code> utility.</p>
<pre><code class="hljs ts"><span class="hljs-keyword">import</span> <span class="hljs-title class_">Snap</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;snap-shot-core&quot;</span>
<span class="hljs-keyword">import</span> &#123; fileURLToPath &#125; <span class="hljs-keyword">from</span> <span class="hljs-string">&#x27;url&#x27;</span>

<span class="hljs-title function_">describe</span>(<span class="hljs-string">&#x27;User insertion&#x27;</span>, <span class="hljs-function">() =&gt;</span> &#123;
    <span class="hljs-title function_">it</span>(<span class="hljs-keyword">async</span> <span class="hljs-keyword">function</span> <span class="hljs-title function_">insertsNewRow</span>(<span class="hljs-params"></span>) &#123;
        <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">createUser</span>(&#123;
            <span class="hljs-attr">email</span>: <span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>
        &#125;)
        <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">await</span> <span class="hljs-title class_">UserService</span>.<span class="hljs-title function_">findByEmail</span>(<span class="hljs-string">&#x27;janedoe@example.com&#x27;</span>)
        <span class="hljs-title class_">Snap</span>.<span class="hljs-title function_">core</span>(&#123;
            <span class="hljs-attr">what</span>: user,
            <span class="hljs-attr">file</span>: <span class="hljs-title function_">fileURLToPath</span>(<span class="hljs-keyword">import</span>.<span class="hljs-property">meta</span>.<span class="hljs-property">url</span>),
            <span class="hljs-attr">specName</span>: insertsNewRow.<span class="hljs-property">name</span>
        &#125;)
    &#125;)
&#125;)</code></pre>
</div><div class="post-comments"><!-- .comments-target--></div><div class="post-comments" style="margin-top: 10px;"><div id="remark42"></div></div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>© 2022 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p></div></body></html>