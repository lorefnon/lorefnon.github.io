<!DOCTYPE html><html class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><title>Lorefnon | Blog | Dealing with circular type references in Mobx-state-tree</title><meta property="og:title" content="Lorefnon | Blog | Dealing with circular type references in Mobx-state-tree"><meta property="og:description" content="Ramblings on Web Development and software architecture"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="icon" href="/images/favicon/favicon.ico"><script src="https://unpkg.com/htmx.org@1.7.0/dist/htmx.min.js" defer></script><script src="https://unpkg.com/dompurify@2.3.6/dist/purify.min.js" defer></script><script src="/js/blog.js" defer></script><script>window.goatcounter = {no_onload: true}

htmx.on('htmx:load', (e) => {
    window.goatcounter.count({
        path: location.pathname + location.search + location.hash,
    })
})</script><script data-goatcounter="https://analytics.lorefnon.com/count" async src="https://analytics.lorefnon.com/count.js"></script><meta name="generator" content="Hexo 6.1.0"></head><body class="blog-body" hx-boost="true"><div class="blog-summary"><a class="primary-link" href="/" hx-boost="false"><h1 class="header-text">Gaurab Paul</h1><h2 class="header-text">Polyglot software developer &amp; consultant passionate about web development, distributed systems and open source technologies</h2></a><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a></div></div></div><div class="blog-sidebar"><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a><div class="blog-support-arrow"></div><p class="support-text body-text">Support my blog and open-source work</p></div></div><h1 class="header-text">Tags</h1><ul class="tag-list"><li class="body-text"><a class="tag-link" href="/tags/Typescript/"><img src="/images/tag.svg">Typescript</a></li><li class="body-text"><a class="tag-link" href="/tags/MobX/"><img src="/images/tag.svg">MobX</a></li><li class="body-text"><a class="tag-link" href="/tags/MobX-State-Tree/"><img src="/images/tag.svg">MobX-State-Tree</a></li></ul></div><div class="blog-header blog-post-header"><div class="blog-post-header-inner"><div class="header-text">Dealing with circular type references in Mobx-state-tree</div><div class="posted-date sub-header-text" title="2019-08-15">Posted &nbsp;3 years ago</div><hr class="blog-header-separator"></div></div><div class="blog-main"><div class="page-content"><link rel="stylesheet" href="/css/crayon.min.css" >
<link rel="stylesheet" href="/css/crayon-flatui-light.css" >



	<p>A frequently occuring issue when creating interrelated MST models, is that of circular type references.</p>
<p>Usually we don’t don’t have to explicitly define interfaces for our models, because they can be inferred for us through the APIs exposed by MST. However, when defining models that depend on each other, this falls short because TypeScript’s type-inference is not good enough to circular dependencies.</p>
<p>For example, lets say we have a note taking application with <code>Snippet</code> and <code>Annotation</code> models. A <code>Snippet</code> can have many <code>Annotation</code>s and every <code>Annotation</code> belongs to exactly one <code>Snippet</code>.</p>
<p>Our first stab might be something like this:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9a9679920934" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-7">7</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-8">8</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-9">9</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-10">10</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-11">11</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-12">12</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-13">13</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-14">14</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-15">15</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-16">16</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-17">17</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-18">18</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-19">19</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-20">20</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-21">21</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-22">22</div><div class="crayon-num" data-line="crayon-5fba446a3b9a9679920934-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-1">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-2"><span class="crayon-c">// models/Snippet.ts</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-3">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-4"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-e">types </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">"mobx-state-tree"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-5"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-e">v4 </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-i">uuid</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">"uuid"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-6"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-i">Annotation</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">"./Annotation"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-7">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-8"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Snippet"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-9"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-11"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-12">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-13"><span class="crayon-c">// models/Annotation.ts</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-14">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-15"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-e">types </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-i">t</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">"mobx-state-tree"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-16"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-e">v4 </span><span class="crayon-st">as</span><span class="crayon-h"> </span><span class="crayon-i">uuid</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">"uuid"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-17"><span class="crayon-e">import</span><span class="crayon-h"> </span><span class="crayon-sy">{</span><span class="crayon-h"> </span><span class="crayon-i">Snippet</span><span class="crayon-h"> </span><span class="crayon-sy">}</span><span class="crayon-h"> </span><span class="crayon-i">from</span><span class="crayon-h"> </span><span class="crayon-s">"./Snippet"</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-18">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-19"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Annotation"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-21"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">snippet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">reference</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-22"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9a9679920934-23">&nbsp;</div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0073 seconds] -->
<p></p>
<p>However, this will not work out well because of the aforementioned issue with circular dependency, and we will get following error:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9bd558713277" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9bd558713277-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9bd558713277-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9bd558713277-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9bd558713277-1"><span class="crayon-s">'Snippet'</span><span class="crayon-h"> </span><span class="crayon-e">implicitly </span><span class="crayon-e">has </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'any'</span><span class="crayon-h"> </span><span class="crayon-e">because </span><span class="crayon-e">it </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-i">have</span><span class="crayon-h"> </span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-e">type </span><span class="crayon-e">annotation </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-e">referenced </span><span class="crayon-e">directly </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-e">indirectly </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">its </span><span class="crayon-e">own </span><span class="crayon-v">initializer</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3b9bd558713277-2">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9bd558713277-3"><span class="crayon-s">'Annotation'</span><span class="crayon-h"> </span><span class="crayon-e">implicitly </span><span class="crayon-e">has </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'any'</span><span class="crayon-h"> </span><span class="crayon-e">because </span><span class="crayon-e">it </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-i">have</span><span class="crayon-h"> </span><span class="crayon-i">a</span><span class="crayon-h"> </span><span class="crayon-e">type </span><span class="crayon-e">annotation </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-e">referenced </span><span class="crayon-e">directly </span><span class="crayon-st">or</span><span class="crayon-h"> </span><span class="crayon-e">indirectly </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-e">its </span><span class="crayon-e">own </span><span class="crayon-v">initializer</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0014 seconds] -->
<p></p>
<p>We would want to resolve this, but at the same time, use the automatic inference as much as possible so we don’t have to define the entire model type ourselves.</p>
<p>MST allows us to define our models in multiple stages:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9c3787886264" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3b9c3787886264-7">7</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-1"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Snippet"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-3"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-4">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-5"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3b9c3787886264-7"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0019 seconds] -->
<p></p>
</code><p><code></code></p>
<p>This split is not arbitrary. While we haven’t quite solved the problem yet, but we note that for <code>Snippet$1</code> our model types can be inferred as there are no circular references there.</p>
<p>The idea is to augment the inferred type of <code>Snippet$1</code> model with a manual specification of types of attributes which cause circular reference.</p>
<p>Before we start on that, lets take a step back and reflect on following two facts we can leverage:</p>
<ol>
<li>TypeScript interfaces can have circular references. While inferred types and type aliases are eager resolved (atleast as of this writing), interfaces can have mutual dependencies.<p></p>
</li>
<li>
<p>The type of an MST model is <code>IType&lt;ISnapshotInType, ISnapshotOutType, IInstanceType&gt;</code> where:</p>
<ol>
<li><code>ISnapshotInType</code> is what we can pass to <code>Model.create</code>.</li>
<li><code>ISnapshotOutType</code> is what we get back in <code>onSnapshot</code> hook.</li>
<li><code>IInstanceType</code> is the type of the model instances.</li>
</ol>
</li>
</ol>
<p>So for our case, if we were not using MST, we would have defined an <code>ISnippet</code> interface something like:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9c9118492127" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9c9118492127-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9c9118492127-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9c9118492127-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9c9118492127-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9c9118492127-1"><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippet</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9c9118492127-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-t">string</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9c9118492127-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9c9118492127-4"><span class="crayon-sy">&#125;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0006 seconds] -->
<p></p>
</code><p><code></code></p>
<p>We can still do that, but the idea of this post is to avoid duplication of type definitions as much as possible because in real applications we would have many more attributes, and we wouldn’t want to keep them in sync across MST models and manually defined instance types.</p>
<p>If you are wondering why <code>ISnapshotInType</code> and <code>ISnapshotOutType</code> can be different, the answer is right there above. Our model has id as an optional attribute with a factory function for supplying default values. So in our <code>ISnapshotInType</code> for Snippet (lets call it <code>ISnippetSnapshotIn</code>), id will be optional, but in the outgoing snapshot type it will always be present.</p>
<p>MST also supports <a class="wp-editor-md-post-content-link" target="_blank" rel="noopener" href="https://github.com/mobxjs/mobx-state-tree#lifecycle-hooks-for-typesmodel">pre-process and post-process hooks</a> and when using them our incoming and outgoing snapshot types will often diverge.</p>
<p>MST also allows us to extract<sup><a href="#extract-types" id="extract-types-back">[1]</a></sup> out the Snapshot types and Instance types for cases where inference is possible.</p>
<p>So <code>Instance&lt;typeof Snippet$1&gt;</code> gives us the Instance type of <code>Snippet$1</code> model which is basically <code>&#123; id: string &#125;</code>.<br>
Similarly we can extract out <code>SnapshotIn&lt;typeof Snippet$1&gt;</code> and <code>SnapshotOut&lt;typeof Snippet$1&gt;</code> which are the incoming and outgoing snapshot types respectively.</p>
<p>So, armed with above insights, lets us augment the extracted types from <code>Snippet$1</code> with the additional attributes we need for our <code>Snippet</code> model:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9cf416703410" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-7">7</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-8">8</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-9">9</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-10">10</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-11">11</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-12">12</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-13">13</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-14">14</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-15">15</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-16">16</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-17">17</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-18">18</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-19">19</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-20">20</div><div class="crayon-num" data-line="crayon-5fba446a3b9cf416703410-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-1"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Snippet"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-3"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-4">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-5"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippet</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">Instance</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotation</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-7"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-8">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-9"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippetSnapshotIn</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotIn</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationSnapshotIn</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-11"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-12">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-13"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippetSnapshotOut</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotOut</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationSnapshotOut</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-15"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-16">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-17"><span class="crayon-e">export </span><span class="crayon-e">type </span><span class="crayon-v">ISnippetRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">IType</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippetSnapshotIn</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ISnippetSnapshotOut</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ISnippet</span><span class="crayon-o">&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-18">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-19"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-v"> Snippet:</span><span class="crayon-h"> </span><span class="crayon-v">ISnippetRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3b9cf416703410-21"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0041 seconds] -->
<p></p>
</code><p><code></code></p>
<p>Similarly, for <code>Annotation</code>:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9d5863581117" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-7">7</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-8">8</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-9">9</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-10">10</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-11">11</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-12">12</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-13">13</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-14">14</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-15">15</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-16">16</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-17">17</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-18">18</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-19">19</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-20">20</div><div class="crayon-num" data-line="crayon-5fba446a3b9d5863581117-21">21</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-1"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Annotation"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-3"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-4">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-5"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotation</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">Instance</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Annotation</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">snippet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-i">ISnippet</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-7"><span class="crayon-sy">&#125;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-8">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-9"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotationSnapshotIn</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotIn</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Annotation</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">snippet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">ReferenceIdentifier</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-11"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-12">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-13"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotationSnapshotOut</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotOut</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Annotation</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-14"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">snippet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">ReferenceIdentifier</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-15"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-16">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-17"><span class="crayon-e">export </span><span class="crayon-e">type </span><span class="crayon-v">IAnnotationRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">IType</span><span class="crayon-o">&lt;</span><span class="crayon-v">IAnnotationSnapshotIn</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationSnapshotOut</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotation</span><span class="crayon-o">&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-18">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-19"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-v"> Annotation:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-20"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">snippet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">reference</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3b9d5863581117-21"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0033 seconds] -->
<p></p>
</code><p><code></code></p>
<p>This solves our problem and we can conclude here, but I wanted to take this opportunity to highlight a potential caveat with the above implementation.</p>
<p>Let’s say we decide to add a <code>title</code> field to our <code>Snippet</code> model, and we accidentally add it to <code>Snippet</code>:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9db958078312" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9db958078312-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9db958078312-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9db958078312-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9db958078312-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9db958078312-1"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-v"> Snippet:</span><span class="crayon-h"> </span><span class="crayon-v">ISnippetRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9db958078312-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9db958078312-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-5fba446a3b9db958078312-4"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
</code><p><code></code></p>
<p>Because we aren’t using the inferred type from <code>Snippet</code> and we haven’t manually updated the types of <code>ISnippet</code>, <code>ISnippetSnapshotIn</code> and <code>ISnippetSnapshotOut</code>, we will run into an error when we try to create a snippet with a title:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9e0705144719" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9e0705144719-1">1</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9e0705144719-1"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">snippet</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">.</span><span class="crayon-e">create</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-s">"foo"</span><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
</code><p><code></code></p>
<p>Above code fails with:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9e5319533974" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9e5319533974-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9e5319533974-2">2</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9e5319533974-1"><span class="crayon-e">Argument </span><span class="crayon-e">of </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'&#123; title: string; &#125;'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">assignable </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-e">parameter </span><span class="crayon-e">of </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'ISnippetSnapshotIn'</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3b9e5319533974-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-t">Object</span><span class="crayon-h"> </span><span class="crayon-e">literal </span><span class="crayon-e">may </span><span class="crayon-e">only </span><span class="crayon-e">specify </span><span class="crayon-e">known </span><span class="crayon-v">properties</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-s">'title'</span><span class="crayon-h"> </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">exist </span><span class="crayon-st">in</span><span class="crayon-h"> </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'ISnippetSnapshotIn'</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
<p>So, yeah we have type-safety and the type-error points us to the correct direction but we got that error only after we tried to instantiate <code>Snippet</code> with a title and nothing before then.</p>
<p>One might wonder what if we could make such a mistake impossible to make in the first place.</p>
<p>The solution, as <a class="wp-editor-md-post-content-link" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/47124309/how-to-declaratively-enforce-compatibility-of-types">suggested</a> by SO user <a class="wp-editor-md-post-content-link" target="_blank" rel="noopener" href="https://stackoverflow.com/users/2887218/jcalz">jcalz</a> is through witness types which exist solely to check compatibility of types:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9ea404796817" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9ea404796817-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9ea404796817-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9ea404796817-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9ea404796817-1">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9ea404796817-2"><span class="crayon-e">type </span><span class="crayon-v">ExtendsWitness</span><span class="crayon-o">&lt;</span><span class="crayon-i">U</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-v">T</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">T</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-i">U</span></div><div class="crayon-line" id="crayon-5fba446a3b9ea404796817-3">&nbsp;</div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0005 seconds] -->
<p></p>
<p>Now to take advantage of the <code>ExtendsWitness</code> we can update our <code>Snippet</code> model such that instead of specifying the type of <code>Snippet</code> we just explicitly substitute the parts causing circular dependency with <code>any</code>:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9ef551857959" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9ef551857959-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9ef551857959-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9ef551857959-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9ef551857959-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3b9ef551857959-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3b9ef551857959-6">6</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9ef551857959-1">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9ef551857959-2"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">{</span></div><div class="crayon-line" id="crayon-5fba446a3b9ef551857959-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">any</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9ef551857959-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-5fba446a3b9ef551857959-5"><span class="crayon-sy">}</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9ef551857959-6">&nbsp;</div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0010 seconds] -->
<p></p>
<p>We don’t have a type error because the function passed to <code>t.late</code> explicitly returns <code>any</code>.</p>
<p>Now, lets define witness types for the types extracted from <code>Snippet</code> (which is possible because our use of <code>any</code> has eliminated the circular dependency issue):</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9f4092753155" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9f4092753155-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9f4092753155-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9f4092753155-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9f4092753155-4">4</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9f4092753155-1">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9f4092753155-2"><span class="crayon-e">type </span><span class="crayon-v">_ISnippetSnapshotInWitness</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ExtendsWitness</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippetSnapshotIn</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SnapshotIn</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9f4092753155-3"><span class="crayon-e">type </span><span class="crayon-v">_ISnippetSnapshotOutWitness</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ExtendsWitness</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippetSnapshotOut</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SnapshotOut</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9f4092753155-4">&nbsp;</div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<p>Our compiler will now start complaining about that title:</p>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9f9320088353" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums" data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9f9320088353-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9f9320088353-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9f9320088353-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9f9320088353-1"><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">'ISnippetSnapshotOut'</span><span class="crayon-h"> </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">satisfy </span><span class="crayon-e">the </span><span class="crayon-i">constraint</span><span class="crayon-h"> </span><span class="crayon-s">'ModelSnapshotType&lt;{ id: IOptionalIType&lt;ISimpleType&lt;string&gt;, [undefined]&gt;; } &amp; { annotations: IArrayType&lt;any&gt;; title: ISimpleType&lt;string&gt;; }&gt;'</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3b9f9320088353-2">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9f9320088353-3"><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">'ISnippetSnapshotOut'</span><span class="crayon-h"> </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">satisfy </span><span class="crayon-e">the </span><span class="crayon-i">constraint</span><span class="crayon-h"> </span><span class="crayon-s">'ModelSnapshotType&lt;{ id: IOptionalIType&lt;ISimpleType&lt;string&gt;, [undefined]&gt;; } &amp; { annotations: IArrayType&lt;any&gt;; title: ISimpleType&lt;string&gt;; }&gt;'</span><span class="crayon-sy">.</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
<p>Note that the order of types here is important, because <code>ExtendsWitness&lt;SnapshotIn&lt;typeof Snippet&gt;, ISnippetSnapshotIn&gt;</code> will happily pass. We need to ensure that what we are extracting after any-substitution remains a subtype of what we are declaring as our final type.</p>
<p>The reported errors will go away when we move our title from <code>Snippet</code> to <code>Snippet$1</code>:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3b9ff939225499" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-7">7</div><div class="crayon-num" data-line="crayon-5fba446a3b9ff939225499-8">8</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-1"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Snippet"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">title</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">string</span></div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-4"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-5">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-6"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-7"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">any</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3b9ff939225499-8"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0018 seconds] -->
<p></p>
</code><p><code></code></p>
<p>If we define a similar witness type for <code>ISnippet</code> we will encounter another error:</p>
<p><code>type _ISnippetWitness = ExtendsWitness<isnippet, instance<typeof="" snippet="">&gt;;</isnippet,></code></p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3ba04228311725" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3ba04228311725-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3ba04228311725-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3ba04228311725-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3ba04228311725-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3ba04228311725-5">5</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3ba04228311725-1"><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">'ISnippet'</span><span class="crayon-h"> </span><span class="crayon-e">does </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">satisfy </span><span class="crayon-e">the </span><span class="crayon-i">constraint</span><span class="crayon-h"> </span><span class="crayon-s">'ModelInstanceTypeProps&lt;&#123; id: IOptionalIType&lt;ISimpleType&lt;string&gt;, [undefined]&gt;; title: ISimpleType&lt;string&gt;; &#125; &amp; &#123; annotations: IArrayType&lt;any&gt;; &#125;&gt; &amp; IStateTreeNode&lt;IModelType&lt;&#123; id: IOptionalIType&lt;ISimpleType&lt;string&gt;, [...]&gt;; title: ISimpleType&lt;...&gt;; &#125; &amp; &#123; ...; &#125;, &#123;&#125;, _NotCustomized, _NotCustomized&gt;&gt;'</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3ba04228311725-2"><span class="crayon-h">&nbsp;&nbsp;</span><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">'ISnippet'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">assignable </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'ModelInstanceTypeProps&lt;&#123; id: IOptionalIType&lt;ISimpleType&lt;string&gt;, [undefined]&gt;; title: ISimpleType&lt;string&gt;; &#125; &amp; &#123; annotations: IArrayType&lt;any&gt;; &#125;&gt;'</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3ba04228311725-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-e">Types </span><span class="crayon-e">of </span><span class="crayon-m">property</span><span class="crayon-h"> </span><span class="crayon-s">'annotations'</span><span class="crayon-h"> </span><span class="crayon-e">are </span><span class="crayon-v">incompatible</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3ba04228311725-4"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">'IAnnotation[]'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-st">not</span><span class="crayon-h"> </span><span class="crayon-e">assignable </span><span class="crayon-st">to</span><span class="crayon-h"> </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'IMSTArray&lt;any&gt; &amp; IStateTreeNode&lt;IArrayType&lt;any&gt;&gt;'</span><span class="crayon-sy">.</span></div><div class="crayon-line" id="crayon-5fba446a3ba04228311725-5"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-i">Type</span><span class="crayon-h"> </span><span class="crayon-s">'IAnnotation[]'</span><span class="crayon-h"> </span><span class="crayon-st">is</span><span class="crayon-h"> </span><span class="crayon-e">missing </span><span class="crayon-e">the </span><span class="crayon-e">following </span><span class="crayon-e">properties </span><span class="crayon-e">from </span><span class="crayon-i">type</span><span class="crayon-h"> </span><span class="crayon-s">'IMSTArray&lt;any&gt;'</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">spliceWithArray</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">observe</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">intercept</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">clear</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-st">and</span><span class="crayon-h"> </span><span class="crayon-cn">4</span><span class="crayon-h"> </span><span class="crayon-v">more</span><span class="crayon-sy">.</span><span class="crayon-h"> </span><span class="crayon-sy">[</span><span class="crayon-cn">2344</span><span class="crayon-sy">]</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0020 seconds] -->
<p></p>
</code><p><code></code></p>
<p>This happens because our manually defined instance type <code>ISnippet</code> uses a plain array where in the instance we would actually have an <code>IMSTArray</code> which <a class="wp-editor-md-post-content-link" target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Duck_typing">quacks like</a> an array, but is also MST aware (handles references, snapshot types etc.) and obsevervable.</p>
<p>So we can update our <code>ISnippet</code> implementation to use an <code>IMSTArray</code>:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3ba0b862130930" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3ba0b862130930-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3ba0b862130930-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3ba0b862130930-3">3</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3ba0b862130930-1"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippet</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">Instance</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3ba0b862130930-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IMSTArray</span><span class="crayon-o">&lt;</span><span class="crayon-v">IAnnotationRunType</span><span class="crayon-o">&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba0b862130930-3"><span class="crayon-sy">&#125;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0008 seconds] -->
<p></p>
</code><p><code></code></p>
<p>So the witnesses potentially safeguards against hard(-er) to debug errors at invocation sites by identifying them close to the definition site itself.</p>
<p>However, when we added witness types we removed our augmented type annotation from Snippet (<code>export const Snippet: ISnippetRunType = ...</code> to <code>export const Snippet = ...</code>). While this enabled us to add witnesses for the types derived from <code>Snippet</code>, these derived types have strictly less information than <code>ISnippetRunType</code> and so when exporting we would want to export a model of type <code>ISnippetRunType</code>:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3ba10153273011" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-7">7</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-8">8</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-9">9</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-10">10</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-11">11</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-12">12</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-13">13</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-14">14</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-15">15</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-16">16</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-17">17</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-18">18</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-19">19</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-20">20</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-21">21</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-22">22</div><div class="crayon-num" data-line="crayon-5fba446a3ba10153273011-23">23</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3ba10153273011-1"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippet</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">Instance</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IMSTArray</span><span class="crayon-o">&lt;</span><span class="crayon-v">IAnnotationRunType</span><span class="crayon-o">&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-3"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-4">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-5"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippetSnapshotIn</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotIn</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-6"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-sy">?</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationSnapshotIn</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-7"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-8">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-9"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippetSnapshotOut</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotOut</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-10"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationSnapshotOut</span><span class="crayon-sy">[</span><span class="crayon-sy">]</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-11"><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-12">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-13"><span class="crayon-e">export </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">ISnippetRunType </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-v">IType</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippetSnapshotIn</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">ISnippetSnapshotOut</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">ISnippet</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span><span class="crayon-h"> </span><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-14">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-15"><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">2</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">1.props</span><span class="crayon-sy">(</span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-16"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">annotations</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-t">array</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-17"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-18">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-19"><span class="crayon-e">type </span><span class="crayon-v">_ISnippetSnapshotInWitness</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ExtendsWitness</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippetSnapshotIn</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SnapshotIn</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-20"><span class="crayon-e">type </span><span class="crayon-v">_ISnippetSnapshotOutWitness</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ExtendsWitness</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippetSnapshotOut</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">SnapshotOut</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-21"><span class="crayon-e">type </span><span class="crayon-v">_ISnippetWitness</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">ExtendsWitness</span><span class="crayon-o">&lt;</span><span class="crayon-v">ISnippet</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">Instance</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-o">&gt;&gt;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-22">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba10153273011-23"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-v"> Snippet:</span><span class="crayon-h"> </span><span class="crayon-v">ISnippetRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">$</span><span class="crayon-cn">2</span><span class="crayon-sy">;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0039 seconds] -->
<p></p>
</code><p><code></code></p>
<p>Note that we have also replaced the previous type alias (ISnippetRunType) with an interface which we can use as the return types of <code>t.late</code> (because interfaces can have cyclic dependencies).</p>
<p>We could do exactly the same thing for <code>Annotation.ts</code>, but we can do better.</p>
<p>We can further take advantage of the fact that interfaces can have cyclic-dependencies to reduce the boilerplate in <code>Annotation.ts</code> to the extent that we won’t even need the intermediate type <code>Annotation$1</code>:</p>
<p><code></code></p><code>
<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->

		<div id="crayon-5fba446a3ba17417090421" class="crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover" style=" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;">
		
			<div class="crayon-plain-wrap"></div>
			<div class="crayon-main" style="">
				<table class="crayon-table">
					<tbody><tr class="crayon-row">
				<td class="crayon-nums " data-settings="hide">
					<div class="crayon-nums-content" style="font-size: 15px !important; line-height: 20px !important;"><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-1">1</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-2">2</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-3">3</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-4">4</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-5">5</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-6">6</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-7">7</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-8">8</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-9">9</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-10">10</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-11">11</div><div class="crayon-num" data-line="crayon-5fba446a3ba17417090421-12">12</div></div>
				</td>
						<td class="crayon-code"><div class="crayon-pre" style="font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;"><div class="crayon-line" id="crayon-5fba446a3ba17417090421-1"><span class="crayon-e">export </span><span class="crayon-m">const</span><span class="crayon-h"> </span><span class="crayon-v">Annotation</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">model</span><span class="crayon-sy">(</span><span class="crayon-s">"Annotation"</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-2"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">id</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">optional</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-v">identifier</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-e">uuid</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span><span class="crayon-sy">,</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-3"><span class="crayon-h">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="crayon-v">snippet</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">reference</span><span class="crayon-sy">(</span><span class="crayon-v">t</span><span class="crayon-sy">.</span><span class="crayon-e">late</span><span class="crayon-sy">(</span><span class="crayon-sy">(</span><span class="crayon-sy">)</span><span class="crayon-o">:</span><span class="crayon-h"> </span><span class="crayon-v">ISnippetRunType</span><span class="crayon-h"> </span><span class="crayon-o">=</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-v">Snippet</span><span class="crayon-sy">)</span><span class="crayon-sy">)</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-4"><span class="crayon-sy">&#125;</span><span class="crayon-sy">)</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-5">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-6"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotation</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">Instance</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Annotation</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span><span class="crayon-h"> </span><span class="crayon-sy">&#125;</span><span class="crayon-sy">;</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-7">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-8"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotationSnapshotIn</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotIn</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Annotation</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span><span class="crayon-h"> </span><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-9">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-10"><span class="crayon-e">export</span><span class="crayon-h"> </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotationSnapshotOut</span><span class="crayon-h"> </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-e">SnapshotOut</span><span class="crayon-o">&lt;</span><span class="crayon-r">typeof</span><span class="crayon-h"> </span><span class="crayon-e">Annotation</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span><span class="crayon-h"> </span><span class="crayon-sy">&#125;</span></div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-11">&nbsp;</div><div class="crayon-line" id="crayon-5fba446a3ba17417090421-12"><span class="crayon-e">export </span><span class="crayon-t">interface</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotationRunType </span><span class="crayon-r">extends</span><span class="crayon-h"> </span><span class="crayon-v">IType</span><span class="crayon-o">&lt;</span><span class="crayon-v">IAnnotationSnapshotIn</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-v">IAnnotationSnapshotOut</span><span class="crayon-sy">,</span><span class="crayon-h"> </span><span class="crayon-e">IAnnotation</span><span class="crayon-o">&gt;</span><span class="crayon-h"> </span><span class="crayon-sy">&#123;</span><span class="crayon-h"> </span><span class="crayon-sy">&#125;</span></div></div></td>
					</tr>
				</tbody></table>
			</div>
		</div>
<!-- [Format Time: 0.0055 seconds] -->
<p></p>
</code><p><code></code></p>
<p>Obviously we can’t do this for both <code>Snippet</code> and <code>Annotation</code> because TypeScript will not allow us to define a type such that its definition will use itself.</p>
<p>So with this, we are finally done 🖖.</p>
<hr>
<p><sup><a href="#extract-types-back" id="extract-types">[1]</a></sup> My <a class="wp-editor-md-post-content-link" href="/2018/07/18/unwrapping-composite-types-in-typescript/">post on unwrapping composite types</a> goes into more detail around TypeScript features that enable us to extract out types of members of a composite type.</p>
<p>PS: You’d note that we had to write quite a bit of boilerplate to ensure type-safety. I am writing an inline code-generator called <a class="wp-editor-md-post-content-link" target="_blank" rel="noopener" href="https://github.com/lorefnon/InGenR">InGenR</a> that helps with automating this kind of thing using code-generation. If this interests you I’d be more than happy to receive feedback and contributions.</p>


    </div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>© 2022 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p></div></body></html>