<!DOCTYPE html><html class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><title>Lorefnon | Blog | Using Vector to funnel Docker Compose logs to S3</title><meta property="og:title" content="Lorefnon | Blog | Using Vector to funnel Docker Compose logs to S3"><meta property="og:description" content="Ramblings on Web Development and software architecture"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="icon" href="/images/favicon/favicon.ico"><script data-goatcounter="https://analytics.lorefnon.com/count" async src="https://analytics.lorefnon.com/count.js"></script><script src="https://unpkg.com/htmx.org@1.7.0/dist/htmx.min.js" defer></script><script src="https://unpkg.com/dompurify@2.3.6/dist/purify.min.js" defer></script><script src="/js/blog.js" defer></script><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="Icicles of Thought" type="application/atom+xml">
</head><body class="blog-body" hx-boost="true"><div class="blog-summary"><a class="primary-link" href="/" hx-boost="false"><h1 class="header-text">Gaurab Paul</h1><h2 class="header-text">Polyglot software developer &amp; consultant passionate about web development, distributed systems and open source technologies</h2></a><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a></div></div></div><div class="blog-sidebar"><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a><div class="blog-support-arrow"></div><p class="support-text body-text">Support my blog and open-source work</p></div></div><h1 class="header-text">Tags</h1><ul class="tag-list"><li class="body-text"><a class="tag-link" href="/tags/AWS/"><img src="/images/tag.svg">AWS</a></li><li class="body-text"><a class="tag-link" href="/tags/Docker/"><img src="/images/tag.svg">Docker</a></li><li class="body-text"><a class="tag-link" href="/tags/Docker-Compose/"><img src="/images/tag.svg">Docker-Compose</a></li><li class="body-text"><a class="tag-link" href="/tags/Vector/"><img src="/images/tag.svg">Vector</a></li><li class="body-text"><a class="tag-link" href="/tags/S3/"><img src="/images/tag.svg">S3</a></li></ul></div><div class="blog-header blog-post-header"><div class="blog-post-header-inner"><div class="header-text">Using Vector to funnel Docker Compose logs to S3</div><div class="posted-date sub-header-text" title="2023-08-20">Posted &nbsp;7 days ago</div><hr class="blog-header-separator"></div></div><div class="blog-main"><div class="page-content"><p><a href="https://docs.docker.com/compose/" target="_blank" rel="noopener external nofollow noreferrer">Docker compose</a> is an easy-to-use utility for running multi-container applications. It is particularly suited for development and local testing, but is also useful for production development of low-traffic&#x2F;personal-use application which neither need a full fledged cluster nor features like auto-scaling&#x2F;failover-handling which come with more advanced container orchestration solutions.</p>
<p>This post is a quick recipe to funnel docker compose logs to AWS S3 for long term archival.</p>
<p>The utility we use for shipping the logs is <a href="https://vector.dev/guides/" target="_blank" rel="noopener external nofollow noreferrer">Vector</a>. Vector is a full featured observability pipeline solution which supports not just shipping but also aggregating and transforming logs. However, in this post we just use it to ship logs to a bucket so that we can analyse them later if needed. Being a rust-based native utility, it has a very low footprint and is well suited to single server or homelab deployments.</p>
<p>In <code>docker-compose.yaml</code>:</p>
<pre><code class="hljs yaml"><span class="hljs-attr">version:</span> <span class="hljs-string">&quot;3.9&quot;</span>

<span class="hljs-attr">services:</span>
  <span class="hljs-attr">vector:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">timberio/vector:0.31.0-debian</span>
    <span class="hljs-attr">restart:</span> <span class="hljs-string">always</span>
    <span class="hljs-attr">container_name:</span> <span class="hljs-string">vector</span>
    <span class="hljs-attr">hostname:</span> <span class="hljs-string">vector</span>
    <span class="hljs-attr">environment:</span> 
      <span class="hljs-bullet">-</span> <span class="hljs-string">DOCKER_HOST=&quot;unix:///var/run/docker.sock&quot;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">AWS_ACCESS_KEY_ID</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">AWS_SECRET_ACCESS_KEY</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">AWS_REGION</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&#x27;8383:8383&#x27;</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./vector-setup/vector.yaml:/etc/vector/vector.yaml:ro</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">/var/run/docker.sock:/var/run/docker.sock:ro</span>
    <span class="hljs-attr">command:</span> <span class="hljs-string">--config</span> <span class="hljs-string">/etc/vector/vector.yaml</span>

  <span class="hljs-comment"># Add any other services:</span>
  <span class="hljs-attr">caddy:</span>
    <span class="hljs-attr">image:</span> <span class="hljs-string">caddy:latest</span>
    <span class="hljs-attr">volumes:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./modules/caddy-setup/tmp/config:/config</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./modules/caddy-setup/tmp/data:/data</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">./modules/caddy-setup/Caddyfile:/etc/caddy/Caddyfile</span>
    <span class="hljs-attr">ports:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;80:80&quot;</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;443:443&quot;</span></code></pre>

<p>Since vector needs to communicate with the docker daemon we need to mount the docker socket and make it available to the vector container.</p>
<p>In the vector.yaml config, we can specify which bucket we want to funnel our logs to and which services we want to track:</p>
<pre><code class="hljs yaml"><span class="hljs-attr">data_dir:</span> <span class="hljs-string">/var/lib/vector</span>
<span class="hljs-attr">sources:</span>
  <span class="hljs-attr">docker_logs_source:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">docker_logs</span>
    <span class="hljs-attr">docker_host:</span> <span class="hljs-string">&quot;unix:///var/run/docker.sock&quot;</span>

<span class="hljs-attr">sinks:</span>
  <span class="hljs-attr">s3_sink:</span>
    <span class="hljs-attr">type:</span> <span class="hljs-string">aws_s3</span>
    <span class="hljs-attr">inputs:</span> [<span class="hljs-string">docker_logs_source</span>]
    <span class="hljs-attr">region:</span> <span class="hljs-string">ap-south-1</span>
    <span class="hljs-attr">bucket:</span> <span class="hljs-string">my-service-logs</span>
    <span class="hljs-attr">key_prefix:</span> <span class="hljs-string">&quot;container-logs/date=%Y-%m-%d&quot;</span>
    <span class="hljs-attr">compression:</span> <span class="hljs-string">gzip</span>
    <span class="hljs-attr">encoding:</span>
      <span class="hljs-attr">codec:</span> <span class="hljs-string">json</span></code></pre>

<p>And that is all we need. Once we run <code>docker compose up</code>, after a while we should see our logs getting dumped into the S3 bucket.</p>
</div><div class="post-comments"><!-- .comments-target--></div><div class="post-comments" style="margin-top: 10px;"><div id="remark42"></div></div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>Â© 2022 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p></div></body></html>