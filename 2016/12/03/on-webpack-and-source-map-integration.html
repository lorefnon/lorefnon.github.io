<!DOCTYPE html><html class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><title>Lorefnon | Blog | On Webpack and Source Map integration</title><meta property="og:title" content="Lorefnon | Blog | On Webpack and Source Map integration"><meta property="og:description" content="A comprehensive detour into the various devtools options in webpack"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="icon" href="/images/favicon/favicon.ico"><script data-goatcounter="https://analytics.lorefnon.com/count" async src="https://analytics.lorefnon.com/count.js"></script><script src="https://unpkg.com/htmx.org@1.7.0/dist/htmx.min.js" defer></script><script src="https://unpkg.com/dompurify@2.3.6/dist/purify.min.js" defer></script><script src="/js/blog.js" defer></script><meta name="generator" content="Hexo 6.2.0"></head><body class="blog-body" hx-boost="true"><div class="blog-summary"><a class="primary-link" href="/" hx-boost="false"><h1 class="header-text">Gaurab Paul</h1><h2 class="header-text">Polyglot software developer &amp; consultant passionate about web development, distributed systems and open source technologies</h2></a><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a></div></div></div><div class="blog-sidebar"><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a><div class="blog-support-arrow"></div><p class="support-text body-text">Support my blog and open-source work</p></div></div><h1 class="header-text">Tags</h1><ul class="tag-list"></ul></div><div class="blog-header blog-post-header"><div class="blog-post-header-inner"><div class="header-text">On Webpack and Source Map integration</div><div class="posted-date sub-header-text" title="2016-12-03">Posted &nbsp;6 years ago</div><hr class="blog-header-separator"></div></div><div class="blog-main"><div class="flex-row post-warning"><img src="/images/primary/alert-triangle.svg" style="margin-right: 1rem">This post has not been updated in quite some time and the content here may be out of date 
or not reflect my current my recommedation in the matter.</div><div class="page-content"><p>Webpack is the forerunner in the javascript module bundling space. One of the important aspects that plays a key role in debuggability of javascript applications is source map integration - so we can debug the original source code  after transpilation.</p>

<p>Webpack has a <code>devtool</code> option which (just like everything in webpack) supports a variety of choices which can be beffudling even though the official documentation has a <a target="_blank" rel="noopener" href="https://webpack.github.io/docs/configuration.html#devtool">dedicated section</a> on it.</p>

<p>Our primary focus would be on a babel transpiled project, though sourcemaps can be effectively used with many other compile-to-js languages like dart, coffeescript, opal(ruby) etc, as well as languages which target css.</p>

<hr>

<p>Before we delve into different supported <code>devtool</code> options, let us briefly look into how a webpack generated file typically looks like.</p>

<a class="header-link" href="#webpack-bootstrapper"><h1 id="webpack-bootstrapper">Webpack bootstrapper</h1></a>

<p>A typical bundle generated by webpack file is essentially an IIFE that is passed an array of compiled modules.</p>
<div class="highlight"><pre><code class="javascript language-javascript" data-lang="javascript"><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">modules</span><span class="p">)</span> <span class="p">&#123;</span>
  <span class="p">...</span> <span class="nx">bootstrapper</span> <span class="nx">goes</span> <span class="nx">here</span>
<span class="p">&#125;)([</span>
  <span class="p">...</span> <span class="nx">modules</span> <span class="nx">go</span> <span class="nx">here</span>
<span class="p">])</span>
</code></pre></div>
<p>The bootstrapper basically defines a minimal dependency loader <code>__webpack_require__</code> which is injected into each module . The entry module (modules[0]) is invoked first and uses <code>__webpack_require__</code> to load other dependencies (if any). Irrespective of whether the original source code used commonjs/amd/ES6 imports, they all are transpiled to use <code>__webpack_require__</code>.</p>

<a class="header-link" href="#different-devtool-options-"><h1 id="different-devtool-options-">Different devtool options:</h1></a>

<p>The documentation mentions following options as valid values for the devtool config, and outlines their characteristics in a helpful table:</p>

<div class="table-wrapper"><table>
<thead>
<tr>
<th>devtool</th>
<th>build speed</th>
<th>rebuild speed</th>
<th>production supported</th>
<th>quality</th>
</tr>
</thead>
<tbody>
<tr>
<td>eval</td>
<td>+++</td>
<td>+++</td>
<td>no</td>
<td>generated code</td>
</tr>
<tr>
<td>cheap-eval-source-map</td>
<td>+</td>
<td>++</td>
<td>no</td>
<td>transformed code (lines only)</td>
</tr>
<tr>
<td>cheap-source-map</td>
<td>+</td>
<td>o</td>
<td>yes</td>
<td>transformed code (lines only)</td>
</tr>
<tr>
<td>cheap-module-eval-source-map</td>
<td>o</td>
<td>++</td>
<td>no</td>
<td>original source (lines only)</td>
</tr>
<tr>
<td>cheap-module-source-map</td>
<td>o</td>
<td>-</td>
<td>yes</td>
<td>original source (lines only)</td>
</tr>
<tr>
<td>eval-source-map</td>
<td>–</td>
<td>+</td>
<td>no</td>
<td>original source</td>
</tr>
<tr>
<td>source-map</td>
<td>–</td>
<td>–</td>
<td>yes</td>
<td>original source</td>
</tr>
</tbody>
</table></div>

<p>The different dev-tools option provides different levels of ease of debuggability. We start with the most basic one:</p>

<a class="header-link" href="#eval"><h2 id="eval">eval</h2></a>

<p>| Each module is executed with eval and //@ sourceURL.</p>

<p>With eval each module entry in the modules array looks something like this:</p>
<div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="nb">eval</span><span class="p">(</span><span class="s2">"'use strict';...generated code of index.js...//# sourceURL=webpack:///./index.js?"</span><span class="p">);</span>
</code></pre></div>
<p>In this mode the only mapping we have is at file level so exceptions point to the right file in the source code, but not to the right line number of original source code. But while debugging we are not really debugging the original code that we wrote.</p>

<p>It is not really a great choice for compiled code. It is possible to deal with it for languages which are semantically similar to ES2015 like coffeescript or basic babel compilation without async/await transforms (which result in significant restructuring of code) because it is easy to mentally map the compiled source to original code, but it is advisable that we look into the other options below for easier debuggability.</p>

<p>It is to be noted that the line numbers in exception stack traces not only don't match with original code before babel transpilation, it might also not match with the babel transpiled code because of webpack specific transformations that happen before bundle generation. So we can not reliable depend on our editor plugins' babel transpile output to get the line numbers from exceptions.</p>

<p>However, there is one advantage: During debugging, it is easy to copy a part of the source code from the sources panel at any point, tweak it a bit and evaluate it in the javascript console. While this feature is often taken for granted by developers habituated to vanilla javascript, we loose this in most of the other alternatives below.</p>

<p>Because of its simplicity the generation time is quite fast (in fact fastest among all the options below) and does not significantly add to the size of generated bundle.</p>

<p>However, it should not be used in production because eval potentially <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/86513/why-is-using-the-javascript-eval-function-a-bad-idea">disables</a> multiple performance optimizations that javascript engines perform.</p>

<a class="header-link" href="#cheap-eval-source-map"><h2 id="cheap-eval-source-map">cheap-eval-source-map</h2></a>

<p>The above table mentions the quality as "transformed code (lines code)". What this means is that the code visible in browser devtools is the code <em>after</em> being transformed by babel (or other loaders) but before final stage webpack specific transformations, which transforms the require statements to use <code>__webpack_require__</code>, injects errors for missing modules etc.</p>

<p>In this mode each module entry in the modules array looks something like this:</p>
<div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="nb">eval</span><span class="p">(</span><span class="s2">"'use strict';...generated code of index.js ...//# sourceMappingURL=data:application/json;charset=utf-8;base64,...base 64 encoded string of sourcemap..."</span><span class="p">);</span>
</code></pre></div>
<p>The last part is a base64 encoded string of a JSON source map similar to the following:</p>
<div class="highlight"><pre><code class="json language-json" data-lang="json"><span class="p">&#123;</span>
  <span class="nt">"version"</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="nt">"file"</span><span class="p">:</span> <span class="s2">"0.js"</span><span class="p">,</span>
  <span class="nt">"sources"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"webpack:///./index.js?8920"</span>
  <span class="p">],</span>
  <span class="nt">"sourcesContent"</span><span class="p">:</span> <span class="p">[</span>
    <span class="s2">"'use strict';\n\nvar _react = require('react');\n\nvar _react2 = _interopRequireDefault(_react);\n\nvar _reactDom = require('react-dom');\n\nfunction _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;\n\ndebugger;\n\n(0, _reactDom.render)(_react2.default.createElement(\n  'div',\n  null,\n  'Hello world'\n), document.getElementById('root'));\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./index.js\n// module id = 0\n// module chunks = 0"</span>
  <span class="p">],</span>
  <span class="nt">"mappings"</span><span class="p">:</span> <span class="s2">"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA"</span><span class="p">,</span>
  <span class="nt">"sourceRoot"</span><span class="p">:</span> <span class="s2">""</span>
<span class="p">&#125;</span>
</code></pre></div>
<p>The code in <code>sourcesContent</code> is the source code after babel transformation, so we <em>can</em> use editor plugin's babel transformation preview (or for that matter babel cli) to get lines reported in exceptions.</p>

<p>Besides the above, the advantages and disadvantages are mostly the same as <code>eval</code> and is basically only useful if the code being webpacked is vanilla javascript which is loaded through webpack. For debugging original source code before babel transpilation, other options are outlined below.</p>

<p>This should also not be used in production because of not only the eval related issues highlighted above, but also because generated code is separately embedded in the code which increases the size of bundle significantly. For production usage it is desirable that the source map be saved as separate files which are loaded on demand during debugging sessions.</p>

<p>While typically line numbers would not match with the original source code if loaders (like babel) are used for transformation, however babel has a option <code>retainLines</code> which will result in output structured in such a way that line numbers of transpiled code match original source line numbers. This obviously does not retain the column numbers.</p>

<p>In the example below we see a simple example of original and babel-transpiled code with retainLines=true</p>
<div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="kr">import</span> <span class="nx">React</span> <span class="nx">from</span> <span class="s1">'react'</span><span class="p">;</span>
<span class="kr">import</span> <span class="p">&#123;</span><span class="nx">render</span><span class="p">&#125;</span> <span class="nx">from</span> <span class="s1">'react-dom'</span><span class="p">;</span>

<span class="nx">render</span><span class="p">(</span>
  <span class="o">&lt;</span><span class="nx">div</span><span class="o">&gt;</span>
    <span class="nx">Hello</span> <span class="nx">world</span>
  <span class="o">&lt;</span><span class="err">/div&gt;,</span>
  <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">)</span>
<span class="p">);</span>
</code></pre></div>
<div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="s1">'use strict'</span><span class="p">;</span><span class="kd">var</span> <span class="nx">_react</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'react'</span><span class="p">);</span><span class="kd">var</span> <span class="nx">_react2</span> <span class="o">=</span> <span class="nx">_interopRequireDefault</span><span class="p">(</span><span class="nx">_react</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">_reactDom</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'react-dom'</span><span class="p">);</span><span class="kd">function</span> <span class="nx">_interopRequireDefault</span><span class="p">(</span><span class="nx">obj</span><span class="p">)</span> <span class="p">&#123;</span><span class="k">return</span> <span class="nx">obj</span> <span class="o">&amp;&amp;</span> <span class="nx">obj</span><span class="p">.</span><span class="nx">__esModule</span> <span class="o">?</span> <span class="nx">obj</span> <span class="o">:</span> <span class="p">&#123;</span> <span class="k">default</span><span class="o">:</span> <span class="nx">obj</span> <span class="p">&#125;;&#125;</span>

<span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">_reactDom</span><span class="p">.</span><span class="nx">render</span><span class="p">)(</span>
<span class="nx">_react2</span><span class="p">.</span><span class="k">default</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">'div'</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="s1">'Hello world'</span><span class="p">),</span>


<span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'root'</span><span class="p">));</span>
</code></pre></div>
<a class="header-link" href="#cheap-source-map"><h2 id="cheap-source-map">cheap-source-map</h2></a>

<p>In this case <code>eval</code> is no longer used. And a single source map file is generated which is referred in the generated bundle through a line in the end like:</p>
<div class="highlight"><pre><code class="js language-js" data-lang="js"><span class="c1">//# sourceMappingURL=bundle.js.map</span>
</code></pre></div>
<p>The code visible in browser dev-tools is still babel-transpiled code, like the case with <code>cheap-eval-source-map</code>.</p>

<a class="header-link" href="#cheap-module-eval-source-map"><h2 id="cheap-module-eval-source-map">cheap-module-eval-source-map</h2></a>

<p>As mentioned in the name this uses <code>eval</code> but the source is the actual source code before babel transpilation. Though we get line level mapping, individual expressions are not mapped to expressions in the original source.</p>

<p>However because of the same reasons as cheap-eval-source-map (eval usage, source map embedded in generated bundle leading to increased size) it is not suitable for production usage.</p>

<a class="header-link" href="#cheap-module-source-map"><h2 id="cheap-module-source-map">cheap-module-source-map</h2></a>

<p>This is an evolution over the above in that we get rid of eval and move source maps to separate files making it sutable for production usage.</p>

<a class="header-link" href="#eval-source-map"><h3 id="eval-source-map">eval-source-map</h3></a>

<p>This maps to not only lines of original source code, but also columns. It does, however, use eval making it suitable only for development.</p>

<p>The detailed source map generation results in an execution time penalty during bundling as well as larger source maps.</p>

<a class="header-link" href="#source-map"><h2 id="source-map">source-map</h2></a>

<p>This has column level mapping to original source code, does not use eval and is suitable for production. This is the best option for production usage, even though build times are slower than above options.</p>

<hr>

<p>For the simple example above the sizes of different bundles and source maps are summarized below:</p>

<div class="table-wrapper"><table>
  <tr>
    <th>File</th>
<th>Size</th>
<th>Time taken for initial bundling</th>
  </tr>
  <tr>
    <td> bundle.eval.js</td>
<td>760K</td>
<td> 1603ms</td>
  </tr>
  <tr>
    <td> bundle.cheap-eval-source-map.js </td>
<td>1.9M</td>
<td>1888ms</td>
  </tr>
  <tr>
    <td>bundle.cheap-source-map.js</td>
<td>723K</td>
<td rowspan="2"> 1724ms</td>
  </tr>
  <tr>
    <td>bundle.cheap-source-map.js.map</td>
<td>841K</td>
  </tr>
  <tr>
    <td>bundle.cheap-module-eval-source-map.js</td>
<td>1.9M</td>
<td>1870ms</td>
  </tr>
  <tr>
    <td>bundle.cheap-module-source-map.js</td>
<td>723K</td>
<td rowspan="2">1756ms</td>
  </tr>
  <tr>
    <td>bundle.cheap-module-source-map.js.map</td>
<td>841K</td>
  </tr>
  <tr>
    <td>bundle.eval-source-map.js</td>
<td>1.9M</td>
<td>2127ms</td>
  </tr>
  <tr>
    <td>bundle.source-map.js</td>
<td>725K</td>
<td rowspan="2">2197ms</td>
  </tr>
  <tr>
    <td>bundle.source-map.js.map</td>
<td>844K</td>
  </tr>
</table></div>

<p>Given this is a small file with very few dependencies, the webpack bundling times are not representative of real world use cases.</p>

<p>It is recommended to use separate webpack configurations for production and development. In development, when dealing with mostly well formatted source code <code>cheap-module-eval-source-map</code> is usually adequate where as in production it is good to have <code>source-map</code> as the devtool config.</p>

<a class="header-link" href="#selective-source-map-generation"><h1 id="selective-source-map-generation">Selective source map generation</h1></a>

<p>Webpack provides a <a target="_blank" rel="noopener" href="https://webpack.github.io/docs/list-of-plugins.html#sourcemapdevtoolplugin"><code>SourceMapDevToolPlugin</code></a> for greater control over which files source maps should be generated for.</p>

<p>For instance, using this plugin we can specify a regular expression for filtering all the files for which source maps should be generated.</p>

<a class="header-link" href="#about-pragma-styles"><h1 id="about-pragma-styles">About pragma styles</h1></a>

<p>The devtool configuration string can be prefixed with <code>#</code> or <code>@</code> to force a specific a pragma style. The latter is now deprecated by browser vendors. The reasoning behind this has been summarized by html5rocks:</p>

<blockquote>
<p>Previously the comment pragma was <code>//@</code> but due to some issues with that and <a target="_blank" rel="noopener" href="https://www.html5rocks.com/en/tutorials/developertools/sourcemaps/#toc-issues">IE conditional compilation</a> comments the <a target="_blank" rel="noopener" href="https://groups.google.com/forum/#!topic/mozilla.dev.js-sourcemap/4uo7Z5nTfUY">decision was made</a> to change it to <code>//#</code>. Currently Chrome Canary, WebKit Nightly and Firefox 24+ support the new comment pragma. This syntax change also affects sourceURL.</p>
</blockquote>

<p>Changing the prefix to <code>@</code> can help with debugging in older browsers</p>

</div><div class="post-comments"><!-- .comments-target--></div><div class="post-comments" style="margin-top: 10px;"><div id="remark42"></div></div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>© 2022 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p></div></body></html>