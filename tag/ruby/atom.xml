<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://lorefnon.me</id>
    <title>Icicles of Thought • Posts by &#34;ruby&#34; tag</title>
    <link href="https://lorefnon.me" />
    <updated>2016-03-31T00:00:00.000Z</updated>
    <category term="Javascript" />
    <category term="KnockoutJS" />
    <category term="Ruby" />
    <category term="EventMachine" />
    <category term="Websockets" />
    <category term="SQLite" />
    <category term="Jade" />
    <category term="Node.js" />
    <category term="Rails" />
    <category term="Emacs" />
    <category term="Gulp" />
    <category term="ActiveAdmin" />
    <category term="ActiveRecord" />
    <category term="Devise" />
    <category term="Integration" />
    <category term="ZSH" />
    <category term="Productivity Hacks" />
    <category term="OCR" />
    <category term="Design Patterns" />
    <category term="InfluxDB" />
    <category term="Grafana" />
    <category term="React" />
    <category term="Functional Programming" />
    <category term="ES6" />
    <category term="Helm" />
    <category term="SPF" />
    <category term="CSS" />
    <category term="Redux" />
    <category term="Redux-loop" />
    <category term="Frontend" />
    <category term="Vagrant" />
    <category term="Clojure" />
    <category term="Hashicorp" />
    <category term="Typescript" />
    <category term="ReasonML" />
    <category term="Next.js" />
    <category term="Koa" />
    <category term="Apollo" />
    <category term="GraphQL" />
    <category term="MongoDB" />
    <category term="Automerge" />
    <category term="CRDT" />
    <category term="SVG" />
    <category term="VSCode" />
    <category term="Comlink" />
    <category term="Web-workers" />
    <category term="io-ts" />
    <category term="MobX" />
    <category term="MobX-State-Tree" />
    <category term="Routing" />
    <category term="HAR" />
    <category term="Jq" />
    <category term="Kotlin" />
    <category term="Vert.X" />
    <category term="Vert.X-Web" />
    <category term="Backend-development" />
    <category term="API-development" />
    <category term="Java" />
    <category term="JOOQ" />
    <category term="Ruby on Rails" />
    <category term="Liquibase" />
    <category term="tbls" />
    <category term="jOOQ" />
    <category term="Gradle" />
    <category term="Spring" />
    <category term="Spring-Boot" />
    <category term="gRPC" />
    <category term="Redis" />
    <category term="Database" />
    <category term="Exposed" />
    <category term="vim" />
    <category term="kotlin" />
    <category term="spring" />
    <category term="spring-security" />
    <category term="komapper" />
    <category term="spring-boot" />
    <category term="typescript" />
    <category term="zod" />
    <category term="ts-match" />
    <category term="Lit-html" />
    <category term="Stimulus" />
    <category term="Vue" />
    <category term="TypeScript" />
    <entry>
        <id>https://lorefnon.me/2016/03/31/database-driven-scheduling-with-clockwork-and-activejob.html</id>
        <title>Database driven scheduling with Clockwork and ActiveJob</title>
        <link rel="alternate" href="https://lorefnon.me/2016/03/31/database-driven-scheduling-with-clockwork-and-activejob.html"/>
        <content type="html">

&lt;a class=&#34;header-link&#34; href=&#34;#on-cron-and-cron-management-dsls&#34;&gt;&lt;h2 id=&#34;on-cron-and-cron-management-dsls&#34;&gt;On cron and cron management DSLs&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The &lt;a href=&#34;https://en.wikipedia.org/wiki/Cron&#34;&gt;cron utility&lt;/a&gt; is the typical goto scheduling solution in unix/linux systems. Utilities like &lt;a href=&#34;https://github.com/javan/whenever&#34;&gt;whenever&lt;/a&gt; allow us to take advantage of cron through an elegant and declarative pure ruby DSL.&lt;/p&gt;

&lt;p&gt;The typical approach when using whenever for scheduling is to use deployment hooks to update the crontab from whenever&#39;s configuration during application deployment. However this approach falls short when the schedule is expected to be configurable at run time and especially if we want to give administrators fine grained controls over what is being scheduled and when.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#database-driven-scheduling&#34;&gt;&lt;h2 id=&#34;database-driven-scheduling&#34;&gt;Database driven scheduling&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The post outlines an alternative solution using the library &lt;a href=&#34;https://github.com/tomykaira/clockwork&#34;&gt;clockwork&lt;/a&gt; that makes it easy to make event scheduling run time configurable through database models managed using familiar ruby ORMs.&lt;/p&gt;

&lt;p&gt;While clockwork handles the scheduling aspect, the responsibility of actual execution of the jobs is expected to be delegated to a background processor like &lt;a href=&#34;https://github.com/mperham/sidekiq&#34;&gt;sidekiq&lt;/a&gt; or &lt;a href=&#34;https://github.com/collectiveidea/delayed_job&#34;&gt;delayed job&lt;/a&gt;.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#activejob-and-standardized-apis-for-background-processing&#34;&gt;&lt;h2 id=&#34;activejob-and-standardized-apis-for-background-processing&#34;&gt;ActiveJob and standardized APIs for background processing&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Rather than coupling our code to a specific background processor which might in turn may be coupled with a specific transport system (like Sidekiq and Redis) it is advisable to rely instead (as much as possible) on ActiveJob API which provides a standardized API for background processing in Rails ecosystem.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#integration-with-admin-interfaces&#34;&gt;&lt;h2 id=&#34;integration-with-admin-interfaces&#34;&gt;Integration with Admin interfaces&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The benefit of the event system being manageable through ActiveRecord is that integrated admin interfaces like &lt;a href=&#34;https://activeadmin.info&#34;&gt;ActiveAdmin&lt;/a&gt; and &lt;a href=&#34;https://github.com/thoughtbot/administrate&#34;&gt;Administrate&lt;/a&gt; (which we might already have integrated in our existing applications) work out of the box and we get a complete schedule management interface with minimal extraneous boilerblate.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#getting-started-with-our-app&#34;&gt;&lt;h2 id=&#34;getting-started-with-our-app&#34;&gt;Getting started with our app&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The rest of the tutorial walks through the creation of a Postgres backed Rails 5 application that illustrates the concepts outlined above.&lt;/p&gt;

&lt;p&gt;We start off with familiar rails application generation steps:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;gem install rails --pre --no-rdoc --no-ri

&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails -v
Rails 5.0.0.beta3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that while skipping rdoc and ri is purely a matter of convenience (I did not need them at the time) - the &lt;code&gt;--pre&lt;/code&gt; flag is required, as of this writing, for installing Rails 5 as it is still in beta.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails new rails5-clockwork-demo --database&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;postgresql

      create
      create  README.md
      create  Rakefile
      create  config.ru
      create  .gitignore
      create  Gemfile
      create  app
      create  app/assets/config/manifest.js
      create  app/assets/javascripts/application.js
      create  app/assets/javascripts/cable.coffee
      create  app/assets/stylesheets/application.css
      create  app/channels/application_cable/channel.rb
      create  app/channels/application_cable/connection.rb
      create  app/controllers/application_controller.rb
      create  app/helpers/application_helper.rb
      create  app/jobs/application_job.rb
      create  app/mailers/application_mailer.rb
      create  app/models/application_record.rb
      create  app/views/layouts/application.html.erb
      create  app/views/layouts/mailer.html.erb
      create  app/views/layouts/mailer.text.erb
      create  app/assets/images/.keep
      create  app/assets/javascripts/channels
      create  app/assets/javascripts/channels/.keep
      create  app/controllers/concerns/.keep
      create  app/models/concerns/.keep
      create  bin
      create  bin/bundle
      create  bin/rails
      create  bin/rake
      create  bin/setup
      create  bin/update
      create  config
      create  config/routes.rb
      create  config/application.rb
      create  config/environment.rb
      create  config/secrets.yml
      create  config/cable.yml
      create  config/puma.rb
      create  config/environments
      create  config/environments/development.rb
      create  config/environments/production.rb
      create  config/environments/test.rb
      create  config/initializers
      create  config/initializers/active_record_belongs_to_required_by_default.rb
      create  config/initializers/application_controller_renderer.rb
      create  config/initializers/assets.rb
      create  config/initializers/backtrace_silencers.rb
      create  config/initializers/callback_terminator.rb
      create  config/initializers/cookies_serializer.rb
      create  config/initializers/cors.rb
      create  config/initializers/filter_parameter_logging.rb
      create  config/initializers/inflections.rb
      create  config/initializers/mime_types.rb
      create  config/initializers/per_form_csrf_tokens.rb
      create  config/initializers/request_forgery_protection.rb
      create  config/initializers/session_store.rb
      create  config/initializers/wrap_parameters.rb
      create  config/locales
      create  config/locales/en.yml
      create  config/boot.rb
      create  config/database.yml
      create  db
      create  db/seeds.rb
      create  lib
      create  lib/tasks
      create  lib/tasks/.keep
      create  lib/assets
      create  lib/assets/.keep
      create  log
      create  log/.keep
      create  public
      create  public/404.html
      create  public/422.html
      create  public/500.html
      create  public/apple-touch-icon-precomposed.png
      create  public/apple-touch-icon.png
      create  public/favicon.ico
      create  public/robots.txt
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures/files
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures/files/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/controllers
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/controllers/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/mailers
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/mailers/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/models
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/models/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/helpers
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/helpers/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/integration
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/integration/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/test_helper.rb
      create  tmp
      create  tmp/.keep
      create  tmp/cache
      create  tmp/cache/assets
      create  vendor/assets/javascripts
      create  vendor/assets/javascripts/.keep
      create  vendor/assets/stylesheets
      create  vendor/assets/stylesheets/.keep
      remove  config/initializers/cors.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note the line &lt;code&gt;create  app/jobs/application_job.rb&lt;/code&gt; above. Rails 5 comes pre-integrated with ActiveJob.&lt;/p&gt;

&lt;p&gt;Next we add clockwork and sidekiq to our Gemfile.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;gem &#39;clockwork&#39;
gem &#39;sidekiq&#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It may be tempting to just leave the in-memory adapter of ActiveJob in place but it should not be used in any production application. &lt;a href=&#34;http://edgeguides.rubyonrails.org/active_job_basics.html&#34;&gt;Rails guides&lt;/a&gt; explain it well enough:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Rails itself only provides an in-process queuing system, which only keeps the jobs in RAM. If the process crashes or the machine is reset, then all outstanding jobs are lost with the default async back-end. This may be fine for smaller apps or non-critical jobs, but most production apps will need to pick a persistent backend.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#implementing-the-event-model&#34;&gt;&lt;h2 id=&#34;implementing-the-event-model&#34;&gt;Implementing the Event model&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Next we need to define our models for persisting our schedules.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g model event name:string frequency:integer at:string job_name:string job_arguments:jsonb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here the first three columns correspond to accessors mandated by Clockwork. Name is primary for descriptive logging purposes (more on this below). &lt;code&gt;frequency&lt;/code&gt; specifies the recurrance frequency in seconds. &lt;code&gt;at&lt;/code&gt; signifies point of occurance within the recurrance span. Following are the valid formats:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;HH:MM
 H:MM
**:MM
HH:**
(Mon|mon|Monday|monday) HH:MM
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The last two columns &lt;code&gt;job_name&lt;/code&gt; and &lt;code&gt;job_arguments&lt;/code&gt; identify the job to be triggered. As would become obvious below, we did not need to provide the job name through the database - it could be inferred at the runtime through any custom logic expressed in ruby. But having it in database leads to a straightforward and transparent implementation and management.&lt;/p&gt;

&lt;p&gt;It may be tempting to just reuse the &lt;code&gt;name&lt;/code&gt; field as the job_name as well, but it may obscure debugging when same job is being invoked as part of multiple events for different use cases. It is recommended to keep the &lt;code&gt;name&lt;/code&gt; as something representative of the use case - eg. &lt;code&gt;enterprise_plan_customers_sales_aggregation_trigger&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Our model would look something like below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;class Event &amp;lt; ApplicationRecord
  validates :name, :frequency, :job_name, presence: true
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#clock-rb-file-&#34;&gt;&lt;h2 id=&#34;clock-rb-file-&#34;&gt;
&lt;code&gt;clock.rb&lt;/code&gt; file:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The entry point of clockwork is the file &lt;code&gt;clock.rb&lt;/code&gt;. This is the file that tells clockwork to
poll the events table and execute the inferred job.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;nb&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;clockwork&#39;&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;clockwork/database_events&#39;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;require_relative&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;./config/boot&#39;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;require_relative&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;./config/environment&#39;&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;Clockwork&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;# required to enable database syncing support&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;Clockwork&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;manager&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;DatabaseEvents&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Manager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;sync_database_events&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;every&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;minute&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;job_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;constantize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;perform_later&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;job_arguments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#configuring-activejob-to-use-sidekiq&#34;&gt;&lt;h2 id=&#34;configuring-activejob-to-use-sidekiq&#34;&gt;Configuring ActiveJob to use sidekiq&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;We had added sidekiq as the persistence backend for ActiveJob but we have not configured ActiveJob to use it.&lt;/p&gt;

&lt;p&gt;That is one additional line of code in &lt;code&gt;config/application.rb&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;Rails5ClockworkDemo&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Application&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Application&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;# Configure ActiveJob to use sidekiq&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;active_job&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_adapter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:sidekiq&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#running-clockwork-&#34;&gt;&lt;h2 id=&#34;running-clockwork-&#34;&gt;Running clockwork:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Clockwork can be executed by running &lt;code&gt;clockwork clock.rb&lt;/code&gt; at project root. However we can not expect something exciting yet because we simply have no entries in the table:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;clockwork clock.rb
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:02:54.032058 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Starting clock for 1 events: [ sync_database_events_for_model_Event ]&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:02:54.032150 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;sync_database_events_for_model_Event&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#adding-administrative-interface-&#34;&gt;&lt;h2 id=&#34;adding-administrative-interface-&#34;&gt;Adding administrative interface:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;We would be using ActiveAdmin for our admin interface for managing events. As of this writing to use ActiveAdmin along with Rails 5 we need to use the master branch of ActiveAdmin.&lt;/p&gt;

&lt;p&gt;While we will not go into elaboration of the ActiveAdmin DSL, most of the ideas should be applicable to alternative admin builders as well.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Gemfile.rb&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;gem&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;activeadmin&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;github&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;activeadmin&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g active_admin:install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For now we skip authorization as well as authentication entirely - integrating ActiveAdmin with authentication systems is covered &lt;a href=&#34;https://github.com/activeadmin/activeadmin/blob/master/docs/0-installation.md&#34;&gt;here&lt;/a&gt; and usage in conjugation with authorization systems is covered &lt;a href=&#34;https://github.com/activeadmin/activeadmin/blob/master/docs/13-authorization-adapter.md&#34;&gt;here&lt;/a&gt; in the official docs.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g active_admin:install --skip-users
Running via Spring preloader in process 59785
      create  config/initializers/active_admin.rb
      create  app/admin
      create  app/admin/dashboard.rb
       route  ActiveAdmin.routes&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;self&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
    generate  active_admin:assets
Running via Spring preloader in process 59787
      create  app/assets/javascripts/active_admin.js.coffee
      create  app/assets/stylesheets/active_admin.scss
      create  db/migrate/20160331204250_create_active_admin_comments.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To present our Event model through ActiveAdmin we need to generate an ActiveAdmin Event resource.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g active_admin:resource Event
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command creates the following file for us:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# app/admin/event.rb&lt;/span&gt;

&lt;span class=&#34;no&#34;&gt;ActiveAdmin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;register&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Event&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;# See permitted parameters documentation:&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://github.com/activeadmin/activeadmin/blob/master/docs/2-resource-customization.md#setting-up-strong-parameters&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# permit_params :list, :of, :attributes, :on, :model&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# or&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# permit_params do&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#   permitted = [:permitted, :attributes]&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#   permitted &amp;lt;&amp;lt; :other if params[:action] == &#39;create&#39; &amp;amp;&amp;amp; current_user.admin?&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#   permitted&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# end&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once we configure permitted parameters as elaborated in the comments we have something like below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;ActiveAdmin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;register&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Event&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;permit_params&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:job_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:job_arguments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:frequency&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:at&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now after we can run our migrations and booted up our server:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Booting &lt;span class=&#34;nv&#34;&gt;Puma&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Rails 5.0.0.beta3 application starting in development on http://localhost:3000
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Run &lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;rails server -h&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;more startup &lt;span class=&#34;nv&#34;&gt;options&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Ctrl-C to shutdown server
Puma starting in single mode...
* Version 3.2.0 &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ruby 2.3.0-p0&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;, codename: Spring Is A Heliocentric Viewpoint
* Min threads: 5, max threads: 5
* Environment: development
* Listening on tcp://localhost:3000
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If this is the first time you are using Rails 5 the new default home page as well as puma as the default server can be a pleasant surprise.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/2016-03-31/rails5_home.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;Our admin panel available at &lt;code&gt;/admin&lt;/code&gt; provides us with the means to edit our events.&lt;/p&gt;

&lt;p&gt;However when we attempt to create an event we would be faced with an error because formtastic does not know out of the box how to handle jsonb field which we used for job arguments.&lt;/p&gt;

&lt;p&gt;While it is not difficult to &lt;a href=&#34;https://stackoverflow.com/questions/33720697/activeadmin-formtastic-custom-input-json&#34;&gt;create custom form inputs&lt;/a&gt; for formtastic and I have outlined an &lt;a href=&#34;https://lorefnon.me/2015/03/02/dealing-with-json-fields-in-active-admin.html&#34;&gt;alternative approach&lt;/a&gt; before, to keep the example simple let us simply use a textarea for the arguments field:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;  form do |f|
    f.inputs do
      f.input :name
      f.input :job_name
      f.input :frequency
      f.input :at
      f.input :job_arguments, as: :text
    end
    f.actions
  end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can create an event to trigger a dummy job:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/2016-03-31/dummy_job_form.png&#34;&gt;&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#defining-our-jobs-&#34;&gt;&lt;h2 id=&#34;defining-our-jobs-&#34;&gt;Defining our jobs:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Of course, for this job to be runnable, we need to define the job as well. We can use ActiveJob&#39;s generators for the same:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g job dummy
Running via Spring preloader in process 63269
      invoke  test_unit
      create    &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/jobs/dummy_job_test.rb
      create  app/jobs/dummy_job.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Our job implementation itself is fairly mundane but serves the purpose of illustration:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;DummyJob&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationJob&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;queue_as&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;perform&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Dummy Job Executed&#34;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now once our clockwork process synchronizes with the databases, it will pickup the dummy job and keep executing every one second:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:54.003679 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;sync_database_events_for_model_Event&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:54.005132 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:55.005873 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:56.001670 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:57.001761 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the rails development log we can see that ActiveRecord is queuing this job:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 64813900-c70f-4b40-9dd7-452c4cac6b73&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 0d0a66d1-a46b-4427-92db-83a301b38c1c&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 1de45b36-7cc9-4a9a-9bb7-363591f64dd5&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 483fe8a2-5acf-4830-80fb-6c6883f0f7c2&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now if we run sidekiq, our background processor - we should see the enqued job getting executed in the &lt;code&gt;log/sidekiq.log&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;2016-03-31T21:01:00.064Z 64128 TID-ox54l2v7s DummyJob JID-fc59a048d2d1fe2aeecc3452 INFO: start
Dummy Job Executed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This concludes our introductory post on database driven scheduling with clockwork. Please share any issues you might have faced or any suggestions for improvement in the comments.&lt;/p&gt;

&lt;p&gt;The source code for this post is available in this &lt;a href=&#34;https://github.com/lorefnon/rails5-clockwork-demo&#34;&gt;github repo&lt;/a&gt;.&lt;/p&gt;

</content>
        <category term="Ruby" />
        <category term="Rails" />
        <updated>2016-03-31T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2016/01/16/protip--annotate-activeadmin-resources-along-with-models.html</id>
        <title>Tip: Annotate ActiveAdmin resources along with models</title>
        <link rel="alternate" href="https://lorefnon.me/2016/01/16/protip--annotate-activeadmin-resources-along-with-models.html"/>
        <content type="html">


          

&lt;p&gt;&lt;a href=&#34;https://github.com/ctran/annotate_models&#34;&gt;Annotate&lt;/a&gt; is a very useful utility for annotating schema information in Rails models. The gem prepends (or appends, as per your &lt;a href=&#34;https://github.com/ctran/annotate_models#options&#34;&gt;configuration&lt;/a&gt;) a summarized information about the table schema in each model file as comments) - saving multiple roundtrips to the &lt;code&gt;schema.rb&lt;/code&gt; file during coding.&lt;/p&gt;

&lt;p&gt;For Example:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# == Schema Information&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# Table name: roles&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  id            :integer          not null, primary key&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  name          :string&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  resource_id   :integer&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  resource_type :string&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  created_at    :datetime&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  updated_at    :datetime&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# Indexes&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  index_roles_on_name                                    (name)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#  index_roles_on_name_and_resource_type_and_resource_id  (name,resource_type,resource_id)&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However while working with admin interfaces powered by &lt;a href=&#34;http://activeadmin.info&#34;&gt;ActiveAdmin&lt;/a&gt; I have often found it convenient to have the model schema annotations available right in the &lt;a href=&#34;http://activeadmin.info/docs/2-resource-customization.html&#34;&gt;ActiveAdmin resource files&lt;/a&gt;. There is a very simple way to achieve that:&lt;/p&gt;

&lt;p&gt;The rake task &lt;a href=&#34;https://github.com/ctran/annotate_models#configuration-in-rails&#34;&gt;generated&lt;/a&gt; by Annotate (&lt;code&gt;lib/tasks/auto_annotate_models.rake&lt;/code&gt;) has option to specify the model directory. This is primarily intended for projects with non standard directory configuration. As it so happens we can specify multiple directories separated by commas.&lt;/p&gt;

&lt;p&gt;So taking advantage of the fact that our ActiveAdmin resource files are conventionally named same as the models, we can just add the admin directory to the list of model directories:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;development?&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;task&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:set_annotation_options&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;# You can override any of these by setting an environment variable of the&lt;/span&gt;
    &lt;span class=&#34;c1&#34;&gt;# same name.&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;Annotate&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;set_defaults&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
      &lt;span class=&#34;s1&#34;&gt;&#39;model_dir&#39;&lt;/span&gt;               &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;app/models,app/admin&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# ... other configuration options&lt;/span&gt;
    &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next time annotate is run, either manually invoked or through migration hooks, our ActiveAdmin resource files with annotated along with our model files.&lt;/p&gt;

&lt;p&gt;If you are not using the generated rake file, this approach of course works with the &lt;code&gt;--model-dir&lt;/code&gt; command line option as well.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <updated>2016-01-16T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2016/01/16/useful-delegation-patterns-for-rails.html</id>
        <title>Useful delegation patterns for Rails</title>
        <link rel="alternate" href="https://lorefnon.me/2016/01/16/useful-delegation-patterns-for-rails.html"/>
        <content type="html">
&lt;a class=&#34;header-link&#34; href=&#34;#about-delegation&#34;&gt;&lt;h2 id=&#34;about-delegation&#34;&gt;About delegation&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Delegation is a very useful software pattern and this post focusses on how this pattern can be applied in the context of a Rails application and the associated advantages of doing so.&lt;/p&gt;

&lt;p&gt;If you are unfamiliar with this pattern, &lt;a href=&#34;https://en.wikipedia.org/wiki/Delegation_pattern&#34;&gt;Wikipedia&lt;/a&gt; has a very good explanation: &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;In software engineering, the delegation pattern is a design pattern in object-oriented programming where an object, instead of performing one of its stated tasks, delegates that task to an associated helper object.&lt;/p&gt;

&lt;p&gt;There is an Inversion of Responsibility in which a helper object, known as a delegate, is given the responsibility to execute a task for the delegator.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Also, this &lt;a href=&#34;https://stackoverflow.com/questions/7168714/what-is-the-purpose-of-a-delegation-pattern&#34;&gt;Stackoverflow post&lt;/a&gt; has some interesting posts elaborating on the practical benefits of the concepts of delegation in a language neutral context.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#implementing-delegators-in-ruby&#34;&gt;&lt;h2 id=&#34;implementing-delegators-in-ruby&#34;&gt;Implementing Delegators in Ruby&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Ruby&#39;s metaprogramming facilities enable us to implement delegation in a much easier and consise manner than many other object oriented languages.&lt;/p&gt;

&lt;p&gt;Using dynamic interception of method calls, it is very straightforward to forward method invocations to a target object. This is very well illustrated by the &lt;a href=&#34;https://github.com/ruby/ruby/blob/trunk/lib/delegate.rb#L75-L89&#34;&gt;implementation&lt;/a&gt; of &lt;a href=&#34;https://github.com/sj26/ruby-1.9.3-p0/blob/master/lib/delegate.rb&#34;&gt;Delegate class&lt;/a&gt; provided by Ruby standard library:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Delegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;BasicObject&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;#...&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# Handles the magic of delegation through \_\_getobj\_\_.&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;method_missing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__getobj__&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;respond_to?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__send__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Kernel&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;respond_to?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Kernel&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance_method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#wrapping-objects-with-simpledelegator&#34;&gt;&lt;h2 id=&#34;wrapping-objects-with-simpledelegator&#34;&gt;Wrapping objects with SimpleDelegator&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;In practice we usually deal with &lt;a href=&#34;https://ruby-doc.org/stdlib-2.1.0/libdoc/delegate/rdoc/SimpleDelegator.html&#34;&gt;&lt;code&gt;SimpleDelegator&lt;/code&gt;&lt;/a&gt; subclass of &lt;code&gt;Delegator&lt;/code&gt; more often. The constructor takes a single object and any method invocations are delegated to the target instance. &lt;/p&gt;

&lt;p&gt;We can simply subclass from &lt;code&gt;SimpleDelegator&lt;/code&gt; and implement our customizations therein, and delegate to the parent object through a &lt;code&gt;super&lt;/code&gt; call conveniently.&lt;/p&gt;

&lt;p&gt;Example from docs:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;born_on&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;Date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1989&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserDecorator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;birth_year&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;born_on&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;year&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;UserDecorator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#using-delegation-for-presenter-logic&#34;&gt;&lt;h3 id=&#34;using-delegation-for-presenter-logic&#34;&gt;Using delegation for Presenter logic&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is arguably the most common use case for delegators. Often we end up adding a lot of methods in our models that have nothing to do with domain logic whatsoever. Does something like this look familiar?&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;# ...&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;formatted_date_of_birth&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;date_of_birth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strftime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Born on %m/%d/%Y&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Such methods which are primarily written for handling presentation concerns come into the perview of Presenter logic and are best left out of models. Instead we can decorate our model instances using presenter classes before passing them to views:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserDecorator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

 &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;formatted_date_of_birth&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;date_of_birth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strftime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Born on %m/%d/%Y&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
 &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UsersController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;show&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;find&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;UserDecorator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I find this to be more elegant from an object oriented perspective compared to the conventional approach using Rails helper modules.&lt;/p&gt;

&lt;p&gt;There are many &lt;a href=&#34;https://www.ruby-toolbox.com/categories/rails_presenters&#34;&gt;libraries&lt;/a&gt; for implementing additional convenience utilities around presenters. While the above simple approach takes us quite far, if you find yourself repeating the decorator instantiation boilerplate, generators and conventions offered by a library like &lt;a href=&#34;https://github.com/drapergem/draper&#34;&gt;Draper&lt;/a&gt; can be helpful.&lt;/p&gt;

&lt;p&gt;Note that one of the biggest strengths of decorators is on demand composability. For instance we may have various user centric helper methods for reporting. We can extract them into a &lt;code&gt;UserReportPresenter&lt;/code&gt; decorator that is used only in the &lt;code&gt;UserReportsController&lt;/code&gt;. Accordingly we can have multiple use-case specific delegators layered one upon another, each delegating to its immediate target transparently.&lt;/p&gt;

&lt;p&gt;We may want to have some approach to restrict what can be decorated by a decorator. We may be tempted to define something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserReportPresenter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDecorator&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;initialize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ArgumentError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Expected entity being decorated to be User&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However this is not something we would want to do as it breaks composability. One approach would be to &#34;unwrap&#34; the decorated before instance check:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Decorator&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__getobj__&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ArgumentError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Expected entity being decorated to be User&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;but I strongly recommend not resorting to &lt;code&gt;is_a?&lt;/code&gt; checks at all and relying instead on behavior checks using &lt;code&gt;responds_to?&lt;/code&gt;.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#delegation-for-memoization-caching&#34;&gt;&lt;h3 id=&#34;delegation-for-memoization-caching&#34;&gt;Delegation for memoization/caching&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is another good use case for delegation. We can wrap our models into Delegators that transparently cache or memoize method invocations:&lt;/p&gt;

&lt;p&gt;Example using &lt;code&gt;Rails.cache&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserReportCachedDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;annual_performance_stats&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cache&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fetch&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;user.&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;#&amp;#123;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;.annual_performance_stats&#34;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However one thing that we should keep in mind that SimpleDelegator allows the decorated target to be run time configurable. While this is not a problem in the above implementation as we use an entity specific key, this may become a problem if, for example, we were using transparent memoization through &lt;a href=&#34;https://github.com/matthewrudy/memoist&#34;&gt;Memoist&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserReportMemoizedDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;extend&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Memoist&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;annual_performance_stats&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;memoize&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:annual_performance_stats&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above implementation is broken because even if we were to change the decorated instance using &lt;code&gt;__setobj__&lt;/code&gt; our memoized method would continue returning the output of invocation of the method on previously decorated instance.&lt;/p&gt;

&lt;p&gt;A simple solution for the above is to flush the cache when the decorated entity changes:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;MemoizedDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;extend&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Memoist&lt;/span&gt;

   &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;__setobj__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
     &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;
     &lt;span class=&#34;n&#34;&gt;flush_cache&lt;/span&gt;
   &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#using-delegation-for-collection-objects&#34;&gt;&lt;h3 id=&#34;using-delegation-for-collection-objects&#34;&gt;Using delegation for collection objects&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is something I recently found to be useful. Sometimes when we need to define operations that make sense for a set of instances, we just resort to class methods in model. However a better object oriented design would be to implement such behaviors on a dedicated collection resource.&lt;/p&gt;

&lt;p&gt;Decorating &lt;code&gt;ActiveRecord::CollectionProxy&lt;/code&gt; is helpful because we get facilities like scope chaining, lazy-loading etc. for free.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;EmployeesReportDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;month_wise_performance_stats&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;joins&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:assessments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;MONTH(assessments.created_at)&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;assessments.evaluation_rank as rank&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#using-delegation-to-augment-lifecycle-hooks&#34;&gt;&lt;h3 id=&#34;using-delegation-to-augment-lifecycle-hooks&#34;&gt;Using delegation to augment lifecycle hooks&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is occassionaly useful especially when dealing with third party SDKs. We can leverage &lt;code&gt;ActiveSupport::Callbacks&lt;/code&gt; to wrap custom callback hooks around specific behaviors of decorated objects:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;MailDispatchDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Callbacks&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;define_callbacks&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:dispatch&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;dispatch&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;run_callbacks&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:dispatch&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;      
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;MailFilterDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;MailDispatchDelegator&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;set_callback&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:dispatch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:before&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;object&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;validated_domains&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;include?&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;object&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;domain&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ValidationError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Domain not whitelisted&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#in-rails-any-module-can-delegate&#34;&gt;&lt;h2 id=&#34;in-rails-any-module-can-delegate&#34;&gt;In Rails, any module can delegate&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;While creating a dedicated Delegator makes sense in a variety of use cases, often we want to just delegate just a few methods to a contained object. ActiveSupport Module extensions provide a convenient approach to delegate specific methods to any contained object. This comes in very handy in controllers:&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#delegating-helpers-to-model-instances-&#34;&gt;&lt;h3 id=&#34;delegating-helpers-to-model-instances-&#34;&gt;Delegating helpers to model instances:&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;For example in a rails controller, we might want to expose a few model methods:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ProductsController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:ensure_logged_in!&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:available_products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_user&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;index&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@available_products&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;available_products&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can also simply expose the delegated methods as a helper_method to our views:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ProductsController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:ensure_logged_in!&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:available_products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_user&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;helper_method&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:available_products&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I have found this to be a common use case, and a class method that wraps the two can help in DRYing things up:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;delegate_helper&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;
  &lt;span class=&#34;kp&#34;&gt;loop&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;method_name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shift&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;break&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Symbol&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;helper_method&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method_name&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above method allows us to take advantage of full api of &lt;code&gt;Module#delegate&lt;/code&gt; which allows delegation of multiple methods to single target and configuration of generated method.&lt;/p&gt;

&lt;p&gt;So for example, we can do the following:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;SomeController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:ensure_logged_in!&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate_helper&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:designations&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; 
                  &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; 
                  &lt;span class=&#34;ss&#34;&gt;prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now delegated methods would be available as &lt;code&gt;current_user_designations&lt;/code&gt; and &lt;code&gt;current_user_products&lt;/code&gt; in our views.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Module#delegate&lt;/code&gt; works very well with instance variables and class variables as well. Here is an example from the &lt;a href=&#34;http://api.rubyonrails.org/classes/Module.html#method-i-delegate&#34;&gt;official documentation&lt;/a&gt; :&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Foo&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;CONSTANT_ARRAY&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
  &lt;span class=&#34;vc&#34;&gt;@@class_array&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;initialize&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@instance_array&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:CONSTANT_ARRAY&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:min&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:@@class_array&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:max&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:@instance_array&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;no&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# =&amp;gt; 6&lt;/span&gt;
&lt;span class=&#34;no&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;min&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# =&amp;gt; 4&lt;/span&gt;
&lt;span class=&#34;no&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# =&amp;gt; 11&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#chaining-delegators&#34;&gt;&lt;h3 id=&#34;chaining-delegators&#34;&gt;Chaining delegators&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;As you may have inferred at this point, we can easily chain delegated invocations:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;class ProductsController &amp;lt; ApplicationController

  before_action :ensure_logged_in!
  delegate :manager, to: :current_user
  delegate :designation, to: :manager, prefix: :manager

end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#delegation-as-an-alternative-to-concerns&#34;&gt;&lt;h2 id=&#34;delegation-as-an-alternative-to-concerns&#34;&gt;Delegation as an alternative to Concerns&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Since the official endorsement of concerns from Rails 4 concerns have soared in popularity, however I have often observend that concerns are overused, especially for use cases that are better handled by other patterns.&lt;/p&gt;

&lt;p&gt;Since this post is about delegation, let us look at a few things that delegation has to offer over concerns:&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#run-time-configurability-&#34;&gt;&lt;h3 id=&#34;run-time-configurability-&#34;&gt;Run time configurability:&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;While it is true that concerns can be injected at run time, however code that runs in the included hooks potentially modifies the host instance making run time switching of concerns not very practical in most cases. Delegation offers a clearer approach and we have already demonstrated that switching delegated instances in delegator instances is quite useful.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#on-demand-specialization-&#34;&gt;&lt;h3 id=&#34;on-demand-specialization-&#34;&gt;On demand specialization:&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is particularly useful for objects that did not originate in our code. Rather than polluting the library generated objects with application specific behavior, which may cause subtle unintended side-effects, it is much more elegant to pass around decorated instances in application code and pass the unwrapped instances back to the library should there be a need to do so.&lt;/p&gt;

&lt;p&gt;All in all concnerns are more suitable for application specific classes where core functionality is shared among multiple classes, and delegation is more useful for implementing auxiliary use case specific behaviors or transparently augmenting existing behavior. &lt;/p&gt;

&lt;p&gt;A good example of former use case would be a cross-cutting functionality like using a &lt;code&gt;completed_at&lt;/code&gt; column for scoping on completion status or checking if a model (eg. Payment, Project etc.) has been completed  :&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;CompletionSupport&lt;/span&gt;
  &lt;span class=&#34;kp&#34;&gt;extend&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Concern&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;included&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;

    &lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;complete&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;completed&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;scope&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;where&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;completed_at is not null&#39;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;scope&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:incomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;where&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;completed_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;complete!&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;completed_at&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;DateTime&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;now&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;complete?&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;completed_at&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;present?&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;alias_method&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:completed?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:complete?&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;incomplete?&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;complete?&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;alias_method&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:not_completed?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:incomplete?&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#delegation-in-command-line-applications&#34;&gt;&lt;h2 id=&#34;delegation-in-command-line-applications&#34;&gt;Delegation in command line applications&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Last but not the least, delegation makes sense in command line applications as well. An excellent example would be github&#39;s &lt;a href=&#34;https://github.com/github/hub&#34;&gt;hub&lt;/a&gt; command line utility that makes a lot of github &lt;a href=&#34;https://github.com/github/hub#commands&#34;&gt;features&lt;/a&gt; like &lt;code&gt;pull-requests&lt;/code&gt; accessible from the command line, while delegating everything else to git.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#some-alternatives&#34;&gt;&lt;h2 id=&#34;some-alternatives&#34;&gt;Some alternatives&lt;/h2&gt;&lt;/a&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#observers&#34;&gt;&lt;h3 id=&#34;observers&#34;&gt;Observers&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;While observer pattern can help towards decoupling and the advantags therein overlap with those offered by delegates in some cases, in general I refrain from using Observer pattern because it makes the flow of logic harder to trace - especially in larger applications.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#refinements&#34;&gt;&lt;h3 id=&#34;refinements&#34;&gt;Refinements&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;Refinements are a recent addition to the Ruby language where in we can selectively monkey-patch modules (and hence classes) with custom behavior. But a key aspect of refinements is lexical scoping. The offical docs explain this very well:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Refinements are lexical in scope. When control is transferred outside the scope the refinement is deactivated. This means that if you require or load a file or call a method that is defined outside the current scope the refinement will be deactivated:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;C&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;M&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;refine&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;C&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;foo&lt;/span&gt;
      &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;C#foo in M&#34;&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;call_foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;using&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;M&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;       &lt;span class=&#34;c1&#34;&gt;# prints &#34;C#foo in M&#34;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;call_foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;#=&amp;gt; raises NoMethodError&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;While this explicit aspect of Refinements is a commendable improvement over adhoc monkey-patching in many scenarios - the convenience offered by transparent overlaying of behavior that decorators offer us, is, in most practical cases, more appealing.&lt;/p&gt;

&lt;p&gt;The primary exception to the above would be cases where the code consuming the augmented instances rely on &lt;code&gt;instance_of?&lt;/code&gt; checks to determine the identity of passed instance. Using refinements we are not changing the class of the instance, where as while passing the wrapped instance we fail on the &lt;code&gt;instance_of?&lt;/code&gt; checks as the wrapped instances are actually instances of a different class though they implement interchangeable behavior.&lt;/p&gt;

&lt;p&gt;This concludes our post on delegation. As always any insights on pragmatic usage of this pattern is more than welcome. Please use the comments section to share any feedback or criticism.&lt;/p&gt;

</content>
        <category term="Ruby" />
        <category term="Rails" />
        <updated>2016-01-16T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2015/12/07/extending-the-ruby-case-statement-for-fun-and-profit.html</id>
        <title>Extending the ruby case statement for fun and profit</title>
        <link rel="alternate" href="https://lorefnon.me/2015/12/07/extending-the-ruby-case-statement-for-fun-and-profit.html"/>
        <content type="html">
&lt;p&gt;I have often found that, despite being one of the most powerful constructs of the language, ruby case statement is often undervalued in everyday code. &lt;/p&gt;

&lt;p&gt;This is especially true when the people involved are coming from C/Java background because the switch statements in those languages are very restrictive in comparision to ruby. While ruby&#39;s case statement still leaves quite a bit to be desired after a taste of pattern matching in languages like &lt;a href=&#34;http://elixir-lang.org/getting-started/pattern-matching.html&#34;&gt;elixir&lt;/a&gt; and &lt;a href=&#34;https://kerflyn.wordpress.com/2011/02/14/playing-with-scalas-pattern-matching/&#34;&gt;scala&lt;/a&gt;, nevertheless, with a little effort we can adapt ruby&#39;s case statement to handle variety of use cases very expressively.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#under-the-hood-of-case-statement&#34;&gt;&lt;h2 id=&#34;under-the-hood-of-case-statement&#34;&gt;Under the hood of case statement&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Behind the scenes, ruby uses the case equality method (===) for matching in case statements. So our primary appraoch for adding custom behavior to case statement would be through overriden behavior implemented in this method. &lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#proc-as-a-match-target&#34;&gt;&lt;h2 id=&#34;proc-as-a-match-target&#34;&gt;Proc as a match target&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;An especially convenient aspect of proc is that it&#39;s case equality method results in invocation of the proc itself - this comes in handy for quickly matching conditions:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;palindrome?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;word&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;word&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;proc&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;w&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reverse&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;w&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
    &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#more-expressive-code-with-custom-matchers&#34;&gt;&lt;h2 id=&#34;more-expressive-code-with-custom-matchers&#34;&gt;More expressive code with custom matchers&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Custom matchers can often help us make our code more expressive and closer to intent.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;DivisibilityMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:divisor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;%&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;DivisibilityMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;18&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;divisible by 5&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;divisible by 3&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;divisible by 2&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;by&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#matchers-for-membership-evaluation&#34;&gt;&lt;h2 id=&#34;matchers-for-membership-evaluation&#34;&gt;Matchers for membership evaluation&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;A simple use case might be to extend case to handle membership evaluation:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;MembershipEvaluationMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:collection&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;collection&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;include?&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;member_of&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;collection&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;MembershipEvaluationMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;collection&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;member_of&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;sx&#34;&gt;%w[a b c]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;case 1&#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;member_of&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;case 2&#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#matcher-composition&#34;&gt;&lt;h2 id=&#34;matcher-composition&#34;&gt;Matcher composition&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Advantage of having matcher objects dedicatedly handling only the responsibility of matching is that we can compose them in ways that make sense from the perspective of match making. &lt;/p&gt;

&lt;p&gt;Let us extend our divisibility check to illustrate the above. You may have noticed that our checks don&#39;t fall through the conditions -- so while divisibility with 3 is reported, divisibility with 2 is not. Let us check both using a matcher.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;CompositeDivisibilityMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:matchers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; 
    &lt;span class=&#34;n&#34;&gt;combine_results&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchers&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;m&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;===&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;combine_results&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt;
    &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;AllDivisibilityMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;CompositeDivisibilityMatcher&lt;/span&gt; 
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;combine_results&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reduce&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;AnyDivisibilityMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;CompositeDivisibilityMatcher&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;combine_results&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reduce&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:|&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;no&#34;&gt;DivisibilityMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:divisor&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;%&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisor&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matcher&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;AllDivisibilityMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matcher&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;AnyDivisibilityMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;DivisibilityMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;100&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;FizzBuzz&#39;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;Fizz&#39;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;divisible_by&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;Buzz&#39;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;num&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can also take advantage of &lt;a href=&#34;https://ruby-doc.org/core-1.9.3/Proc.html#method-i-curry&#34;&gt;proc currying&lt;/a&gt; reduce some verbosity here.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;n&#34;&gt;is_divisible&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;proc&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;b&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;a&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;%&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;b&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;is_divisible_by_all&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;proc&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;arr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_divisible&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curry&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reduce&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:&amp;amp;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;is_divisible_by_any&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;proc&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;arr&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;arr&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;map&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_divisible&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curry&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;reduce&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:|&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;18&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;is_divisible_by_all&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curry&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]]&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;div by 2 and 3&#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;is_divisible_by_any&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;curry&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]]&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;div by 2 or 3&#39;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;by&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt; &lt;span class=&#34;ow&#34;&gt;and&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#matching-against-incomplete-data-structures&#34;&gt;&lt;h2 id=&#34;matching-against-incomplete-data-structures&#34;&gt;Matching against incomplete data structures&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;We can extend this concept to match against analogous data structures that are incompletely specified. In the example below we match against a list where missing values are denoted by :_ . The case statement will ignore these missing items when matching.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;Matchers&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;ListMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:matchable_list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;length&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchable_list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;length&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each_with_index&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;item&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchable_list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;item&lt;/span&gt;
          &lt;span class=&#34;k&#34;&gt;next&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
          &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;       
      &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
      &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; 
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;matches&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;Matchers&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;ListMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 1&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 2&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 3&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 4&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;# Outputs: case 4&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#retrieving-the-missing-data-items&#34;&gt;&lt;h2 id=&#34;retrieving-the-missing-data-items&#34;&gt;Retrieving the missing data items&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;If we are matching against incomplete data structures perhaps it would be nice to extract the missing items as well. This requires a bit more boilerplate though.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;Matchers&lt;/span&gt;

  &lt;span class=&#34;no&#34;&gt;Matchable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:target&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;matches&lt;/span&gt;
      &lt;span class=&#34;vi&#34;&gt;@matches&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;||=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[]&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;no&#34;&gt;ListMatcher&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Struct&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:matchable_list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;===&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;length&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchable_list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;length&lt;/span&gt;

      &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[]&lt;/span&gt;

      &lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each_with_index&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;item&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchable_list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;idx&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt;
          &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;item&lt;/span&gt;
          &lt;span class=&#34;k&#34;&gt;next&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;item&lt;/span&gt;
          &lt;span class=&#34;k&#34;&gt;next&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
          &lt;span class=&#34;k&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;       
      &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

      &lt;span class=&#34;n&#34;&gt;list&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;match_results&lt;/span&gt;
      &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; 
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;matches&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;Matchers&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;ListMatcher&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;array&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;matchable&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Matchers&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Matchable&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;case&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchable&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 1&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 2&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 3&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;case 4&#34;&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;matchable&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;matches&lt;/span&gt;
 &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]]&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Running the matchable through the case statements multiple times will keep appending the match results to the matches.&lt;/p&gt;

&lt;p&gt;Thus we have explored a variety of use cases where the case construct can, perhaps unexpectedly, be applied to our advantage. &lt;/p&gt;

&lt;p&gt;This concludes on our exploration of extensibility of the ruby case equality and I hope that it helps you write more expressive and elegant code using matchers.&lt;/p&gt;

</content>
        <category term="Ruby" />
        <updated>2015-12-07T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2015/04/04/gathering-and-visualizing-rails-metrics-influxdb.html</id>
        <title>Gathering and Visualizing metrics from Rails application using InfluxDB</title>
        <link rel="alternate" href="https://lorefnon.me/2015/04/04/gathering-and-visualizing-rails-metrics-influxdb.html"/>
        <content type="html">&lt;h2 id=&#34;Overview&#34;&gt;&lt;a href=&#34;#Overview&#34; class=&#34;headerlink&#34; title=&#34;Overview&#34;&gt;&lt;/a&gt;Overview&lt;/h2&gt;&lt;p&gt;InfluxDB is a distributed time series database. It is a specialized data store for saving large volumes of timestamped event data and this makes it especially suited for storing metrics, lifecycle events and analytics. The &lt;code&gt;influxdb-rails&lt;/code&gt; gem, maintained by the InfluxDB team, facilitates integration with Rails and makes it easy to save various metrics from a rails application to InfluxDB and visualize it through frontends like &lt;a href=&#34;http://grafana.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Grafana&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The rest of this post, explores various aspects of a simple setup in which we build a rudimentary cms based site and monitor it using influxdb and grafana. We don&amp;#39;t assume prior familiarity with InfluxDB, and elaborate on relevant aspects of time series databases on the go, but familiarity with Rails is assumed.&lt;/p&gt;
&lt;p&gt;This post also assumes that InfluxDB is installed as per the official &lt;a href=&#34;http://influxdb.com/docs/v0.8/introduction/installation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;installation instructions&lt;/a&gt; with default configuration. If installation has been customized eg. ports have been changed, the configurations provided to &lt;code&gt;influxdb-rails&lt;/code&gt; will have to be adapted accordingly. On mac influxdb can be installed using &lt;a href=&#34;http://brew.sh/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Homebrew&lt;/a&gt; : &lt;code&gt;brew install influxdb&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;Setting-up-a-basic-application&#34;&gt;&lt;a href=&#34;#Setting-up-a-basic-application&#34; class=&#34;headerlink&#34; title=&#34;Setting up a basic application&#34;&gt;&lt;/a&gt;Setting up a basic application&lt;/h2&gt;&lt;p&gt;Next, we bootstrap a simple rails application using the &lt;a href=&#34;https://github.com/comfy/comfortable-mexican-sofa&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Comfortable mexican sofa&lt;/a&gt; CMS to quickly setup a site with a few pages we can tinker with. This is not really important, but it simply helps us work with a reasonably more realistic setup than a typically crud ui generated through scaffolds.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;rails new influxdb-cms-demo --database=mysql&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In Gemfile:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;comfortable_mexican_sofa&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;~&amp;gt; 1.12.0&amp;#x27;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;influxdb-rails&amp;#x27;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Setting up CMS requires an additional step:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;rails generate comfy:cms&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Setting up InfluxDB adapter also requires an additional step:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;rails g influxdb&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The default configuration options are available in the generated &lt;code&gt;influxdb-rails.rb&lt;/code&gt; and they correspond to the default settings of influxdb.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;InfluxDB::Rails.configure &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;config&lt;/span&gt;|
  config.influxdb_database = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;rails&amp;quot;&lt;/span&gt;
  config.influxdb_username = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;
  config.influxdb_password = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;
  config.influxdb_hosts    = [&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;]
  config.influxdb_port     = &lt;span class=&#34;hljs-number&#34;&gt;8086&lt;/span&gt;

  &lt;span class=&#34;hljs-comment&#34;&gt;# config.series_name_for_controller_runtimes = &amp;quot;rails.controller&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# config.series_name_for_view_runtimes       = &amp;quot;rails.view&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# config.series_name_for_db_runtimes         = &amp;quot;rails.db&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The last three lines signify the names of time series where the corresponding metrics would be stored, and we will use the same when querying the time series database.&lt;/p&gt;
&lt;p&gt;Before our application can start dispatching metrics to InfluxDB the database &amp;quot;rails&amp;quot; specified in the above configuration file would have to be created. InfluxDB admin provides a means to do that using the GUI. The admin interface may be accessed by visiting: &lt;a href=&#34;http://localhost:8083/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;localhost:8083&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_landing_page.png&#34; alt=&#34;InfluxDB landing page&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The default username&amp;#x2F;password combination is root&amp;#x2F;root, which is not advisable for production use.&lt;/p&gt;
&lt;p&gt;The only option that is particularly relevant is database name: which we would have to change to &amp;quot;rails&amp;quot;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_create_database.png&#34; alt=&#34;InfluxDB creating database&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;This would be a good point to run &lt;code&gt;db:migrate&lt;/code&gt; and visit the CMS dashboard &lt;code&gt;/admin&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Once a new site has been bootstrapped, we can rapidly create multiple pages through the CMS admin interface. These steps are not elaborated here because the guided CMS admin makes it pretty trivial. Once a few pages have been setup, we have some metrics to explore in InfluxDB.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/new_page_cms.png&#34; alt=&#34;Add a new page in CMS&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;Data-exploration&#34;&gt;&lt;a href=&#34;#Data-exploration&#34; class=&#34;headerlink&#34; title=&#34;Data exploration&#34;&gt;&lt;/a&gt;Data exploration&lt;/h2&gt;&lt;p&gt;In the list of databases, we should have an option to &lt;code&gt;Explore Data&lt;/code&gt;. Let us go ahead and click that:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_database_list.png&#34; alt=&#34;InfluxDB database list&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;We will be presented with a simple interface to read and write points (which are essentially multi-column timestamped datasets).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_query_interface.png&#34; alt=&#34;InfluxDB Query interface&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;This page also highlights an interesting aspect of InfluxDB - though it is not a relational database, it does provide an SQL like language to query the database.&lt;/p&gt;
&lt;p&gt;A basic query might look something like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_select_all_query.png&#34; alt=&#34;InfluxDB Select All Query&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Besides controllers, we can also run similar queries for our timeseries for views and db:
&lt;img src=&#34;/images/influxdb_select_all_from_view.png&#34; alt=&#34;InfluxDB Select All from View Query&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/influxdb_select_all_from_db.png&#34; alt=&#34;InfluxDB Select All from DB Query&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;Configuring-additional-lifecycle-events&#34;&gt;&lt;a href=&#34;#Configuring-additional-lifecycle-events&#34; class=&#34;headerlink&#34; title=&#34;Configuring additional lifecycle events&#34;&gt;&lt;/a&gt;Configuring additional lifecycle events&lt;/h2&gt;&lt;p&gt;In a real applications we would want to aggregate additional metrics of our choosing. A popular solution for dispatching and subscribing to various lifecycle events that ruby community has developed is &lt;code&gt;ActiveSupport::Notifications&lt;/code&gt; which Rails internally uses.&lt;/p&gt;
&lt;p&gt;Using &lt;code&gt;ActiveSupport::Notifications&lt;/code&gt; we can subscribe to lifecycle events of a rails application and add callbacks to dispatch these metrics to InfluxDB.&lt;/p&gt;
&lt;p&gt;For example if we would like to track the execution times of queries in InfluxDB we can write an initializer:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveSupport::Notifications.subscribe(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;sql.active_record&amp;#x27;&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;name, start, finish, id, payload&lt;/span&gt;|
  InfluxDB::Rails.client.write_point(name, &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;value:&lt;/span&gt; (finish-start), &lt;span class=&#34;hljs-symbol&#34;&gt;start:&lt;/span&gt; start, &lt;span class=&#34;hljs-symbol&#34;&gt;finish:&lt;/span&gt; finish &amp;#125;)
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The value attribute is something that InfluxDB admin will use to generate graph by default. We can query this just like the previous queries:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_lifecycle_event_query.png&#34; alt=&#34;InfluxDB Query lifecycle event&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;More lifecycle events of Rails application can be found in the &lt;a href=&#34;http://edgeguides.rubyonrails.org/active_support_instrumentation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Rails guides&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In addition, the instrumentation API can be used directly to create a custom lifecycle events. Here is an example taken from the &lt;a href=&#34;http://api.rubyonrails.org/classes/ActiveSupport/Notifications.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;official documentation&lt;/a&gt; that outlines how a part of application code can be wrapped into an instrumented block which we could subscribe to in an identical fashion.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveSupport::Notifications.instrument(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;render&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;extra:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:information&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
  render &lt;span class=&#34;hljs-symbol&#34;&gt;text:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Foo&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While the InfluxDB admin interface provides a convenient dashboard to visualize the metrics, it is not ideal for complex, comparative or realtime visualizations. For such use cases it is better to resort to dedicated solutions like Grafana.&lt;/p&gt;
&lt;h2 id=&#34;Setting-up-Grafana&#34;&gt;&lt;a href=&#34;#Setting-up-Grafana&#34; class=&#34;headerlink&#34; title=&#34;Setting up Grafana&#34;&gt;&lt;/a&gt;Setting up Grafana&lt;/h2&gt;&lt;p&gt;While Grafana releases binary downloads for most major versions of linux, there isn&amp;#39;t one available for Mac. And neither is it available from Homebrew. However installation from the sources is straightforward if you have Go. It is important that the version of Go is correct (1.4 +) otherwise installation fails with totally incomprehensible errors. The version of Go available from Homebrew is outdated - however Google provides &lt;a href=&#34;https://golang.org/doc/install&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;installers&lt;/a&gt; which work like a charm. Once Go is setup properly, the &lt;a href=&#34;https://github.com/grafana/grafana#building-the-backend&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;installation steps&lt;/a&gt; for Grafana are straightforward.&lt;/p&gt;
&lt;p&gt;Another hiccup is that when running the web interface, Grafana uses the same default port as Rails (3000). To alleviate that we need to edit configuration file dev.ini in &lt;code&gt;$GOPATH/src/github.com/grafana/grafana/conf&lt;/code&gt; and specify an alternate port&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ini&#34;&gt;&lt;span class=&#34;hljs-attr&#34;&gt;app_mode&lt;/span&gt; = development

&lt;span class=&#34;hljs-section&#34;&gt;[server]&lt;/span&gt;
&lt;span class=&#34;hljs-attr&#34;&gt;router_logging&lt;/span&gt; = &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;
&lt;span class=&#34;hljs-attr&#34;&gt;http_port&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;8000&lt;/span&gt;

&lt;span class=&#34;hljs-section&#34;&gt;[log]&lt;/span&gt;
&lt;span class=&#34;hljs-attr&#34;&gt;level&lt;/span&gt; = Trace&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once this is configured running &lt;code&gt;./grafana web&lt;/code&gt; from grafana source directory, should run the webserver on port 8000:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_startup_log.png&#34; alt=&#34;Grafana server log&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now we can browse the Grafana dashboard and provide the default login details admin&amp;#x2F;admin. Again it is not advisable to use this in production.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_login.png&#34; alt=&#34;Grafana Login&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The default dashboard is pretty bare:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_home.png&#34; alt=&#34;Grafana Home page&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Adding a new dashboard is straightforward:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_add_dashboard.png&#34; alt=&#34;Grafana : Adding a dashboard&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Once we have a dedicated dashboard for our Rails application we can start adding graphs:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_add_graph.png&#34; alt=&#34;Grafana : Add Graph&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;It would be probably surprising to see a great looking graph instantly generated. After all no influxdb&amp;#x2F;rails specific configuration has been done yet, so what data is being presented ?&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_test_graph.png&#34; alt=&#34;Grafana : Default Graph&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Once we try to edit the data source, it would become clear that the graph being presented is infact coming from a dummy data source&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_edit_graph.png&#34; alt=&#34;Grafana : Edit Graph&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/grafana_configure_graph_data_source.png&#34; alt=&#34;Grafana : Configure Graph Data Source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;At this point, because InfluxDB data source hasn&amp;#39;t been configured hence no other data source is available :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_singular_data_source.png&#34; alt=&#34;Grafana : Missing Data Source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The sidebar has a section for data sources that can be used for this task:
&lt;img src=&#34;/images/grafana_sidebar_close_up.png&#34; alt=&#34;Grafana : Sidebar&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/grafana_add_data_source.png&#34; alt=&#34;Grafana : Add data source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;While adding a data source it is of particular importance the version of InfluxDB is correct in the type field. Rest of the fields in form are self explanatory - It is advisable that in production Auth is configured to protect against intrusion.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_edit_data_source.png&#34; alt=&#34;Grafana : Edit data source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now in the graph editor multiple data sources should be available:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_multiple_data_source_selector.png&#34; alt=&#34;Grafana : Multiple data sources&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can now specify the InfluxDB query to be made in the &lt;code&gt;Metrics&lt;/code&gt; section:
&lt;img src=&#34;/images/grafana_metric_specification.png&#34; alt=&#34;Grafana : Specify Metric&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Since we don&amp;#39;t have a lot of historical data at this point, for inspection we can adjust the time range to something recent:
&lt;img src=&#34;/images/grafana_range_selection.png&#34; alt=&#34;Grafana : Range Selection&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The dummy graph should now be replaced with a real visualization of our metric
&lt;img src=&#34;/images/grafana_metric_output.png&#34; alt=&#34;Grfana : Metric Output&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;In similar fashion more graphs can be added and additional dashboards can be set up as per requirements.&lt;/p&gt;
&lt;h2 id=&#34;Conclusion&#34;&gt;&lt;a href=&#34;#Conclusion&#34; class=&#34;headerlink&#34; title=&#34;Conclusion&#34;&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;&lt;p&gt;This concludes this post, in which we have setup a basic development setup of InfluxDB and explored how a time series datastore can be used to save metrics from our Rails application and how we can query this data store and derive actionable insights. Also we explored creation of dashboards using Grafana to visualize these metrics in near-real time.&lt;/p&gt;
&lt;p&gt;Our proof of concept setup, however is not suitable for production deployments with large volumes of data, in which case we would want to utilize advanced cluster management features of InfluxDB. Fortunately InfluxDB documentation already has a lot of &lt;a href=&#34;http://influxdb.com/docs/v0.8/clustering/setup.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;helpful information&lt;/a&gt; on scaling up production deployment which is only expected to mature over time. There are also &lt;a href=&#34;https://customers.influxdb.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;commercial options&lt;/a&gt; available for hosted InfluxDB which I encourage users to &lt;a href=&#34;https://customers.influxdb.com/users/sign_up&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;try out&lt;/a&gt; and evaluate.&lt;/p&gt;
&lt;h2 id=&#34;Where-to-go-from-here&#34;&gt;&lt;a href=&#34;#Where-to-go-from-here&#34; class=&#34;headerlink&#34; title=&#34;Where to go from here&#34;&gt;&lt;/a&gt;Where to go from here&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://influxdb.com/docs/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;InfluxDB documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://docs.grafana.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Grafana Documentation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
</content>
        <category term="Ruby" />
        <category term="Rails" />
        <category term="InfluxDB" />
        <category term="Grafana" />
        <updated>2015-04-04T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2015/03/02/dealing-with-json-fields-in-active-admin.html</id>
        <title>Dealing with JSON data in Active Admin</title>
        <link rel="alternate" href="https://lorefnon.me/2015/03/02/dealing-with-json-fields-in-active-admin.html"/>
        <content type="html">&lt;p&gt;Many a times, depending on the requirements, it makes sense to store
unstructured json data in database fields. PostgreSQL recognizes this
requirement and provides a dedicated json field that automatically
handles JSON validation. As has been outlined in the
&lt;a href=&#34;http://edgeguides.rubyonrails.org/active_record_postgresql.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;RoR Guides&lt;/a&gt;
, it is pretty simple to take advantage of this feature from Rails.
However if you also use &lt;a href=&#34;https://github.com/activeadmin/activeadmin&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;ActiveAdmin&lt;/a&gt; to manage your admin interface,
you will quickly find out that library &lt;a href=&#34;https://github.com/justinfrench/formtastic&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Formtastic&lt;/a&gt; that ActiveAdmin
uses to manage its forms, leaves a lot to be desired when it comes to
JSON editing support.&lt;/p&gt;
&lt;p&gt;In this post we outline a simple approach to improve JSON editing
support in ActiveAdmin using the excellent &lt;a href=&#34;https://github.com/josdejong/jsoneditor/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;JSON editor widget&lt;/a&gt;
by &lt;a href=&#34;https://github.com/josdejong&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Jos de Jong&lt;/a&gt;. It is worth pointing
out that our implementation has very little to do with PostgreSQL
and may be used without modifications if you are storing JSON in say MySQL
text fields. Of course you will need to handle server side validation yourself in that case.&lt;/p&gt;
&lt;p&gt;The source code for the post is available on &lt;a href=&#34;https://github.com/lorefnon/activeadmin-jsoneditor-demo&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Let us have a simple product model with following schema:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;CreateProducts&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Migration&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;change&lt;/span&gt;
    create_table &lt;span class=&#34;hljs-symbol&#34;&gt;:products&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;t&lt;/span&gt;|
      t.string &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;
      t.text &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
      t.json &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;
      t.timestamps
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You may expect providing admin support for this model will just be
a matter of adding a file &lt;code&gt;app/admin/product.rb&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register Product &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
  permit_params &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;However the moment you try to create a new instance, you will be greeted
with an error message:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/formtastic_unknown_input.png&#34; alt=&#34;Formtastic unknown input error&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;So basically Formtastic has no input field pre-configured for json
field. A rudimentary workaround is fairly simple - We explicitly ask
it to use a textarea for metadata field&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register Product &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;

  permit_params &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;

  form &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;f&lt;/span&gt;|
    f.inputs &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;as:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:text&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    f.actions
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This does the job:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/aa1.png&#34; alt=&#34;Form with explicitly specified textarea&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;But seriously, if you have to edit this json very frequently or manage
large json entries, a simple textarea is not an ideal solution. Plus
if you accidentally enter some invalid json, You will be provided with a
feedback only post submission:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/aa2.png&#34; alt=&#34;Error in JSON field&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/aa3.png&#34; alt=&#34;JSON validation error&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The &lt;a href=&#34;https://github.com/josdejong/jsoneditor/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;JSON editor widget&lt;/a&gt;
by &lt;a href=&#34;https://github.com/josdejong&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Jos de Jong&lt;/a&gt; provides a lot better json editing
interface. You can try it out &lt;a href=&#34;http://jsoneditoronline.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;online&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you like what you see, you will be pleased to find that the widget
is pretty easy to integrate right inside ActiveAdmin.&lt;/p&gt;
&lt;p&gt;Let us first configure our form to add a class to the json field
so that we can handle json input fields in a generic fashion.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register Product &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;

  permit_params &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;

  form &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;f&lt;/span&gt;|
    f.inputs &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;as:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:text&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;input_html:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;class:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;jsoneditor-target&amp;#x27;&lt;/span&gt; &amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    f.actions
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next we will need to download the &lt;a href=&#34;http://jsoneditoronline.org/downloads/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;relevant files&lt;/a&gt; and add to our vendor
directory. I have already changed the files to use sprockets urls, so you can
grab the files form the repo.&lt;/p&gt;
&lt;p&gt;Next we modify the active_admin.js.coffee:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs coffeescript&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;#= require active_admin/base&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;#= require jsoneditor&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;#= require jsoneditor_activeadmin_integration&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have the required files in place, integration is pretty simple -
&lt;code&gt;app/assets/javascripts/jsoneditor_activeadmin_integration&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs coffeescript&#34;&gt;$ -&amp;gt;

  $(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;.jsoneditor-target&amp;#x27;&lt;/span&gt;).each -&amp;gt;

    target = $ this

    container = $(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;&amp;lt;div class=&amp;quot;jsoneditor-container&amp;quot;&amp;gt;&amp;#x27;&lt;/span&gt;)
      .insertAfter target

    editor = &lt;span class=&#34;hljs-keyword&#34;&gt;new&lt;/span&gt; JSONEditor container[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;],
      modes: [&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;code&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;form&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;text&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;tree&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;view&amp;#x27;&lt;/span&gt;]
      change: &lt;span class=&#34;hljs-function&#34;&gt;-&amp;gt;&lt;/span&gt;
        target.val editor.get()

    editor.set(
      &lt;span class=&#34;hljs-keyword&#34;&gt;try&lt;/span&gt;
        &lt;span class=&#34;hljs-built_in&#34;&gt;JSON&lt;/span&gt;.parse target.val()
    )

    target.hide()&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This simply hides the textarea for json field, and adds a json editor
widget. When the editor is updated, the hidden textarea is updated
with the new value - so our form continues to work just as expected,
without Formtastic having to be aware of the widget at all.&lt;/p&gt;
&lt;p&gt;I had to explicitly override some of the conflicting styles from
ActiveAdmin which were messing up the Editor Widget css:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs scss&#34;&gt;&lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor-container&lt;/span&gt;, &lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor-contextmenu&lt;/span&gt; &amp;#123;
    &lt;span class=&#34;hljs-selector-tag&#34;&gt;table&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-attribute&#34;&gt;width&lt;/span&gt;: auto;
        &lt;span class=&#34;hljs-attribute&#34;&gt;margin&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
    &amp;#125;

    &lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-attribute&#34;&gt;background&lt;/span&gt;: white;
    &amp;#125;

    &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;, &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;&lt;span class=&#34;hljs-selector-pseudo&#34;&gt;:hover&lt;/span&gt;, &lt;span class=&#34;hljs-selector-class&#34;&gt;.menu&lt;/span&gt; &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;, &lt;span class=&#34;hljs-selector-class&#34;&gt;.menu&lt;/span&gt; &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;&lt;span class=&#34;hljs-selector-pseudo&#34;&gt;:hover&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-attribute&#34;&gt;background&lt;/span&gt;: none;
        &lt;span class=&#34;hljs-attribute&#34;&gt;text-shadow&lt;/span&gt;: none;
        &lt;span class=&#34;hljs-attribute&#34;&gt;box-shadow&lt;/span&gt;: none;
        &lt;span class=&#34;hljs-attribute&#34;&gt;border-radius&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
    &amp;#125;
&amp;#125;

&lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor-container&lt;/span&gt; &amp;#123;
    &lt;span class=&#34;hljs-attribute&#34;&gt;margin-left&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;20%&lt;/span&gt;;
    &lt;span class=&#34;hljs-attribute&#34;&gt;width&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;80%&lt;/span&gt;;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we are pretty much done:
&lt;img src=&#34;/images/aa4.png&#34; alt=&#34;Widget integrated with Active Admin&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;I realize that the default styling of the widget sticks out a bit against
 the default styling of ActiveAdmin page, but all that is needed to rectify is a few CSS
rules which I leave as an exercise for the reader.&lt;/p&gt;
&lt;p&gt;As always, any feedback and suggestions are more than welcome.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="Rails" />
        <category term="ActiveAdmin" />
        <updated>2015-03-02T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2015/01/03/leveraging-strategy-pattern-in-rails.html</id>
        <title>Leveraging the strategy pattern in Rails - I</title>
        <link rel="alternate" href="https://lorefnon.me/2015/01/03/leveraging-strategy-pattern-in-rails.html"/>
        <content type="html">&lt;h1 id=&#34;To-begin-with-what-is-strategy-pattern&#34;&gt;&lt;a href=&#34;#To-begin-with-what-is-strategy-pattern&#34; class=&#34;headerlink&#34; title=&#34;To begin with, what is strategy pattern ?&#34;&gt;&lt;/a&gt;To begin with, what is strategy pattern ?&lt;/h1&gt;&lt;p&gt;Quoting from &lt;a href=&#34;http://en.wikipedia.org/wiki/Strategy_pattern&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Wikipedia&lt;/a&gt;,&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the strategy pattern (also known as the policy pattern) is a software design
pattern that enables an algorithm&amp;#39;s behavior to be selected at runtime.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;So-how-does-this-help-us&#34;&gt;&lt;a href=&#34;#So-how-does-this-help-us&#34; class=&#34;headerlink&#34; title=&#34;So how does this help us ?&#34;&gt;&lt;/a&gt;So how does this help us ?&lt;/h1&gt;&lt;p&gt;Strategy pattern just helps us escape the soup of complex nested conditionals
and model behavior selection in an object oriented fashion. To understand why this is
required let us explore a fictional example:&lt;/p&gt;
&lt;h1 id=&#34;An-adventure&#34;&gt;&lt;a href=&#34;#An-adventure&#34; class=&#34;headerlink&#34; title=&#34;An adventure&#34;&gt;&lt;/a&gt;An adventure&lt;/h1&gt;&lt;p&gt;Suppose that we are developing a social network for book lovers. To encourage users
to read more we decide to show a recommendations panel which highlights books that
are trending in the community.&lt;/p&gt;
&lt;p&gt;Our (over-simplified) implementation might be something like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:tags&lt;/span&gt;

  scope &lt;span class=&#34;hljs-symbol&#34;&gt;:popular&lt;/span&gt;, -&amp;gt; &amp;#123;  where &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommendations_count &amp;gt; 100&amp;#x27;&lt;/span&gt; &amp;#125;

  &lt;span class=&#34;hljs-comment&#34;&gt;# Return a random subset of recommended books&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# Yes, this approach is sub-optimal for large number of popular books. Better&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# approaches are outlined here:&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# http://stackoverflow.com/questions/4329396/mysql-select-10-random-rows-from-600k-rows-fast&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended
    popular.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Recommendation&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;counter_cache:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:book&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;counter_cache:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In home&amp;#x2F;index.html.erb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommended-book-list&amp;#x27;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; Book.recommended.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; book.title &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So far so good, however we realize that for users who have been using our service
for a while, it makes more sense to show recommendations based on their intersts. So we do a
shotgun surgery and modify our code to the following:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; user.blank? |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| (user.recommendations_count &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
      popular
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      not_recommended_by(user).where(&lt;span class=&#34;hljs-symbol&#34;&gt;tags:&lt;/span&gt; user.recommended_tags)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommended_books&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;through:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;source:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:book&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommended_tags&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;through:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:recommended_books&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;source:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:tags&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  scope &lt;span class=&#34;hljs-symbol&#34;&gt;:not_recommended_by&lt;/span&gt;, -&amp;gt; (user) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
    joins(&lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;)
      .where(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommendations.user_id != ?&amp;#x27;&lt;/span&gt;, user.id)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And our template becomes something like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommended-book-list&amp;#x27;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; Book.recommended_for(current_user).each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; book.title &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We see that at this point our &lt;code&gt;recommended_for&lt;/code&gt; method is burdened with multiple
responsibilities - the decision for the approach to be used as well as the logic
for multiple approaches all reside in the same method, which is not very ideal.&lt;/p&gt;
&lt;p&gt;Let us push this further. Say, after a couple of months our social networks gains
a lot of traction and we strike a very profitable deal with a major publishing
firm &amp;#39;Jackass Kangaroo Publications&amp;#39; and as a part of the deal we need to ensure
that the recommended books include only those which have been published by this
publication.&lt;/p&gt;
&lt;p&gt;No problem, we just need add a few lines of code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    query = Book

    &lt;span class=&#34;hljs-comment&#34;&gt;# Comment this out when deal with Jackass Kangaroo Publication is over.&lt;/span&gt;
    query = query.where(&lt;span class=&#34;hljs-symbol&#34;&gt;publisher:&lt;/span&gt; Publisher.where(&lt;span class=&#34;hljs-symbol&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Jackass Kangaroo Publication&amp;#x27;&lt;/span&gt;).first)

    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; user.blank? |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| (user.recommendations_count &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
      query.popular
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      query.not_recommended_by(user).where(&lt;span class=&#34;hljs-symbol&#34;&gt;tags:&lt;/span&gt; user.recommended_tags)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;No words are needed to describe the ugliness of the code above. Our eyes bleed but we
choose to look away and carry on with our buisness.&lt;/p&gt;
&lt;p&gt;Of course, the journey of our social network is not all rosy. We get hit by a
lawsuit making our deal with &lt;code&gt;Jackass Kangaroo Publications&lt;/code&gt; illegal in a specific country.
But why bother backing off from this insanity when all problems can be resolved
by adding just another condition:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    query = Book

    &lt;span class=&#34;hljs-comment&#34;&gt;# Comment this out when deal with Jackass Kangaroo Publication is over.&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;unless&lt;/span&gt; user.located_in? &lt;span class=&#34;hljs-variable constant_&#34;&gt;DISPUTED_DEMOGRAPHY&lt;/span&gt;
      query = query.where(&lt;span class=&#34;hljs-symbol&#34;&gt;publisher:&lt;/span&gt; Publisher.where(&lt;span class=&#34;hljs-symbol&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Jackass Kangaroo Publication&amp;#x27;&lt;/span&gt;).first)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;A-downhill-slope&#34;&gt;&lt;a href=&#34;#A-downhill-slope&#34; class=&#34;headerlink&#34; title=&#34;A downhill slope&#34;&gt;&lt;/a&gt;A downhill slope&lt;/h1&gt;&lt;p&gt;So requirements keep stacking up and we keep adding conditions. Fast forward a few years, and
a sincere programmer who is new to the project, unfamiliar with our rocky history and now is responsible
for maintenance of the project is staring
blankly at the entangled mess of conditional statements. Of course the crutial details of the deal
and the subsequent lawsuits are now lost in sands of time, and none of the present team members
have any idea what is going on.&lt;/p&gt;
&lt;h1 id=&#34;Retrospection&#34;&gt;&lt;a href=&#34;#Retrospection&#34; class=&#34;headerlink&#34; title=&#34;Retrospection&#34;&gt;&lt;/a&gt;Retrospection&lt;/h1&gt;&lt;p&gt;The question now is, what could be done to avoid a situation like this ? As you might have guessed
at this point, burdening the Book class with responsibility to determine various aspects of
application that affect our recommendation policy as well as the complete implementation of all these policies
is cumbersome. What we can do is that we can refactor out the specific strategies into dedicated
classes that encapsulate the actual implementation details. This is exactly what the strategy pattern
encourages us to embrace.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;RecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Struct&lt;/span&gt;.new(user, scoped_collection)
    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| Book
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
      &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;br&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;DefaultRecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;RecommendationGeneration&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
          &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
          &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| popular
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
          scoped_collection.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;br&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;UserAdaptedRecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;RecommendationGeneration&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
      user.present?
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; user.present?
        not_recommended_by(user).where(&lt;span class=&#34;hljs-symbol&#34;&gt;tags:&lt;/span&gt; user.recommended_tags)
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
            &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
          &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
          Strategies::DefaultRecommendation
            .new(user, scoped_collection)
                .execute
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;br&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;PartnershipAdaptedRecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;RecommendationGeneration&lt;/span&gt;

    &lt;span class=&#34;hljs-comment&#34;&gt;# It is better to model buisness constraints in the persistance layer&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# rather than relying on implicit assumptions.&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;#&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
          ! partner_publisher.blank?
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;partner_publisher&lt;/span&gt;
          Partnership
            .legal_in(user.demography)
        .having_recommendation_priviledge
                .active
                .first
                .publisher
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
          Book.where(&lt;span class=&#34;hljs-symbol&#34;&gt;publisher:&lt;/span&gt; partner_publisher)
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
          Strategies::UserAdaptedRecommendationGeneration
                .new(user, scoped_collection)
                .execute
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now our &lt;code&gt;recommended_for&lt;/code&gt; method just has to decide which is the applicable strategy and execute
it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...

  &lt;span class=&#34;hljs-variable constant_&#34;&gt;RECOMMENDATION_STRATEGIES&lt;/span&gt; = [
    PartnershipAdaptedRecommendationGeneration
        UserAdaptedRecommendationGeneration
        DefaultRecommendationGeneration
  ]

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    &lt;span class=&#34;hljs-variable constant_&#34;&gt;RECOMMENDATION_STRATEGIES&lt;/span&gt;.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;strategy_class&lt;/span&gt;|
          strategy = strategy_class.new(user)
          &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; strategy.applicable?
            strategy.execute
                &lt;span class=&#34;hljs-keyword&#34;&gt;break&lt;/span&gt;
          &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is signficantly better than our prior approach and aligns well with the tenets of
&lt;a href=&#34;http://en.wikipedia.org/wiki/SOLID_(object-oriented_design)&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;SOLID&lt;/a&gt; principles. Apart from
explaining the use of strategy pattern it also illustrates how strategies can reuse existing
strategies by means of composition thus keeping our code DRY.&lt;/p&gt;
&lt;p&gt;So we see that, the strategy pattern is especially helpful when it comes to applications where
requirements are rapidly changing all the time. Since the core logic is encapsulated
into interchangeable concrete implementations, strategy implementations can be
introduced or switched with relative ease at a later phase.&lt;/p&gt;
&lt;p&gt;While this post focussed on use of strategy pattern to simply complex logic in model layer, in
subsequent posts we will cover how this pattern can simplify our implementations in controller
and view layers as well.&lt;/p&gt;
&lt;p&gt;This concludes the post. Please feel free to let me know about your suggestions for improvements, or
mistakes that I might have made in the post above.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="Rails" />
        <category term="Design Patterns" />
        <updated>2015-01-03T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2014/10/12/decrypting-an-obfuscated-font-with-ocr.html</id>
        <title>Decrypting an obfuscated font with OCR</title>
        <link rel="alternate" href="https://lorefnon.me/2014/10/12/decrypting-an-obfuscated-font-with-ocr.html"/>
        <content type="html">&lt;p&gt;I recently came across [this site](the site &lt;a href=&#34;http://protext.herokuapp.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;http://protext.herokuapp.com/&lt;/a&gt;) which demostrates a strategy for copy protection using an obfuscated font. So basically if you copy the text in the header you will realize that text copied is not exactly what is visible on the screen. The text is presented through a font that maps the characters to glyphs of a different character and hence though the output is human readable the underlying text is not. This is presented as a means towards protecting the site from crawlers and scrapers. In the post below I intend to demonstrate that this is not as full-proof as non-technical folks would be led to believe.&lt;/p&gt;
&lt;img src=&#34;/images/protext_site.png&#34; style=&#34;border: 1px solid silver;&#34;/&gt;

&lt;p&gt;The Achilles heel of such strategies is that the unecrypted text is visible to the user. So a decent &lt;a href=&#34;http://en.wikipedia.org/wiki/Optical_character_recognition&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;OCR&lt;/a&gt; will be able to parse the output and generate the text to reasonable accuracy. So though this technique certainly presents hinderences to a scraper it is not a full proof solution. Through simple code snippets we see below how this can be accomplished in ruby.&lt;/p&gt;
&lt;p&gt;We can directly get the screenshot of the entire site using a tool like phantomJS and pass it on to OCR but the approach below is much more accurate.&lt;/p&gt;
&lt;p&gt;First of all download the font used for the text. The path should be clearly visible in the source of the site and can be scraped using conventional text parsing through regular expressions.&lt;/p&gt;
&lt;img src=&#34;/images/protext_css_source.png&#34;/&gt;

&lt;p&gt;Alternatively it can be manually downloaded through devtools:&lt;/p&gt;
&lt;img src=&#34;/images/protext_devtools_font.png&#34;/&gt;

&lt;p&gt;Now we need two gems:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;https://www.ruby-toolbox.com/projects/tesseract-ocr&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Tesseract-OCR&lt;/a&gt; - Ruby bindings for Tesseract OCR&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;https://www.ruby-toolbox.com/projects/magick_title&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Magic Title&lt;/a&gt; - to convert the text to image using a specific font.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Quoting the &lt;a href=&#34;http://code.google.com/p/tesseract-ocr/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Tesseract OCR Website&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Tesseract is probably the most accurate open source OCR engine available. Combined with the Leptonica Image Processing Library it can read a wide variety of image formats and convert them to text in over 60 languages. It was one of the top 3 engines in the 1995 UNLV Accuracy test. Between 1995 and 2006 it had little work done on it, but since then it has been improved extensively by Google. It is released under the Apache License 2.0.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Installing Tesseract on OS X is as simple as &lt;code&gt;brew install tesseract&lt;/code&gt; and it is also available through several linux package managers.&lt;/p&gt;
&lt;p&gt;The ruby gems can be installed by adding the following to your Gemfile:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;gem &amp;#39;magick_title&amp;#39;, &amp;#39;&amp;gt;= 0.2.0&amp;#39;
gem &amp;#39;tesseract-ocr&amp;#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now in irb (or a ruby script) you can do:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;magick_title&amp;#x27;&lt;/span&gt;
MagickTitle.options[&lt;span class=&#34;hljs-symbol&#34;&gt;:font&lt;/span&gt;] = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;font_dfcb813d6c003fb3e2fca9f5295e9f58.ttf&amp;quot;&lt;/span&gt;  &lt;span class=&#34;hljs-comment&#34;&gt;# Font downloaded from the site&lt;/span&gt;
MagickTitle.options[&lt;span class=&#34;hljs-symbol&#34;&gt;:font_path&lt;/span&gt;] =  Proc.new&amp;#123; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;/tmp&amp;#x27;&lt;/span&gt; &amp;#125;  &lt;span class=&#34;hljs-comment&#34;&gt;# Directory where the font resides on our system&lt;/span&gt;
MagickTitle.options[&lt;span class=&#34;hljs-symbol&#34;&gt;:destination&lt;/span&gt;] =  Proc.new&amp;#123; MagicTitle.root &amp;#125; &lt;span class=&#34;hljs-comment&#34;&gt;# Defaults to current directory&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now let us fetch the string from the site header. For the sake of keeping the example minimal we omit the actual scraping code here:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;str =  &amp;quot;1zb SN358 y6JBl HJL 7Nagq JRb6 kzb n2vP 9JV. F + h = t.&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;code&gt;MagickTitle.say(str)&lt;/code&gt; will give us an image containing the text in exactly the same form as is visible to end user.&lt;/p&gt;
&lt;p&gt;Now we pass the image to Tesseract engine:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;e = &lt;span class=&#34;hljs-title class_&#34;&gt;Tesseract::Engine&lt;/span&gt;.new &amp;#123;|&lt;span class=&#34;hljs-params&#34;&gt;e&lt;/span&gt;|
    e.language  = &lt;span class=&#34;hljs-symbol&#34;&gt;:eng&lt;/span&gt;
    e.blacklist = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;|&amp;#x27;&lt;/span&gt;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can get the string using:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; e.text_for(&amp;quot;./#&amp;#123;MagickTitle.say(str).filename&amp;#125;&amp;quot;)
=&amp;gt; &amp;quot;The quick brown fox jumps over\nthe lazy dog 1 2 3\n\n&amp;quot;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;As you can see that result is not perfect but quite accurate.&lt;/p&gt;
&lt;p&gt;To further improve the performance of the solution we can create an image of every character through MagickTitle and pass it to Tesseract to generate a character by character map. Now large chunks of text can be translated using this map much more efficiently.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="OCR" />
        <updated>2014-10-12T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2014/09/07/devise-multiple-emails.html</id>
        <title>Effectively debugging KnockoutJS applications.</title>
        <link rel="alternate" href="https://lorefnon.me/2014/09/07/devise-multiple-emails.html"/>
        <content type="html">

          

&lt;p&gt;&lt;a href=&#34;https://github.com/plataformatec/devise&#34;&gt;Devise&lt;/a&gt; is an incredibly popular authorization gem for Rails. Unfortunately allowing a user to log in through multiple emails is not as straightforward as one might expect. This post outlines a way to do just that.&lt;/p&gt;

&lt;p&gt;The code for this blog is available &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo.git&#34;&gt;here&lt;/a&gt;. We start off with a rudimentary devise installation (you may want to checkout &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo/tree/3d5be26be7986aaf73c18497cffd67a9365e38cb&#34;&gt;Commit:3d5be26&lt;/a&gt; as a starting point - if you are not familiar with devise I suggest you take a look at the official documentation. As you may have noticed I am writing this post against Rails 4.2 Beta which Devise master does not support as of this writing. Luckily &lt;a href=&#34;https://github.com/lucasmazza&#34;&gt;lucasmazza&lt;/a&gt; has already submitted a pull request for 4.2 compatibility and we just need to use the branch &lt;code&gt;lm-rails-4-2&lt;/code&gt;.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#creating-email-model&#34;&gt;&lt;h2 id=&#34;creating-email-model&#34;&gt;Creating Email model&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;First step is creating an email model.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g model email email:string user_id:integer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we setup the relationships between user and email:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;validates&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;presence&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;uniqueness&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The email format validation comes from &lt;a href=&#34;https://github.com/balexand/email_validator&#34;&gt;email_validator&lt;/a&gt; gem.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# Include default devise modules. Others available are:&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# :confirmable, :lockable, :timeoutable and :omniauthable&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;devise&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:database_authenticatable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:registerable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
         &lt;span class=&#34;ss&#34;&gt;:recoverable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:rememberable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:trackable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:validatable&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;has_many&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Once we have done that, we can do away with the email field provided by devise. Instead of that, let us have a default email reference which may be used as a primary means of communication eg. for sending
newsletters, fetching gravatars etc. So here we go:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g migration add_default_email_to_users default_email_id:integer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In &lt;code&gt;db/migrate/20140907091858_add_default_email_to_users.rb&lt;/code&gt;&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;AddDefaultEmailToUsers&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Migration&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;change&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;remove_column&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;add_column&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:integer&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In user model:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;class_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Email&#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#setting-up-the-registration-flow-&#34;&gt;&lt;h2 id=&#34;setting-up-the-registration-flow-&#34;&gt;Setting up the registration flow:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;At this point if we try visiting a devise sign up page, we will
get an obvious error because devise views expect an email field in
model.&lt;/p&gt;

&lt;p&gt;&lt;image src=&#34;/images/devise_email_not_found.png&#34;&gt;&lt;/image&gt;&lt;/p&gt;

&lt;p&gt;We resort to a simple hack rather than put in a lot of effort in rewiring Devise. We add email accessors which (as far as devise is concerned) behave just like the email field devise had generated, but internally act as proxy to default email. Duck typing FTW.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;devise&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:database_authenticatable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:registerable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
         &lt;span class=&#34;ss&#34;&gt;:recoverable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:rememberable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:trackable&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;has_many&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;dependent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:destroy&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;after_commit&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:save_default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:create&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;class_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Email&#34;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;validates&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;presence&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;default_scope&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;includes&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;rescue&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;nil&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;emails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first_or_initialize&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;private&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;save_default_email&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blank?&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Exceptions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;EmailConflict&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note that we have removed &lt;code&gt;:validatable&lt;/code&gt; which is added by default
by devise. Also the after commit hook is required because when we are saving the user
for the first time, user id is nil when email is instantiated and hence will have to assign it once we have saved the user. An email conflict will be raised if the email
is already associated with another account. Handling that error gracefully is left as an exercise for the reader.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#setting-up-the-login-flow-&#34;&gt;&lt;h2 id=&#34;setting-up-the-login-flow-&#34;&gt;Setting up the login flow:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;While registration should work smoothly at this point, if we try to login we will run into trouble:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/devise_login_flow_fail.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;The problem is obvious. Devise tries to search using email field which does not exist. So we need to
configure devise to find using the emails table we have created.&lt;/p&gt;

&lt;p&gt;This can be done by overriding the class method &lt;code&gt;find_first_by_auth_conditions&lt;/code&gt; :&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;having_email&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;includes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;joins&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;p&#34;&gt;&amp;#125;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;find_first_by_auth_conditions&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;warden_conditions&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;conditions&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;warden_conditions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dup&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;conditions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;having_email&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;warden_conditions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;private&lt;/span&gt;

  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Once we have done that, login flow should as intended.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#interface-for-managing-emails&#34;&gt;&lt;h2 id=&#34;interface-for-managing-emails&#34;&gt;Interface for managing emails&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;At this point a user can login and signup but he can not manage the emails which are associated with his/her account. Let us take care of that.&lt;/p&gt;

&lt;p&gt;The default edit account view of devise looks something like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/devise_default_edit.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;Note that this form works perfectly well - thanks to our email accessor hack. But users don&#39;t have the ability to add new emails or delete existing emails.&lt;/p&gt;

&lt;p&gt;We will to augment this form to accept nested attributes for emails. For nested forms probably the most popular solution is &lt;a href=&#34;https://github.com/ryanb/nested_form&#34;&gt;nested_form&lt;/a&gt; but it has been unmaintained for a while. So I resorted to &lt;a href=&#34;https://github.com/nathanvda/cocoon&#34;&gt;cocoon&lt;/a&gt; which is more actively maintained. Both of them work in a similar fashion - through unobstructive javascript.&lt;/p&gt;

&lt;p&gt;First we have to configure our model to accept nested attributes for emails - this part is easy:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;accepts_nested_attributes_for&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;reject_if&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:all_blank&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;allow_destroy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Nest we need to generate devise views using &lt;code&gt;rails g devise:views&lt;/code&gt; and edit the &lt;code&gt;app/views/devise/registrations/edit.html.erb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;We edit the template to add nested form for emails:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;erb&#34;&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;h2&amp;gt;Edit &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_s&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;humanize&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/h2&amp;gt;&lt;/span&gt;

&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;form_for&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;registration_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;html&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:put&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;devise_error_messages!&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Default Email&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autofocus&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fields_for&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email_f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;render&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;email_fields&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email_f&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &amp;lt;div class=&#34;links&#34;&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;link_to_add_association&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;Add Email&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;devise_mapping&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;confirmable?&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending_reconfirmation?&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &amp;lt;div&amp;gt;Currently waiting confirmation for: &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unconfirmed_email&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt; &amp;lt;i&amp;gt;(leave blank if you don&#39;t want to change it)&amp;lt;/i&amp;gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autocomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;off&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password_confirmation&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password_confirmation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autocomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;off&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_password&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt; &amp;lt;i&amp;gt;(we need your current password to confirm your changes)&amp;lt;/i&amp;gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autocomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;off&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;submit&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Update&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;&amp;lt;h3&amp;gt;Cancel my account&amp;lt;/h3&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;&amp;lt;p&amp;gt;Unhappy? &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;button_to&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Cancel my account&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;registration_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;confirm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Are you sure?&#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:delete&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;

&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;link_to&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Back&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:back&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Cocoon mandates a separate partial for email fields, which in our case is very simple:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;erb&#34;&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;div class=&#34;nested-fields&#34;&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;link_to_remove_association&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;remove email&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;At this point if we try saving the form, we will notice that email fields are not getting saved. The reason is that the strong parameters specified by devise does not include our email fields. Fortunately devise provides a way to configure that :&lt;/p&gt;

&lt;p&gt;In &lt;code&gt;ApplicationController&lt;/code&gt; :&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ApplicationController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActionController&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# Prevent CSRF attacks by raising an exception.&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# For APIs, you may want to use :null_session instead.&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;protect_from_forgery&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;with&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:exception&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:configure_permitted_parameters&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:devise_controller?&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;protected&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;configure_permitted_parameters&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;devise_parameter_sanitizer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:account_update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;permit&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password_confirmation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;emails_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_destroy&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note that &lt;code&gt;:_destroy&lt;/code&gt; symbol in the attribute list. It is required because to destroy nested models, rails uses a virtual attribute called _destroy. When _destroy is set, the nested model will be deleted.&lt;/p&gt;

&lt;p&gt;If we try adding, removing and editing emails now, everything should work smoothly.
&lt;img src=&#34;/images/devise_nested_form_edit.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;In a production setting we will most certainly need to send out confirmation mails before activating the emails. We skip the additional steps for the sake of brevity.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#omniauth-integration-&#34;&gt;&lt;h2 id=&#34;omniauth-integration-&#34;&gt;Omniauth integration:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;One of the things we all love about devise is that it integrates beautifully with
&lt;a href=&#34;https://github.com/intridea/omniauth&#34;&gt;omniauth&lt;/a&gt; making integration with a plethora of social services painless. However due to the fundamental changes we have made, omniauth integration requires jumping through a few extra hoops.&lt;/p&gt;

&lt;p&gt;We use Facebook login as an example below:&lt;/p&gt;

&lt;p&gt;Firstly, of course we need to create an application on &lt;a href=&#34;https://developers.facebook.com&#34;&gt;https://developers.facebook.com&lt;/a&gt;. Once we have created an application, and have obtained the API key and secret, we configure devise omniauth parameters:&lt;/p&gt;

&lt;p&gt;In Gemfile&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;n&#34;&gt;gem&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;omniauth&#39;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;gem&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;omniauth-facebook&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In config/initializers/devise.rb&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;Devise&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;setup&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;omniauth&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:twitter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;application&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;secrets&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fb_app_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;application&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;secrets&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fb_app_secret&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In config/secrets.yml&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;yaml&#34;&gt;&lt;span class=&#34;l-Scalar-Plain&#34;&gt;development&lt;/span&gt;&lt;span class=&#34;p-Indicator&#34;&gt;:&lt;/span&gt;
  &lt;span class=&#34;l-Scalar-Plain&#34;&gt;fb_app_id&lt;/span&gt;&lt;span class=&#34;p-Indicator&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;l-Scalar-Plain&#34;&gt;&amp;lt;add api key here&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;l-Scalar-Plain&#34;&gt;fb_app_secret&lt;/span&gt;&lt;span class=&#34;p-Indicator&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;l-Scalar-Plain&#34;&gt;&amp;lt;add api secret here&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In app/models/user.rb&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;devise&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:omniauthable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;omniauth_providers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:facebook&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In config/routes.rb&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;  &lt;span class=&#34;n&#34;&gt;devise_for&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;controllers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;omniauth_callbacks&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;users/omniauth_callbacks&#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;where &lt;code&gt;users/omniauth_callbacks&lt;/code&gt; is a controller we define to which facebook will redirect to after authenticating our application.&lt;/p&gt;

&lt;p&gt;If you have used omniauth with devise before, there is nothing out of the ordinary so far.&lt;/p&gt;

&lt;p&gt;Just like we wish to allow the user to sign up through multiple emails, we also wish to allow a user to sign up through multiple social networks. (s)he may be registered in different social networks with different emails. A simple and elegant way to represent a user&#39;s presence in multiple third party sites is through a separate &lt;code&gt;UserIdentity&lt;/code&gt; model.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g model UserIdentity user_id:integer email_id:integer uid:string provider:string
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserIdentity&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;validates&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:uid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:provider&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;presence&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Our callback controller is intentially very simple. Depending on your use case you may want to check if the user is newly created and direct him/her to a profile completion page. For the sake of simplicity, we just redirect any user to the profile page.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Users&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;OmniauthCallbacksController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Devise&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;OmniauthCallbacksController&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;facebook&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;from_omniauth&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;omniauth.auth&#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;sign_in_and_redirect&lt;/span&gt; &lt;span class=&#34;vi&#34;&gt;@user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:event&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:authentication&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;#this will throw if @user is not activated&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In the &lt;code&gt;from_omniauth&lt;/code&gt; class method of user we need to identify user based on the auth parameters passed.
Luckily facebook provides us with the email, so we can use that to identify a user.&lt;/p&gt;

&lt;p&gt;Four scenarios are possible:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User is signing up for the first time through facebook.&lt;/strong&gt;
In this case we just use the email obtained from facebook as the default email and register the user&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User already has an account and has chosen to login through facebook for the first time&lt;/strong&gt;
We can identify this situation if user&#39;s existing email is the same as the one he has used in Facebook. In this case we create a new UserIdentity for an existing user.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using the same email&lt;/strong&gt;
Nothing needs to be created. We just log the user in.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using a different email&lt;/strong&gt;
We keep the existing email, but associate the user identity with the new email.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here is our implementation&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;

  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;from_omniauth&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Email&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;includes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first_or_initialize&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;UserIdentity&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;provider&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;provider&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;uid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first_or_initialize&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;persisted?&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# Existing user, Existing social identity&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;persisted?&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;# Email changed on third party site&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Exceptions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;EmailConflict&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;persisted?&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# Existing User, new identity&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# New user new identity&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;ss&#34;&gt;password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Devise&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;friendly_token&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The code above raises an &lt;code&gt;EmailConflict&lt;/code&gt; exception if we end up in a scenario where an existing user is logging in and the email is associated with another account. Gracefully handling the error is left as an exercise for the reader. Also we assume that the social login provider will provide us with an email.
While this is true for many providers like Github, not all providers provide with emails. A prominent example is twitter. Since this is not intended to be a comprehensive tutorial on omniauth, for the sake of brevity we don&#39;t
elaborate on those scenarios. A good way to handle such a case would be to direct a user to a profile completion after login where he/she can enter the email and warn them if an account already exists for that email.&lt;/p&gt;

&lt;p&gt;So we conclude the post with a functional setup that allows a user to have multiple emails associated with a devise account. Feel free to bug me if you face any issues. Any comments and suggestions are also welcome.&lt;/p&gt;


</content>
        <category term="Ruby" />
        <category term="Rails" />
        <updated>2014-09-07T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2014/09/07/devise-multiple-emails.html</id>
        <title>Allowing multiple emails for a user in Devise</title>
        <link rel="alternate" href="https://lorefnon.me/2014/09/07/devise-multiple-emails.html"/>
        <content type="html">&lt;p&gt;&lt;a href=&#34;https://github.com/plataformatec/devise&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Devise&lt;/a&gt; is an incredibly popular authorization gem for Rails. Unfortunately allowing a user to log in through multiple emails is not as straightforward as one might expect. This post outlines a way to do just that.&lt;/p&gt;
&lt;p&gt;The code for this blog is available &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo.git&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;here&lt;/a&gt;. We start off with a rudimentary devise installation (you may want to checkout &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo/tree/3d5be26be7986aaf73c18497cffd67a9365e38cb&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Commit:3d5be26&lt;/a&gt; as a starting point - if you are not familiar with devise I suggest you take a look at the official documentation. As you may have noticed I am writing this post against Rails 4.2 Beta which Devise master does not support as of this writing. Luckily &lt;a href=&#34;https://github.com/lucasmazza&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;lucasmazza&lt;/a&gt; has already submitted a pull request for 4.2 compatibility and we just need to use the branch &lt;code&gt;lm-rails-4-2&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;Creating-Email-model&#34;&gt;&lt;a href=&#34;#Creating-Email-model&#34; class=&#34;headerlink&#34; title=&#34;Creating Email model&#34;&gt;&lt;/a&gt;Creating Email model&lt;/h2&gt;&lt;p&gt;First step is creating an email model.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g model email email:string user_id:integer
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next we setup the relationships between user and email:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Email&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;
  validates &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;presence:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;uniqueness:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The email format validation comes from &lt;a href=&#34;https://github.com/balexand/email_validator&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;email_validator&lt;/a&gt; gem.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# Include default devise modules. Others available are:&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# :confirmable, :lockable, :timeoutable and :omniauthable&lt;/span&gt;
  devise &lt;span class=&#34;hljs-symbol&#34;&gt;:database_authenticatable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:registerable&lt;/span&gt;,
         &lt;span class=&#34;hljs-symbol&#34;&gt;:recoverable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:rememberable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:trackable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:validatable&lt;/span&gt;

  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have done that, we can do away with the email field provided by devise. Instead of that, let us have a default email reference which may be used as a primary means of communication eg. for sending
newsletters, fetching gravatars etc. So here we go:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g migration add_default_email_to_users default_email_id:integer
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In &lt;code&gt;db/migrate/20140907091858_add_default_email_to_users.rb&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;AddDefaultEmailToUsers&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Migration&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;change&lt;/span&gt;
    remove_column &lt;span class=&#34;hljs-symbol&#34;&gt;:users&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;
    add_column &lt;span class=&#34;hljs-symbol&#34;&gt;:users&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email_id&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:integer&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In user model:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;class_name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Email&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;Setting-up-the-registration-flow&#34;&gt;&lt;a href=&#34;#Setting-up-the-registration-flow&#34; class=&#34;headerlink&#34; title=&#34;Setting up the registration flow:&#34;&gt;&lt;/a&gt;Setting up the registration flow:&lt;/h2&gt;&lt;p&gt;At this point if we try visiting a devise sign up page, we will
get an obvious error because devise views expect an email field in
model.&lt;/p&gt;
&lt;image src=&#34;/images/devise_email_not_found.png&#34; /&gt;

&lt;p&gt;We resort to a simple hack rather than put in a lot of effort in rewiring Devise. We add email accessors which (as far as devise is concerned) behave just like the email field devise had generated, but internally act as proxy to default email. Duck typing FTW.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  devise &lt;span class=&#34;hljs-symbol&#34;&gt;:database_authenticatable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:registerable&lt;/span&gt;,
         &lt;span class=&#34;hljs-symbol&#34;&gt;:recoverable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:rememberable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:trackable&lt;/span&gt;

  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;dependent:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:destroy&lt;/span&gt;
  after_commit &lt;span class=&#34;hljs-symbol&#34;&gt;:save_default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;on:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:create&lt;/span&gt;

  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;class_name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Email&amp;quot;&lt;/span&gt;
  validates &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;presence:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  default_scope &amp;#123; includes &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt; &amp;#125;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;email&lt;/span&gt;
    default_email.email &lt;span class=&#34;hljs-keyword&#34;&gt;rescue&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;email=&lt;/span&gt; email
    &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.default_email = emails.where(&lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; email).first_or_initialize
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  private

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;save_default_email&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; default_email.user.blank?
      default_email.user = &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; default_email.user != &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;
      raise Exceptions::EmailConflict
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    default_email.save!
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that we have removed &lt;code&gt;:validatable&lt;/code&gt; which is added by default
by devise. Also the after commit hook is required because when we are saving the user
for the first time, user id is nil when email is instantiated and hence will have to assign it once we have saved the user. An email conflict will be raised if the email
is already associated with another account. Handling that error gracefully is left as an exercise for the reader.&lt;/p&gt;
&lt;h2 id=&#34;Setting-up-the-login-flow&#34;&gt;&lt;a href=&#34;#Setting-up-the-login-flow&#34; class=&#34;headerlink&#34; title=&#34;Setting up the login flow:&#34;&gt;&lt;/a&gt;Setting up the login flow:&lt;/h2&gt;&lt;p&gt;While registration should work smoothly at this point, if we try to login we will run into trouble:&lt;/p&gt;
&lt;img src=&#34;/images/devise_login_flow_fail.png&#34;/&gt;

&lt;p&gt;The problem is obvious. Devise tries to search using email field which does not exist. So we need to
configure devise to find using the emails table we have created.&lt;/p&gt;
&lt;p&gt;This can be done by overriding the class method &lt;code&gt;find_first_by_auth_conditions&lt;/code&gt; :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.having_email email
    User
      .includes(&lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;)
      .joins(&lt;span class=&#34;hljs-symbol&#34;&gt;emails:&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt;  email
      &amp;#125;)
      .first
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.find_first_by_auth_conditions warden_conditions
    conditions = warden_conditions.dup
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; email = conditions.delete(&lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;)
      having_email email
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;(warden_conditions)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  private

  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have done that, login flow should as intended.&lt;/p&gt;
&lt;h2 id=&#34;Interface-for-managing-emails&#34;&gt;&lt;a href=&#34;#Interface-for-managing-emails&#34; class=&#34;headerlink&#34; title=&#34;Interface for managing emails&#34;&gt;&lt;/a&gt;Interface for managing emails&lt;/h2&gt;&lt;p&gt;At this point a user can login and signup but he can not manage the emails which are associated with his&amp;#x2F;her account. Let us take care of that.&lt;/p&gt;
&lt;p&gt;The default edit account view of devise looks something like this:&lt;/p&gt;
&lt;img src=&#34;/images/devise_default_edit.png&#34;/&gt;

&lt;p&gt;Note that this form works perfectly well - thanks to our email accessor hack. But users don&amp;#39;t have the ability to add new emails or delete existing emails.&lt;/p&gt;
&lt;p&gt;We will to augment this form to accept nested attributes for emails. For nested forms probably the most popular solution is &lt;a href=&#34;https://github.com/ryanb/nested_form&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;nested_form&lt;/a&gt; but it has been unmaintained for a while. So I resorted to &lt;a href=&#34;https://github.com/nathanvda/cocoon&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;cocoon&lt;/a&gt; which is more actively maintained. Both of them work in a similar fashion - through unobstructive javascript.&lt;/p&gt;
&lt;p&gt;First we have to configure our model to accept nested attributes for emails - this part is easy:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  accepts_nested_attributes_for &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;reject_if:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:all_blank&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;allow_destroy:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nest we need to generate devise views using &lt;code&gt;rails g devise:views&lt;/code&gt; and edit the &lt;code&gt;app/views/devise/registrations/edit.html.erb&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We edit the template to add nested form for emails:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;Edit &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; resource_name.to_s.humanize &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; form_for(resource, &lt;span class=&#34;hljs-symbol&#34;&gt;as:&lt;/span&gt; resource_name, &lt;span class=&#34;hljs-symbol&#34;&gt;url:&lt;/span&gt; registration_path(resource_name), &lt;span class=&#34;hljs-symbol&#34;&gt;html:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;method:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:put&lt;/span&gt; &amp;#125;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;f&lt;/span&gt;| &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; devise_error_messages! &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Default Email&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.email_field &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autofocus:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.fields_for &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;email_f&lt;/span&gt;| &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;email_fields&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;f:&lt;/span&gt; email_f &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;links&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to_add_association &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Add Email&amp;#x27;&lt;/span&gt;, f, &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; devise_mapping.confirmable? &amp;amp;&amp;amp; resource.pending_reconfirmation? &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;Currently waiting confirmation for: &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; resource.unconfirmed_email &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:password&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;(leave blank if you don&amp;#x27;t want to change it)&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.password_field &lt;span class=&#34;hljs-symbol&#34;&gt;:password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autocomplete:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;off&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:password_confirmation&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.password_field &lt;span class=&#34;hljs-symbol&#34;&gt;:password_confirmation&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autocomplete:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;off&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:current_password&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;(we need your current password to confirm your changes)&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.password_field &lt;span class=&#34;hljs-symbol&#34;&gt;:current_password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autocomplete:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;off&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.submit &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Update&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt;&amp;gt;&lt;/span&gt;Cancel my account&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;Unhappy? &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; button_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Cancel my account&amp;quot;&lt;/span&gt;, registration_path(resource_name), &lt;span class=&#34;hljs-symbol&#34;&gt;data:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;confirm:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Are you sure?&amp;quot;&lt;/span&gt; &amp;#125;, &lt;span class=&#34;hljs-symbol&#34;&gt;method:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:delete&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Back&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:back&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cocoon mandates a separate partial for email fields, which in our case is very simple:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nested-fields&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.email_field &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to_remove_association &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;remove email&amp;quot;&lt;/span&gt;, f &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this point if we try saving the form, we will notice that email fields are not getting saved. The reason is that the strong parameters specified by devise does not include our email fields. Fortunately devise provides a way to configure that :&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;ApplicationController&lt;/code&gt; :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;ApplicationController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActionController::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# Prevent CSRF attacks by raising an exception.&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# For APIs, you may want to use :null_session instead.&lt;/span&gt;

  protect_from_forgery &lt;span class=&#34;hljs-symbol&#34;&gt;with:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:exception&lt;/span&gt;
  before_action &lt;span class=&#34;hljs-symbol&#34;&gt;:configure_permitted_parameters&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;if:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:devise_controller?&lt;/span&gt;

  protected

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;configure_permitted_parameters&lt;/span&gt;
    devise_parameter_sanitizer.&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt;(&lt;span class=&#34;hljs-symbol&#34;&gt;:account_update&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;u&lt;/span&gt;|
      u.permit &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:password_confirmation&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:current_password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;emails_attributes:&lt;/span&gt; [&lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:_destroy&lt;/span&gt;]
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that &lt;code&gt;:_destroy&lt;/code&gt; symbol in the attribute list. It is required because to destroy nested models, rails uses a virtual attribute called _destroy. When _destroy is set, the nested model will be deleted.&lt;/p&gt;
&lt;p&gt;If we try adding, removing and editing emails now, everything should work smoothly.
&lt;img src=&#34;/images/devise_nested_form_edit.png&#34;/&gt;&lt;/p&gt;
&lt;p&gt;In a production setting we will most certainly need to send out confirmation mails before activating the emails. We skip the additional steps for the sake of brevity.&lt;/p&gt;
&lt;h2 id=&#34;Omniauth-integration&#34;&gt;&lt;a href=&#34;#Omniauth-integration&#34; class=&#34;headerlink&#34; title=&#34;Omniauth integration:&#34;&gt;&lt;/a&gt;Omniauth integration:&lt;/h2&gt;&lt;p&gt;One of the things we all love about devise is that it integrates beautifully with
&lt;a href=&#34;https://github.com/intridea/omniauth&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;omniauth&lt;/a&gt; making integration with a plethora of social services painless. However due to the fundamental changes we have made, omniauth integration requires jumping through a few extra hoops.&lt;/p&gt;
&lt;p&gt;We use Facebook login as an example below:&lt;/p&gt;
&lt;p&gt;Firstly, of course we need to create an application on &lt;a href=&#34;https://developers.facebook.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;https://developers.facebook.com&lt;/a&gt;. Once we have created an application, and have obtained the API key and secret, we configure devise omniauth parameters:&lt;/p&gt;
&lt;p&gt;In Gemfile&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;omniauth&amp;#x27;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;omniauth-facebook&amp;#x27;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In config&amp;#x2F;initializers&amp;#x2F;devise.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;Devise.setup &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;config&lt;/span&gt;|
  ...
  config.omniauth &lt;span class=&#34;hljs-symbol&#34;&gt;:twitter&lt;/span&gt;, Rails.application.secrets.fb_app_id, Rails.application.secrets.fb_app_secret
  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In config&amp;#x2F;secrets.yml&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs yaml&#34;&gt;&lt;span class=&#34;hljs-attr&#34;&gt;development:&lt;/span&gt;
  &lt;span class=&#34;hljs-attr&#34;&gt;fb_app_id:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;lt;add&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;api&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;here&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;hljs-attr&#34;&gt;fb_app_secret:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;lt;add&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;api&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;secret&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;here&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In app&amp;#x2F;models&amp;#x2F;user.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  devise &lt;span class=&#34;hljs-symbol&#34;&gt;:omniauthable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;omniauth_providers:&lt;/span&gt; [&lt;span class=&#34;hljs-symbol&#34;&gt;:facebook&lt;/span&gt;]
  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In config&amp;#x2F;routes.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;devise_for &lt;span class=&#34;hljs-symbol&#34;&gt;:users&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;controllers:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;omniauth_callbacks:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;users/omniauth_callbacks&amp;quot;&lt;/span&gt; &amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;where &lt;code&gt;users/omniauth_callbacks&lt;/code&gt; is a controller we define to which facebook will redirect to after authenticating our application.&lt;/p&gt;
&lt;p&gt;If you have used omniauth with devise before, there is nothing out of the ordinary so far.&lt;/p&gt;
&lt;p&gt;Just like we wish to allow the user to sign up through multiple emails, we also wish to allow a user to sign up through multiple social networks. (s)he may be registered in different social networks with different emails. A simple and elegant way to represent a user&amp;#39;s presence in multiple third party sites is through a separate &lt;code&gt;UserIdentity&lt;/code&gt; model.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g model UserIdentity user_id:integer email_id:integer uid:string provider:string
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;UserIdentity&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;
  validates &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:uid&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:provider&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;presence:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Our callback controller is intentially very simple. Depending on your use case you may want to check if the user is newly created and direct him&amp;#x2F;her to a profile completion page. For the sake of simplicity, we just redirect any user to the profile page.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Users::OmniauthCallbacksController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Devise::OmniauthCallbacksController&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;facebook&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@user&lt;/span&gt; = User.from_omniauth(request.env[&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;omniauth.auth&amp;quot;&lt;/span&gt;])
    sign_in_and_redirect &lt;span class=&#34;hljs-variable&#34;&gt;@user&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:event&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:authentication&lt;/span&gt; &lt;span class=&#34;hljs-comment&#34;&gt;#this will throw if &lt;span class=&#34;hljs-doctag&#34;&gt;@user&lt;/span&gt; is not activated&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the &lt;code&gt;from_omniauth&lt;/code&gt; class method of user we need to identify user based on the auth parameters passed.
Luckily facebook provides us with the email, so we can use that to identify a user.&lt;/p&gt;
&lt;p&gt;Four scenarios are possible:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User is signing up for the first time through facebook.&lt;/strong&gt;
In this case we just use the email obtained from facebook as the default email and register the user&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User already has an account and has chosen to login through facebook for the first time&lt;/strong&gt;
We can identify this situation if user&amp;#39;s existing email is the same as the one he has used in Facebook. In this case we create a new UserIdentity for an existing user.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using the same email&lt;/strong&gt;
Nothing needs to be created. We just log the user in.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using a different email&lt;/strong&gt;
We keep the existing email, but associate the user identity with the new email.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here is our implementation&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  ...

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.from_omniauth auth

    email = Email
      .includes(&lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;)
      .where(&lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; auth.info.email)
      .first_or_initialize

    ui = UserIdentity
      .where(&lt;span class=&#34;hljs-symbol&#34;&gt;provider:&lt;/span&gt; auth.provider, &lt;span class=&#34;hljs-symbol&#34;&gt;uid:&lt;/span&gt; auth.uid)
      .first_or_initialize

    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ui.persisted?
      &lt;span class=&#34;hljs-comment&#34;&gt;# Existing user, Existing social identity&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ! email.persisted?
        &lt;span class=&#34;hljs-comment&#34;&gt;# Email changed on third party site&lt;/span&gt;
        email.user = ui.user
        email.save!
        ui.email = email
      &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; email.user == ui.user
        ui.user
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        raise Exceptions::EmailConflict.new
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; email.persisted?
      &lt;span class=&#34;hljs-comment&#34;&gt;# Existing User, new identity&lt;/span&gt;
      ui.user = email.user
      ui.save!
      ui.user
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;hljs-comment&#34;&gt;# New user new identity&lt;/span&gt;
      email.save!
      user = &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt;.new(
        &lt;span class=&#34;hljs-symbol&#34;&gt;password:&lt;/span&gt; Devise.friendly_token[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;20&lt;/span&gt;],
        &lt;span class=&#34;hljs-symbol&#34;&gt;default_email:&lt;/span&gt; email
      )
      user.save!
      ui.user = user
      ui.email = email
      ui.save!
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    ui.user
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  ...

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The code above raises an &lt;code&gt;EmailConflict&lt;/code&gt; exception if we end up in a scenario where an existing user is logging in and the email is associated with another account. Gracefully handling the error is left as an exercise for the reader. Also we assume that the social login provider will provide us with an email.
While this is true for many providers like Github, not all providers provide with emails. A prominent example is twitter. Since this is not intended to be a comprehensive tutorial on omniauth, for the sake of brevity we don&amp;#39;t
elaborate on those scenarios. A good way to handle such a case would be to direct a user to a profile completion after login where he&amp;#x2F;she can enter the email and warn them if an account already exists for that email.&lt;/p&gt;
&lt;p&gt;So we conclude the post with a functional setup that allows a user to have multiple emails associated with a devise account. Feel free to bug me if you face any issues. Any comments and suggestions are also welcome.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="Rails" />
        <category term="Devise" />
        <category term="Integration" />
        <updated>2014-09-07T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2014/09/03/in-memory-zipping-ruby.html</id>
        <title>In-Memory Zipping in Ruby</title>
        <link rel="alternate" href="https://lorefnon.me/2014/09/03/in-memory-zipping-ruby.html"/>
        <content type="html">&lt;p&gt;&lt;a href=&#34;https://github.com/rubyzip/rubyzip&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Rubyzip&lt;/a&gt; is pretty much the defacto solution for manipulating zip files in ruby. However an underdocumented feature of this library is that it allows for creating zip files in memory ie. without actually writing anything to a file.&lt;/p&gt;
&lt;p&gt;There are many situations when this can come in handy. For example in a Web application it may be faster to zip a small number of files on the fly and deliver it to client without writing to disc. This is especially handy in cloud environments where direct disc access is prohibited.&lt;/p&gt;
&lt;p&gt;This can be accomplished as follows:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;file_stream = Zip::ZipOutputStream.write_buffer &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;zip&lt;/span&gt;|
  zip.put_next_entry &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;hello.txt&amp;quot;&lt;/span&gt;
  zip.print &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Hello World&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above creates a zip file with a single file hello.txt containing the text &amp;quot;Hello World&amp;quot;&lt;/p&gt;
&lt;p&gt;Creating directory structures is just as easy:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;file_stream = Zip::ZipOutputStream.write_buffer &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;zip&lt;/span&gt;|
  zip.put_next_entry &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;dir1/hello.txt&amp;quot;&lt;/span&gt;
  zip.print &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Hello&amp;quot;&lt;/span&gt;
  zip.put_next_entry &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;dir2/hello.txt&amp;quot;&lt;/span&gt;
  zip.print &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;World&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Finally, before we can read from the stream we will have to rewind it first. As an illustrative example the following shows a typical Rails controller that renders a zipped file to client.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;SomeController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ApplicationController&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;some_action&lt;/span&gt;
    file_stream = Zip::ZipOutputStream.write_buffer &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;zip&lt;/span&gt;|
      zip.put_next_entry &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;dir1/hello.txt&amp;quot;&lt;/span&gt;
      zip.print &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Hello&amp;quot;&lt;/span&gt;
      zip.put_next_entry &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;dir2/hello.txt&amp;quot;&lt;/span&gt;
      zip.print &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;World&amp;quot;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    file_stream.rewind
    respond_to &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;format&lt;/span&gt;|
      format.zip &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
        send_data file_stream.read, &lt;span class=&#34;hljs-symbol&#34;&gt;filename:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;zip_file.zip&amp;quot;&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;A user visiting this action will be downloading a file named zip_file.zip containing two files in their respective directories.&lt;/p&gt;
&lt;p&gt;For &lt;code&gt;format.zip&lt;/code&gt; to be available we will have to register &lt;code&gt;application/zip&lt;/code&gt; mimetype. Add the following to an initializer:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;Mime::Type.register &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;application/zip&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:zip&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This concludes this small article. Please feel free to leave your suggestions in the comments below.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <updated>2014-09-03T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2014/07/27/optimizing-sti-columns.html</id>
        <title>Optimizing space taken by type column in Rails STI</title>
        <link rel="alternate" href="https://lorefnon.me/2014/07/27/optimizing-sti-columns.html"/>
        <content type="html">&lt;p&gt;The &lt;a href=&#34;http://api.rubyonrails.org/classes/ActiveRecord/Base.html#label-Single+table+inheritance&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Single Table Inheritance&lt;/a&gt;
facility in Rails is quite awesome in that it is simple, minimal and easy to understand.
However that simplicity comes with a small price - the type column stores the full name of the relevant class as a string.
This becomes especially unweildy if you scope your models inside a module.&lt;/p&gt;
&lt;p&gt;Let us illustrate this with an example:&lt;/p&gt;
&lt;p&gt;Let us say, we have a database of institutions. For non profit and commercial institutions we have two subclasses of &lt;code&gt;Institution::Base&lt;/code&gt; namely, &lt;code&gt;Institution::NonProfit&lt;/code&gt;, &lt;code&gt;Institution::Commercial&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;#app/models/institution.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Institution
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.table_name_prefix
    &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;institution_&amp;#x27;&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;# app/models/institution/base.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Base&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;#app/models/institution/non_profit.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::NonProfit&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Institution::Base&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;#app/models/institution/commercial.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Commercial&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Institution::Base&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We deliberately keep the schema simple:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;create_table &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;institution_bases&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;force:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;t&lt;/span&gt;|
    t.string   &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;
    t.string   &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;
    t.datetime &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;created_at&amp;quot;&lt;/span&gt;
    t.datetime &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;updated_at&amp;quot;&lt;/span&gt;
 &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The subclasses simply reuse the table and Rails distinguishes between them using the type column. If we  try to store some sample entries, we would notice that the value stored in type field contains the fully namespaces class name: &lt;code&gt;Institution::NonProfit&lt;/code&gt;, &lt;code&gt;Institution::Commercial&lt;/code&gt; etc.&lt;/p&gt;
&lt;p&gt;Since we know that our application will not store models from other namespace in this table, the extra space taken by the module name is wasteful. In fact storing the name in its entirety is wasteful. So this post highlights a simple approach to minimise the space taken by type column without sacrificing the ease of use of STI in rails.&lt;/p&gt;
&lt;p&gt;It turns out we can override the methods Rails uses to convert the table name to class name and vice versa:&lt;/p&gt;
&lt;p&gt;The relevant methods are &lt;code&gt;find_sti_class&lt;/code&gt; which is responsible for the translating the value stored in the type column to the respective ActiveRecord model and &lt;code&gt;sti_name&lt;/code&gt; which is responsible for retriving the value stored in type column given an ActiveRecord subclass.&lt;/p&gt;
&lt;p&gt;So we override the default implementations to the following:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Base&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  &lt;span class=&#34;hljs-variable constant_&#34;&gt;ALLOWED_CLASSES&lt;/span&gt; = &lt;span class=&#34;hljs-string&#34;&gt;%w[Institution::NonProfit Institution::Commercial]&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &amp;lt;&amp;lt; &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;find_sti_class&lt;/span&gt; type_name
      idx = type_name.to_i
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
      &lt;span class=&#34;hljs-variable constant_&#34;&gt;ALLOWED_CLASSES&lt;/span&gt;[idx-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;].constantize
    &lt;span class=&#34;hljs-keyword&#34;&gt;rescue&lt;/span&gt; NameError, TypeError
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_name&lt;/span&gt;
      idx = &lt;span class=&#34;hljs-variable constant_&#34;&gt;ALLOWED_CLASSES&lt;/span&gt;.index(&lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.name)
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
        &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        idx + &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have done this the STI subsystem of ActiveRecord will the use the &lt;code&gt;ALLOWED_CLASSES&lt;/code&gt; to infer the name Institution classes using the index stored in the database column.&lt;/p&gt;
&lt;p&gt;What is particularly nice is that if have any existing data, we don&amp;#39;t end up getting
any errors when trying to save or retrieve them since we delegate to default implementations. Although it would be a better option to write a migration to change the type column to integer.&lt;/p&gt;
&lt;p&gt;The eagle eyed among us might have noticed we are offsetting the index in the &lt;code&gt;ALLOWED_CLASSES&lt;/code&gt; index by 1. This is a basic precaution because calling &lt;code&gt;to_i&lt;/code&gt; on a string that is not a numeric string returns &lt;code&gt;0&lt;/code&gt; instead of raising an error. So delegating to default implementation incase of zero value allows us to retain legacy compatibility.&lt;/p&gt;
&lt;p&gt;You might want to ask why the array ALLOWED_CLASS_NAMES is a string array rather than an actual array of classes. Having an array of classes leads to RecursiveDependency errors while autoloading when fetching the entries from databases.&lt;/p&gt;
&lt;p&gt;While this is nice and good, this functionality is generic and doesn&amp;#39;t really belong to the &lt;code&gt;Institution::Base&lt;/code&gt; class. What if we need another module tomorrow which is unreleated but needs the same functionality?&lt;/p&gt;
&lt;p&gt;So in the spirit of reusability and separation of concerns we create a &lt;code&gt;concern&lt;/code&gt; for this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; OptimallyInheritable
  extend ActiveSupport::Concern

  &lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; ClassMethods
    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;support_sti_for&lt;/span&gt; cls_list
      &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt; = []
      &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt; += cls_list
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_cls_list&lt;/span&gt;
      &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;find_sti_class&lt;/span&gt; type_name
      idx = type_name.to_i
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
      sti_cls_list[type_name.to_i-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;].constantize
    &lt;span class=&#34;hljs-keyword&#34;&gt;rescue&lt;/span&gt; NameError, TypeError
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_name&lt;/span&gt;
      idx = sti_cls_list.index(&lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.name)
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
        &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        idx + &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And our &lt;code&gt;Institution::Base&lt;/code&gt; class just reduces to:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Base&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;include&lt;/span&gt; OptimallyInheritable
  support_sti_for &lt;span class=&#34;hljs-string&#34;&gt;%w[Institution::NonProfit Institution::Commercial]&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All seems kosher, so we take our implementation for a test drive:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; Institution::Base.all
Institution::Base Load (0.4ms)  SELECT `institution_bases`.* FROM `institution_bases`
=&amp;gt; #&amp;lt;ActiveRecord::Relation [#&amp;lt;Institution::Commercial id: 3, name: &amp;quot;loremipsum&amp;quot;, type: &amp;quot;2&amp;quot;, created_at: &amp;quot;2014-07-17 12:27:26&amp;quot;, updated_at: &amp;quot;2014-07-17 12:27:26&amp;quot;&amp;gt;]&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;While laoding instances of base class works well, we run into issues when we try to load all commercial
institutions:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;2.1.2 :005 &amp;gt; Institution::Commercial.all
NoMethodError: undefined method `index&amp;#39; for nil:NilClass
               from /Users/lorefnon/Workspace/sample/app/models/concerns/optimally_inheritable.rb:24:in `sti_name&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/inheritance.rb:170:in `block in type_condition&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/inheritance.rb:170:in `map&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/inheritance.rb:170:in `type_condition&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/core.rb:170:in `relation&amp;#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The problem is obvious : the variable &lt;code&gt;sti_class_list&lt;/code&gt; is not available in subclasses.&lt;/p&gt;
&lt;p&gt;So we rectify our solution:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_cls_list&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; superclass.respond_to? &lt;span class=&#34;hljs-symbol&#34;&gt;:sti_cls_list&lt;/span&gt;
    superclass.sti_cls_list
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This resolves the aforementioned issues.&lt;/p&gt;
&lt;p&gt;Now that we have reached the end of the post, it would be a good time to highlight the drawbacks of our approach:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Firstly, The array passed to &lt;code&gt;support_sti_for&lt;/code&gt; function will have to be kept in sync with the class names, if the name of any model class changes in future.&lt;/li&gt;
&lt;li&gt;Secondly, While it is safe to add new entries to supported classes, their order can not be arbitrarily changed without running a data correction script first.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This concludes our post. The full source code is available at &lt;a href=&#34;https://github.com/lorefnon/sti_optimization_demo.git&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Github&lt;/a&gt;. As always, any criticism or feedback is welcome.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="Rails" />
        <category term="ActiveRecord" />
        <updated>2014-07-27T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2014/07/13/presenting-sql-views-through-active-admin.html</id>
        <title>Presenting SQL views through ActiveAdmin</title>
        <link rel="alternate" href="https://lorefnon.me/2014/07/13/presenting-sql-views-through-active-admin.html"/>
        <content type="html">&lt;p&gt;&lt;a href=&#34;http://en.wikipedia.org/wiki/View_(SQL)&#34;&gt; SQL Views &lt;/a&gt; are a handy feature that allow us to
save a query whose results are computed&amp;#x2F;collated dynamically whenever the view is requested.
Because the abstraction provided by a view is semantically close to a table we can leverage
ActiveRecord to interface with the view through a proxy model and use it to
present the result set through &lt;a href=&#34;http://activeadmin.info/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;ActiveAdmin&lt;/a&gt; interface.&lt;/p&gt;
&lt;p&gt;This can be very useful for reporting and visual inspection, especially by
non technical staff.&lt;/p&gt;
&lt;p&gt;The rest of the post elaborates on a simple approach for doing this through
code examples. Please note that henceforth we use the term view
to refer to an SQL View rather than Rails view templates. Also the code is
written for Rails 4 but should be usable with Rails 3 as well.&lt;/p&gt;
&lt;p&gt;For the sake of illustration we use an example database containing
geographical information of Indian cities. The full code is available &lt;a href=&#34;https://github.com/lorefnon/active_admin_view_demo&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;here&lt;/a&gt;.
For brevity we just mention the generator commands and
model classes here:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs sh&#34;&gt;rails g model City name:string district_id:&lt;span class=&#34;hljs-built_in&#34;&gt;integer&lt;/span&gt;
rails g model District name:string state_id:&lt;span class=&#34;hljs-built_in&#34;&gt;integer&lt;/span&gt;
rails g model State name:string&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;# app/models/state.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;State&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:districts&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:cities&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;through:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:districts&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;# app/models/district.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;District&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:state&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:cities&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;# app/models/city.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;City&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:district&lt;/span&gt;
  has_one &lt;span class=&#34;hljs-symbol&#34;&gt;:state&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;through:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:district&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note: Using the most recent Rails version, 4.1.4, will cause numerous dependency
conflicts, hence we use Rails 4.0.0 with ActiveAdmin edge.Since we don&amp;#39;t plan
to use any cutting edge features in this example this should be an acceptable
compromise.&lt;/p&gt;
&lt;p&gt;We stick to default Devise based AdminUser for authentication. Once we generate
active admin resources for our models, we have something like this:&lt;/p&gt;
&lt;img src=&#34;/images/active_admin_states.png&#34; /&gt;
&lt;img src=&#34;/images/active_admin_districts.png&#34; /&gt;
&lt;img src=&#34;/images/active_admin_cities.png&#34; /&gt;

&lt;p&gt;The view that we intend to create combines the data in the three tables
joins.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;SELECT cities.id AS id, states.name AS state, districts.name AS district, cities.name AS city
FROM states
INNER JOIN districts ON districts.state_id = states.id
INNER JOIN cities ON cities.district_id = districts.id
&lt;/code&gt;&lt;/pre&gt;
&lt;img src=&#34;/images/joins_states.png&#34; /&gt;

&lt;p&gt;To create the view we generate a migration:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g migration create_state_district_city_view
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;CreateStateDistrictCityView&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Migration&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;up&lt;/span&gt;
    &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.connection.execute &lt;span class=&#34;hljs-string&#34;&gt;%Q( CREATE OR REPLACE VIEW state_district_city_view AS&lt;/span&gt;
&lt;span class=&#34;hljs-string&#34;&gt;      SELECT cities.id AS id, states.name AS state, districts.name AS district, cities.name AS city&lt;/span&gt;
&lt;span class=&#34;hljs-string&#34;&gt;      FROM states&lt;/span&gt;
&lt;span class=&#34;hljs-string&#34;&gt;      INNER JOIN districts ON districts.state_id = states.id&lt;/span&gt;
&lt;span class=&#34;hljs-string&#34;&gt;      INNER JOIN cities ON cities.district_id = districts.id&lt;/span&gt;
&lt;span class=&#34;hljs-string&#34;&gt;    )&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;down&lt;/span&gt;
    &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.connection.execute &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;DROP VIEW IF EXISTS state_district_city_view;&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now a view, as far as read access is concerned, behaves similar to a table, we
can just define a normal ActiveRecord model to access this view.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;StateDistrictCityViewProxy&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
    &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.table_name = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;state_district_city_view&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can take the proxy model for a test drive using IRB:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&amp;gt; StateDistrictCityViewProxy.limit(&lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;).to_a
  StateDistrictCityViewProxy Load (&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;.4ms)  &lt;span class=&#34;hljs-variable constant_&#34;&gt;SELECT&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;`state_district_city_view`&lt;/span&gt;.* &lt;span class=&#34;hljs-variable constant_&#34;&gt;FROM&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;`state_district_city_view`&lt;/span&gt; &lt;span class=&#34;hljs-variable constant_&#34;&gt;LIMIT&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;
=&amp;gt; [#&amp;lt;StateDistrictCityViewProxy id: 1, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Agali&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 2, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Amadagur&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 3, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Amarapuram&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 4, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Anantapur&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 5, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Atmakur&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 6, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Bathalapalle&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 7, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Beluguppa&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 8, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Bommanahal&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 9, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Brahmasamudram&amp;quot;&amp;gt;, #&amp;lt;StateDistrictCityViewProxy id: 10, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Bukkapatnam&amp;quot;&amp;gt;]&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we have a model, generating an ActiveAdmin resource is as simple as:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt; rails g active_admin:resource StateDistrictCityViewProxy
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;At this point upon visiting the index page in ActiveAdmin we might have expected
a fancy paginated table but instead we are greeted with a not-so-helpful error:&lt;/p&gt;
&lt;img src=&#34;/images/err1.png&#34;/&gt;

&lt;p&gt;The problem is immediately obvious if we try to get the attributes of a model instance:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; s1 = StateDistrictCityViewProxy.first
  StateDistrictCityViewProxy Load (0.3ms)  SELECT `state_district_city_view`.* FROM `state_district_city_view` LIMIT 1
=&amp;gt; #&amp;lt;StateDistrictCityViewProxy id: 1, state: &amp;quot;Andhra Pradesh&amp;quot;, district: &amp;quot;Anantapur&amp;quot;, city: &amp;quot;Agali&amp;quot;&amp;gt;
&amp;gt; s1.attributes
=&amp;gt; &amp;#123;&amp;quot;id&amp;quot;=&amp;gt;1, &amp;quot;state&amp;quot;=&amp;gt;&amp;quot;Andhra Pradesh&amp;quot;, &amp;quot;district&amp;quot;=&amp;gt;&amp;quot;Anantapur&amp;quot;, &amp;quot;city&amp;quot;=&amp;gt;&amp;quot;Agali&amp;quot;, nil=&amp;gt;nil&amp;#125;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;So the question is where is the nil coming from? The problem is that an SQL view doesn&amp;#39;t have a primary key. Rails doesn&amp;#39;t automatically
assume that our &lt;code&gt;id&lt;/code&gt; field is a primary key.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; StateDistrictCityViewProxy.primary_key
=&amp;gt; nil
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;We can not somehow add a primary key to an SQL view, that is utterly pointless. However we can force ActiveRecord to use the &lt;code&gt;id&lt;/code&gt; attribute
as primary key.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;StateDistrictCityViewProxy&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.table_name = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;state_district_city_view&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.primary_key = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And voila. We have our fancy table:&lt;/p&gt;
&lt;img src=&#34;/images/active_admin_view.png&#34;/&gt;

&lt;h1 id=&#34;Caveats&#34;&gt;&lt;a href=&#34;#Caveats&#34; class=&#34;headerlink&#34; title=&#34;Caveats:&#34;&gt;&lt;/a&gt;Caveats:&lt;/h1&gt;&lt;p&gt;While everything looks great at this point, our setup has a couple of issues that need to be resolved:&lt;/p&gt;
&lt;h2 id=&#34;schema-rb&#34;&gt;&lt;a href=&#34;#schema-rb&#34; class=&#34;headerlink&#34; title=&#34;schema.rb&#34;&gt;&lt;/a&gt;schema.rb&lt;/h2&gt;&lt;p&gt;If you take a look at schema.rb the problem immediately becomes obvious. Nothing about our view is to be found.
The problem is that Rails is blissfully oblivious of our SQL views and the sql statements
in our migrations have not introducted any changes in schema.rb. So when you regenerate the database from
schema.yml the view will not be created. This has multiple solutions. A simple one
is to get rid of schema.rb in favor of sql schema format.&lt;/p&gt;
&lt;p&gt;In config&amp;#x2F;application.rb:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;config.active_record.schema_format = :sql
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next time we run &lt;code&gt;rake db:migrate&lt;/code&gt; a &lt;code&gt;structure.sql&lt;/code&gt; file will be generated that contains the SQL
for generating our views.&lt;/p&gt;
&lt;p&gt;An alternative option is the gem &lt;a href=&#34;https://github.com/lomba/schema_plus&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;schema_plus&lt;/a&gt; that augments ActiveRecord
with support for views among other advanced database features.&lt;/p&gt;
&lt;h2 id=&#34;Edit-x2F-Delete-actions&#34;&gt;&lt;a href=&#34;#Edit-x2F-Delete-actions&#34; class=&#34;headerlink&#34; title=&#34;Edit&amp;#x2F;Delete actions&#34;&gt;&lt;/a&gt;Edit&amp;#x2F;Delete actions&lt;/h2&gt;&lt;p&gt;Our ActiveAdmin view table has been blessed with &lt;code&gt;Edit&lt;/code&gt; and &lt;code&gt;Delete&lt;/code&gt; actions for every row, which
oviously trigger an error. For example, here is what we end up with when clicking on &lt;code&gt;Delete&lt;/code&gt; :&lt;/p&gt;
&lt;img src=&#34;/images/err2.png&#34;/&gt;

&lt;p&gt;Let us declare the proxy model as readonly.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;StateDistrictCityViewProxy&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.table_name = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;state_district_city_view&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.primary_key = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;id&amp;quot;&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;readonly?&lt;/span&gt;
    &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next we simply remove the irrelevant actions from the ActiveAdmin view:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register StateDistrictCityViewProxy &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;

  actions &lt;span class=&#34;hljs-symbol&#34;&gt;:index&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:show&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that the quirks of our setup have been ironed out, feel free to go ahead and try it out.
Of course SQL views are not the only solution for a problem like this and the aforementioned table could have been
built entirely through DSLs provided by ActiveAdmin. But nonetheless, SQL views are something that
most DBAs are already familiar with and is a hassle free setup. If you already have a legacy database
with views or need to use views for other auxiliary purposes, the aforementioned approach may make
things easy for you.&lt;/p&gt;
&lt;p&gt;Any suggestion or criticism is welcome.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="Rails" />
        <category term="ActiveAdmin" />
        <updated>2014-07-13T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2012/09/08/creating-a-basic-command-line-based-todo-app-using-ruby-and-sqlite.html</id>
        <title>Creating a basic command line based todo app using ruby and sqlite.</title>
        <link rel="alternate" href="https://lorefnon.me/2012/09/08/creating-a-basic-command-line-based-todo-app-using-ruby-and-sqlite.html"/>
        <content type="html">&lt;p&gt;This tutorial aims to demonstrate how Ruby can be used to create simple command line applications.  A basic familiarity with Ruby and SQLite is assumed. Also availability of a POSIX compliant system is assumed. Although it is quite possible to port this tutorial to other proprietary platforms, I will not make any effort in this regard because of sheer lack of interest. In the tutorial, we create a simple command line based Task management application which is persisted through a local sqlite database. Thanks to the awesome commander library for ruby, the usual legwork of dealing with command line arguments and managing flags is greatly simplified.&lt;/p&gt;
&lt;p&gt;Hopefully you are already using RVM. So we begin by creating a new gemset :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rvm gemset create task-trooper
rvm gemset use task-trooper
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Running gem list presents us with the following :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;*** LOCAL GEMS ***

bundler (1.1.5)
rake (0.9.2.2)
rubygems-bundler (1.0.3)
rvm (1.11.3.5)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If you are not using rvm (though I would highly recommend you to use it) you would have to manually install bundler at this point.&lt;/p&gt;
&lt;p&gt;If you don’t already have SQLite, you will have to install it using your favourite package manager. Installation for ubuntu is as simple as :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;sudo apt-get install sqlite3 libsqlite3-dev
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Let us create a project directory and a Gemfile for managing our ruby dependencies :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir task-trooper
cd task-trooper
touch Gemfile
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Populate your gemfile with the following :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;source &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;http://rubygems.org&amp;quot;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;commander&amp;quot;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;sqlite3&amp;quot;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;sequel&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;and run &lt;strong&gt;bundle install&lt;/strong&gt;.
Commander is a ruby library for managing command line arguments. sqlite3 is the ruby adapter for sqlite. And since we don’t want to dabble with SQL strings, we use a simple ruby ORM – Sequel.
If all goes well, the dependencies will be fetched and you should see something like this :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;Fetching gem metadata from http://rubygems.org/........
Using highline (1.6.14)
Using commander (4.1.2)
Using sequel (3.39.0)
Installing sqlite3 (1.3.6) with native extensions
Using bundler (1.1.5)
Your bundle is complete! Use `bundle show [gemname]` to see where a bundled gem is installed.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Now, let us begin with the actual application code.
We will eventually deploy it as a rubygem. For now let us just focus on the core essentials.
For now our application code resides in a single file : task-trooper.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;rubygems&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;bundler/setup&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;commander/import&amp;#x27;&lt;/span&gt;

program &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Task Trooper&amp;quot;&lt;/span&gt;
program &lt;span class=&#34;hljs-symbol&#34;&gt;:version&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;1.0.0&amp;#x27;&lt;/span&gt;
program &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;A simple command line based task manager&amp;#x27;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above code does not add a lot of functionality, it simply simply supplies the name of the application and some version related information. Nevertheless the commander DSL takes care of some bootstrapping for us. Try running the follwing :
    $ ruby task-trooper.rb&lt;/p&gt;
&lt;p&gt;This was expected. Let us see what help has to offer:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ ruby task-trooper.rb --help

  NAME:

    Task Trooper

  DESCRIPTION:

    A simple command line based task manager

  COMMANDS:

    help                 Display global or [command] help documentation.

  GLOBAL OPTIONS:

    -h, --help
        Display help documentation

    -v, --version
        Display version information

    -t, --trace
        Display backtrace when an error occurs
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Not so bad, huh ?&lt;/p&gt;
&lt;p&gt;Now we extend our code to incorporate database features :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;rubygems&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;bundler/setup&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;commander/import&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;sequel&amp;#x27;&lt;/span&gt;

program &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Task Trooper&amp;quot;&lt;/span&gt;
program &lt;span class=&#34;hljs-symbol&#34;&gt;:version&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;1.0.0&amp;#x27;&lt;/span&gt;
program &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;A simple command line based task manager&amp;#x27;&lt;/span&gt;

&lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt; = Sequel.sqlite(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;tasks_db.db&amp;#x27;&lt;/span&gt;)

&lt;span class=&#34;hljs-keyword&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt;.table_exists? &lt;span class=&#34;hljs-symbol&#34;&gt;:tasks&lt;/span&gt;
  &lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt;.create_table(&lt;span class=&#34;hljs-symbol&#34;&gt;:tasks&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
      primary_key &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;
  String &lt;span class=&#34;hljs-symbol&#34;&gt;:title&lt;/span&gt;
  String &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
  Boolean &lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

ds = &lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt;[&lt;span class=&#34;hljs-symbol&#34;&gt;:tasks&lt;/span&gt;]&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above piece of code shows how easy it is to use the Sequel library to manage database. The above code simply checks for the existence of a database table. In case the table does not exist, it is created. For now we keep the schema simple. Please note that thanks to database-agonistic api of Sequel you can use any other database here instead of Sqlite and all that would require is the alteration of one single line of configuration. Its time now to implement our first command :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;command &lt;span class=&#34;hljs-symbol&#34;&gt;:new&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;c&lt;/span&gt;|
  c.syntax = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper new&amp;#x27;&lt;/span&gt;
  c.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Creates a new task&amp;#x27;&lt;/span&gt;
  c.action &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;args, options&lt;/span&gt;|
    puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Task created!&amp;#x27;&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The syntax and description methods simply provide the metadata which will be presented in the help text. As far as the actual action is concerned, it simply
prints ‘Task created!’ and exits.&lt;/p&gt;
&lt;p&gt;Lets checkout if the command new is actually available.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ ruby task-trooper.rb new

Task created!

$ ruby task-trooper.rb new --help

  NAME:

    new

  SYNOPSIS:

    task-trooper new

  DESCRIPTION:

    Creates a new task
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Great ! That works. Of course, at this point our task does not do anything. So let us add some functionality.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;command &lt;span class=&#34;hljs-symbol&#34;&gt;:new&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;c&lt;/span&gt;|
  c.syntax = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper new&amp;#x27;&lt;/span&gt;
  c.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Creates a new task&amp;#x27;&lt;/span&gt;
  c.option &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;--title STRING&amp;#x27;&lt;/span&gt;, String, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Title of the task&amp;#x27;&lt;/span&gt;
  c.option &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;--description STRING&amp;#x27;&lt;/span&gt;, String, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Task Description&amp;#x27;&lt;/span&gt;
  c.action &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;args, options&lt;/span&gt;|
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; options.title.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
      options.title = ask(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Provide a title for the task :&amp;#x27;&lt;/span&gt;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; options.description.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
      options.description = ask(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Provide a description for the task :&amp;#x27;&lt;/span&gt;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    ds.insert(&lt;span class=&#34;hljs-symbol&#34;&gt;:title&lt;/span&gt; =&amp;gt; options.title, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt; =&amp;gt; options.description, &lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;)
    say &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Task added !&amp;#x27;&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, in the above code we specified the options that this command will expect.
if the title and description are not provided, the user will be prompted for
these options. Once both title and description are available, a record will be
inserted in the database.&lt;/p&gt;
&lt;p&gt;Next, we need some way to show to the list of tasks. That’s not difficult either.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;command &lt;span class=&#34;hljs-symbol&#34;&gt;:list&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;c&lt;/span&gt;|
  c.syntax = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper list&amp;#x27;&lt;/span&gt;
  c.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Lists the tasks.&amp;#x27;&lt;/span&gt;
  c.action &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;args, options&lt;/span&gt;|
    ds.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;task&lt;/span&gt;|
      status = &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; task[&lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt;] &lt;span class=&#34;hljs-keyword&#34;&gt;then&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;completed&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;pending&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
      puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Task [&lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;task[&lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;]&amp;#125;&lt;/span&gt;] - &amp;lt;&lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;status&amp;#125;&lt;/span&gt;&amp;gt; : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;task[&lt;span class=&#34;hljs-symbol&#34;&gt;:title&lt;/span&gt;]&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    pending_count = ds.where(&lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;).count
    count = ds.count
    completed_count = count - pending_count
    puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;\n&amp;quot;&lt;/span&gt;
    puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Out of &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;count&amp;#125;&lt;/span&gt; Total Tasks : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;pending_count&amp;#125;&lt;/span&gt; pending, &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;completed_count&amp;#125;&lt;/span&gt; completed.&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So, at this point basic creation and listing of tasks is available to us.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;$ ruby task-trooper.rb new --title &amp;quot;Water plants&amp;quot; --description &amp;quot;The plants in the garden have to be watered before sundown.&amp;quot;
Task added !

$ ruby task-trooper.rb new
Provide a title for the task :
Add fertilizer
Provide a description for the task :
Add some fertilizer to the pot of roses.
Task added !

$ ruby task-trooper.rb list
Task [1] - &amp;lt;pending&amp;gt; : Water plants
Task [2] - &amp;lt;pending&amp;gt; : Add fertilizer

Out of 2 Total Tasks : 2 pending, 0 completed.
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next, we need a way to mark a task as completed :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;command &lt;span class=&#34;hljs-symbol&#34;&gt;:done&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;c&lt;/span&gt;|
  c.syntax = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper done &amp;lt;id&amp;gt;&amp;#x27;&lt;/span&gt;
  c.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Mark a task as done&amp;#x27;&lt;/span&gt;
  c.action &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;args, options&lt;/span&gt;|
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; args.first.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
      puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Please specify the task to be marked as complete&amp;#x27;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      items = ds.where(&lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt; =&amp;gt; args.first)
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; items.count &amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
        items.update(&lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;)
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Updated&amp;quot;&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;No item found&amp;#x27;&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Try running &lt;strong&gt;ruby task-trooper.rb done 1&lt;/strong&gt; follwed by &lt;strong&gt;ruby task-trooper.rb list&lt;/strong&gt;
to make sure that the task has indeed been marked as done.&lt;/p&gt;
&lt;p&gt;After this, we add facility to show details for a task and delete a task :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;command &lt;span class=&#34;hljs-symbol&#34;&gt;:show&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;c&lt;/span&gt;|
  c.syntax = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper show &amp;lt;id&amp;gt;&amp;#x27;&lt;/span&gt;
  c.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Shows the description of a task&amp;#x27;&lt;/span&gt;
  c.action &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;args, options&lt;/span&gt;|
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; args.first.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
      puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Please specify the task to be shown.&amp;quot;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      ds.where(&lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt; =&amp;gt; args.first).each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;task&lt;/span&gt;|
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Title : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;task[&lt;span class=&#34;hljs-symbol&#34;&gt;:title&lt;/span&gt;]&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Description : &amp;quot;&lt;/span&gt;
        puts task[&lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;]
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Completed : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;task[&lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt;]&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

command &lt;span class=&#34;hljs-symbol&#34;&gt;:delete&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;c&lt;/span&gt;|
  c.syntax = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper delete &amp;lt;id&amp;gt;&amp;#x27;&lt;/span&gt;
  c.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Delete a task&amp;#x27;&lt;/span&gt;
  c.action &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;args, options&lt;/span&gt;|
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; args.first.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
      puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Please specify the task to be deleted&amp;quot;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      items = ds.where(&lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt; =&amp;gt; args.first)
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; items.count &amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
        items.delete
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Deleted&amp;quot;&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;No task found&amp;quot;&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that we have all the basic facilities up and running, lets us proceed to
create a ruby gem so we can make the application available to other users.&lt;/p&gt;
&lt;p&gt;We create a bin director, move our script to it and make it executable.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;mkdir bin
mv task-trooper.rb bin/task-trooper
chmod a+x bin/task-trooper
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Also, we need to add a shebang to direct the shell to run it with ruby.
    #!&amp;#x2F;usr&amp;#x2F;bin&amp;#x2F;env ruby&lt;/p&gt;
&lt;p&gt;Next, we need to add a gemspec to specify the required metadata for the
gem.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-title class_&#34;&gt;Gem::Specification&lt;/span&gt;.new &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;s&lt;/span&gt;|
  s.name = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper&amp;#x27;&lt;/span&gt;
  s.version = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;1.0.0&amp;#x27;&lt;/span&gt;
  s.date = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;2012-09-09&amp;#x27;&lt;/span&gt;
  s.summary = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Task Trooper&amp;quot;&lt;/span&gt;
  s.description = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Simple command line based task manager&amp;quot;&lt;/span&gt;
  s.authors = [ &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Lorefnon&amp;quot;&lt;/span&gt; ]
  s.email = &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;lorefnon@gmail.com&amp;#x27;&lt;/span&gt;
  s.executables &amp;lt;&amp;lt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;task-trooper&amp;#x27;&lt;/span&gt;

  [&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;commander&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;sqlite3&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;sequel&amp;#x27;&lt;/span&gt;].each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;dep&lt;/span&gt;|
    s.add_dependency dep
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We might also want to have our sqlite database in a hidden folder in user’s
home directory. This is easily accomplished :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;config_dir = File.expand_path(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;~/.task-trooper&amp;#x27;&lt;/span&gt;)
&lt;span class=&#34;hljs-keyword&#34;&gt;unless&lt;/span&gt; Dir[config_dir].length &amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
  Dir::mkdir(config_dir)
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt; = Sequel.sqlite(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;config_dir&amp;#125;&lt;/span&gt;/tasks.db&amp;quot;&lt;/span&gt;)

&lt;span class=&#34;hljs-keyword&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt;.table_exists? &lt;span class=&#34;hljs-symbol&#34;&gt;:tasks&lt;/span&gt;
  &lt;span class=&#34;hljs-variable constant_&#34;&gt;DB&lt;/span&gt;.create_table(&lt;span class=&#34;hljs-symbol&#34;&gt;:tasks&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
    primary_key &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;
    String &lt;span class=&#34;hljs-symbol&#34;&gt;:title&lt;/span&gt;
    String &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
    Boolean &lt;span class=&#34;hljs-symbol&#34;&gt;:completed&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Having done that, we can build our gem :
    gem build task-trooper.gemset&lt;/p&gt;
&lt;p&gt;We can test our gem in a fresh rvm gemset
    rvm gemset create test
    rvm gemset use test
    gem install .&amp;#x2F;task-trooper-1.0.0.gem&lt;/p&gt;
&lt;p&gt;Hold your breath while the dependencies are auto-matically fetched and installed. Now you can use task-trooper as you would use any other command line executable.
Here is an obligatory screenshot :&lt;/p&gt;
&lt;img src=&#34;/images/task_trooper.png&#34; /&gt;

&lt;p&gt;So in less than an hour we were able to create a simple but functional todo app which is persisted in an Sqlite database. We can easily see that creating simple command line applications is not at all cumbersome in ruby. I do really hope that you can expand upon the material presented above to create some nifty CLI-apps. For some inspiration do check out : cli-apps.org .&lt;/p&gt;
&lt;p&gt;Also, as usual feel free to provide your suggestions, criticism or details regarding any problems that you faced.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="SQLite" />
        <updated>2012-09-08T00:00:00.000Z</updated>
    </entry>
    <entry>
        <id>https://lorefnon.me/2012/08/15/a-websocket-powered-tic-tac-toe-game-using-ruby-eventmachine--part-1.html</id>
        <title>A Websocket powered Tic tac toe game using Ruby EventMachine – Part 1</title>
        <link rel="alternate" href="https://lorefnon.me/2012/08/15/a-websocket-powered-tic-tac-toe-game-using-ruby-eventmachine--part-1.html"/>
        <content type="html">&lt;p&gt;Lately I have been fiddling around a bit with websockets. Websocket support is now available in most of the modern browsers and Flash based shims are available for older browsers. Having bi-directional communication stream between server and the browser based client opens up a whole new world of opportunities for dynamic web applications.&lt;/p&gt;
&lt;p&gt;Implementing a web-socket server in ruby is fairly easy given the plethora of libraries available. One such useful gem is em-websocket which is essentially an Event-Machine based asynchronous web-socket server.&lt;/p&gt;
&lt;p&gt;In this post I present a small tutorial implementing a simple tic-tac-toe game. Though the game will be pretty barebones, I hope it will serve as a good introduction to web-socket api.&lt;/p&gt;
&lt;p&gt;In the part-1 we focus primarily on the server-part to which we can communicate from the browser using the javascript console. In later parts we will create a client side frontend and further enhance server side facilities.&lt;/p&gt;
&lt;p&gt;First, we ensure that Ruby is installed (I have used ruby-1.9.3 for the tutorial) . eventmachine and em-websocket are available as ruby gems. So installing them is as easy as :
    gem install eventmachine
    gem install em-websocket&lt;/p&gt;
&lt;p&gt;To see if em-websocket is working without hassles, run the following minimal web-socket implementation.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;eventmachine&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;em-websocket&amp;#x27;&lt;/span&gt;

EventMachine.run &amp;#123;

    EventMachine::WebSocket.start(&lt;span class=&#34;hljs-symbol&#34;&gt;:host&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;0.0.0.0&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:port&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;8080&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;ws&lt;/span&gt;|
        ws.onopen &amp;#123;
          puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;WebSocket connection open&amp;quot;&lt;/span&gt;
        &amp;#125;
        ws.onclose &amp;#123;
          puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Connection closed&amp;quot;&lt;/span&gt;
        &amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;What this code does is it creates a socket-server which listens at localhost:8080 . Callbacks have been provided for open and close events, so when a client creates a connection or a connection gets closed the associated callbacks print an appropriate message to the terminal.&lt;/p&gt;
&lt;p&gt;run the webserver with :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;ruby server.rb
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The server should go into an event-loop without any errors. Now fire up your browser’s javascript console (or NodeJS console) and try :&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;socket = new WebSocket(&amp;quot;ws://localhost:8080&amp;quot;)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;If all goes well, it should return true and the message “Websocket connection open” should be displayed in the terminal.&lt;/p&gt;
&lt;p&gt;So far, so good. But the main purpose of a server is to relay data to the client. How do we do that ? Turns out that is pretty simple too.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;EventMachine.run &amp;#123;

    EventMachine::WebSocket.start(&lt;span class=&#34;hljs-symbol&#34;&gt;:host&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;0.0.0.0&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:port&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;8080&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;ws&lt;/span&gt;|
        ws.onopen &amp;#123;
          puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;WebSocket connection open&amp;quot;&lt;/span&gt;
          &lt;span class=&#34;hljs-comment&#34;&gt;# publish message to the client&lt;/span&gt;
          ws.send &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Hello Client&amp;quot;&lt;/span&gt;
        &amp;#125;

        ws.onclose &amp;#123;
          puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Connection closed&amp;quot;&lt;/span&gt;
        &amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Using the send  method, the server sends data to the client. The client side socket has an onmessage event that enables you to recieve the data.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs javascript&#34;&gt;socket = &lt;span class=&#34;hljs-keyword&#34;&gt;new&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;WebSocket&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;ws://localhost:8080&amp;quot;&lt;/span&gt;);
socket.&lt;span class=&#34;hljs-property&#34;&gt;onmessage&lt;/span&gt; = &lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;(&lt;span class=&#34;hljs-params&#34;&gt;msg&lt;/span&gt;)&amp;#123;
    &lt;span class=&#34;hljs-variable language_&#34;&gt;console&lt;/span&gt;.&lt;span class=&#34;hljs-title function_&#34;&gt;log&lt;/span&gt;(msg.&lt;span class=&#34;hljs-property&#34;&gt;data&lt;/span&gt;)
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Remember we said something socket being a two-way communication channel. The send message is available on the client too and the message can be received in the server in very similar way :&lt;/p&gt;
&lt;p&gt;Let us modify our server to enable it to receive data.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ws.onmessage &amp;#123; |&lt;span class=&#34;hljs-params&#34;&gt;msg&lt;/span&gt;|
  puts msg
  ws.send msg
&amp;#125;&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;What it does is, it prints any data that it receives and relays it back to the client. So now if you run in the javascript console :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs javascript&#34;&gt;socket.&lt;span class=&#34;hljs-title function_&#34;&gt;send&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Hello world&amp;quot;&lt;/span&gt;)&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You should receive the message back.&lt;/p&gt;
&lt;p&gt;Now that we have a basic familiarity with the usage of web-sockets let’s proceed with our game :&lt;/p&gt;
&lt;p&gt;The flow of the game is like this : A client, after opening the connection, requests the server to register it. Upon registration, if a free player is available, then he is paired up with this player and game begins. If a player is not free the player is added to a queue and once a new player arrives , they both commence a new game.&lt;/p&gt;
&lt;p&gt;For now let us not delve into user-registration and score management and satisfy ourselves with an anonymous player vs player game.&lt;/p&gt;
&lt;p&gt;In the simple examples above we have only focussed on a single client at a time. If in response to the actions of a client other players have to be relayed information the situation becomes slightly complex. The typical way to deal with such scenarios is to use a Pub-sub system. While a redis based pub-sub system is an excellent solution, we are not using one here to keep things simple and also we have the advantage that it is priorly known that players will always interact in pairs.&lt;/p&gt;
&lt;p&gt;Let us organize our code in an object oriented fashion :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;GameController&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;add_player&lt;/span&gt; player
    &lt;span class=&#34;hljs-comment&#34;&gt;# if partner is available&lt;/span&gt;
    &lt;span class=&#34;hljs-comment&#34;&gt;#   pair_up with partner&lt;/span&gt;
    &lt;span class=&#34;hljs-comment&#34;&gt;# else&lt;/span&gt;
    &lt;span class=&#34;hljs-comment&#34;&gt;#   enqueue partner&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;pair_up&lt;/span&gt; player, partner
    &lt;span class=&#34;hljs-comment&#34;&gt;# create a new game&lt;/span&gt;
    &lt;span class=&#34;hljs-comment&#34;&gt;# appoint one of the player as first, and start the game&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;end_game&lt;/span&gt; game, players
    &lt;span class=&#34;hljs-comment&#34;&gt;# re-allocate partner if someone is waiting&lt;/span&gt;
    &lt;span class=&#34;hljs-comment&#34;&gt;# ... call add_player - and a new game proceeds&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

EventMachine.run &amp;#123;
  &lt;span class=&#34;hljs-variable&#34;&gt;@gc&lt;/span&gt; = GameController.new
  EventMachine::WebSocket.start(&lt;span class=&#34;hljs-symbol&#34;&gt;:host&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;0.0.0.0&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:port&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;8080&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;ws&lt;/span&gt;|

    ws.onmessage &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;req&lt;/span&gt;|
      req = &lt;span class=&#34;hljs-variable constant_&#34;&gt;JSON&lt;/span&gt;.parse(req)
      &lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; req[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;action&amp;#x27;&lt;/span&gt;]
      &lt;span class=&#34;hljs-keyword&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;register&amp;#x27;&lt;/span&gt;
        player = &lt;span class=&#34;hljs-title class_&#34;&gt;Player&lt;/span&gt;.new ws
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Registering player : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;player.id&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
        &lt;span class=&#34;hljs-variable&#34;&gt;@gc&lt;/span&gt;.add_player player
        player.notify (&amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:success&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt; =&amp;gt; player.id&amp;#125;)
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the above example : when we have received a message from the client : we check if it is a request for registration. We have abstracted out the game management facilites in an external GameController class (yet unimplemented) which would take care of managing the users and games.&lt;/p&gt;
&lt;p&gt;For the sake of consistency, lets have all client server communications serialized as JSON.&lt;/p&gt;
&lt;p&gt;Rather than Running around with socket references, we encapsulate all the functionality of a single client in a player class :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Player&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;attr_accessor&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:socket&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;attr_reader&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;initialize&lt;/span&gt; ws
    &lt;span class=&#34;hljs-variable&#34;&gt;@id&lt;/span&gt; = rand(&lt;span class=&#34;hljs-number&#34;&gt;5000&lt;/span&gt;)
    &lt;span class=&#34;hljs-variable&#34;&gt;@socket&lt;/span&gt; = ws
    &lt;span class=&#34;hljs-variable&#34;&gt;@score&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;notify&lt;/span&gt; msg_hash
    &lt;span class=&#34;hljs-variable&#34;&gt;@socket&lt;/span&gt;.send &lt;span class=&#34;hljs-variable constant_&#34;&gt;JSON&lt;/span&gt;.dump msg_hash
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Also, we add a stub for a game class which will take care of managing the game state. The Game class instance would represent a single ongoing game between two opponents.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Game&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;attr_reader&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;initialize&lt;/span&gt; player1, player2, game_controller
    &lt;span class=&#34;hljs-variable&#34;&gt;@id&lt;/span&gt; = rand(&lt;span class=&#34;hljs-number&#34;&gt;5000&lt;/span&gt;)
    &lt;span class=&#34;hljs-comment&#34;&gt;# create initial game state&lt;/span&gt;
    &lt;span class=&#34;hljs-comment&#34;&gt;# notify the players about the game&lt;/span&gt;
    start
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;start&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;id, player&lt;/span&gt;|
      ws = player.socket
      ws.onmessage &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;msg&lt;/span&gt;|
        &lt;span class=&#34;hljs-comment&#34;&gt;# parse the msg&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# is the user request valid in the current context of the game&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# if yes :&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;#   change the state of the game to reflect this&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;#   notify the opponent about the changed state&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# if no:&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;#   notify the initiator about failure&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# has the game concluded:&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# Declare the winner, if any.&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now that basic overview of the code is clear, implementing the details is not very difficult. Here is the complete code :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;eventmachine&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;em-websocket&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;json&amp;#x27;&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Player&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;attr_accessor&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:score&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:socket&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;attr_reader&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;initialize&lt;/span&gt; ws
    &lt;span class=&#34;hljs-variable&#34;&gt;@id&lt;/span&gt; = rand(&lt;span class=&#34;hljs-number&#34;&gt;5000&lt;/span&gt;)
    &lt;span class=&#34;hljs-variable&#34;&gt;@socket&lt;/span&gt; = ws
    &lt;span class=&#34;hljs-variable&#34;&gt;@score&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;notify&lt;/span&gt; msg_hash
    &lt;span class=&#34;hljs-variable&#34;&gt;@socket&lt;/span&gt;.send &lt;span class=&#34;hljs-variable constant_&#34;&gt;JSON&lt;/span&gt;.dump msg_hash
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Game&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;attr_reader&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;initialize&lt;/span&gt; player1, player2, game_controller
    &lt;span class=&#34;hljs-variable&#34;&gt;@id&lt;/span&gt; = rand(&lt;span class=&#34;hljs-number&#34;&gt;5000&lt;/span&gt;)
    &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt; = &amp;#123;&amp;#125;
    [player1, player2].each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;player&lt;/span&gt;|
      &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;[player.id] = player
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@game_controller&lt;/span&gt; = game_controller
    &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt; = [[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;],[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;],[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;]]
    &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;id, player&lt;/span&gt;|
      player.notify(&amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Game initiated !!!&amp;quot;&lt;/span&gt; &amp;#125;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    player1.notify(&amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Your turn&amp;quot;&lt;/span&gt;&amp;#125;)
    player2.notify(&amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Opponent&amp;#x27;s turn&amp;quot;&lt;/span&gt;&amp;#125;)
    &lt;span class=&#34;hljs-variable&#34;&gt;@next_player&lt;/span&gt; = player1.id
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;start&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;id, player&lt;/span&gt;|
      ws = player.socket
      ws.onmessage &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;msg&lt;/span&gt;|
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Message received : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;msg&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
        msg = &lt;span class=&#34;hljs-variable constant_&#34;&gt;JSON&lt;/span&gt;.parse msg
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;id received : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;]&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;players : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;&lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;.to_json&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
        initiator = &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;[msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;]]

        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;initiator ===&amp;gt; &amp;quot;&lt;/span&gt;, initiator.to_json
        partner = find_partner initiator
        &lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;action&amp;#x27;&lt;/span&gt;]
        &lt;span class=&#34;hljs-keyword&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;move&amp;#x27;&lt;/span&gt;
          validation_result = validate_move msg
          initiator.notify(validation_result)
          &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; validation_result[&lt;span class=&#34;hljs-symbol&#34;&gt;:success&lt;/span&gt;]
            update_state msg
            &lt;span class=&#34;hljs-variable&#34;&gt;@next_player&lt;/span&gt; = partner.id
            update_gamestate partner

            &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; victorious?
              initiator.notify (&amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;You win&amp;quot;&lt;/span&gt; &amp;#125;)
              partner.notify(&amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;You lose&amp;quot;&lt;/span&gt; &amp;#125;)
              &lt;span class=&#34;hljs-variable&#34;&gt;@game_controller&lt;/span&gt;.end_game &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;, &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;
            &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; finished?
              resp = &amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Game Over&amp;quot;&lt;/span&gt;&amp;#125;
              initiator.notify resp
              partner.notify resp
              &lt;span class=&#34;hljs-variable&#34;&gt;@game_controller&lt;/span&gt;.end_game &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;, &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;
            &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
          &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
            update_gamestate initiator
          &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;validate_move&lt;/span&gt; msg
    res = &amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:success&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;&amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;] != &lt;span class=&#34;hljs-variable&#34;&gt;@next_player&lt;/span&gt;
      res = &amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:success&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:error&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Move out of turn&amp;quot;&lt;/span&gt;&amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;x&amp;#x27;&lt;/span&gt;]][msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;y&amp;#x27;&lt;/span&gt;]] != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
      res = &amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:success&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:error&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Overrite not allowed&amp;quot;&lt;/span&gt;&amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    res
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;update_state&lt;/span&gt; msg
    &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;x&amp;#x27;&lt;/span&gt;]][msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;y&amp;#x27;&lt;/span&gt;]] = msg[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;id&amp;#x27;&lt;/span&gt;]
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;update_gamestate&lt;/span&gt; player
    player.notify (&amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:game_state&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt; &amp;#125;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;find_partner&lt;/span&gt; player
    &lt;span class=&#34;hljs-variable&#34;&gt;@players&lt;/span&gt;.each &amp;#123; |&lt;span class=&#34;hljs-params&#34;&gt;id, pl&lt;/span&gt;| &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; pl &lt;span class=&#34;hljs-keyword&#34;&gt;unless&lt;/span&gt;  id == player.id &amp;#125;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;victorious?&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;teq&lt;/span&gt; a,b,c
      a != &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;and&lt;/span&gt; a == b &lt;span class=&#34;hljs-keyword&#34;&gt;and&lt;/span&gt; b ==c
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    i = &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;while&lt;/span&gt; i &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;3&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; teq &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[i][&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[i][&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[i][&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;]
      &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; teq &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;][i], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;][i], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;][i]
      i = i+&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; teq &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;][&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;][&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;][&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;]
    &lt;span class=&#34;hljs-keyword&#34;&gt;return&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; teq &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;][&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;][&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;], &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;][&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;]
    &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;finished?&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;].&lt;span class=&#34;hljs-keyword&#34;&gt;include&lt;/span&gt;? (&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;and&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;not&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;].&lt;span class=&#34;hljs-keyword&#34;&gt;include&lt;/span&gt;? (&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;and&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;not&lt;/span&gt;  &lt;span class=&#34;hljs-variable&#34;&gt;@state&lt;/span&gt;[&lt;span class=&#34;hljs-number&#34;&gt;2&lt;/span&gt;].&lt;span class=&#34;hljs-keyword&#34;&gt;include&lt;/span&gt;? (&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;GameController&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;initialize&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@games&lt;/span&gt; = &amp;#123;&amp;#125;
    &lt;span class=&#34;hljs-variable&#34;&gt;@free_players&lt;/span&gt; = []
    &lt;span class=&#34;hljs-variable&#34;&gt;@engaged_players&lt;/span&gt; = []
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;add_player&lt;/span&gt; player
    puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Adding player : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;player.id&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
    partner = &lt;span class=&#34;hljs-variable&#34;&gt;@free_players&lt;/span&gt;.pop
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; partner.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
      &lt;span class=&#34;hljs-variable&#34;&gt;@free_players&lt;/span&gt; &amp;lt;&amp;lt; player
      puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Putting on wait&amp;quot;&lt;/span&gt;
      player.notify (&amp;#123;
        &lt;span class=&#34;hljs-symbol&#34;&gt;:msg&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;You will have to wait till we find a partner for you&amp;quot;&lt;/span&gt;
      &amp;#125;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Pairing up : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;player.id&amp;#125;&lt;/span&gt;, &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;partner.id&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
      pair_up player, partner
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;pair_up&lt;/span&gt; player, partner
    puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Starting game between player &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;player.id&amp;#125;&lt;/span&gt; and &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;partner.id&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
    game = &lt;span class=&#34;hljs-title class_&#34;&gt;Game&lt;/span&gt;.new player, partner, &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@games&lt;/span&gt;[game.id] = game.id
    game.start
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;end_game&lt;/span&gt; game, players
    &lt;span class=&#34;hljs-variable&#34;&gt;@games&lt;/span&gt;[game.id] = &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
    players.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;id, player&lt;/span&gt;|
      add_player player
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

EventMachine.run &amp;#123;
  &lt;span class=&#34;hljs-variable&#34;&gt;@gc&lt;/span&gt; = GameController.new
  EventMachine::WebSocket.start(&lt;span class=&#34;hljs-symbol&#34;&gt;:host&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;0.0.0.0&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:port&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;8080&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;ws&lt;/span&gt;|

    ws.onmessage &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;req&lt;/span&gt;|
      req = &lt;span class=&#34;hljs-variable constant_&#34;&gt;JSON&lt;/span&gt;.parse(req)
      &lt;span class=&#34;hljs-keyword&#34;&gt;case&lt;/span&gt; req[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;action&amp;#x27;&lt;/span&gt;]
      &lt;span class=&#34;hljs-keyword&#34;&gt;when&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;register&amp;#x27;&lt;/span&gt;
        player = &lt;span class=&#34;hljs-title class_&#34;&gt;Player&lt;/span&gt;.new ws
        puts &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Registering player : &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;player.id&amp;#125;&lt;/span&gt;&amp;quot;&lt;/span&gt;
        &lt;span class=&#34;hljs-variable&#34;&gt;@gc&lt;/span&gt;.add_player player
        player.notify (&amp;#123;&lt;span class=&#34;hljs-symbol&#34;&gt;:success&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt; =&amp;gt; player.id&amp;#125;)
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&amp;#125;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While I have skipped over the details of management of game, I believe the code above is fairly readable.&lt;/p&gt;
&lt;p&gt;And yes, I am aware of the several issues with the code above. The most obvious one is that serialized state passed to client contains the id of other player as well. So it is easy to cheat the game.  Apart from this there are several other things I have looked over. What if a player passes in a request that cannot be parsed as JSON ? A malformed request initiates an exception that crashes the whole game.  These issues will be resolved and  a score management system and a front-end will be added in the later parts of the tutorial. So stay tuned.&lt;/p&gt;
&lt;p&gt;Here is a snapshot of my Javascript console showing a game in progress :&lt;/p&gt;
&lt;img src=&#34;/images/game.png&#34; /&gt;

&lt;p&gt;As always, feel free to provide your suggestions and to point out errors.&lt;/p&gt;
</content>
        <category term="Ruby" />
        <category term="EventMachine" />
        <category term="Websockets" />
        <updated>2012-08-15T00:00:00.000Z</updated>
    </entry>
</feed>
