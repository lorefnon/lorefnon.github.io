{
    "version": "https://jsonfeed.org/version/1",
    "title": "Icicles of Thought • All posts by \"crdt\" tag",
    "description": "",
    "home_page_url": "https://lorefnon.me",
    "items": [
        {
            "id": "https://lorefnon.me/2018/09/23/using-google-diff-match-patch-with-automerge-text/",
            "url": "https://lorefnon.me/2018/09/23/using-google-diff-match-patch-with-automerge-text/",
            "title": "Integrating Google diff-match-patch with AutoMerge.Text",
            "date_published": "2018-09-23T00:00:00.000Z",
            "content_html": "<link rel=\"stylesheet\" href=\"/css/crayon.min.css\" >\n<link rel=\"stylesheet\" href=\"/css/crayon-flatui-light.css\" >\n\n\n\n\t<p>This post outlines the use of Google’s <a href=\"https://github.com/google/diff-match-patch/wiki/Language:-JavaScript\">diff-match-patch library</a> to generate patches that can be translated to operations against an <a href=\"https://github.com/automerge/automerge#text-editing-support\">AutoMerge.Text</a> <a href=\"https://en.wikipedia.org/wiki/Conflict-free_replicated_data_type\">CRDT</a> for situations when deriving the operations directly from user interactions is cumbersome.<br>\n<span id=\"more-469\"></span></p>\n<blockquote><p>\n  <a href=\"https://github.com/automerge/automerge\">Automerge</a> is a so-called Conflict-Free Replicated Data Type (CRDT), which allows concurrent changes on different devices to be merged automatically without requiring any central server.\n</p></blockquote>\n<p></p>\n<blockquote><p>\n  <a href=\"https://github.com/automerge/automerge#text-editing-support\">Automerge.Text</a> provides experimental support for collaborative text editing. Under the hood, text is represented as a list of characters, which is edited by inserting or deleting individual characters. Compared to using a regular JavaScript array, Automerge.Text offers better performance.\n</p></blockquote>\n<p>However, using the AutoMerge.Text API directly is somewhat cumbersome in practice:</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-5fba447e7f3ce267270330\" class=\"crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"\">\n\t\t\t\t<table class=\"crayon-table\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums\" data-settings=\"hide\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 15px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3ce267270330-1\">1</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3ce267270330-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3ce267270330-3\">3</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3ce267270330-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3ce267270330-5\">5</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3ce267270330-6\">6</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5fba447e7f3ce267270330-1\"><span class=\"crayon-v\">newDoc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Automerge</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">change</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">currentDoc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3ce267270330-2\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">Automerge</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Text</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3ce267270330-3\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">insertAt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'h'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'e'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'l'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'l'</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'o'</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3ce267270330-4\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">deleteAt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3ce267270330-5\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">insertAt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">'H'</span><span class=\"crayon-sy\">)</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3ce267270330-6\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0026 seconds] -->\n<p></p>\n<p>It is of course possible to track every keypress in a text field and translate them to insert/delete operations, but this requires handling of a lot of corner cases like selection tracking, handling clipboard paste etc.</p>\n<p>Many javascript text editor components (eg. Quill, Draft etc.) provide deltas in the change events and we can translate them into AutoMerge operations.</p>\n<p>An alternative to the above is using Google’s diff-match-patch library to compute patches that represent the change between the source document and changed document, and we can easily translate these patches to changes in AutoMerge Text data structure.</p>\n<p>This comes in particularly handly when we don’t have control over the editor component, and deriving change deltas from user interactions is not very straightforward.</p>\n<p></p><!-- Crayon Syntax Highlighter v_2.7.2_beta -->\n\n\t\t<div id=\"crayon-5fba447e7f3e1141648705\" class=\"crayon-syntax crayon-theme-flatui-light crayon-font-inconsolata crayon-os-pc print-yes notranslate\" data-settings=\" minimize scroll-mouseover\" style=\" margin-top: 12px; margin-bottom: 12px; font-size: 15px !important; line-height: 20px !important;\">\n\t\t\n\t\t\t<div class=\"crayon-plain-wrap\"></div>\n\t\t\t<div class=\"crayon-main\" style=\"\">\n\t\t\t\t<table class=\"crayon-table\">\n\t\t\t\t\t<tbody><tr class=\"crayon-row\">\n\t\t\t\t<td class=\"crayon-nums\" data-settings=\"hide\">\n\t\t\t\t\t<div class=\"crayon-nums-content\" style=\"font-size: 15px !important; line-height: 20px !important;\"><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-1\">1</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-2\">2</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-3\">3</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-4\">4</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-5\">5</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-6\">6</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-7\">7</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-8\">8</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-9\">9</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-10\">10</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-11\">11</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-12\">12</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-13\">13</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-14\">14</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-15\">15</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-16\">16</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-17\">17</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-18\">18</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-19\">19</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-20\">20</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-21\">21</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-22\">22</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-23\">23</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-24\">24</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-25\">25</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-26\">26</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-27\">27</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-28\">28</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-29\">29</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-30\">30</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-31\">31</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-32\">32</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-33\">33</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-34\">34</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-35\">35</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-36\">36</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-37\">37</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-38\">38</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-39\">39</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-40\">40</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-41\">41</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-42\">42</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-43\">43</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-44\">44</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-45\">45</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-46\">46</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-47\">47</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-48\">48</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-49\">49</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-50\">50</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-51\">51</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-52\">52</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-53\">53</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-54\">54</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-55\">55</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-56\">56</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-57\">57</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-58\">58</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-59\">59</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-60\">60</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-61\">61</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-62\">62</div><div class=\"crayon-num\" data-line=\"crayon-5fba447e7f3e1141648705-63\">63</div></div>\n\t\t\t\t</td>\n\t\t\t\t\t\t<td class=\"crayon-code\"><div class=\"crayon-pre\" style=\"font-size: 15px !important; line-height: 20px !important; -moz-tab-size:4; -o-tab-size:4; -webkit-tab-size:4; tab-size:4;\"><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-1\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">DiffMatchPatch </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"diff-match-patch\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-2\"><span class=\"crayon-e\">import </span><span class=\"crayon-e\">AutoMerge </span><span class=\"crayon-i\">from</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"automerge\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-3\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-4\"><span class=\"crayon-c\">// Typically we would get the changedText after some interactions in our UI components:</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-5\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">sourceText</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"The angel shall fall\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-6\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">changedText</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-s\">\"Lucifer shall rise\"</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-7\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-8\"><span class=\"crayon-c\">// Initialize AutoMerge wrapper document</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-9\"><span class=\"crayon-e\">let </span><span class=\"crayon-v\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AutoMerge</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">init</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-10\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-11\"><span class=\"crayon-v\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AutoMerge</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">change</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-12\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AutoMerge</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">Text</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-13\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">insertAt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">sourceText</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">split</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-14\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-15\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-16\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dmp</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-r\">new</span><span class=\"crayon-h\"> </span><span class=\"crayon-e\">DiffMatchPatch</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-17\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-18\"><span class=\"crayon-c\">// Compute the diff:</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-19\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">diff</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dmp</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">diff_main</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sourceText</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">changedText</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-20\"><span class=\"crayon-c\">// diff is simply an array of binary tuples representing the change</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-21\"><span class=\"crayon-c\">// [[-1,\"The ang\"],[1,\"Lucif\"],[0,\"e\"],[-1,\"l\"],[1,\"r\"],[0,\" shall \"],[-1,\"fall\"],[1,\"rise\"]]</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-22\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-23\"><span class=\"crayon-c\">// This cleans up the diff so that the diff is more human friendly.</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-24\"><span class=\"crayon-v\">dmp</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">diff_cleanupSemantic</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">diff</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-25\"><span class=\"crayon-c\">// [[-1,\"The angel\"],[1,\"Lucifer\"],[0,\" shall \"],[-1,\"fall\"],[1,\"rise\"]]</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-26\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-27\"><span class=\"crayon-m\">const</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">patches</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">dmp</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">patch_make</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">sourceText</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">diff</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-28\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-29\"><span class=\"crayon-c\">// A patch object wraps the diffs along with some change metadata:</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-30\"><span class=\"crayon-c\">//</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-31\"><span class=\"crayon-c\">// [{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-32\"><span class=\"crayon-c\">//&nbsp;&nbsp; \"diffs\":[[-1,\"The angel\"],[1,\"Lucifer\"],[0,\" shall \"],[-1,\"fall\"], [1,\"rise\"]],</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-33\"><span class=\"crayon-c\">//&nbsp;&nbsp; \"start1\":0,</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-34\"><span class=\"crayon-c\">//&nbsp;&nbsp; \"start2\":0,</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-35\"><span class=\"crayon-c\">//&nbsp;&nbsp; \"length1\":20,</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-36\"><span class=\"crayon-c\">//&nbsp;&nbsp; \"length2\":18</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-37\"><span class=\"crayon-c\">// }]</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-38\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-39\"><span class=\"crayon-c\">// We can use the patch to derive the changedText from the sourceText</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-40\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">dmp</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">patch_apply</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">patches</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">sourceText</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">[</span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// \"Lucifer shall rise\"</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-41\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-42\"><span class=\"crayon-c\">// Now we translate these patches to operations against AutoMerge.Text instance:</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-43\"><span class=\"crayon-v\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">AutoMerge</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">change</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">doc</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-44\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-v\">patches</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">patch</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-45\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-e\">let </span><span class=\"crayon-v\">idx</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">patch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">start1</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-46\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">patch</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">diffs</span><span class=\"crayon-sy\">.</span><span class=\"crayon-st\">forEach</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">(</span><span class=\"crayon-sy\">[</span><span class=\"crayon-v\">operation</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">changeText</span><span class=\"crayon-sy\">]</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-o\">&gt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-47\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">switch</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">operation</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-48\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Insertion</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-49\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">insertAt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">idx</span><span class=\"crayon-sy\">,</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">changeText</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">split</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-50\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// No Change</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-51\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">idx</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">+=</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">changeText</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">length</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-52\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-53\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">case</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">-</span><span class=\"crayon-cn\">1</span><span class=\"crayon-o\">:</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// Deletion</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-54\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">for</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">(</span><span class=\"crayon-i\">let</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">=</span><span class=\"crayon-h\"> </span><span class=\"crayon-cn\">0</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-h\"> </span><span class=\"crayon-o\">&lt;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">changeText</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">length</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-v\">i</span><span class=\"crayon-o\">++</span><span class=\"crayon-sy\">)</span><span class=\"crayon-h\"> </span><span class=\"crayon-sy\">{</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-55\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">deleteAt</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">idx</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-56\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-57\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-st\">break</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-58\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-59\"><span class=\"crayon-h\">&nbsp;&nbsp;&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-60\"><span class=\"crayon-h\">&nbsp;&nbsp;</span><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-61\"><span class=\"crayon-sy\">}</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span></div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-62\">&nbsp;</div><div class=\"crayon-line\" id=\"crayon-5fba447e7f3e1141648705-63\"><span class=\"crayon-v\">console</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">log</span><span class=\"crayon-sy\">(</span><span class=\"crayon-v\">doc</span><span class=\"crayon-sy\">.</span><span class=\"crayon-v\">text</span><span class=\"crayon-sy\">.</span><span class=\"crayon-e\">join</span><span class=\"crayon-sy\">(</span><span class=\"crayon-s\">\"\"</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">)</span><span class=\"crayon-sy\">;</span><span class=\"crayon-h\"> </span><span class=\"crayon-c\">// \"Lucifer shall rise\"</span></div></div></td>\n\t\t\t\t\t</tr>\n\t\t\t\t</tbody></table>\n\t\t\t</div>\n\t\t</div>\n<!-- [Format Time: 0.0121 seconds] -->\n<p></p>\n\n\n    ",
            "tags": [
                "Automerge",
                "CRDT",
                "Frontend"
            ]
        }
    ]
}