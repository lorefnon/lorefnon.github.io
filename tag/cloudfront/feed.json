{
    "version": "https://jsonfeed.org/version/1",
    "title": "Icicles of Thought â€¢ All posts by \"cloudfront\" tag",
    "description": "",
    "home_page_url": "https://lorefnon.me",
    "items": [
        {
            "id": "https://lorefnon.me/2022/12/06/configuring-cloudfront-as-non-caching-reverse-proxy-for-api-backend/",
            "url": "https://lorefnon.me/2022/12/06/configuring-cloudfront-as-non-caching-reverse-proxy-for-api-backend/",
            "title": "Using CDK to configure cloudfront as non-caching reverse proxy for API backend",
            "date_published": "2022-12-06T00:00:00.000Z",
            "content_html": "<p>Cloudfront is primarily a CDN, but it is often also convenient to use it as reverse proxy for a backend service. This is especially convenient when the entire frontend SPA (including HTML) is already hosted from Cloudfront and we don&#39;t want to support CORS in our backend API that this frontend talks to.</p>\n<p>Reusing Cloudfront as a reverse proxy in such cases ensures that both our frontend and backend can be available from the same domain. However, in such case we must take special care to ensure that our backend responses do get unexpectedly cached by Cloudfront. This post outlines the CDK configuration to facilitate this.</p>\n<p>A minimal Cloudfront setup for an SPA may look something like this: </p>\n<pre><code class=\"hljs ts\"><span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> cdk <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> s3 <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-s3&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> cf <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-cloudfront&quot;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FrontendStack</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_ inherited__\">cdk.Stack</span> &#123;\n  publicAssetsS3Bucket = <span class=\"hljs-keyword\">new</span> s3.<span class=\"hljs-title class_\">Bucket</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&#x27;PublicAssetsS3Bucket&#x27;</span>, &#123;\n    <span class=\"hljs-attr\">removalPolicy</span>: cdk.<span class=\"hljs-property\">RemovalPolicy</span>.<span class=\"hljs-property\">RETAIN</span>,\n    <span class=\"hljs-attr\">publicReadAccess</span>: <span class=\"hljs-literal\">true</span>,\n    <span class=\"hljs-attr\">websiteIndexDocument</span>: <span class=\"hljs-string\">&quot;index.html&quot;</span>,\n    <span class=\"hljs-attr\">versioned</span>: <span class=\"hljs-literal\">false</span>,\n  &#125;)\n\n  s3Origin = <span class=\"hljs-keyword\">new</span> origins.<span class=\"hljs-title function_\">S3Origin</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">publicAssetsS3Bucket</span>);\n\n  cfDistribution = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Distribution</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&#x27;CFDistribution&#x27;</span>, &#123;\n    <span class=\"hljs-attr\">defaultBehavior</span>: &#123;\n      <span class=\"hljs-attr\">origin</span>: s3Origin,\n    &#125;,\n    <span class=\"hljs-comment\">// Certificate and domain configuration omitted</span>\n  &#125;);\n&#125;</code></pre>\n\n<p>Here our CF Distribution is backed by an S3 bucket.</p>\n<p>Now, to support reverse proxying to an API we need an additional origin. While adding this origin, we will also want to configure additional policies to ensure that the responses from this origin do not get cached: </p>\n<pre><code class=\"hljs ts\">dist.<span class=\"hljs-title function_\">addBehavior</span>(<span class=\"hljs-string\">&quot;/api/*&quot;</span>, apiOrigin, &#123;\n    <span class=\"hljs-attr\">responseHeadersPolicy</span>: cfAPIRespHeadersPolicy,\n    <span class=\"hljs-attr\">allowedMethods</span>: cf.<span class=\"hljs-property\">AllowedMethods</span>.<span class=\"hljs-property\">ALLOW_ALL</span>,\n    <span class=\"hljs-attr\">cachePolicy</span>: cfApiCachePolicy,\n    <span class=\"hljs-attr\">originRequestPolicy</span>: cfApiOriginReqPolicy,\n&#125;);</code></pre>\n\n<p>It is important to explicitly allow all methods because CF by default permits only GET &amp; HEAD requests, and other HTTP verbs will be rejected.</p>\n<p>Let&#39;s next look at the associated policies: </p>\n<p>Following Response headers policy primary hints browsers to not cache the API responses:</p>\n<pre><code class=\"hljs ts\">cfAPIRespHeadersPolicy = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">ResponseHeadersPolicy</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;CFAPIRespHeadersPolicy&quot;</span>, &#123;\n    <span class=\"hljs-attr\">customHeadersBehavior</span>: &#123;\n      <span class=\"hljs-attr\">customHeaders</span>: [\n        &#123;\n          <span class=\"hljs-attr\">header</span>: <span class=\"hljs-string\">&quot;Cache-Control&quot;</span>,\n          <span class=\"hljs-attr\">override</span>: <span class=\"hljs-literal\">true</span>,\n          <span class=\"hljs-attr\">value</span>: <span class=\"hljs-string\">&quot;no-cache&quot;</span>,\n        &#125;,\n      ],\n    &#125;,\n&#125;);</code></pre>\n\n<p>The Cache policy will ensure that cloudfront itself does not cache the responses from our API backend: </p>\n<pre><code class=\"hljs ts\">cfApiCachePolicy = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">CachePolicy</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;ApiCachePolicy&quot;</span>, &#123;\n  <span class=\"hljs-attr\">defaultTtl</span>: cdk.<span class=\"hljs-property\">Duration</span>.<span class=\"hljs-title function_\">seconds</span>(<span class=\"hljs-number\">0</span>),\n  <span class=\"hljs-attr\">maxTtl</span>: cdk.<span class=\"hljs-property\">Duration</span>.<span class=\"hljs-title function_\">seconds</span>(<span class=\"hljs-number\">1</span>),\n  <span class=\"hljs-attr\">queryStringBehavior</span>: cf.<span class=\"hljs-property\">CacheQueryStringBehavior</span>.<span class=\"hljs-title function_\">all</span>(),\n  <span class=\"hljs-attr\">headerBehavior</span>: cf.<span class=\"hljs-property\">CacheHeaderBehavior</span>.<span class=\"hljs-title function_\">allowList</span>(<span class=\"hljs-string\">&#x27;Authorization&#x27;</span>)\n&#125;);</code></pre>\n\n<p>Note that we also need to explicitly allow the Authorization header otherwise it will be stripped by Cloudfront. </p>\n<p>Currently there appears to be a bug which prevents us from being able to specify a header behavior if all the ttls are 0, so we keep the maxTtl as 1s.</p>\n<p>Lastly, we need an OriginRequestPolicy that instructs Cloudfront to forward all query params &amp; cookies to the backend. In addition we can also specify any cloudfront specific headers here. In example below we add the <code>CloudFront-Viewer-Address</code> header which enables the backend to receive the actual IP of the user.</p>\n<pre><code class=\"hljs ts\">cfApiOriginReqPolicy = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">OriginRequestPolicy</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;ApiOriginReqPolicy&quot;</span>, &#123;\n    <span class=\"hljs-attr\">originRequestPolicyName</span>: <span class=\"hljs-string\">&quot;SampleApiOriginReqPolicy&quot;</span>,\n    <span class=\"hljs-attr\">cookieBehavior</span>: cf.<span class=\"hljs-property\">OriginRequestCookieBehavior</span>.<span class=\"hljs-title function_\">all</span>(),\n    <span class=\"hljs-attr\">headerBehavior</span>: cf.<span class=\"hljs-property\">OriginRequestHeaderBehavior</span>.<span class=\"hljs-title function_\">all</span>(\n      <span class=\"hljs-string\">&quot;CloudFront-Viewer-Address&quot;</span>\n    ),\n    <span class=\"hljs-attr\">queryStringBehavior</span>: cf.<span class=\"hljs-property\">OriginRequestQueryStringBehavior</span>.<span class=\"hljs-title function_\">all</span>(),\n&#125;);</code></pre>\n\n<p>Our final integration looks like this:</p>\n<pre><code class=\"hljs ts\"><span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> cdk <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> s3 <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-s3&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> cf <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-cloudfront&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> origins <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-cloudfront-origins&quot;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FrontendStack</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_ inherited__\">cdk.Stack</span> &#123;\n  publicAssetsS3Bucket = <span class=\"hljs-keyword\">new</span> s3.<span class=\"hljs-title class_\">Bucket</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&#x27;PublicAssetsS3Bucket&#x27;</span>, &#123;\n    <span class=\"hljs-attr\">removalPolicy</span>: cdk.<span class=\"hljs-property\">RemovalPolicy</span>.<span class=\"hljs-property\">RETAIN</span>,\n    <span class=\"hljs-attr\">publicReadAccess</span>: <span class=\"hljs-literal\">true</span>,\n    <span class=\"hljs-attr\">websiteIndexDocument</span>: <span class=\"hljs-string\">&quot;index.html&quot;</span>,\n    <span class=\"hljs-attr\">versioned</span>: <span class=\"hljs-literal\">false</span>,\n  &#125;)\n\n  cfApiCachePolicy = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">CachePolicy</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;ApiCachePolicy&quot;</span>, &#123;\n    <span class=\"hljs-attr\">defaultTtl</span>: cdk.<span class=\"hljs-property\">Duration</span>.<span class=\"hljs-title function_\">seconds</span>(<span class=\"hljs-number\">0</span>),\n    <span class=\"hljs-attr\">maxTtl</span>: cdk.<span class=\"hljs-property\">Duration</span>.<span class=\"hljs-title function_\">seconds</span>(<span class=\"hljs-number\">1</span>),\n    <span class=\"hljs-attr\">queryStringBehavior</span>: cf.<span class=\"hljs-property\">CacheQueryStringBehavior</span>.<span class=\"hljs-title function_\">all</span>(),\n    <span class=\"hljs-attr\">headerBehavior</span>: cf.<span class=\"hljs-property\">CacheHeaderBehavior</span>.<span class=\"hljs-title function_\">allowList</span>(<span class=\"hljs-string\">&#x27;Authorization&#x27;</span>)\n  &#125;);\n\n  cfApiOriginReqPolicy = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">OriginRequestPolicy</span>(\n    <span class=\"hljs-variable language_\">this</span>,\n    <span class=\"hljs-string\">&quot;ApiOriginReqPolicy&quot;</span>,\n    &#123;\n      <span class=\"hljs-attr\">originRequestPolicyName</span>: <span class=\"hljs-string\">&quot;SampleApiOriginReqPolicy&quot;</span>,\n      <span class=\"hljs-attr\">cookieBehavior</span>: cf.<span class=\"hljs-property\">OriginRequestCookieBehavior</span>.<span class=\"hljs-title function_\">all</span>(),\n      <span class=\"hljs-attr\">headerBehavior</span>: cf.<span class=\"hljs-property\">OriginRequestHeaderBehavior</span>.<span class=\"hljs-title function_\">all</span>(\n        <span class=\"hljs-string\">&quot;CloudFront-Viewer-Address&quot;</span>,\n        <span class=\"hljs-string\">&quot;CloudFront-Viewer-Country&quot;</span>,\n        <span class=\"hljs-string\">&quot;CloudFront-Viewer-City&quot;</span>,\n        <span class=\"hljs-string\">&quot;CloudFront-Viewer-Country-Region&quot;</span>\n      ),\n      <span class=\"hljs-attr\">queryStringBehavior</span>: cf.<span class=\"hljs-property\">OriginRequestQueryStringBehavior</span>.<span class=\"hljs-title function_\">all</span>(),\n    &#125;\n  );\n\n  s3Origin = <span class=\"hljs-keyword\">new</span> origins.<span class=\"hljs-title function_\">S3Origin</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">publicAssetsS3Buckets</span>[idx]);\n\n  apiOrigin = <span class=\"hljs-keyword\">new</span> origins.<span class=\"hljs-title class_\">HttpOrigin</span>(serverHost!);\n  \n  cfAPIRespHeadersPolicy = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">ResponseHeadersPolicy</span>(\n    <span class=\"hljs-variable language_\">this</span>,\n    <span class=\"hljs-string\">&quot;cfHTMLRespHeadersPolicy&quot;</span>,\n    &#123;\n      <span class=\"hljs-attr\">customHeadersBehavior</span>: &#123;\n        <span class=\"hljs-attr\">customHeaders</span>: [\n          &#123;\n            <span class=\"hljs-attr\">header</span>: <span class=\"hljs-string\">&quot;Cache-Control&quot;</span>,\n            <span class=\"hljs-attr\">override</span>: <span class=\"hljs-literal\">true</span>,\n            <span class=\"hljs-attr\">value</span>: <span class=\"hljs-string\">&quot;no-cache&quot;</span>,\n          &#125;,\n        ],\n      &#125;,\n    &#125;\n  );\n\n  configureCFDistribution = (): cf.<span class=\"hljs-property\">Distribution</span> =&gt; &#123;\n      <span class=\"hljs-keyword\">const</span> dist = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Distribution</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&#x27;CFDistribution&#x27;</span>, &#123;\n        <span class=\"hljs-attr\">defaultBehavior</span>: &#123;\n          <span class=\"hljs-attr\">origin</span>: s3Origin,\n        &#125;,\n        <span class=\"hljs-comment\">// Certificate and domain configuration omitted</span>\n      &#125;);\n\n      dist.<span class=\"hljs-title function_\">addBehavior</span>(<span class=\"hljs-string\">&quot;/api/*&quot;</span>, apiOrigin, &#123;\n        <span class=\"hljs-attr\">responseHeadersPolicy</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfAPIRespHeadersPolicy</span>,\n        <span class=\"hljs-attr\">allowedMethods</span>: cf.<span class=\"hljs-property\">AllowedMethods</span>.<span class=\"hljs-property\">ALLOW_ALL</span>,\n        <span class=\"hljs-attr\">cachePolicy</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfApiCachePolicy</span>,\n        <span class=\"hljs-attr\">originRequestPolicy</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfApiOriginReqPolicy</span>,\n      &#125;);\n\n      <span class=\"hljs-keyword\">return</span> dist;\n  &#125;\n\n  cfDistribution = <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-title function_\">configureCFDistribution</span>()\n&#125;</code></pre>\n",
            "tags": [
                "typescript",
                "cloudfront",
                "AWS",
                "CDK"
            ]
        },
        {
            "id": "https://lorefnon.me/2022/11/15/configuring-cloudfront-functions-for-spa-routing-using-cdk/",
            "url": "https://lorefnon.me/2022/11/15/configuring-cloudfront-functions-for-spa-routing-using-cdk/",
            "title": "Configuring cloudfront functions for SPA routing with CDK",
            "date_published": "2022-11-15T00:00:00.000Z",
            "content_html": "<p>When building <a href=\"https://en.wikipedia.org/wiki/Single-page_application\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">single page applications</a>, it is convenient to serve the complete website including the HTML files from a CDN like AWS cloudfront. All the assets can then be potentially served from a location close to the user. This works particularly well for PWAs and dynamic client rendered websites. </p>\n<p>It is also common to use <a href=\"https://developer.mozilla.org/en-US/docs/Web/API/History_API/Working_with_the_History_API\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">push based</a> routing in single page applications. However the first request would always go the server so we need to setup some server side routing as well to route these requests to an appropriate HTML file. In the simplest case we&#39;d route all incoming requests to our domain to a single index.html file, and the javascript referenced in the HTML file will take over once the browser renders it.</p>\n<p>This is easily accomplished via <a href=\"https://docs.amazonaws.cn/en_us/AmazonCloudFront/latest/DeveloperGuide/cloudfront-functions.html\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">cloudfront functions</a>, which are a <a href=\"https://aws.amazon.com/blogs/aws/introducing-cloudfront-functions-run-your-code-at-the-edge-with-low-latency-at-any-scale/\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">recently introduced</a> cost effective alternative to <a href=\"https://docs.amazonaws.cn/en_us/AmazonCloudFront/latest/DeveloperGuide/lambda-at-the-edge.html\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">lambda@edge</a>. </p>\n<p>lambda@edge may be more suitable if you need to execute complex logic and need access to a more full-fledged execution environment like node.js (For example if you are doing server side rendering). However for simpler use cases like changing routes, adapting headers etc. cloudfront functions offer a simpler and more cost effective alternative.</p>\n<p>Here is a simple function to route all requests which don&#39;t have an extension in the url to index.html: </p>\n<pre><code class=\"hljs js\"><span class=\"hljs-comment\">// path-redir-rule.js</span>\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">handler</span>(<span class=\"hljs-params\">event</span>) &#123;\n    <span class=\"hljs-keyword\">var</span> request = event.<span class=\"hljs-property\">request</span>\n    <span class=\"hljs-keyword\">var</span> hasExtension = request.<span class=\"hljs-property\">uri</span>.<span class=\"hljs-title function_\">includes</span>(<span class=\"hljs-string\">&#x27;.&#x27;</span>)\n    <span class=\"hljs-keyword\">if</span> (!hasExtension) &#123;\n        request.<span class=\"hljs-property\">uri</span> = <span class=\"hljs-string\">&#x27;/app/index.html&#x27;</span>\n    &#125;\n    <span class=\"hljs-keyword\">return</span> request;\n&#125;</code></pre>\n\n<p>Because we love <a href=\"https://en.wikipedia.org/wiki/Infrastructure_as_code\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">IaC</a>, we will use <a href=\"https://aws.amazon.com/cdk/\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">CDK</a> to wire up our cloudfront. This post is not intended to be a good first intro to CDK, but here are a few if you are using it for first time: <a href=\"https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/serverless-cdk-getting-started.html\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">[1]</a>, <a href=\"https://dev.to/kevin_odongo35/getting-started-with-aws-cdk-2k19\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">[2]</a>.</p>\n<p>It should not surprise anyone that AWS CDK has good support for AWS Cloudfront. </p>\n<p>Here is a simple stack that uses CDK with typescript to wire up a cloudfront stack backed by an S3 bucket. </p>\n<pre><code class=\"hljs ts\"><span class=\"hljs-keyword\">import</span> path <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;node:path&quot;</span>\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> cdk <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> s3 <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-s3&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> cf <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-cloudfront&quot;</span>;\n<span class=\"hljs-keyword\">import</span> * <span class=\"hljs-keyword\">as</span> origins <span class=\"hljs-keyword\">from</span> <span class=\"hljs-string\">&quot;aws-cdk-lib/aws-cloudfront-origins&quot;</span>;\n\n<span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FrontendStack</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_ inherited__\">cdk.Stack</span> &#123;\n  publicAssetsS3Bucket = <span class=\"hljs-keyword\">new</span> s3.<span class=\"hljs-title class_\">Bucket</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;PublicAssetsBucket&quot;</span>, &#123;\n    <span class=\"hljs-attr\">removalPolicy</span>: cdk.<span class=\"hljs-property\">RemovalPolicy</span>.<span class=\"hljs-property\">RETAIN</span>,\n    <span class=\"hljs-attr\">publicReadAccess</span>: <span class=\"hljs-literal\">true</span>,\n    <span class=\"hljs-attr\">websiteIndexDocument</span>: <span class=\"hljs-string\">&quot;index.html&quot;</span>,\n    <span class=\"hljs-attr\">versioned</span>: <span class=\"hljs-literal\">false</span>,\n  &#125;);\n\n  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfOrigin</span> = <span class=\"hljs-keyword\">new</span> origins.<span class=\"hljs-title function_\">S3Origin</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">publicAssetsS3Bucket</span>);\n\n  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfDistribution</span> = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Distribution</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;CFDistribution&quot;</span>, &#123;\n    <span class=\"hljs-attr\">defaultBehavior</span>: &#123;\n      <span class=\"hljs-attr\">origin</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfOrigin</span>\n    &#125;\n  &#125;);\n&#125;</code></pre>\n\n<p>In a production application we will also configure certifications and domains for the distribution, which I have omited to keep the post focussed, but here is <a href=\"https://blog.dennisokeeffe.com/blog/2021-08-08-building-a-cdn-with-s3-cloudfront-and-the-aws-cdk\" target=\"_blank\" rel=\"noopener external nofollow noreferrer\">another post</a> that convers those things too.</p>\n<p>We can now update this CF distribution configuration to use our function.</p>\n<pre><code class=\"hljs\"><table class=\"hlcode-table\"><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FrontendStack</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_ inherited__\">cdk.Stack</span> {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  publicAssetsS3Bucket = <span class=\"hljs-keyword\">new</span> s3.<span class=\"hljs-title class_\">Bucket</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;PublicAssetsBucket&quot;</span>, {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">removalPolicy</span>: cdk.<span class=\"hljs-property\">RemovalPolicy</span>.<span class=\"hljs-property\">RETAIN</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">publicReadAccess</span>: <span class=\"hljs-literal\">true</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">websiteIndexDocument</span>: <span class=\"hljs-string\">&quot;index.html&quot;</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">versioned</span>: <span class=\"hljs-literal\">false</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  })\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">  cfPathRedirFunction = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Function</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;PathRedirFunction&quot;</span>, {\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">      <span class=\"hljs-attr\">code</span>: cf.<span class=\"hljs-property\">FunctionCode</span>.<span class=\"hljs-title function_\">fromFile</span>({\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        <span class=\"hljs-attr\">filePath</span>: path.<span class=\"hljs-title function_\">join</span>(\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">          __dirname,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-string\">&quot;./cf-functions/path-redir-rule.js&quot;</span>\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        ),\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">      }),\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">    });\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfOrigin</span> = <span class=\"hljs-keyword\">new</span> origins.<span class=\"hljs-title function_\">S3Origin</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">publicAssetsS3Bucket</span>);\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfDistribution</span> = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Distribution</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;CFDistribution&quot;</span>, {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">defaultBehavior</span>: {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">      <span class=\"hljs-attr\">origin</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfOrigin</span>,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">      <span class=\"hljs-attr\">functionAssociations</span>: [\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        {\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-attr\">function</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfPathRedirFunction</span>,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-attr\">eventType</span>: cf.<span class=\"hljs-property\">FunctionEventType</span>.<span class=\"hljs-property\">VIEWER_REQUEST</span>,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        }\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">      ],\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    }\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  });\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">}\n</td></tr></table></code></pre>\n\n<p>Since this function will need to be run before the target is selected, we needed to use <code>VIEWER_REQUEST</code> event type.</p>\n<p>We can also consider adding a response function which adds headers to prevent the browser from caching our html pages, as we can expect it to frequently change.</p>\n<pre><code class=\"hljs ts\"><span class=\"hljs-comment\">// prevent-html-caching.js</span>\n\n<span class=\"hljs-keyword\">function</span> <span class=\"hljs-title function_\">handler</span>(<span class=\"hljs-params\">event</span>) &#123;\n    <span class=\"hljs-keyword\">var</span> request = event.<span class=\"hljs-property\">request</span>\n    <span class=\"hljs-keyword\">var</span> parts = request.<span class=\"hljs-property\">uri</span>.<span class=\"hljs-title function_\">split</span>(<span class=\"hljs-string\">&#x27;/&#x27;</span>)\n    <span class=\"hljs-keyword\">var</span> lastPart = parts[parts.<span class=\"hljs-property\">length</span>-<span class=\"hljs-number\">1</span>]\n    <span class=\"hljs-keyword\">var</span> response = event.<span class=\"hljs-property\">response</span>;\n    <span class=\"hljs-keyword\">var</span> headers = response.<span class=\"hljs-property\">headers</span>;\n    <span class=\"hljs-keyword\">if</span> (lastPart.<span class=\"hljs-title function_\">match</span>(<span class=\"hljs-regexp\">/\\.html$/</span>) || lastPart.<span class=\"hljs-title function_\">match</span>(<span class=\"hljs-regexp\">/^[^.]*$/</span>)) &#123;\n        headers[<span class=\"hljs-string\">&#x27;cache-control&#x27;</span>] = &#123; <span class=\"hljs-attr\">value</span>: <span class=\"hljs-string\">&#x27;no-cache&#x27;</span> &#125;\n    &#125;\n    <span class=\"hljs-keyword\">return</span> response\n&#125;</code></pre>\n\n<p>Because this function needs access to the response being sent, the function event type needs to be <code>VIEWER_RESPONSE</code>.</p>\n<pre><code class=\"hljs\"><table class=\"hlcode-table\"><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\"><span class=\"hljs-keyword\">export</span> <span class=\"hljs-keyword\">class</span> <span class=\"hljs-title class_\">FrontendStack</span> <span class=\"hljs-keyword\">extends</span> <span class=\"hljs-title class_ inherited__\">cdk.Stack</span> {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  <span class=\"hljs-comment\">// ...</span>\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">  cfHtmlRespFunction = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Function</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;HTMLRespFunction&quot;</span>, {\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">code</span>: cf.<span class=\"hljs-property\">FunctionCode</span>.<span class=\"hljs-title function_\">fromFile</span>({\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">      <span class=\"hljs-attr\">filePath</span>: path.<span class=\"hljs-title function_\">join</span>(\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        __dirname,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        <span class=\"hljs-string\">&quot;./cf-functions/prevent-html-caching.js&quot;</span>\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">      ),\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">    }),\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">  });\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfOrigin</span> = <span class=\"hljs-keyword\">new</span> origins.<span class=\"hljs-title function_\">S3Origin</span>(<span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">publicAssetsS3Bucket</span>);\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfDistribution</span> = <span class=\"hljs-keyword\">new</span> cf.<span class=\"hljs-title class_\">Distribution</span>(<span class=\"hljs-variable language_\">this</span>, <span class=\"hljs-string\">&quot;CFDistribution&quot;</span>, {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    <span class=\"hljs-attr\">defaultBehavior</span>: {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">      <span class=\"hljs-attr\">origin</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfDistribution</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">      <span class=\"hljs-attr\">functionAssociations</span>: [\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">        {\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-attr\">function</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfPathRedirFunction</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-attr\">eventType</span>: cf.<span class=\"hljs-property\">FunctionEventType</span>.<span class=\"hljs-property\">VIEWER_REQUEST</span>,\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">        },\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        {\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-attr\">function</span>: <span class=\"hljs-variable language_\">this</span>.<span class=\"hljs-property\">cfHtmlRespFunction</span>,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">          <span class=\"hljs-attr\">eventType</span>: cf.<span class=\"hljs-property\">FunctionEventType</span>.<span class=\"hljs-property\">VIEWER_RESPONSE</span>,\n</td></tr><tr style=\"border:none;background:#fffacd;\" class=\"hlcode-line  hlcode-line-highlight\" ><td style=\"border:none\" class=\"hlcode-code-cell\">        },\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">      ],\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">    }\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">  });\n</td></tr><tr style=\"border:none;\" class=\"hlcode-line  \" ><td style=\"border:none\" class=\"hlcode-code-cell\">}\n</td></tr></table></code></pre>\n\n<p>And that is it. Run <code>cdk synth</code> and <code>cdk deploy</code> to deploy or update your cloudfront setup.</p>\n",
            "tags": [
                "cloudfront",
                "AWS",
                "CDK"
            ]
        }
    ]
}