<?xml version="1.0"?>
<rss version="2.0">
    <channel>
        <title>Icicles of Thought â€¢ Posts by &#34;rails&#34; tag</title>
        <link>https://lorefnon.me</link>
        <description></description>
        <language>en</language>
        <pubDate>Thu, 31 Mar 2016 00:00:00 +0000</pubDate>
        <lastBuildDate>Thu, 31 Mar 2016 00:00:00 +0000</lastBuildDate>
        <category>Javascript</category>
        <category>KnockoutJS</category>
        <category>Ruby</category>
        <category>EventMachine</category>
        <category>Websockets</category>
        <category>SQLite</category>
        <category>Jade</category>
        <category>Node.js</category>
        <category>Rails</category>
        <category>Emacs</category>
        <category>Gulp</category>
        <category>ActiveAdmin</category>
        <category>ActiveRecord</category>
        <category>Devise</category>
        <category>Integration</category>
        <category>ZSH</category>
        <category>Productivity Hacks</category>
        <category>OCR</category>
        <category>Design Patterns</category>
        <category>InfluxDB</category>
        <category>Grafana</category>
        <category>React</category>
        <category>Functional Programming</category>
        <category>ES6</category>
        <category>Helm</category>
        <category>SPF</category>
        <category>CSS</category>
        <category>Redux</category>
        <category>Redux-loop</category>
        <category>Frontend</category>
        <category>Vagrant</category>
        <category>Clojure</category>
        <category>Hashicorp</category>
        <category>Typescript</category>
        <category>ReasonML</category>
        <category>Next.js</category>
        <category>Koa</category>
        <category>Apollo</category>
        <category>GraphQL</category>
        <category>MongoDB</category>
        <category>Automerge</category>
        <category>CRDT</category>
        <category>SVG</category>
        <category>VSCode</category>
        <category>Comlink</category>
        <category>Web-workers</category>
        <category>io-ts</category>
        <category>MobX</category>
        <category>MobX-State-Tree</category>
        <category>Routing</category>
        <category>HAR</category>
        <category>Jq</category>
        <category>Lit-html</category>
        <category>Stimulus</category>
        <category>Kotlin</category>
        <category>Vert.X</category>
        <category>Vert.X-Web</category>
        <category>Backend-development</category>
        <category>API-development</category>
        <category>Java</category>
        <category>JOOQ</category>
        <category>Ruby on Rails</category>
        <category>Liquibase</category>
        <category>tbls</category>
        <category>jOOQ</category>
        <category>Vue</category>
        <category>TypeScript</category>
        <category>Gradle</category>
        <category>Spring</category>
        <category>Spring-Boot</category>
        <category>gRPC</category>
        <category>Redis</category>
        <category>Database</category>
        <category>Exposed</category>
        <category>vim</category>
        <category>kotlin</category>
        <category>spring</category>
        <category>spring-security</category>
        <category>komapper</category>
        <category>spring-boot</category>
        <category>typescript</category>
        <category>zod</category>
        <category>ts-pattern</category>
        <category>ts-sql-query</category>
        <category>go</category>
        <category>golang</category>
        <category>zerolog</category>
        <category>jet</category>
        <category>sql</category>
        <category>go-migrate</category>
        <category>chi</category>
        <category>connect</category>
        <category>cloudfront</category>
        <category>AWS</category>
        <category>CDK</category>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2016/03/31/database-driven-scheduling-with-clockwork-and-activejob.html</guid>
            <title>Database driven scheduling with Clockwork and ActiveJob</title>
            <link>https://lorefnon.me/2016/03/31/database-driven-scheduling-with-clockwork-and-activejob.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <pubDate>Thu, 31 Mar 2016 00:00:00 +0000</pubDate>
            <description><![CDATA[ 

&lt;a class=&#34;header-link&#34; href=&#34;#on-cron-and-cron-management-dsls&#34;&gt;&lt;h2 id=&#34;on-cron-and-cron-management-dsls&#34;&gt;On cron and cron management DSLs&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The &lt;a href=&#34;https://en.wikipedia.org/wiki/Cron&#34;&gt;cron utility&lt;/a&gt; is the typical goto scheduling solution in unix/linux systems. Utilities like &lt;a href=&#34;https://github.com/javan/whenever&#34;&gt;whenever&lt;/a&gt; allow us to take advantage of cron through an elegant and declarative pure ruby DSL.&lt;/p&gt;

&lt;p&gt;The typical approach when using whenever for scheduling is to use deployment hooks to update the crontab from whenever&#39;s configuration during application deployment. However this approach falls short when the schedule is expected to be configurable at run time and especially if we want to give administrators fine grained controls over what is being scheduled and when.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#database-driven-scheduling&#34;&gt;&lt;h2 id=&#34;database-driven-scheduling&#34;&gt;Database driven scheduling&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The post outlines an alternative solution using the library &lt;a href=&#34;https://github.com/tomykaira/clockwork&#34;&gt;clockwork&lt;/a&gt; that makes it easy to make event scheduling run time configurable through database models managed using familiar ruby ORMs.&lt;/p&gt;

&lt;p&gt;While clockwork handles the scheduling aspect, the responsibility of actual execution of the jobs is expected to be delegated to a background processor like &lt;a href=&#34;https://github.com/mperham/sidekiq&#34;&gt;sidekiq&lt;/a&gt; or &lt;a href=&#34;https://github.com/collectiveidea/delayed_job&#34;&gt;delayed job&lt;/a&gt;.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#activejob-and-standardized-apis-for-background-processing&#34;&gt;&lt;h2 id=&#34;activejob-and-standardized-apis-for-background-processing&#34;&gt;ActiveJob and standardized APIs for background processing&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Rather than coupling our code to a specific background processor which might in turn may be coupled with a specific transport system (like Sidekiq and Redis) it is advisable to rely instead (as much as possible) on ActiveJob API which provides a standardized API for background processing in Rails ecosystem.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#integration-with-admin-interfaces&#34;&gt;&lt;h2 id=&#34;integration-with-admin-interfaces&#34;&gt;Integration with Admin interfaces&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The benefit of the event system being manageable through ActiveRecord is that integrated admin interfaces like &lt;a href=&#34;https://activeadmin.info&#34;&gt;ActiveAdmin&lt;/a&gt; and &lt;a href=&#34;https://github.com/thoughtbot/administrate&#34;&gt;Administrate&lt;/a&gt; (which we might already have integrated in our existing applications) work out of the box and we get a complete schedule management interface with minimal extraneous boilerblate.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#getting-started-with-our-app&#34;&gt;&lt;h2 id=&#34;getting-started-with-our-app&#34;&gt;Getting started with our app&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The rest of the tutorial walks through the creation of a Postgres backed Rails 5 application that illustrates the concepts outlined above.&lt;/p&gt;

&lt;p&gt;We start off with familiar rails application generation steps:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;gem install rails --pre --no-rdoc --no-ri

&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails -v
Rails 5.0.0.beta3
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note that while skipping rdoc and ri is purely a matter of convenience (I did not need them at the time) - the &lt;code&gt;--pre&lt;/code&gt; flag is required, as of this writing, for installing Rails 5 as it is still in beta.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails new rails5-clockwork-demo --database&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;postgresql

      create
      create  README.md
      create  Rakefile
      create  config.ru
      create  .gitignore
      create  Gemfile
      create  app
      create  app/assets/config/manifest.js
      create  app/assets/javascripts/application.js
      create  app/assets/javascripts/cable.coffee
      create  app/assets/stylesheets/application.css
      create  app/channels/application_cable/channel.rb
      create  app/channels/application_cable/connection.rb
      create  app/controllers/application_controller.rb
      create  app/helpers/application_helper.rb
      create  app/jobs/application_job.rb
      create  app/mailers/application_mailer.rb
      create  app/models/application_record.rb
      create  app/views/layouts/application.html.erb
      create  app/views/layouts/mailer.html.erb
      create  app/views/layouts/mailer.text.erb
      create  app/assets/images/.keep
      create  app/assets/javascripts/channels
      create  app/assets/javascripts/channels/.keep
      create  app/controllers/concerns/.keep
      create  app/models/concerns/.keep
      create  bin
      create  bin/bundle
      create  bin/rails
      create  bin/rake
      create  bin/setup
      create  bin/update
      create  config
      create  config/routes.rb
      create  config/application.rb
      create  config/environment.rb
      create  config/secrets.yml
      create  config/cable.yml
      create  config/puma.rb
      create  config/environments
      create  config/environments/development.rb
      create  config/environments/production.rb
      create  config/environments/test.rb
      create  config/initializers
      create  config/initializers/active_record_belongs_to_required_by_default.rb
      create  config/initializers/application_controller_renderer.rb
      create  config/initializers/assets.rb
      create  config/initializers/backtrace_silencers.rb
      create  config/initializers/callback_terminator.rb
      create  config/initializers/cookies_serializer.rb
      create  config/initializers/cors.rb
      create  config/initializers/filter_parameter_logging.rb
      create  config/initializers/inflections.rb
      create  config/initializers/mime_types.rb
      create  config/initializers/per_form_csrf_tokens.rb
      create  config/initializers/request_forgery_protection.rb
      create  config/initializers/session_store.rb
      create  config/initializers/wrap_parameters.rb
      create  config/locales
      create  config/locales/en.yml
      create  config/boot.rb
      create  config/database.yml
      create  db
      create  db/seeds.rb
      create  lib
      create  lib/tasks
      create  lib/tasks/.keep
      create  lib/assets
      create  lib/assets/.keep
      create  log
      create  log/.keep
      create  public
      create  public/404.html
      create  public/422.html
      create  public/500.html
      create  public/apple-touch-icon-precomposed.png
      create  public/apple-touch-icon.png
      create  public/favicon.ico
      create  public/robots.txt
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures/files
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/fixtures/files/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/controllers
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/controllers/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/mailers
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/mailers/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/models
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/models/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/helpers
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/helpers/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/integration
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/integration/.keep
      create  &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/test_helper.rb
      create  tmp
      create  tmp/.keep
      create  tmp/cache
      create  tmp/cache/assets
      create  vendor/assets/javascripts
      create  vendor/assets/javascripts/.keep
      create  vendor/assets/stylesheets
      create  vendor/assets/stylesheets/.keep
      remove  config/initializers/cors.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note the line &lt;code&gt;create  app/jobs/application_job.rb&lt;/code&gt; above. Rails 5 comes pre-integrated with ActiveJob.&lt;/p&gt;

&lt;p&gt;Next we add clockwork and sidekiq to our Gemfile.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;gem &#39;clockwork&#39;
gem &#39;sidekiq&#39;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It may be tempting to just leave the in-memory adapter of ActiveJob in place but it should not be used in any production application. &lt;a href=&#34;http://edgeguides.rubyonrails.org/active_job_basics.html&#34;&gt;Rails guides&lt;/a&gt; explain it well enough:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Rails itself only provides an in-process queuing system, which only keeps the jobs in RAM. If the process crashes or the machine is reset, then all outstanding jobs are lost with the default async back-end. This may be fine for smaller apps or non-critical jobs, but most production apps will need to pick a persistent backend.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#implementing-the-event-model&#34;&gt;&lt;h2 id=&#34;implementing-the-event-model&#34;&gt;Implementing the Event model&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Next we need to define our models for persisting our schedules.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g model event name:string frequency:integer at:string job_name:string job_arguments:jsonb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Here the first three columns correspond to accessors mandated by Clockwork. Name is primary for descriptive logging purposes (more on this below). &lt;code&gt;frequency&lt;/code&gt; specifies the recurrance frequency in seconds. &lt;code&gt;at&lt;/code&gt; signifies point of occurance within the recurrance span. Following are the valid formats:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;HH:MM
 H:MM
**:MM
HH:**
(Mon|mon|Monday|monday) HH:MM
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The last two columns &lt;code&gt;job_name&lt;/code&gt; and &lt;code&gt;job_arguments&lt;/code&gt; identify the job to be triggered. As would become obvious below, we did not need to provide the job name through the database - it could be inferred at the runtime through any custom logic expressed in ruby. But having it in database leads to a straightforward and transparent implementation and management.&lt;/p&gt;

&lt;p&gt;It may be tempting to just reuse the &lt;code&gt;name&lt;/code&gt; field as the job_name as well, but it may obscure debugging when same job is being invoked as part of multiple events for different use cases. It is recommended to keep the &lt;code&gt;name&lt;/code&gt; as something representative of the use case - eg. &lt;code&gt;enterprise_plan_customers_sales_aggregation_trigger&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;Our model would look something like below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;class Event &amp;lt; ApplicationRecord
  validates :name, :frequency, :job_name, presence: true
end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#clock-rb-file-&#34;&gt;&lt;h2 id=&#34;clock-rb-file-&#34;&gt;
&lt;code&gt;clock.rb&lt;/code&gt; file:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;The entry point of clockwork is the file &lt;code&gt;clock.rb&lt;/code&gt;. This is the file that tells clockwork to
poll the events table and execute the inferred job.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;nb&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;clockwork&#39;&lt;/span&gt;
&lt;span class=&#34;nb&#34;&gt;require&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;clockwork/database_events&#39;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;require_relative&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;./config/boot&#39;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;require_relative&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;./config/environment&#39;&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;Clockwork&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;# required to enable database syncing support&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;Clockwork&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;manager&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;DatabaseEvents&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Manager&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;sync_database_events&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;model&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Event&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;every&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;minute&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;job_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;constantize&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;perform_later&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;event&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;job_arguments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#configuring-activejob-to-use-sidekiq&#34;&gt;&lt;h2 id=&#34;configuring-activejob-to-use-sidekiq&#34;&gt;Configuring ActiveJob to use sidekiq&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;We had added sidekiq as the persistence backend for ActiveJob but we have not configured ActiveJob to use it.&lt;/p&gt;

&lt;p&gt;That is one additional line of code in &lt;code&gt;config/application.rb&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;Rails5ClockworkDemo&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Application&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Application&lt;/span&gt;

    &lt;span class=&#34;c1&#34;&gt;# Configure ActiveJob to use sidekiq&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;active_job&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;queue_adapter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:sidekiq&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#running-clockwork-&#34;&gt;&lt;h2 id=&#34;running-clockwork-&#34;&gt;Running clockwork:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Clockwork can be executed by running &lt;code&gt;clockwork clock.rb&lt;/code&gt; at project root. However we can not expect something exciting yet because we simply have no entries in the table:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;clockwork clock.rb
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:02:54.032058 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Starting clock for 1 events: [ sync_database_events_for_model_Event ]&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:02:54.032150 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;sync_database_events_for_model_Event&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#adding-administrative-interface-&#34;&gt;&lt;h2 id=&#34;adding-administrative-interface-&#34;&gt;Adding administrative interface:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;We would be using ActiveAdmin for our admin interface for managing events. As of this writing to use ActiveAdmin along with Rails 5 we need to use the master branch of ActiveAdmin.&lt;/p&gt;

&lt;p&gt;While we will not go into elaboration of the ActiveAdmin DSL, most of the ideas should be applicable to alternative admin builders as well.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# Gemfile.rb&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;gem&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;activeadmin&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;github&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;activeadmin&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g active_admin:install
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;For now we skip authorization as well as authentication entirely - integrating ActiveAdmin with authentication systems is covered &lt;a href=&#34;https://github.com/activeadmin/activeadmin/blob/master/docs/0-installation.md&#34;&gt;here&lt;/a&gt; and usage in conjugation with authorization systems is covered &lt;a href=&#34;https://github.com/activeadmin/activeadmin/blob/master/docs/13-authorization-adapter.md&#34;&gt;here&lt;/a&gt; in the official docs.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g active_admin:install --skip-users
Running via Spring preloader in process 59785
      create  config/initializers/active_admin.rb
      create  app/admin
      create  app/admin/dashboard.rb
       route  ActiveAdmin.routes&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;self&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
    generate  active_admin:assets
Running via Spring preloader in process 59787
      create  app/assets/javascripts/active_admin.js.coffee
      create  app/assets/stylesheets/active_admin.scss
      create  db/migrate/20160331204250_create_active_admin_comments.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;To present our Event model through ActiveAdmin we need to generate an ActiveAdmin Event resource.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g active_admin:resource Event
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above command creates the following file for us:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;c1&#34;&gt;# app/admin/event.rb&lt;/span&gt;

&lt;span class=&#34;no&#34;&gt;ActiveAdmin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;register&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Event&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;

&lt;span class=&#34;c1&#34;&gt;# See permitted parameters documentation:&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# https://github.com/activeadmin/activeadmin/blob/master/docs/2-resource-customization.md#setting-up-strong-parameters&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# permit_params :list, :of, :attributes, :on, :model&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# or&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# permit_params do&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#   permitted = [:permitted, :attributes]&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#   permitted &amp;lt;&amp;lt; :other if params[:action] == &#39;create&#39; &amp;amp;&amp;amp; current_user.admin?&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;#   permitted&lt;/span&gt;
&lt;span class=&#34;c1&#34;&gt;# end&lt;/span&gt;


&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Once we configure permitted parameters as elaborated in the comments we have something like below:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;ActiveAdmin&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;register&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Event&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;permit_params&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:job_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:job_arguments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:frequency&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:at&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now after we can run our migrations and booted up our server:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Booting &lt;span class=&#34;nv&#34;&gt;Puma&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Rails 5.0.0.beta3 application starting in development on http://localhost:3000
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Run &lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt;rails server -h&lt;span class=&#34;sb&#34;&gt;`&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;for &lt;/span&gt;more startup &lt;span class=&#34;nv&#34;&gt;options&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt;&amp;gt; Ctrl-C to shutdown server
Puma starting in single mode...
* Version 3.2.0 &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;ruby 2.3.0-p0&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;, codename: Spring Is A Heliocentric Viewpoint
* Min threads: 5, max threads: 5
* Environment: development
* Listening on tcp://localhost:3000
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;If this is the first time you are using Rails 5 the new default home page as well as puma as the default server can be a pleasant surprise.&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/2016-03-31/rails5_home.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;Our admin panel available at &lt;code&gt;/admin&lt;/code&gt; provides us with the means to edit our events.&lt;/p&gt;

&lt;p&gt;However when we attempt to create an event we would be faced with an error because formtastic does not know out of the box how to handle jsonb field which we used for job arguments.&lt;/p&gt;

&lt;p&gt;While it is not difficult to &lt;a href=&#34;https://stackoverflow.com/questions/33720697/activeadmin-formtastic-custom-input-json&#34;&gt;create custom form inputs&lt;/a&gt; for formtastic and I have outlined an &lt;a href=&#34;https://lorefnon.me/2015/03/02/dealing-with-json-fields-in-active-admin.html&#34;&gt;alternative approach&lt;/a&gt; before, to keep the example simple let us simply use a textarea for the arguments field:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;  form do |f|
    f.inputs do
      f.input :name
      f.input :job_name
      f.input :frequency
      f.input :at
      f.input :job_arguments, as: :text
    end
    f.actions
  end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now we can create an event to trigger a dummy job:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/2016-03-31/dummy_job_form.png&#34;&gt;&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#defining-our-jobs-&#34;&gt;&lt;h2 id=&#34;defining-our-jobs-&#34;&gt;Defining our jobs:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Of course, for this job to be runnable, we need to define the job as well. We can use ActiveJob&#39;s generators for the same:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$ &lt;/span&gt;rails g job dummy
Running via Spring preloader in process 63269
      invoke  test_unit
      create    &lt;span class=&#34;nb&#34;&gt;test&lt;/span&gt;/jobs/dummy_job_test.rb
      create  app/jobs/dummy_job.rb
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Our job implementation itself is fairly mundane but serves the purpose of illustration:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;DummyJob&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationJob&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;queue_as&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;perform&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Dummy Job Executed&#34;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now once our clockwork process synchronizes with the databases, it will pickup the dummy job and keep executing every one second:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:54.003679 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;sync_database_events_for_model_Event&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:54.005132 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:55.005873 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:56.001670 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
I, &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;2016-04-01T02:30:57.001761 &lt;span class=&#34;c&#34;&gt;#57534]  INFO -- : Triggering &#39;execute_dummy_job&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In the rails development log we can see that ActiveRecord is queuing this job:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 64813900-c70f-4b40-9dd7-452c4cac6b73&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 0d0a66d1-a46b-4427-92db-83a301b38c1c&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 1de45b36-7cc9-4a9a-9bb7-363591f64dd5&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;ActiveJob&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt; Enqueued DummyJob &lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;Job ID: 483fe8a2-5acf-4830-80fb-6c6883f0f7c2&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt; to Sidekiq&lt;span class=&#34;o&#34;&gt;(&lt;/span&gt;default&lt;span class=&#34;o&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now if we run sidekiq, our background processor - we should see the enqued job getting executed in the &lt;code&gt;log/sidekiq.log&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;bash language-bash&#34; data-lang=&#34;bash&#34;&gt;2016-03-31T21:01:00.064Z 64128 TID-ox54l2v7s DummyJob JID-fc59a048d2d1fe2aeecc3452 INFO: start
Dummy Job Executed
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;This concludes our introductory post on database driven scheduling with clockwork. Please share any issues you might have faced or any suggestions for improvement in the comments.&lt;/p&gt;

&lt;p&gt;The source code for this post is available in this &lt;a href=&#34;https://github.com/lorefnon/rails5-clockwork-demo&#34;&gt;github repo&lt;/a&gt;.&lt;/p&gt;

 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2016/01/16/useful-delegation-patterns-for-rails.html</guid>
            <title>Useful delegation patterns for Rails</title>
            <link>https://lorefnon.me/2016/01/16/useful-delegation-patterns-for-rails.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <pubDate>Sat, 16 Jan 2016 00:00:00 +0000</pubDate>
            <description><![CDATA[ 
&lt;a class=&#34;header-link&#34; href=&#34;#about-delegation&#34;&gt;&lt;h2 id=&#34;about-delegation&#34;&gt;About delegation&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Delegation is a very useful software pattern and this post focusses on how this pattern can be applied in the context of a Rails application and the associated advantages of doing so.&lt;/p&gt;

&lt;p&gt;If you are unfamiliar with this pattern, &lt;a href=&#34;https://en.wikipedia.org/wiki/Delegation_pattern&#34;&gt;Wikipedia&lt;/a&gt; has a very good explanation: &lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;In software engineering, the delegation pattern is a design pattern in object-oriented programming where an object, instead of performing one of its stated tasks, delegates that task to an associated helper object.&lt;/p&gt;

&lt;p&gt;There is an Inversion of Responsibility in which a helper object, known as a delegate, is given the responsibility to execute a task for the delegator.&lt;/p&gt;
&lt;/blockquote&gt;

&lt;p&gt;Also, this &lt;a href=&#34;https://stackoverflow.com/questions/7168714/what-is-the-purpose-of-a-delegation-pattern&#34;&gt;Stackoverflow post&lt;/a&gt; has some interesting posts elaborating on the practical benefits of the concepts of delegation in a language neutral context.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#implementing-delegators-in-ruby&#34;&gt;&lt;h2 id=&#34;implementing-delegators-in-ruby&#34;&gt;Implementing Delegators in Ruby&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Ruby&#39;s metaprogramming facilities enable us to implement delegation in a much easier and consise manner than many other object oriented languages.&lt;/p&gt;

&lt;p&gt;Using dynamic interception of method calls, it is very straightforward to forward method invocations to a target object. This is very well illustrated by the &lt;a href=&#34;https://github.com/ruby/ruby/blob/trunk/lib/delegate.rb#L75-L89&#34;&gt;implementation&lt;/a&gt; of &lt;a href=&#34;https://github.com/sj26/ruby-1.9.3-p0/blob/master/lib/delegate.rb&#34;&gt;Delegate class&lt;/a&gt; provided by Ruby standard library:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Delegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;BasicObject&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;#...&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# Handles the magic of delegation through \_\_getobj\_\_.&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;method_missing&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__getobj__&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;false&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;r&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;respond_to?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;target&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__send__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Kernel&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;respond_to?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Kernel&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;instance_method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;bind&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;block&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#wrapping-objects-with-simpledelegator&#34;&gt;&lt;h2 id=&#34;wrapping-objects-with-simpledelegator&#34;&gt;Wrapping objects with SimpleDelegator&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;In practice we usually deal with &lt;a href=&#34;https://ruby-doc.org/stdlib-2.1.0/libdoc/delegate/rdoc/SimpleDelegator.html&#34;&gt;&lt;code&gt;SimpleDelegator&lt;/code&gt;&lt;/a&gt; subclass of &lt;code&gt;Delegator&lt;/code&gt; more often. The constructor takes a single object and any method invocations are delegated to the target instance. &lt;/p&gt;

&lt;p&gt;We can simply subclass from &lt;code&gt;SimpleDelegator&lt;/code&gt; and implement our customizations therein, and delegate to the parent object through a &lt;code&gt;super&lt;/code&gt; call conveniently.&lt;/p&gt;

&lt;p&gt;Example from docs:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;born_on&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;Date&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1989&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserDecorator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;birth_year&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;born_on&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;year&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;o&#34;&gt;&amp;gt;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;UserDecorator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#using-delegation-for-presenter-logic&#34;&gt;&lt;h3 id=&#34;using-delegation-for-presenter-logic&#34;&gt;Using delegation for Presenter logic&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is arguably the most common use case for delegators. Often we end up adding a lot of methods in our models that have nothing to do with domain logic whatsoever. Does something like this look familiar?&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt;

  &lt;span class=&#34;c1&#34;&gt;# ...&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;formatted_date_of_birth&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;date_of_birth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strftime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Born on %m/%d/%Y&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Such methods which are primarily written for handling presentation concerns come into the perview of Presenter logic and are best left out of models. Instead we can decorate our model instances using presenter classes before passing them to views:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserDecorator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

 &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;formatted_date_of_birth&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;date_of_birth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;strftime&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Born on %m/%d/%Y&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
 &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UsersController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;show&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;find&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;params&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:id&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;UserDecorator&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I find this to be more elegant from an object oriented perspective compared to the conventional approach using Rails helper modules.&lt;/p&gt;

&lt;p&gt;There are many &lt;a href=&#34;https://www.ruby-toolbox.com/categories/rails_presenters&#34;&gt;libraries&lt;/a&gt; for implementing additional convenience utilities around presenters. While the above simple approach takes us quite far, if you find yourself repeating the decorator instantiation boilerplate, generators and conventions offered by a library like &lt;a href=&#34;https://github.com/drapergem/draper&#34;&gt;Draper&lt;/a&gt; can be helpful.&lt;/p&gt;

&lt;p&gt;Note that one of the biggest strengths of decorators is on demand composability. For instance we may have various user centric helper methods for reporting. We can extract them into a &lt;code&gt;UserReportPresenter&lt;/code&gt; decorator that is used only in the &lt;code&gt;UserReportsController&lt;/code&gt;. Accordingly we can have multiple use-case specific delegators layered one upon another, each delegating to its immediate target transparently.&lt;/p&gt;

&lt;p&gt;We may want to have some approach to restrict what can be decorated by a decorator. We may be tempted to define something like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserReportPresenter&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDecorator&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;initialize&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ArgumentError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Expected entity being decorated to be User&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However this is not something we would want to do as it breaks composability. One approach would be to &#34;unwrap&#34; the decorated before instance check:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;while&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Decorator&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;__getobj__&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;decorated&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ArgumentError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Expected entity being decorated to be User&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;but I strongly recommend not resorting to &lt;code&gt;is_a?&lt;/code&gt; checks at all and relying instead on behavior checks using &lt;code&gt;responds_to?&lt;/code&gt;.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#delegation-for-memoization-caching&#34;&gt;&lt;h3 id=&#34;delegation-for-memoization-caching&#34;&gt;Delegation for memoization/caching&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is another good use case for delegation. We can wrap our models into Delegators that transparently cache or memoize method invocations:&lt;/p&gt;

&lt;p&gt;Example using &lt;code&gt;Rails.cache&lt;/code&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserReportCachedDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;annual_performance_stats&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;cache&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fetch&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;user.&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;#&amp;#123;&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;id&lt;/span&gt;&lt;span class=&#34;si&#34;&gt;&amp;#125;&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;.annual_performance_stats&#34;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;However one thing that we should keep in mind that SimpleDelegator allows the decorated target to be run time configurable. While this is not a problem in the above implementation as we use an entity specific key, this may become a problem if, for example, we were using transparent memoization through &lt;a href=&#34;https://github.com/matthewrudy/memoist&#34;&gt;Memoist&lt;/a&gt;:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserReportMemoizedDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;extend&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Memoist&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;annual_performance_stats&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;;&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;memoize&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:annual_performance_stats&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above implementation is broken because even if we were to change the decorated instance using &lt;code&gt;__setobj__&lt;/code&gt; our memoized method would continue returning the output of invocation of the method on previously decorated instance.&lt;/p&gt;

&lt;p&gt;A simple solution for the above is to flush the cache when the decorated entity changes:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;MemoizedDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;extend&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Memoist&lt;/span&gt;

   &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;__setobj__&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
     &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;
     &lt;span class=&#34;n&#34;&gt;flush_cache&lt;/span&gt;
   &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#using-delegation-for-collection-objects&#34;&gt;&lt;h3 id=&#34;using-delegation-for-collection-objects&#34;&gt;Using delegation for collection objects&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is something I recently found to be useful. Sometimes when we need to define operations that make sense for a set of instances, we just resort to class methods in model. However a better object oriented design would be to implement such behaviors on a dedicated collection resource.&lt;/p&gt;

&lt;p&gt;Decorating &lt;code&gt;ActiveRecord::CollectionProxy&lt;/code&gt; is helpful because we get facilities like scope chaining, lazy-loading etc. for free.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;EmployeesReportDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;month_wise_performance_stats&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;joins&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:assessments&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;group&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;MONTH(assessments.created_at)&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;select&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s1&#34;&gt;&#39;assessments.evaluation_rank as rank&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#using-delegation-to-augment-lifecycle-hooks&#34;&gt;&lt;h3 id=&#34;using-delegation-to-augment-lifecycle-hooks&#34;&gt;Using delegation to augment lifecycle hooks&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is occassionaly useful especially when dealing with third party SDKs. We can leverage &lt;code&gt;ActiveSupport::Callbacks&lt;/code&gt; to wrap custom callback hooks around specific behaviors of decorated objects:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;MailDispatchDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;SimpleDelegator&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;include&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Callbacks&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;define_callbacks&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:dispatch&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;dispatch&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;run_callbacks&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:dispatch&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;      
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;MailFilterDelegator&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;MailDispatchDelegator&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;set_callback&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:dispatch&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:before&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;object&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;validated_domains&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;include?&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;object&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;domain&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ValidationError&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;Domain not whitelisted&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#in-rails-any-module-can-delegate&#34;&gt;&lt;h2 id=&#34;in-rails-any-module-can-delegate&#34;&gt;In Rails, any module can delegate&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;While creating a dedicated Delegator makes sense in a variety of use cases, often we want to just delegate just a few methods to a contained object. ActiveSupport Module extensions provide a convenient approach to delegate specific methods to any contained object. This comes in very handy in controllers:&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#delegating-helpers-to-model-instances-&#34;&gt;&lt;h3 id=&#34;delegating-helpers-to-model-instances-&#34;&gt;Delegating helpers to model instances:&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;For example in a rails controller, we might want to expose a few model methods:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ProductsController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:ensure_logged_in!&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:available_products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_user&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;index&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@available_products&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;available_products&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;We can also simply expose the delegated methods as a helper_method to our views:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ProductsController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:ensure_logged_in!&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:available_products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_user&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;helper_method&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:available_products&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;I have found this to be a common use case, and a class method that wraps the two can help in DRYing things up:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;delegate_helper&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;*&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;
  &lt;span class=&#34;kp&#34;&gt;loop&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;method_name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;args&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;shift&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;break&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;unless&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;is_a?&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Symbol&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;helper_method&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;method_name&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;The above method allows us to take advantage of full api of &lt;code&gt;Module#delegate&lt;/code&gt; which allows delegation of multiple methods to single target and configuration of generated method.&lt;/p&gt;

&lt;p&gt;So for example, we can do the following:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;SomeController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:ensure_logged_in!&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate_helper&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:designations&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:products&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; 
                  &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; 
                  &lt;span class=&#34;ss&#34;&gt;prefix&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now delegated methods would be available as &lt;code&gt;current_user_designations&lt;/code&gt; and &lt;code&gt;current_user_products&lt;/code&gt; in our views.&lt;/p&gt;

&lt;p&gt;&lt;code&gt;Module#delegate&lt;/code&gt; works very well with instance variables and class variables as well. Here is an example from the &lt;a href=&#34;http://api.rubyonrails.org/classes/Module.html#method-i-delegate&#34;&gt;official documentation&lt;/a&gt; :&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Foo&lt;/span&gt;
  &lt;span class=&#34;no&#34;&gt;CONSTANT_ARRAY&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;1&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;2&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;3&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
  &lt;span class=&#34;vc&#34;&gt;@@class_array&lt;/span&gt;  &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;4&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;5&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;6&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;7&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;initialize&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@instance_array&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;8&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;9&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;10&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;11&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:sum&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:CONSTANT_ARRAY&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:min&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:@@class_array&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;delegate&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:max&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;to&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:@instance_array&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;no&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;sum&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# =&amp;gt; 6&lt;/span&gt;
&lt;span class=&#34;no&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;min&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# =&amp;gt; 4&lt;/span&gt;
&lt;span class=&#34;no&#34;&gt;Foo&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;max&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;# =&amp;gt; 11&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#chaining-delegators&#34;&gt;&lt;h3 id=&#34;chaining-delegators&#34;&gt;Chaining delegators&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;As you may have inferred at this point, we can easily chain delegated invocations:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;class ProductsController &amp;lt; ApplicationController

  before_action :ensure_logged_in!
  delegate :manager, to: :current_user
  delegate :designation, to: :manager, prefix: :manager

end
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#delegation-as-an-alternative-to-concerns&#34;&gt;&lt;h2 id=&#34;delegation-as-an-alternative-to-concerns&#34;&gt;Delegation as an alternative to Concerns&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Since the official endorsement of concerns from Rails 4 concerns have soared in popularity, however I have often observend that concerns are overused, especially for use cases that are better handled by other patterns.&lt;/p&gt;

&lt;p&gt;Since this post is about delegation, let us look at a few things that delegation has to offer over concerns:&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#run-time-configurability-&#34;&gt;&lt;h3 id=&#34;run-time-configurability-&#34;&gt;Run time configurability:&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;While it is true that concerns can be injected at run time, however code that runs in the included hooks potentially modifies the host instance making run time switching of concerns not very practical in most cases. Delegation offers a clearer approach and we have already demonstrated that switching delegated instances in delegator instances is quite useful.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#on-demand-specialization-&#34;&gt;&lt;h3 id=&#34;on-demand-specialization-&#34;&gt;On demand specialization:&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;This is particularly useful for objects that did not originate in our code. Rather than polluting the library generated objects with application specific behavior, which may cause subtle unintended side-effects, it is much more elegant to pass around decorated instances in application code and pass the unwrapped instances back to the library should there be a need to do so.&lt;/p&gt;

&lt;p&gt;All in all concnerns are more suitable for application specific classes where core functionality is shared among multiple classes, and delegation is more useful for implementing auxiliary use case specific behaviors or transparently augmenting existing behavior. &lt;/p&gt;

&lt;p&gt;A good example of former use case would be a cross-cutting functionality like using a &lt;code&gt;completed_at&lt;/code&gt; column for scoping on completion status or checking if a model (eg. Payment, Project etc.) has been completed  :&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;CompletionSupport&lt;/span&gt;
  &lt;span class=&#34;kp&#34;&gt;extend&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveSupport&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Concern&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;included&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;

    &lt;span class=&#34;o&#34;&gt;%&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;complete&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;completed&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;].&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;each&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;scope&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;where&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;completed_at is not null&#39;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;scope&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:incomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-&amp;gt;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;where&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;completed_at&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;nil&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;complete!&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;completed_at&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;DateTime&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;now&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;complete?&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;completed_at&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;present?&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;alias_method&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:completed?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:complete?&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;incomplete?&lt;/span&gt;
    &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;complete?&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;alias_method&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:not_completed?&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:incomplete?&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;a class=&#34;header-link&#34; href=&#34;#delegation-in-command-line-applications&#34;&gt;&lt;h2 id=&#34;delegation-in-command-line-applications&#34;&gt;Delegation in command line applications&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;Last but not the least, delegation makes sense in command line applications as well. An excellent example would be github&#39;s &lt;a href=&#34;https://github.com/github/hub&#34;&gt;hub&lt;/a&gt; command line utility that makes a lot of github &lt;a href=&#34;https://github.com/github/hub#commands&#34;&gt;features&lt;/a&gt; like &lt;code&gt;pull-requests&lt;/code&gt; accessible from the command line, while delegating everything else to git.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#some-alternatives&#34;&gt;&lt;h2 id=&#34;some-alternatives&#34;&gt;Some alternatives&lt;/h2&gt;&lt;/a&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#observers&#34;&gt;&lt;h3 id=&#34;observers&#34;&gt;Observers&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;While observer pattern can help towards decoupling and the advantags therein overlap with those offered by delegates in some cases, in general I refrain from using Observer pattern because it makes the flow of logic harder to trace - especially in larger applications.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#refinements&#34;&gt;&lt;h3 id=&#34;refinements&#34;&gt;Refinements&lt;/h3&gt;&lt;/a&gt;

&lt;p&gt;Refinements are a recent addition to the Ruby language where in we can selectively monkey-patch modules (and hence classes) with custom behavior. But a key aspect of refinements is lexical scoping. The offical docs explain this very well:&lt;/p&gt;

&lt;blockquote&gt;
&lt;p&gt;Refinements are lexical in scope. When control is transferred outside the scope the refinement is deactivated. This means that if you require or load a file or call a method that is defined outside the current scope the refinement will be deactivated:&lt;/p&gt;
&lt;/blockquote&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby language-ruby&#34; data-lang=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;C&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;module&lt;/span&gt; &lt;span class=&#34;nn&#34;&gt;M&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;refine&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;C&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;foo&lt;/span&gt;
      &lt;span class=&#34;nb&#34;&gt;puts&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;C#foo in M&#34;&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;call_foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;using&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;M&lt;/span&gt;

&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;C&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;foo&lt;/span&gt;       &lt;span class=&#34;c1&#34;&gt;# prints &#34;C#foo in M&#34;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;call_foo&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;x&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;#=&amp;gt; raises NoMethodError&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;While this explicit aspect of Refinements is a commendable improvement over adhoc monkey-patching in many scenarios - the convenience offered by transparent overlaying of behavior that decorators offer us, is, in most practical cases, more appealing.&lt;/p&gt;

&lt;p&gt;The primary exception to the above would be cases where the code consuming the augmented instances rely on &lt;code&gt;instance_of?&lt;/code&gt; checks to determine the identity of passed instance. Using refinements we are not changing the class of the instance, where as while passing the wrapped instance we fail on the &lt;code&gt;instance_of?&lt;/code&gt; checks as the wrapped instances are actually instances of a different class though they implement interchangeable behavior.&lt;/p&gt;

&lt;p&gt;This concludes our post on delegation. As always any insights on pragmatic usage of this pattern is more than welcome. Please use the comments section to share any feedback or criticism.&lt;/p&gt;

 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2015/11/26/boost-your-content-focussed-site-with-structured-page-fragments.html</guid>
            <title>Boost your content focussed site with Structured Page Fragments</title>
            <link>https://lorefnon.me/2015/11/26/boost-your-content-focussed-site-with-structured-page-fragments.html</link>
            <category>Javascript</category>
            <category>Rails</category>
            <category>SPF</category>
            <pubDate>Thu, 26 Nov 2015 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;h2 id=&#34;The-context&#34;&gt;&lt;a href=&#34;#The-context&#34; class=&#34;headerlink&#34; title=&#34;The context&#34;&gt;&lt;/a&gt;The context&lt;/h2&gt;&lt;p&gt;SPF.js a lightweight javascript library to incorporate dynamic page updates that dramatically reduces perceived page latency. Quoting from the Repo Homepage:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Using progressive enhancement and HTML5, SPF integrates with your site to enable a faster, more fluid user experience by updating just the sections of the page that change during navigation, not the whole page. SPF provides a response format for sending document fragments, a robust system for script and style management, an in-memory cache, on-the-fly processing, and more.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;While for complex dynamic sites which have a significant amount of client side logic, I still recommend adopting a client side javascript framework, but for content focussed sites, a nifty utility like SPF.js can be very useful.&lt;/p&gt;
&lt;span id=&#34;more&#34;&gt;&lt;/span&gt;

&lt;h2 id=&#34;Why-not-good-old-js-erb-templates&#34;&gt;&lt;a href=&#34;#Why-not-good-old-js-erb-templates&#34; class=&#34;headerlink&#34; title=&#34;Why not good old js.erb templates ?&#34;&gt;&lt;/a&gt;Why not good old js.erb templates ?&lt;/h2&gt;&lt;p&gt;While Rails allows us to render server generated javascript templates, using them to generate dynamic page updates is a bit cumbersome for most scenarios. Especially you have to handle page url updates manually, scroll back the pages manually etc. None of them are very complex concerns, but having a library deal with such cross cutting concerns is much more elegant IMHO.&lt;/p&gt;
&lt;h2 id=&#34;What-about-turbolinks&#34;&gt;&lt;a href=&#34;#What-about-turbolinks&#34; class=&#34;headerlink&#34; title=&#34;What about turbolinks ?&#34;&gt;&lt;/a&gt;What about turbolinks ?&lt;/h2&gt;&lt;p&gt;While yes, turbolinks does enjoy being a part of the default Rails stack, but frankly, it has always seemed like a half baked product. While turbolinks does improve the experience over full page reloads, behind the scenes it still loads the full page content.&lt;/p&gt;
&lt;p&gt;SPF.js allows you to just fetch the parts of the page that really need updating. The GIF below, also taken from the official site, explains this much better:&lt;/p&gt;
&lt;table style=&#34;margin: auto&#34;&gt;
  &lt;thead&gt;
    &lt;tr&gt;
      &lt;th&gt; Full page re-rerendering &lt;/th&gt;
      &lt;th&gt; Partial section replacement with SPF.js &lt;/th&gt;
    &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
    &lt;tr&gt;
      &lt;td&gt; &lt;img src=&#34;/images/animation-static-340x178.gif&#34;&gt;&lt;/td&gt;
      &lt;td&gt; &lt;img src=&#34;/images/animation-dynamic-340x178.gif&#34;&gt;&lt;/td&gt;
    &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;

&lt;h2 id=&#34;But-doesn-39-t-the-latest-version-of-turbolinks-include-support-for-partial-page-replacement&#34;&gt;&lt;a href=&#34;#But-doesn-39-t-the-latest-version-of-turbolinks-include-support-for-partial-page-replacement&#34; class=&#34;headerlink&#34; title=&#34;But doesn&amp;#39;t the latest version of turbolinks include support for partial page replacement ?&#34;&gt;&lt;/a&gt;But doesn&amp;#39;t the latest version of turbolinks include support for partial page replacement ?&lt;/h2&gt;&lt;p&gt;Yes, but there is a &lt;a href=&#34;https://github.com/rails/turbolinks/issues/628&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;lack of clarity&lt;/a&gt; over when (and if) that feature will be officially released.&lt;/p&gt;
&lt;p&gt;In a nutshell, the version of turbolinks that is scheduled to ship with Rails 5, significantly diverges from what has hitherto been considered as the &lt;a href=&#34;https://github.com/rails/turbolinks/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;official turbolinks repo&lt;/a&gt;, and will probably not contain, among other features, support for partial page replacements. While the future is not set in stone, and as DHH has &lt;a href=&#34;https://github.com/rails/turbolinks/issues/628#issuecomment-157376926&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;put it&lt;/a&gt;:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;But, hey, it&amp;#39;s just code. If the current state of this repo serves your
needs, you don&amp;#39;t need any official blessing from anyone to use it. You can
use it as-is, you can fork, you can do whatever you want. MIT baby!&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;While I appreciate the freedom associated with open source licenses, I would rather bet on a well supported library that caters to the exact same use case and which is already being used in production in a wildly popular site - Youtube.&lt;/p&gt;
&lt;h2 id=&#34;Integrating-SPF-js-with-Rails&#34;&gt;&lt;a href=&#34;#Integrating-SPF-js-with-Rails&#34; class=&#34;headerlink&#34; title=&#34;Integrating SPF.js with Rails&#34;&gt;&lt;/a&gt;Integrating SPF.js with Rails&lt;/h2&gt;&lt;p&gt;The rest of the post outlines the steps required to integrate SPF.js with a rails application. The code for this tutorial is available in &lt;a href=&#34;https://github.com/lorefnon/rails-spfjs-demo&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;We will create a dummy blog application. But hey, since this is just a demo application, we can get away with a little &lt;a href=&#34;https://github.com/sevenwire/forgery&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Forgery&lt;/a&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;PostsController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;index&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; = params[&lt;span class=&#34;hljs-symbol&#34;&gt;:page&lt;/span&gt;].to_i
    &lt;span class=&#34;hljs-variable&#34;&gt;@num_pages&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;1000&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@posts&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;.times.map &amp;#123; fake_post_summary &amp;#125;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;show&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@post&lt;/span&gt; = fake_post
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  private

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;fake_post&lt;/span&gt;
    &lt;span class=&#34;hljs-title class_&#34;&gt;OpenStruct&lt;/span&gt;.new fake_post_summary.to_h.merge!(
      &lt;span class=&#34;hljs-symbol&#34;&gt;id:&lt;/span&gt; params[&lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;],
      &lt;span class=&#34;hljs-symbol&#34;&gt;body:&lt;/span&gt; LoremIpsum.random(&lt;span class=&#34;hljs-symbol&#34;&gt;paragraphs:&lt;/span&gt; rand(&lt;span class=&#34;hljs-number&#34;&gt;20&lt;/span&gt;))
    )
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;fake_post_summary&lt;/span&gt;
    &lt;span class=&#34;hljs-title class_&#34;&gt;OpenStruct&lt;/span&gt;.new(
      &lt;span class=&#34;hljs-symbol&#34;&gt;id:&lt;/span&gt; rand(&lt;span class=&#34;hljs-number&#34;&gt;1000&lt;/span&gt;),
      &lt;span class=&#34;hljs-symbol&#34;&gt;title:&lt;/span&gt; LoremIpsum.lorem_ipsum(&lt;span class=&#34;hljs-symbol&#34;&gt;words:&lt;/span&gt; rand(&lt;span class=&#34;hljs-number&#34;&gt;20&lt;/span&gt;)),
      &lt;span class=&#34;hljs-symbol&#34;&gt;summary:&lt;/span&gt; LoremIpsum.random(&lt;span class=&#34;hljs-symbol&#34;&gt;paragraphs:&lt;/span&gt; &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;),
      &lt;span class=&#34;hljs-symbol&#34;&gt;author:&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;OpenStruct&lt;/span&gt;.new(
        &lt;span class=&#34;hljs-symbol&#34;&gt;user_name:&lt;/span&gt; Forgery(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;internet&amp;#x27;&lt;/span&gt;).user_name,
        &lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; Forgery(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;internet&amp;#x27;&lt;/span&gt;).email_address
      )
    )
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So now that we have our dummy posts in place, we just need to show them:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;&amp;lt;!-- posts/index.html.erb --&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;blog-container&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h1&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;blog-title title&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; Lorefnon&amp;#x27;s Awesome blog &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h1&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;page-title title&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; Posts &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;posts-container&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;posts/posts&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;br/&gt;

&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;&amp;lt;!-- posts/_posts.html.erb --&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;posts-list&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;posts&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@posts&lt;/span&gt;.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;post&lt;/span&gt;| &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;posts/summary&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;post:&lt;/span&gt; post &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;navigation-links&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;posts/navigation_links&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;br/&gt;

&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;&amp;lt;!-- posts/_summary.html.erb --&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;data-post-id&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;lt;%=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; post.id &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&lt;span class=&#34;hljs-string&#34;&gt;%&amp;gt;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;title post-title&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to post.title, post_path(&lt;span class=&#34;hljs-symbol&#34;&gt;id:&lt;/span&gt; post.id) &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; post.summary &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;br/&gt;

&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;&amp;lt;!-- posts/_navigation_links.html.erb --&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; &amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;   &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Previous Page&amp;#x27;&lt;/span&gt;, posts_path(&lt;span class=&#34;hljs-symbol&#34;&gt;page:&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt;-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-variable&#34;&gt;@num_pages&lt;/span&gt; -&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;   &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Next Page&amp;#x27;&lt;/span&gt;, posts_path(&lt;span class=&#34;hljs-symbol&#34;&gt;page:&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt;+&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;) &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;br/&gt;

&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;&amp;lt;!-- posts/show.html.erb --&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;blog-container&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;post-title title&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-variable&#34;&gt;@post&lt;/span&gt;.title, post_path(&lt;span class=&#34;hljs-symbol&#34;&gt;id:&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@post&lt;/span&gt;.id) &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;post-body&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@post&lt;/span&gt;.body &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The above templates have nothing particularly characteristic. If you would have written them yourself, I guess you would have implemented something very similar. I have presented above to particularly highlight that the way you structure your views does not need to be drastically altered to use SPF.js. Hence it is easy to take your existing sites and start using SPF.js.&lt;/p&gt;
&lt;p&gt;Our dummy blog looks something like this now:&lt;/p&gt;
&lt;img src=&#34;/images/2015-11-26/blog_index.png&#34;&gt;

&lt;h2 id=&#34;Including-SPF&#34;&gt;&lt;a href=&#34;#Including-SPF&#34; class=&#34;headerlink&#34; title=&#34;Including SPF&#34;&gt;&lt;/a&gt;Including SPF&lt;/h2&gt;&lt;p&gt;Next step for us is to include SPF.js in the page. For that we will just add the cdn link to our layout. Other methods of including are available &lt;a href=&#34;https://github.com/youtube/spfjs#download&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;After this inclusion our template might look something like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-meta&#34;&gt;&amp;lt;!DOCTYPE &lt;span class=&#34;hljs-keyword&#34;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;Rails Spfjs Demo&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;title&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; javascript_include_tag &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;//ajax.googleapis.com/ajax/libs/spf/2.3.0/spf.js&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; stylesheet_link_tag    &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;application&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;media:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;all&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; javascript_include_tag &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;application&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; csrf_meta_tags &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;head&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;yield&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    spf.init();&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;script&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;body&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;html&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;Making-navigation-links-SPF-aware&#34;&gt;&lt;a href=&#34;#Making-navigation-links-SPF-aware&#34; class=&#34;headerlink&#34; title=&#34;Making navigation links SPF aware&#34;&gt;&lt;/a&gt;Making navigation links SPF aware&lt;/h2&gt;&lt;p&gt;However just initializing SPF.js does not magically ajaxify all navigation links. In fact by so far SPF.js does not alter the navigation in any way. We need to explicitly enable SPFjs for links for which our server knows how to server partial content. For SPF to process a link, it should have the class &amp;#39;spf-link&amp;#39;. Let us start with our navigation links:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; &amp;gt; &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;   &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Previous Page&amp;#x27;&lt;/span&gt;, posts_path(&lt;span class=&#34;hljs-symbol&#34;&gt;page:&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt;-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;), &lt;span class=&#34;hljs-symbol&#34;&gt;class:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;spf-link&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-variable&#34;&gt;@num_pages&lt;/span&gt; -&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;   &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Next Page&amp;#x27;&lt;/span&gt;, posts_path(&lt;span class=&#34;hljs-symbol&#34;&gt;page:&lt;/span&gt; &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt;+&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;), &lt;span class=&#34;hljs-symbol&#34;&gt;class:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;spf-link&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;One great feature of SPF.js is that it handles graceful degradation. So, since we haven&amp;#39;t done anything on the server side to generate partial contents, SPF will try to make an ajax request to server (with the special query parameter spf&amp;#x3D;navigate) and once that response format does not match what SPF expects, it will allow a full page reload.&lt;/p&gt;
&lt;h2 id=&#34;Server-side-handling-for-SPF&#34;&gt;&lt;a href=&#34;#Server-side-handling-for-SPF&#34; class=&#34;headerlink&#34; title=&#34;Server side handling for SPF&#34;&gt;&lt;/a&gt;Server side handling for SPF&lt;/h2&gt;&lt;p&gt;Let us move on to server side handling:&lt;/p&gt;
&lt;p&gt;As we have previously mentioned that SPF sends an ajax request using spf&amp;#x3D;navigate query parameter. We can detect that in our controller and send out a special response that only includes the parts of the page we need to update:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;PostsController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;index&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; = params[&lt;span class=&#34;hljs-symbol&#34;&gt;:page&lt;/span&gt;].to_i
    &lt;span class=&#34;hljs-variable&#34;&gt;@num_pages&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;1000&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@posts&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;.times.map &amp;#123; fake_post_summary &amp;#125;

    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; params[&lt;span class=&#34;hljs-symbol&#34;&gt;:spf&lt;/span&gt;] == &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;navigate&amp;#x27;&lt;/span&gt;
      render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;posts/index.json&amp;#x27;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

...&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next we will have to designate the parts that can be dynamically replace using an id. In our modified &lt;code&gt;posts/_summary.html.erb&lt;/code&gt; below, &lt;code&gt;spf-posts-container&lt;/code&gt; serves that purpose:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;data-post-id&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;lt;%=&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; post.id &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&lt;span class=&#34;hljs-string&#34;&gt;%&amp;gt;&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;title post-title&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to post.title, post_path(&lt;span class=&#34;hljs-symbol&#34;&gt;id:&lt;/span&gt; post.id) &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; post.summary &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;


&lt;p&gt;While SPF does not require DOM node IDs to begin with &lt;code&gt;spf-&lt;/code&gt; prefix I think this is a good convention and makes the intent explict.&lt;/p&gt;
&lt;p&gt;Finally here is our json template that contains the partial page update, in the format that SPF.js &lt;a href=&#34;https://youtube.github.io/spfjs/documentation/responses/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;can process&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;index.json.erb:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;quot;body&amp;quot;: &amp;#123;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;quot;spf-posts-container&amp;quot;: &amp;quot;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; j render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;posts/posts&amp;#x27;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&amp;quot;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;#125;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;#125;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While we are using a simple &lt;code&gt;json.erb&lt;/code&gt; template, it should be noted that any generic approach that can generate json response in rails, works well. So if you are already using &lt;code&gt;rabl&lt;/code&gt; or &lt;code&gt;jbuilder&lt;/code&gt; in your APIs, you can continue using that.&lt;/p&gt;
&lt;p&gt;Now when a navigation link is clicked, the json response is fetched via ajax and the page is dynamically updated - resulting in a much smoother user experience. Also note that browser url has been automatically updated and the page scrolls to the top. SPF tries to emulate the experience the experience of page change as much as possible to prevent uncanny surprises.&lt;/p&gt;
&lt;img src=&#34;/images/2015-11-26/spf_response.png&#34;&gt;

&lt;h2 id=&#34;Optional-Leveraging-rails-magic-for-leaner-controllers&#34;&gt;&lt;a href=&#34;#Optional-Leveraging-rails-magic-for-leaner-controllers&#34; class=&#34;headerlink&#34; title=&#34;(Optional) Leveraging rails magic for leaner controllers&#34;&gt;&lt;/a&gt;(Optional) Leveraging rails magic for leaner controllers&lt;/h2&gt;&lt;p&gt;While the above works, it is unweildy to handle the navigation link in each controller. We can alternatively make the &lt;code&gt;default_render&lt;/code&gt; method that is used by rails to be SPF aware. The &lt;a href=&#34;https://github.com/rails/rails/blob/7f18ea14c893cb5c9f04d4fda9661126758332b5/actionpack/lib/action_controller/metal/implicit_render.rb&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;default implementation&lt;/a&gt; looks like this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;default_render&lt;/span&gt;(&lt;span class=&#34;hljs-params&#34;&gt;*args&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; template_exists?(action_name.to_s, _prefixes, &lt;span class=&#34;hljs-symbol&#34;&gt;variants:&lt;/span&gt; request.variant)
    render(*args)
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; block_given?
      &lt;span class=&#34;hljs-keyword&#34;&gt;yield&lt;/span&gt;(*args)
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      logger.info &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;No template found for &lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;&lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt;.name&amp;#125;&lt;/span&gt;\#&lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;action_name&amp;#125;&lt;/span&gt;, rendering head :no_content&amp;quot;&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; logger
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We can override this in our ApplicationController&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;ApplicationController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActionController::Base&lt;/span&gt;

  &lt;span class=&#34;hljs-comment&#34;&gt;# Prevent CSRF attacks by raising an exception.&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# For APIs, you may want to use :null_session instead.&lt;/span&gt;
  protect_from_forgery &lt;span class=&#34;hljs-symbol&#34;&gt;with:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:exception&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;default_render&lt;/span&gt;(&lt;span class=&#34;hljs-params&#34;&gt;*args&lt;/span&gt;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; params[&lt;span class=&#34;hljs-symbol&#34;&gt;:spf&lt;/span&gt;] == &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;navigate&amp;#x27;&lt;/span&gt;
      render &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;controller_name&amp;#125;&lt;/span&gt;/spf_&lt;span class=&#34;hljs-subst&#34;&gt;#&amp;#123;action_name&amp;#125;&lt;/span&gt;.json&amp;quot;&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now all we have to do is prefix the names of our SPF specific templates with &lt;code&gt;spf_&lt;/code&gt; and we are done. Our &lt;code&gt;spf_index.json.erb&lt;/code&gt; remains unchanged.&lt;/p&gt;
&lt;p&gt;We can clean up the action and remove SPF specific code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;PostsController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ApplicationController&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;index&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@page&lt;/span&gt; = params[&lt;span class=&#34;hljs-symbol&#34;&gt;:page&lt;/span&gt;].to_i
    &lt;span class=&#34;hljs-variable&#34;&gt;@num_pages&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;1000&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@posts&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;10&lt;/span&gt;.times.map &amp;#123; fake_post_summary &amp;#125;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

...&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;Navigation-hooks&#34;&gt;&lt;a href=&#34;#Navigation-hooks&#34; class=&#34;headerlink&#34; title=&#34;Navigation hooks&#34;&gt;&lt;/a&gt;Navigation hooks&lt;/h2&gt;&lt;p&gt;While so far everything works pretty well, we may want to hook into navigation events for greater flexibility. This may be useful for sending events to analytics service or for highlighting specific parts of page. The latter is useful because in some cases when the part replaced is very small, user might not immediate notice a quick change in the page content.&lt;/p&gt;
&lt;p&gt;For instance &lt;code&gt;spfdone&lt;/code&gt; event is invoked after the asynchronous update has been applied to the page. We can attach handlers to this event just like any other event, and hook custom logic:&lt;/p&gt;
&lt;img src=&#34;/images/2015-11-26/spfdone.png&#34;&gt;

&lt;p&gt;Let us highlight the listing of our posts using CSS 3 animations when loaded asynchronously:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs js&#34;&gt;$(&lt;span class=&#34;hljs-variable language_&#34;&gt;document&lt;/span&gt;).&lt;span class=&#34;hljs-title function_&#34;&gt;on&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;spfdone&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;(&lt;span class=&#34;hljs-params&#34;&gt;event&lt;/span&gt;) &amp;#123;

  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; (event.&lt;span class=&#34;hljs-property&#34;&gt;originalEvent&lt;/span&gt;.&lt;span class=&#34;hljs-property&#34;&gt;detail&lt;/span&gt;.&lt;span class=&#34;hljs-property&#34;&gt;response&lt;/span&gt;.&lt;span class=&#34;hljs-property&#34;&gt;body&lt;/span&gt;[&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;spf-posts-container&amp;#x27;&lt;/span&gt;]) &amp;#123;
    $(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;#spf-posts-container&amp;#x27;&lt;/span&gt;).&lt;span class=&#34;hljs-title function_&#34;&gt;addClass&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;flash&amp;#x27;&lt;/span&gt;)

    &lt;span class=&#34;hljs-built_in&#34;&gt;setTimeout&lt;/span&gt;(&lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt;(&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;) &amp;#123;
      $(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;#spf-posts-container&amp;#x27;&lt;/span&gt;).&lt;span class=&#34;hljs-title function_&#34;&gt;removeClass&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;flash&amp;#x27;&lt;/span&gt;)
    &amp;#125;, &lt;span class=&#34;hljs-number&#34;&gt;3000&lt;/span&gt;)

  &amp;#125;

&amp;#125;);&lt;/code&gt;&lt;/pre&gt;

&lt;br/&gt;

&lt;pre&gt;&lt;code class=&#34;hljs css&#34;&gt;&lt;span class=&#34;hljs-selector-class&#34;&gt;.flash&lt;/span&gt; &amp;#123;
  -moz-&lt;span class=&#34;hljs-attribute&#34;&gt;animation&lt;/span&gt;: flash &lt;span class=&#34;hljs-number&#34;&gt;1s&lt;/span&gt; ease-out;
  -moz-&lt;span class=&#34;hljs-attribute&#34;&gt;animation-iteration-count&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;

  -webkit-&lt;span class=&#34;hljs-attribute&#34;&gt;animation&lt;/span&gt;: flash &lt;span class=&#34;hljs-number&#34;&gt;1s&lt;/span&gt; ease-out;
  -webkit-&lt;span class=&#34;hljs-attribute&#34;&gt;animation-iteration-count&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;

  -ms-&lt;span class=&#34;hljs-attribute&#34;&gt;animation&lt;/span&gt;: flash &lt;span class=&#34;hljs-number&#34;&gt;1s&lt;/span&gt; ease-out;
  -ms-&lt;span class=&#34;hljs-attribute&#34;&gt;animation-iteration-count&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;;
&amp;#125;

&lt;span class=&#34;hljs-keyword&#34;&gt;@-webkit-keyframes&lt;/span&gt; flash &amp;#123;
    &lt;span class=&#34;hljs-number&#34;&gt;0%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: none; &amp;#125;
    &lt;span class=&#34;hljs-number&#34;&gt;50%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;#fbf8b2&lt;/span&gt;; &amp;#125;
    &lt;span class=&#34;hljs-number&#34;&gt;100%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: none; &amp;#125;
&amp;#125;

&lt;span class=&#34;hljs-keyword&#34;&gt;@-moz-keyframes&lt;/span&gt; flash &amp;#123;
    &lt;span class=&#34;hljs-number&#34;&gt;0%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: none; &amp;#125;
    &lt;span class=&#34;hljs-number&#34;&gt;50%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;#fbf8b2&lt;/span&gt;; &amp;#125;
    &lt;span class=&#34;hljs-number&#34;&gt;100%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: none; &amp;#125;
&amp;#125;

&lt;span class=&#34;hljs-keyword&#34;&gt;@-ms-keyframes&lt;/span&gt; flash &amp;#123;
    &lt;span class=&#34;hljs-number&#34;&gt;0%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: none; &amp;#125;
    &lt;span class=&#34;hljs-number&#34;&gt;50%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;#fbf8b2&lt;/span&gt;; &amp;#125;
    &lt;span class=&#34;hljs-number&#34;&gt;100%&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-attribute&#34;&gt;background-color&lt;/span&gt;: none; &amp;#125;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now you should see a subtle flash when page content has been replaced.&lt;/p&gt;
&lt;h2 id=&#34;Conclusion&#34;&gt;&lt;a href=&#34;#Conclusion&#34; class=&#34;headerlink&#34; title=&#34;Conclusion&#34;&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;&lt;p&gt;This concludes our small post on SPF integration with Rails. SPF allows for a lot more customization options beyond what our small covers. In particular SPF allows us to inject new scripts and styles dynamically, sophisticated &lt;a href=&#34;https://youtube.github.io/spfjs/documentation/caching/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;cache management&lt;/a&gt; and &lt;a href=&#34;https://youtube.github.io/spfjs/documentation/versioning/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;resource versioning&lt;/a&gt; support, which are all very useful features.&lt;/p&gt;
&lt;p&gt;The &lt;a href=&#34;https://youtube.github.io/spfjs/documentation&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;official documentation&lt;/a&gt; is a great place to start exploring more.&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2015/11/15/a-minimal-setup-for-using-es6-modules-in-rails.html</guid>
            <title>A minimal setup for using ES6 modules in Rails</title>
            <link>https://lorefnon.me/2015/11/15/a-minimal-setup-for-using-es6-modules-in-rails.html</link>
            <category>Javascript</category>
            <category>Rails</category>
            <category>ES6</category>
            <pubDate>Sun, 15 Nov 2015 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;p&gt;While ES6 adoption is progressively improving across browsers, and the sprockets team is planning to integrate ES6 features into Rails asset pipeline in near future, using a widely popular transpiler: &lt;a href=&#34;https://babeljs.io/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Babel&lt;/a&gt; we can leverage many of those features right away. The specific aspect of interest for this post is ES6 modules feature which provides a standardized module system for javascript.&lt;/p&gt;
&lt;p&gt;While babel does have a solution for ES6 modules, rather than handling dependency resolution itself - it transpiles the modules to existing javascript based module systems - the most popular ones being &lt;a href=&#34;https://github.com/amdjs&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;AMD&lt;/a&gt; and &lt;a href=&#34;https://commonjs.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;CommonJS&lt;/a&gt;. This post does not go into a compartive analysis of them, but there is an excellent &lt;a href=&#34;addyosmani.com/writing-modular-js/&#34;&gt;article&lt;/a&gt; by &lt;a href=&#34;https://twitter.com/addyosmani&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Addy Osmani&lt;/a&gt; which provides an in-depth elaboration on the topic.&lt;/p&gt;
&lt;p&gt;The solution &lt;a href=&#34;https://babeljs.io/docs/setup/#rails&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;recommended&lt;/a&gt; by the Babel team for using babel with rails, is through an experimental &lt;a href=&#34;https://github.com/TannerRogalsky/sprockets-es6&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;sprockets-es6&lt;/a&gt; gem, which is intended to be a PoC for future work to be integrated into Sprockets. Quoting from the README:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;This plugin is primarily experimental and will never reach a stable 1.0. The purpose is to test out BabelJS features on Sprockets 3.x and include it by default in Sprockets 4.x.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Apart from the experimental status, the key issue with using this gem is that it is non-trivial to get ES6 modules to work with it. The primary reason being that, as mentioned above, even though babel transpiles ES6 modules to CommonJS (or AMD), we still need to provide an implementation of the relevant module system that will enable the browsers to recognize the modules. This means we will have to include another dependency like &lt;a href=&#34;https://github.com/maccman/sprockets-commonjs&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;sprockets-commonjs&lt;/a&gt;. However there is a caveat:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;One caveat to the approach this library takes, is that dependencies loaded through require() will not be added to the dependency graph. This library will not parse the AST tree for require calls. This decision has been made for a variety of reasons, but it does mean you need to require files through both CommonJS and Sprockets.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;Using AMD modules with &lt;a href=&#34;https://github.com/jwhitley/requirejs-rails&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;requirejs-rails&lt;/a&gt; is something that works, however javascript community has largely adopted &lt;a href=&#34;https://npmjs.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;npm&lt;/a&gt; for package management framework. For example - jQuery plugin repository now states:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;The jQuery Plugin Registry is in read-only mode.
New plugin releases will not be processed.
We recommend moving to npm, using &amp;quot;jquery-plugin&amp;quot; as the keyword in your package.json. The npm blog has instructions for publishing your plugin to npm.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There is however a simpler solution: Using the gem &lt;a href=&#34;https://github.com/browserify-rails/browserify-rails&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;browserify-rails&lt;/a&gt; which bridges sprockets and &lt;a href=&#34;http://browserify.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;browserify&lt;/a&gt;. Browserify is a javascript bundler that leverages CommonJS :&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Browserify lets you require(&amp;#39;modules&amp;#39;) in the browser by bundling up all of your dependencies&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;The great thing about browserify is that we can hook in transforms which can take care of additional pre-processing before the &lt;code&gt;require&lt;/code&gt;d files are bundled up. Of particular interest to us, is the browserify transform for babel - &lt;a href=&#34;https://github.com/babel/babelify&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;babelify&lt;/a&gt; which allows us to  sidestep the caveat above. We need to have a node installation on the system though, just having a javascript runtime is not sufficient - but this is not much of an issue because node.js is now widely supported on all widely used platforms.&lt;/p&gt;
&lt;p&gt;To get this to work we need to add &lt;code&gt;browserify-rails&lt;/code&gt; to Gemfile:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;browserify-rails&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;as well as a &lt;code&gt;package.json&lt;/code&gt; in project root:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs javascript&#34;&gt;&amp;#123;
    &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;something&amp;quot;&lt;/span&gt;,
    &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;license&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;MIT&amp;quot;&lt;/span&gt;,
    &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;engines&amp;quot;&lt;/span&gt;: &amp;#123;
        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;node&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;&amp;gt;= 0.10&amp;quot;&lt;/span&gt;
    &amp;#125;,
    &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;dependencies&amp;quot;&lt;/span&gt;: &amp;#123;
        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;babel-preset-es2015&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;^6.1.18&amp;quot;&lt;/span&gt;,
        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;babelify&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;^7.2.0&amp;quot;&lt;/span&gt;,
        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;browserify&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;~&amp;gt; 10.2.4&amp;quot;&lt;/span&gt;,
        &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;browserify-incremental&amp;quot;&lt;/span&gt;: &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;^3.0.1&amp;quot;&lt;/span&gt;
    &amp;#125;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we want to use other javascript libraries available through npm we can include them directly in the package.json. There is a single caveat though: We can not directly start using ES6 modules in our top level files (typically application.js) but only in our &lt;code&gt;require&lt;/code&gt;d files:&lt;/p&gt;
&lt;p&gt;So our application.js can be fairly minimal with a single require statement:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs javascript&#34;&gt;&lt;span class=&#34;hljs-built_in&#34;&gt;require&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;./main&amp;#x27;&lt;/span&gt;)&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now we can use ES6 modules in main.js&lt;/p&gt;
&lt;p&gt;main.js:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs javascript&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;import&lt;/span&gt; hello &lt;span class=&#34;hljs-keyword&#34;&gt;from&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;./hello&amp;#x27;&lt;/span&gt;

&lt;span class=&#34;hljs-title function_&#34;&gt;hello&lt;/span&gt;()&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;hello.js:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs javascript&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;function&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;hello&lt;/span&gt;(&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;) &amp;#123;
    &lt;span class=&#34;hljs-title function_&#34;&gt;alert&lt;/span&gt;(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;hello world&amp;#x27;&lt;/span&gt;);
&amp;#125;

&lt;span class=&#34;hljs-keyword&#34;&gt;export&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;default&lt;/span&gt; hello;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;If we run the server now and visit the home page, we should be greeted with a hello prompt.&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2015/04/04/gathering-and-visualizing-rails-metrics-influxdb.html</guid>
            <title>Gathering and Visualizing metrics from Rails application using InfluxDB</title>
            <link>https://lorefnon.me/2015/04/04/gathering-and-visualizing-rails-metrics-influxdb.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <category>InfluxDB</category>
            <category>Grafana</category>
            <pubDate>Sat, 04 Apr 2015 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;h2 id=&#34;Overview&#34;&gt;&lt;a href=&#34;#Overview&#34; class=&#34;headerlink&#34; title=&#34;Overview&#34;&gt;&lt;/a&gt;Overview&lt;/h2&gt;&lt;p&gt;InfluxDB is a distributed time series database. It is a specialized data store for saving large volumes of timestamped event data and this makes it especially suited for storing metrics, lifecycle events and analytics. The &lt;code&gt;influxdb-rails&lt;/code&gt; gem, maintained by the InfluxDB team, facilitates integration with Rails and makes it easy to save various metrics from a rails application to InfluxDB and visualize it through frontends like &lt;a href=&#34;http://grafana.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Grafana&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The rest of this post, explores various aspects of a simple setup in which we build a rudimentary cms based site and monitor it using influxdb and grafana. We don&amp;#39;t assume prior familiarity with InfluxDB, and elaborate on relevant aspects of time series databases on the go, but familiarity with Rails is assumed.&lt;/p&gt;
&lt;p&gt;This post also assumes that InfluxDB is installed as per the official &lt;a href=&#34;http://influxdb.com/docs/v0.8/introduction/installation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;installation instructions&lt;/a&gt; with default configuration. If installation has been customized eg. ports have been changed, the configurations provided to &lt;code&gt;influxdb-rails&lt;/code&gt; will have to be adapted accordingly. On mac influxdb can be installed using &lt;a href=&#34;http://brew.sh/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Homebrew&lt;/a&gt; : &lt;code&gt;brew install influxdb&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;Setting-up-a-basic-application&#34;&gt;&lt;a href=&#34;#Setting-up-a-basic-application&#34; class=&#34;headerlink&#34; title=&#34;Setting up a basic application&#34;&gt;&lt;/a&gt;Setting up a basic application&lt;/h2&gt;&lt;p&gt;Next, we bootstrap a simple rails application using the &lt;a href=&#34;https://github.com/comfy/comfortable-mexican-sofa&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Comfortable mexican sofa&lt;/a&gt; CMS to quickly setup a site with a few pages we can tinker with. This is not really important, but it simply helps us work with a reasonably more realistic setup than a typically crud ui generated through scaffolds.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;rails new influxdb-cms-demo --database=mysql&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In Gemfile:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;comfortable_mexican_sofa&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;~&amp;gt; 1.12.0&amp;#x27;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;influxdb-rails&amp;#x27;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Setting up CMS requires an additional step:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;rails generate comfy:cms&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Setting up InfluxDB adapter also requires an additional step:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs bash&#34;&gt;rails g influxdb&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The default configuration options are available in the generated &lt;code&gt;influxdb-rails.rb&lt;/code&gt; and they correspond to the default settings of influxdb.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;InfluxDB::Rails.configure &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;config&lt;/span&gt;|
  config.influxdb_database = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;rails&amp;quot;&lt;/span&gt;
  config.influxdb_username = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;
  config.influxdb_password = &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;root&amp;quot;&lt;/span&gt;
  config.influxdb_hosts    = [&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;localhost&amp;quot;&lt;/span&gt;]
  config.influxdb_port     = &lt;span class=&#34;hljs-number&#34;&gt;8086&lt;/span&gt;

  &lt;span class=&#34;hljs-comment&#34;&gt;# config.series_name_for_controller_runtimes = &amp;quot;rails.controller&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# config.series_name_for_view_runtimes       = &amp;quot;rails.view&amp;quot;&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# config.series_name_for_db_runtimes         = &amp;quot;rails.db&amp;quot;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The last three lines signify the names of time series where the corresponding metrics would be stored, and we will use the same when querying the time series database.&lt;/p&gt;
&lt;p&gt;Before our application can start dispatching metrics to InfluxDB the database &amp;quot;rails&amp;quot; specified in the above configuration file would have to be created. InfluxDB admin provides a means to do that using the GUI. The admin interface may be accessed by visiting: &lt;a href=&#34;http://localhost:8083/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;localhost:8083&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_landing_page.png&#34; alt=&#34;InfluxDB landing page&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The default username&amp;#x2F;password combination is root&amp;#x2F;root, which is not advisable for production use.&lt;/p&gt;
&lt;p&gt;The only option that is particularly relevant is database name: which we would have to change to &amp;quot;rails&amp;quot;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_create_database.png&#34; alt=&#34;InfluxDB creating database&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;This would be a good point to run &lt;code&gt;db:migrate&lt;/code&gt; and visit the CMS dashboard &lt;code&gt;/admin&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Once a new site has been bootstrapped, we can rapidly create multiple pages through the CMS admin interface. These steps are not elaborated here because the guided CMS admin makes it pretty trivial. Once a few pages have been setup, we have some metrics to explore in InfluxDB.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/new_page_cms.png&#34; alt=&#34;Add a new page in CMS&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;Data-exploration&#34;&gt;&lt;a href=&#34;#Data-exploration&#34; class=&#34;headerlink&#34; title=&#34;Data exploration&#34;&gt;&lt;/a&gt;Data exploration&lt;/h2&gt;&lt;p&gt;In the list of databases, we should have an option to &lt;code&gt;Explore Data&lt;/code&gt;. Let us go ahead and click that:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_database_list.png&#34; alt=&#34;InfluxDB database list&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;We will be presented with a simple interface to read and write points (which are essentially multi-column timestamped datasets).&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_query_interface.png&#34; alt=&#34;InfluxDB Query interface&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;This page also highlights an interesting aspect of InfluxDB - though it is not a relational database, it does provide an SQL like language to query the database.&lt;/p&gt;
&lt;p&gt;A basic query might look something like this:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_select_all_query.png&#34; alt=&#34;InfluxDB Select All Query&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Besides controllers, we can also run similar queries for our timeseries for views and db:
&lt;img src=&#34;/images/influxdb_select_all_from_view.png&#34; alt=&#34;InfluxDB Select All from View Query&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/influxdb_select_all_from_db.png&#34; alt=&#34;InfluxDB Select All from DB Query&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;Configuring-additional-lifecycle-events&#34;&gt;&lt;a href=&#34;#Configuring-additional-lifecycle-events&#34; class=&#34;headerlink&#34; title=&#34;Configuring additional lifecycle events&#34;&gt;&lt;/a&gt;Configuring additional lifecycle events&lt;/h2&gt;&lt;p&gt;In a real applications we would want to aggregate additional metrics of our choosing. A popular solution for dispatching and subscribing to various lifecycle events that ruby community has developed is &lt;code&gt;ActiveSupport::Notifications&lt;/code&gt; which Rails internally uses.&lt;/p&gt;
&lt;p&gt;Using &lt;code&gt;ActiveSupport::Notifications&lt;/code&gt; we can subscribe to lifecycle events of a rails application and add callbacks to dispatch these metrics to InfluxDB.&lt;/p&gt;
&lt;p&gt;For example if we would like to track the execution times of queries in InfluxDB we can write an initializer:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveSupport::Notifications.subscribe(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;sql.active_record&amp;#x27;&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;name, start, finish, id, payload&lt;/span&gt;|
  InfluxDB::Rails.client.write_point(name, &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;value:&lt;/span&gt; (finish-start), &lt;span class=&#34;hljs-symbol&#34;&gt;start:&lt;/span&gt; start, &lt;span class=&#34;hljs-symbol&#34;&gt;finish:&lt;/span&gt; finish &amp;#125;)
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The value attribute is something that InfluxDB admin will use to generate graph by default. We can query this just like the previous queries:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/influxdb_lifecycle_event_query.png&#34; alt=&#34;InfluxDB Query lifecycle event&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;More lifecycle events of Rails application can be found in the &lt;a href=&#34;http://edgeguides.rubyonrails.org/active_support_instrumentation.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Rails guides&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;In addition, the instrumentation API can be used directly to create a custom lifecycle events. Here is an example taken from the &lt;a href=&#34;http://api.rubyonrails.org/classes/ActiveSupport/Notifications.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;official documentation&lt;/a&gt; that outlines how a part of application code can be wrapped into an instrumented block which we could subscribe to in an identical fashion.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveSupport::Notifications.instrument(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;render&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;extra:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:information&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
  render &lt;span class=&#34;hljs-symbol&#34;&gt;text:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Foo&amp;#x27;&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;While the InfluxDB admin interface provides a convenient dashboard to visualize the metrics, it is not ideal for complex, comparative or realtime visualizations. For such use cases it is better to resort to dedicated solutions like Grafana.&lt;/p&gt;
&lt;h2 id=&#34;Setting-up-Grafana&#34;&gt;&lt;a href=&#34;#Setting-up-Grafana&#34; class=&#34;headerlink&#34; title=&#34;Setting up Grafana&#34;&gt;&lt;/a&gt;Setting up Grafana&lt;/h2&gt;&lt;p&gt;While Grafana releases binary downloads for most major versions of linux, there isn&amp;#39;t one available for Mac. And neither is it available from Homebrew. However installation from the sources is straightforward if you have Go. It is important that the version of Go is correct (1.4 +) otherwise installation fails with totally incomprehensible errors. The version of Go available from Homebrew is outdated - however Google provides &lt;a href=&#34;https://golang.org/doc/install&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;installers&lt;/a&gt; which work like a charm. Once Go is setup properly, the &lt;a href=&#34;https://github.com/grafana/grafana#building-the-backend&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;installation steps&lt;/a&gt; for Grafana are straightforward.&lt;/p&gt;
&lt;p&gt;Another hiccup is that when running the web interface, Grafana uses the same default port as Rails (3000). To alleviate that we need to edit configuration file dev.ini in &lt;code&gt;$GOPATH/src/github.com/grafana/grafana/conf&lt;/code&gt; and specify an alternate port&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ini&#34;&gt;&lt;span class=&#34;hljs-attr&#34;&gt;app_mode&lt;/span&gt; = development

&lt;span class=&#34;hljs-section&#34;&gt;[server]&lt;/span&gt;
&lt;span class=&#34;hljs-attr&#34;&gt;router_logging&lt;/span&gt; = &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;
&lt;span class=&#34;hljs-attr&#34;&gt;http_port&lt;/span&gt; = &lt;span class=&#34;hljs-number&#34;&gt;8000&lt;/span&gt;

&lt;span class=&#34;hljs-section&#34;&gt;[log]&lt;/span&gt;
&lt;span class=&#34;hljs-attr&#34;&gt;level&lt;/span&gt; = Trace&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once this is configured running &lt;code&gt;./grafana web&lt;/code&gt; from grafana source directory, should run the webserver on port 8000:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_startup_log.png&#34; alt=&#34;Grafana server log&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now we can browse the Grafana dashboard and provide the default login details admin&amp;#x2F;admin. Again it is not advisable to use this in production.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_login.png&#34; alt=&#34;Grafana Login&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The default dashboard is pretty bare:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_home.png&#34; alt=&#34;Grafana Home page&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Adding a new dashboard is straightforward:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_add_dashboard.png&#34; alt=&#34;Grafana : Adding a dashboard&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Once we have a dedicated dashboard for our Rails application we can start adding graphs:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_add_graph.png&#34; alt=&#34;Grafana : Add Graph&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;It would be probably surprising to see a great looking graph instantly generated. After all no influxdb&amp;#x2F;rails specific configuration has been done yet, so what data is being presented ?&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_test_graph.png&#34; alt=&#34;Grafana : Default Graph&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Once we try to edit the data source, it would become clear that the graph being presented is infact coming from a dummy data source&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_edit_graph.png&#34; alt=&#34;Grafana : Edit Graph&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/grafana_configure_graph_data_source.png&#34; alt=&#34;Grafana : Configure Graph Data Source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;At this point, because InfluxDB data source hasn&amp;#39;t been configured hence no other data source is available :&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_singular_data_source.png&#34; alt=&#34;Grafana : Missing Data Source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The sidebar has a section for data sources that can be used for this task:
&lt;img src=&#34;/images/grafana_sidebar_close_up.png&#34; alt=&#34;Grafana : Sidebar&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/grafana_add_data_source.png&#34; alt=&#34;Grafana : Add data source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;While adding a data source it is of particular importance the version of InfluxDB is correct in the type field. Rest of the fields in form are self explanatory - It is advisable that in production Auth is configured to protect against intrusion.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_edit_data_source.png&#34; alt=&#34;Grafana : Edit data source&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Now in the graph editor multiple data sources should be available:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/grafana_multiple_data_source_selector.png&#34; alt=&#34;Grafana : Multiple data sources&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;We can now specify the InfluxDB query to be made in the &lt;code&gt;Metrics&lt;/code&gt; section:
&lt;img src=&#34;/images/grafana_metric_specification.png&#34; alt=&#34;Grafana : Specify Metric&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;Since we don&amp;#39;t have a lot of historical data at this point, for inspection we can adjust the time range to something recent:
&lt;img src=&#34;/images/grafana_range_selection.png&#34; alt=&#34;Grafana : Range Selection&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The dummy graph should now be replaced with a real visualization of our metric
&lt;img src=&#34;/images/grafana_metric_output.png&#34; alt=&#34;Grfana : Metric Output&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;In similar fashion more graphs can be added and additional dashboards can be set up as per requirements.&lt;/p&gt;
&lt;h2 id=&#34;Conclusion&#34;&gt;&lt;a href=&#34;#Conclusion&#34; class=&#34;headerlink&#34; title=&#34;Conclusion&#34;&gt;&lt;/a&gt;Conclusion&lt;/h2&gt;&lt;p&gt;This concludes this post, in which we have setup a basic development setup of InfluxDB and explored how a time series datastore can be used to save metrics from our Rails application and how we can query this data store and derive actionable insights. Also we explored creation of dashboards using Grafana to visualize these metrics in near-real time.&lt;/p&gt;
&lt;p&gt;Our proof of concept setup, however is not suitable for production deployments with large volumes of data, in which case we would want to utilize advanced cluster management features of InfluxDB. Fortunately InfluxDB documentation already has a lot of &lt;a href=&#34;http://influxdb.com/docs/v0.8/clustering/setup.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;helpful information&lt;/a&gt; on scaling up production deployment which is only expected to mature over time. There are also &lt;a href=&#34;https://customers.influxdb.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;commercial options&lt;/a&gt; available for hosted InfluxDB which I encourage users to &lt;a href=&#34;https://customers.influxdb.com/users/sign_up&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;try out&lt;/a&gt; and evaluate.&lt;/p&gt;
&lt;h2 id=&#34;Where-to-go-from-here&#34;&gt;&lt;a href=&#34;#Where-to-go-from-here&#34; class=&#34;headerlink&#34; title=&#34;Where to go from here&#34;&gt;&lt;/a&gt;Where to go from here&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://influxdb.com/docs/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;InfluxDB documentation&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://docs.grafana.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Grafana Documentation&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2015/03/02/dealing-with-json-fields-in-active-admin.html</guid>
            <title>Dealing with JSON data in Active Admin</title>
            <link>https://lorefnon.me/2015/03/02/dealing-with-json-fields-in-active-admin.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <category>ActiveAdmin</category>
            <pubDate>Mon, 02 Mar 2015 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;p&gt;Many a times, depending on the requirements, it makes sense to store
unstructured json data in database fields. PostgreSQL recognizes this
requirement and provides a dedicated json field that automatically
handles JSON validation. As has been outlined in the
&lt;a href=&#34;http://edgeguides.rubyonrails.org/active_record_postgresql.html&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;RoR Guides&lt;/a&gt;
, it is pretty simple to take advantage of this feature from Rails.
However if you also use &lt;a href=&#34;https://github.com/activeadmin/activeadmin&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;ActiveAdmin&lt;/a&gt; to manage your admin interface,
you will quickly find out that library &lt;a href=&#34;https://github.com/justinfrench/formtastic&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Formtastic&lt;/a&gt; that ActiveAdmin
uses to manage its forms, leaves a lot to be desired when it comes to
JSON editing support.&lt;/p&gt;
&lt;p&gt;In this post we outline a simple approach to improve JSON editing
support in ActiveAdmin using the excellent &lt;a href=&#34;https://github.com/josdejong/jsoneditor/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;JSON editor widget&lt;/a&gt;
by &lt;a href=&#34;https://github.com/josdejong&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Jos de Jong&lt;/a&gt;. It is worth pointing
out that our implementation has very little to do with PostgreSQL
and may be used without modifications if you are storing JSON in say MySQL
text fields. Of course you will need to handle server side validation yourself in that case.&lt;/p&gt;
&lt;p&gt;The source code for the post is available on &lt;a href=&#34;https://github.com/lorefnon/activeadmin-jsoneditor-demo&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Github&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Let us have a simple product model with following schema:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;CreateProducts&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Migration&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;change&lt;/span&gt;
    create_table &lt;span class=&#34;hljs-symbol&#34;&gt;:products&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;t&lt;/span&gt;|
      t.string &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;
      t.text &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
      t.json &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;
      t.timestamps
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;You may expect providing admin support for this model will just be
a matter of adding a file &lt;code&gt;app/admin/product.rb&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register Product &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
  permit_params &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;However the moment you try to create a new instance, you will be greeted
with an error message:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/formtastic_unknown_input.png&#34; alt=&#34;Formtastic unknown input error&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;So basically Formtastic has no input field pre-configured for json
field. A rudimentary workaround is fairly simple - We explicitly ask
it to use a textarea for metadata field&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register Product &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;

  permit_params &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;

  form &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;f&lt;/span&gt;|
    f.inputs &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;as:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:text&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    f.actions
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This does the job:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/aa1.png&#34; alt=&#34;Form with explicitly specified textarea&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;But seriously, if you have to edit this json very frequently or manage
large json entries, a simple textarea is not an ideal solution. Plus
if you accidentally enter some invalid json, You will be provided with a
feedback only post submission:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;/images/aa2.png&#34; alt=&#34;Error in JSON field&#34; loading=&#34;lazy&#34;&gt;
&lt;img src=&#34;/images/aa3.png&#34; alt=&#34;JSON validation error&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;The &lt;a href=&#34;https://github.com/josdejong/jsoneditor/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;JSON editor widget&lt;/a&gt;
by &lt;a href=&#34;https://github.com/josdejong&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Jos de Jong&lt;/a&gt; provides a lot better json editing
interface. You can try it out &lt;a href=&#34;http://jsoneditoronline.org/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;online&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;If you like what you see, you will be pleased to find that the widget
is pretty easy to integrate right inside ActiveAdmin.&lt;/p&gt;
&lt;p&gt;Let us first configure our form to add a class to the json field
so that we can handle json input fields in a generic fashion.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;ActiveAdmin.register Product &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;

  permit_params &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;

  form &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;f&lt;/span&gt;|
    f.inputs &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:name&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:description&lt;/span&gt;
      f.input &lt;span class=&#34;hljs-symbol&#34;&gt;:metadata&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;as:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:text&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;input_html:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;class:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;jsoneditor-target&amp;#x27;&lt;/span&gt; &amp;#125;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    f.actions
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Next we will need to download the &lt;a href=&#34;http://jsoneditoronline.org/downloads/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;relevant files&lt;/a&gt; and add to our vendor
directory. I have already changed the files to use sprockets urls, so you can
grab the files form the repo.&lt;/p&gt;
&lt;p&gt;Next we modify the active_admin.js.coffee:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs coffeescript&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;#= require active_admin/base&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;#= require jsoneditor&lt;/span&gt;
&lt;span class=&#34;hljs-comment&#34;&gt;#= require jsoneditor_activeadmin_integration&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have the required files in place, integration is pretty simple -
&lt;code&gt;app/assets/javascripts/jsoneditor_activeadmin_integration&lt;/code&gt;:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs coffeescript&#34;&gt;$ -&amp;gt;

  $(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;.jsoneditor-target&amp;#x27;&lt;/span&gt;).each -&amp;gt;

    target = $ this

    container = $(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;&amp;lt;div class=&amp;quot;jsoneditor-container&amp;quot;&amp;gt;&amp;#x27;&lt;/span&gt;)
      .insertAfter target

    editor = &lt;span class=&#34;hljs-keyword&#34;&gt;new&lt;/span&gt; JSONEditor container[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;],
      modes: [&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;code&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;form&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;text&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;tree&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;view&amp;#x27;&lt;/span&gt;]
      change: &lt;span class=&#34;hljs-function&#34;&gt;-&amp;gt;&lt;/span&gt;
        target.val editor.get()

    editor.set(
      &lt;span class=&#34;hljs-keyword&#34;&gt;try&lt;/span&gt;
        &lt;span class=&#34;hljs-built_in&#34;&gt;JSON&lt;/span&gt;.parse target.val()
    )

    target.hide()&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This simply hides the textarea for json field, and adds a json editor
widget. When the editor is updated, the hidden textarea is updated
with the new value - so our form continues to work just as expected,
without Formtastic having to be aware of the widget at all.&lt;/p&gt;
&lt;p&gt;I had to explicitly override some of the conflicting styles from
ActiveAdmin which were messing up the Editor Widget css:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs scss&#34;&gt;&lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor-container&lt;/span&gt;, &lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor-contextmenu&lt;/span&gt; &amp;#123;
    &lt;span class=&#34;hljs-selector-tag&#34;&gt;table&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-attribute&#34;&gt;width&lt;/span&gt;: auto;
        &lt;span class=&#34;hljs-attribute&#34;&gt;margin&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
    &amp;#125;

    &lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-attribute&#34;&gt;background&lt;/span&gt;: white;
    &amp;#125;

    &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;, &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;&lt;span class=&#34;hljs-selector-pseudo&#34;&gt;:hover&lt;/span&gt;, &lt;span class=&#34;hljs-selector-class&#34;&gt;.menu&lt;/span&gt; &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;, &lt;span class=&#34;hljs-selector-class&#34;&gt;.menu&lt;/span&gt; &lt;span class=&#34;hljs-selector-tag&#34;&gt;button&lt;/span&gt;&lt;span class=&#34;hljs-selector-pseudo&#34;&gt;:hover&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-attribute&#34;&gt;background&lt;/span&gt;: none;
        &lt;span class=&#34;hljs-attribute&#34;&gt;text-shadow&lt;/span&gt;: none;
        &lt;span class=&#34;hljs-attribute&#34;&gt;box-shadow&lt;/span&gt;: none;
        &lt;span class=&#34;hljs-attribute&#34;&gt;border-radius&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;;
    &amp;#125;
&amp;#125;

&lt;span class=&#34;hljs-selector-class&#34;&gt;.jsoneditor-container&lt;/span&gt; &amp;#123;
    &lt;span class=&#34;hljs-attribute&#34;&gt;margin-left&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;20%&lt;/span&gt;;
    &lt;span class=&#34;hljs-attribute&#34;&gt;width&lt;/span&gt;: &lt;span class=&#34;hljs-number&#34;&gt;80%&lt;/span&gt;;
&amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And we are pretty much done:
&lt;img src=&#34;/images/aa4.png&#34; alt=&#34;Widget integrated with Active Admin&#34; loading=&#34;lazy&#34;&gt;&lt;/p&gt;
&lt;p&gt;I realize that the default styling of the widget sticks out a bit against
 the default styling of ActiveAdmin page, but all that is needed to rectify is a few CSS
rules which I leave as an exercise for the reader.&lt;/p&gt;
&lt;p&gt;As always, any feedback and suggestions are more than welcome.&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2015/01/03/leveraging-strategy-pattern-in-rails.html</guid>
            <title>Leveraging the strategy pattern in Rails - I</title>
            <link>https://lorefnon.me/2015/01/03/leveraging-strategy-pattern-in-rails.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <category>Design Patterns</category>
            <pubDate>Sat, 03 Jan 2015 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;h1 id=&#34;To-begin-with-what-is-strategy-pattern&#34;&gt;&lt;a href=&#34;#To-begin-with-what-is-strategy-pattern&#34; class=&#34;headerlink&#34; title=&#34;To begin with, what is strategy pattern ?&#34;&gt;&lt;/a&gt;To begin with, what is strategy pattern ?&lt;/h1&gt;&lt;p&gt;Quoting from &lt;a href=&#34;http://en.wikipedia.org/wiki/Strategy_pattern&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Wikipedia&lt;/a&gt;,&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;the strategy pattern (also known as the policy pattern) is a software design
pattern that enables an algorithm&amp;#39;s behavior to be selected at runtime.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h1 id=&#34;So-how-does-this-help-us&#34;&gt;&lt;a href=&#34;#So-how-does-this-help-us&#34; class=&#34;headerlink&#34; title=&#34;So how does this help us ?&#34;&gt;&lt;/a&gt;So how does this help us ?&lt;/h1&gt;&lt;p&gt;Strategy pattern just helps us escape the soup of complex nested conditionals
and model behavior selection in an object oriented fashion. To understand why this is
required let us explore a fictional example:&lt;/p&gt;
&lt;h1 id=&#34;An-adventure&#34;&gt;&lt;a href=&#34;#An-adventure&#34; class=&#34;headerlink&#34; title=&#34;An adventure&#34;&gt;&lt;/a&gt;An adventure&lt;/h1&gt;&lt;p&gt;Suppose that we are developing a social network for book lovers. To encourage users
to read more we decide to show a recommendations panel which highlights books that
are trending in the community.&lt;/p&gt;
&lt;p&gt;Our (over-simplified) implementation might be something like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:tags&lt;/span&gt;

  scope &lt;span class=&#34;hljs-symbol&#34;&gt;:popular&lt;/span&gt;, -&amp;gt; &amp;#123;  where &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommendations_count &amp;gt; 100&amp;#x27;&lt;/span&gt; &amp;#125;

  &lt;span class=&#34;hljs-comment&#34;&gt;# Return a random subset of recommended books&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# Yes, this approach is sub-optimal for large number of popular books. Better&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# approaches are outlined here:&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# http://stackoverflow.com/questions/4329396/mysql-select-10-random-rows-from-600k-rows-fast&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;#&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended
    popular.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Recommendation&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;counter_cache:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:book&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;counter_cache:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In home&amp;#x2F;index.html.erb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommended-book-list&amp;#x27;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; Book.recommended.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; book.title &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;So far so good, however we realize that for users who have been using our service
for a while, it makes more sense to show recommendations based on their intersts. So we do a
shotgun surgery and modify our code to the following:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; user.blank? |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| (user.recommendations_count &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
      popular
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      not_recommended_by(user).where(&lt;span class=&#34;hljs-symbol&#34;&gt;tags:&lt;/span&gt; user.recommended_tags)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommended_books&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;through:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;source:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:book&lt;/span&gt;
  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:recommended_tags&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;through:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:recommended_books&lt;/span&gt;,
    &lt;span class=&#34;hljs-symbol&#34;&gt;source:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:tags&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  scope &lt;span class=&#34;hljs-symbol&#34;&gt;:not_recommended_by&lt;/span&gt;, -&amp;gt; (user) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt;
    joins(&lt;span class=&#34;hljs-symbol&#34;&gt;:recommendations&lt;/span&gt;)
      .where(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommendations.user_id != ?&amp;#x27;&lt;/span&gt;, user.id)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And our template becomes something like:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;id&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;recommended-book-list&amp;#x27;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; Book.recommended_for(current_user).each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt; &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; book.title &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;li&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;ul&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We see that at this point our &lt;code&gt;recommended_for&lt;/code&gt; method is burdened with multiple
responsibilities - the decision for the approach to be used as well as the logic
for multiple approaches all reside in the same method, which is not very ideal.&lt;/p&gt;
&lt;p&gt;Let us push this further. Say, after a couple of months our social networks gains
a lot of traction and we strike a very profitable deal with a major publishing
firm &amp;#39;Jackass Kangaroo Publications&amp;#39; and as a part of the deal we need to ensure
that the recommended books include only those which have been published by this
publication.&lt;/p&gt;
&lt;p&gt;No problem, we just need add a few lines of code:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    query = Book

    &lt;span class=&#34;hljs-comment&#34;&gt;# Comment this out when deal with Jackass Kangaroo Publication is over.&lt;/span&gt;
    query = query.where(&lt;span class=&#34;hljs-symbol&#34;&gt;publisher:&lt;/span&gt; Publisher.where(&lt;span class=&#34;hljs-symbol&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Jackass Kangaroo Publication&amp;#x27;&lt;/span&gt;).first)

    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; user.blank? |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| (user.recommendations_count &amp;lt; &lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
      query.popular
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      query.not_recommended_by(user).where(&lt;span class=&#34;hljs-symbol&#34;&gt;tags:&lt;/span&gt; user.recommended_tags)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;No words are needed to describe the ugliness of the code above. Our eyes bleed but we
choose to look away and carry on with our buisness.&lt;/p&gt;
&lt;p&gt;Of course, the journey of our social network is not all rosy. We get hit by a
lawsuit making our deal with &lt;code&gt;Jackass Kangaroo Publications&lt;/code&gt; illegal in a specific country.
But why bother backing off from this insanity when all problems can be resolved
by adding just another condition:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    query = Book

    &lt;span class=&#34;hljs-comment&#34;&gt;# Comment this out when deal with Jackass Kangaroo Publication is over.&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;unless&lt;/span&gt; user.located_in? &lt;span class=&#34;hljs-variable constant_&#34;&gt;DISPUTED_DEMOGRAPHY&lt;/span&gt;
      query = query.where(&lt;span class=&#34;hljs-symbol&#34;&gt;publisher:&lt;/span&gt; Publisher.where(&lt;span class=&#34;hljs-symbol&#34;&gt;name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Jackass Kangaroo Publication&amp;#x27;&lt;/span&gt;).first)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    ...
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h1 id=&#34;A-downhill-slope&#34;&gt;&lt;a href=&#34;#A-downhill-slope&#34; class=&#34;headerlink&#34; title=&#34;A downhill slope&#34;&gt;&lt;/a&gt;A downhill slope&lt;/h1&gt;&lt;p&gt;So requirements keep stacking up and we keep adding conditions. Fast forward a few years, and
a sincere programmer who is new to the project, unfamiliar with our rocky history and now is responsible
for maintenance of the project is staring
blankly at the entangled mess of conditional statements. Of course the crutial details of the deal
and the subsequent lawsuits are now lost in sands of time, and none of the present team members
have any idea what is going on.&lt;/p&gt;
&lt;h1 id=&#34;Retrospection&#34;&gt;&lt;a href=&#34;#Retrospection&#34; class=&#34;headerlink&#34; title=&#34;Retrospection&#34;&gt;&lt;/a&gt;Retrospection&lt;/h1&gt;&lt;p&gt;The question now is, what could be done to avoid a situation like this ? As you might have guessed
at this point, burdening the Book class with responsibility to determine various aspects of
application that affect our recommendation policy as well as the complete implementation of all these policies
is cumbersome. What we can do is that we can refactor out the specific strategies into dedicated
classes that encapsulate the actual implementation details. This is exactly what the strategy pattern
encourages us to embrace.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;RecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Struct&lt;/span&gt;.new(user, scoped_collection)
    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| Book
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
      &lt;span class=&#34;hljs-literal&#34;&gt;false&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;br&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;DefaultRecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;RecommendationGeneration&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
          &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
          &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;&lt;/span&gt;| popular
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
          scoped_collection.order(&lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;RAND()&amp;#x27;&lt;/span&gt;).limit(&lt;span class=&#34;hljs-number&#34;&gt;5&lt;/span&gt;)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;br&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;UserAdaptedRecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;RecommendationGeneration&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
      user.present?
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; user.present?
        not_recommended_by(user).where(&lt;span class=&#34;hljs-symbol&#34;&gt;tags:&lt;/span&gt; user.recommended_tags)
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
            &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
          &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
          Strategies::DefaultRecommendation
            .new(user, scoped_collection)
                .execute
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;
&lt;br&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Strategies
  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;PartnershipAdaptedRecommendationGeneration&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;RecommendationGeneration&lt;/span&gt;

    &lt;span class=&#34;hljs-comment&#34;&gt;# It is better to model buisness constraints in the persistance layer&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;# rather than relying on implicit assumptions.&lt;/span&gt;
        &lt;span class=&#34;hljs-comment&#34;&gt;#&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;applicable?&lt;/span&gt;
          ! partner_publisher.blank?
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;partner_publisher&lt;/span&gt;
          Partnership
            .legal_in(user.demography)
        .having_recommendation_priviledge
                .active
                .first
                .publisher
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;scoped_collection&lt;/span&gt;
          Book.where(&lt;span class=&#34;hljs-symbol&#34;&gt;publisher:&lt;/span&gt; partner_publisher)
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

        &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;execute&lt;/span&gt;
          Strategies::UserAdaptedRecommendationGeneration
                .new(user, scoped_collection)
                .execute
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Now our &lt;code&gt;recommended_for&lt;/code&gt; method just has to decide which is the applicable strategy and execute
it:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Book&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...

  &lt;span class=&#34;hljs-variable constant_&#34;&gt;RECOMMENDATION_STRATEGIES&lt;/span&gt; = [
    PartnershipAdaptedRecommendationGeneration
        UserAdaptedRecommendationGeneration
        DefaultRecommendationGeneration
  ]

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.recommended_for user
    &lt;span class=&#34;hljs-variable constant_&#34;&gt;RECOMMENDATION_STRATEGIES&lt;/span&gt;.each &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;strategy_class&lt;/span&gt;|
          strategy = strategy_class.new(user)
          &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; strategy.applicable?
            strategy.execute
                &lt;span class=&#34;hljs-keyword&#34;&gt;break&lt;/span&gt;
          &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
        &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This is signficantly better than our prior approach and aligns well with the tenets of
&lt;a href=&#34;http://en.wikipedia.org/wiki/SOLID_(object-oriented_design)&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;SOLID&lt;/a&gt; principles. Apart from
explaining the use of strategy pattern it also illustrates how strategies can reuse existing
strategies by means of composition thus keeping our code DRY.&lt;/p&gt;
&lt;p&gt;So we see that, the strategy pattern is especially helpful when it comes to applications where
requirements are rapidly changing all the time. Since the core logic is encapsulated
into interchangeable concrete implementations, strategy implementations can be
introduced or switched with relative ease at a later phase.&lt;/p&gt;
&lt;p&gt;While this post focussed on use of strategy pattern to simply complex logic in model layer, in
subsequent posts we will cover how this pattern can simplify our implementations in controller
and view layers as well.&lt;/p&gt;
&lt;p&gt;This concludes the post. Please feel free to let me know about your suggestions for improvements, or
mistakes that I might have made in the post above.&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2014/09/07/devise-multiple-emails.html</guid>
            <title>Effectively debugging KnockoutJS applications.</title>
            <link>https://lorefnon.me/2014/09/07/devise-multiple-emails.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <pubDate>Sun, 07 Sep 2014 00:00:00 +0000</pubDate>
            <description><![CDATA[ 

          

&lt;p&gt;&lt;a href=&#34;https://github.com/plataformatec/devise&#34;&gt;Devise&lt;/a&gt; is an incredibly popular authorization gem for Rails. Unfortunately allowing a user to log in through multiple emails is not as straightforward as one might expect. This post outlines a way to do just that.&lt;/p&gt;

&lt;p&gt;The code for this blog is available &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo.git&#34;&gt;here&lt;/a&gt;. We start off with a rudimentary devise installation (you may want to checkout &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo/tree/3d5be26be7986aaf73c18497cffd67a9365e38cb&#34;&gt;Commit:3d5be26&lt;/a&gt; as a starting point - if you are not familiar with devise I suggest you take a look at the official documentation. As you may have noticed I am writing this post against Rails 4.2 Beta which Devise master does not support as of this writing. Luckily &lt;a href=&#34;https://github.com/lucasmazza&#34;&gt;lucasmazza&lt;/a&gt; has already submitted a pull request for 4.2 compatibility and we just need to use the branch &lt;code&gt;lm-rails-4-2&lt;/code&gt;.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#creating-email-model&#34;&gt;&lt;h2 id=&#34;creating-email-model&#34;&gt;Creating Email model&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;First step is creating an email model.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g model email email:string user_id:integer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Next we setup the relationships between user and email:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;validates&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;presence&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;uniqueness&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The email format validation comes from &lt;a href=&#34;https://github.com/balexand/email_validator&#34;&gt;email_validator&lt;/a&gt; gem.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# Include default devise modules. Others available are:&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# :confirmable, :lockable, :timeoutable and :omniauthable&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;devise&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:database_authenticatable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:registerable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
         &lt;span class=&#34;ss&#34;&gt;:recoverable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:rememberable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:trackable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:validatable&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;has_many&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Once we have done that, we can do away with the email field provided by devise. Instead of that, let us have a default email reference which may be used as a primary means of communication eg. for sending
newsletters, fetching gravatars etc. So here we go:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g migration add_default_email_to_users default_email_id:integer
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;In &lt;code&gt;db/migrate/20140907091858_add_default_email_to_users.rb&lt;/code&gt;&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;AddDefaultEmailToUsers&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Migration&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;change&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;remove_column&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;add_column&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:integer&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In user model:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;class_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Email&#34;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#setting-up-the-registration-flow-&#34;&gt;&lt;h2 id=&#34;setting-up-the-registration-flow-&#34;&gt;Setting up the registration flow:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;At this point if we try visiting a devise sign up page, we will
get an obvious error because devise views expect an email field in
model.&lt;/p&gt;

&lt;p&gt;&lt;image src=&#34;/images/devise_email_not_found.png&#34;&gt;&lt;/image&gt;&lt;/p&gt;

&lt;p&gt;We resort to a simple hack rather than put in a lot of effort in rewiring Devise. We add email accessors which (as far as devise is concerned) behave just like the email field devise had generated, but internally act as proxy to default email. Duck typing FTW.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;devise&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:database_authenticatable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:registerable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
         &lt;span class=&#34;ss&#34;&gt;:recoverable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:rememberable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:trackable&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;has_many&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;dependent&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:destroy&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;after_commit&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:save_default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;on&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:create&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;class_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Email&#34;&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;validates&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;presence&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;default_scope&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;includes&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:default_email&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;rescue&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;nil&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;emails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first_or_initialize&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;private&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;save_default_email&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;blank?&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;self&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Exceptions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;EmailConflict&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note that we have removed &lt;code&gt;:validatable&lt;/code&gt; which is added by default
by devise. Also the after commit hook is required because when we are saving the user
for the first time, user id is nil when email is instantiated and hence will have to assign it once we have saved the user. An email conflict will be raised if the email
is already associated with another account. Handling that error gracefully is left as an exercise for the reader.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#setting-up-the-login-flow-&#34;&gt;&lt;h2 id=&#34;setting-up-the-login-flow-&#34;&gt;Setting up the login flow:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;While registration should work smoothly at this point, if we try to login we will run into trouble:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/devise_login_flow_fail.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;The problem is obvious. Devise tries to search using email field which does not exist. So we need to
configure devise to find using the emails table we have created.&lt;/p&gt;

&lt;p&gt;This can be done by overriding the class method &lt;code&gt;find_first_by_auth_conditions&lt;/code&gt; :&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;having_email&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;includes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;joins&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt;
        &lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt;  &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;p&#34;&gt;&amp;#125;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;find_first_by_auth_conditions&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;warden_conditions&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;conditions&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;warden_conditions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;dup&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;conditions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;delete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;having_email&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;super&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;warden_conditions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;private&lt;/span&gt;

  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Once we have done that, login flow should as intended.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#interface-for-managing-emails&#34;&gt;&lt;h2 id=&#34;interface-for-managing-emails&#34;&gt;Interface for managing emails&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;At this point a user can login and signup but he can not manage the emails which are associated with his/her account. Let us take care of that.&lt;/p&gt;

&lt;p&gt;The default edit account view of devise looks something like this:&lt;/p&gt;

&lt;p&gt;&lt;img src=&#34;/images/devise_default_edit.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;Note that this form works perfectly well - thanks to our email accessor hack. But users don&#39;t have the ability to add new emails or delete existing emails.&lt;/p&gt;

&lt;p&gt;We will to augment this form to accept nested attributes for emails. For nested forms probably the most popular solution is &lt;a href=&#34;https://github.com/ryanb/nested_form&#34;&gt;nested_form&lt;/a&gt; but it has been unmaintained for a while. So I resorted to &lt;a href=&#34;https://github.com/nathanvda/cocoon&#34;&gt;cocoon&lt;/a&gt; which is more actively maintained. Both of them work in a similar fashion - through unobstructive javascript.&lt;/p&gt;

&lt;p&gt;First we have to configure our model to accept nested attributes for emails - this part is easy:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;accepts_nested_attributes_for&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;reject_if&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:all_blank&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;allow_destroy&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Nest we need to generate devise views using &lt;code&gt;rails g devise:views&lt;/code&gt; and edit the &lt;code&gt;app/views/devise/registrations/edit.html.erb&lt;/code&gt;.&lt;/p&gt;

&lt;p&gt;We edit the template to add nested form for emails:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;erb&#34;&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;h2&amp;gt;Edit &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;to_s&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;humanize&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/h2&amp;gt;&lt;/span&gt;

&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;form_for&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resource&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;as&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;url&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;registration_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;html&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:put&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;devise_error_messages!&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Default Email&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autofocus&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fields_for&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email_f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;render&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;email_fields&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email_f&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &amp;lt;div class=&#34;links&#34;&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;link_to_add_association&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;Add Email&#39;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:emails&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;devise_mapping&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;confirmable?&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;amp;&amp;amp;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;pending_reconfirmation?&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &amp;lt;div&amp;gt;Currently waiting confirmation for: &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;resource&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;unconfirmed_email&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt; &amp;lt;i&amp;gt;(leave blank if you don&#39;t want to change it)&amp;lt;/i&amp;gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autocomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;off&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password_confirmation&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password_confirmation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autocomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;off&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_password&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt; &amp;lt;i&amp;gt;(we need your current password to confirm your changes)&amp;lt;/i&amp;gt;&amp;lt;br /&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;    &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;password_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;autocomplete&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;off&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;submit&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Update&#34;&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;cp&#34;&gt;&amp;lt;%&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;&amp;lt;h3&amp;gt;Cancel my account&amp;lt;/h3&amp;gt;&lt;/span&gt;

&lt;span class=&#34;x&#34;&gt;&amp;lt;p&amp;gt;Unhappy? &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;button_to&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Cancel my account&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;registration_path&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;resource_name&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;),&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;data&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;confirm&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Are you sure?&#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;,&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;method&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:delete&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;/p&amp;gt;&lt;/span&gt;

&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;link_to&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;Back&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:back&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Cocoon mandates a separate partial for email fields, which in our case is very simple:&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;erb&#34;&gt;&lt;span class=&#34;x&#34;&gt;&amp;lt;div class=&#34;nested-fields&#34;&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &amp;lt;div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;label&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email_field&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;      &lt;/span&gt;&lt;span class=&#34;cp&#34;&gt;&amp;lt;%=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;link_to_remove_association&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;remove email&#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;f&lt;/span&gt; &lt;span class=&#34;cp&#34;&gt;%&amp;gt;&lt;/span&gt;&lt;span class=&#34;x&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;  &amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;span class=&#34;x&#34;&gt;&amp;lt;/div&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;At this point if we try saving the form, we will notice that email fields are not getting saved. The reason is that the strong parameters specified by devise does not include our email fields. Fortunately devise provides a way to configure that :&lt;/p&gt;

&lt;p&gt;In &lt;code&gt;ApplicationController&lt;/code&gt; :&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;ApplicationController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActionController&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# Prevent CSRF attacks by raising an exception.&lt;/span&gt;
  &lt;span class=&#34;c1&#34;&gt;# For APIs, you may want to use :null_session instead.&lt;/span&gt;

  &lt;span class=&#34;n&#34;&gt;protect_from_forgery&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;with&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:exception&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;before_action&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:configure_permitted_parameters&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:devise_controller?&lt;/span&gt;

  &lt;span class=&#34;kp&#34;&gt;protected&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;configure_permitted_parameters&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;devise_parameter_sanitizer&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;for&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:account_update&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;u&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;permit&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:password_confirmation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:current_password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;emails_attributes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:_destroy&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Note that &lt;code&gt;:_destroy&lt;/code&gt; symbol in the attribute list. It is required because to destroy nested models, rails uses a virtual attribute called _destroy. When _destroy is set, the nested model will be deleted.&lt;/p&gt;

&lt;p&gt;If we try adding, removing and editing emails now, everything should work smoothly.
&lt;img src=&#34;/images/devise_nested_form_edit.png&#34;&gt;&lt;/p&gt;

&lt;p&gt;In a production setting we will most certainly need to send out confirmation mails before activating the emails. We skip the additional steps for the sake of brevity.&lt;/p&gt;

&lt;a class=&#34;header-link&#34; href=&#34;#omniauth-integration-&#34;&gt;&lt;h2 id=&#34;omniauth-integration-&#34;&gt;Omniauth integration:&lt;/h2&gt;&lt;/a&gt;

&lt;p&gt;One of the things we all love about devise is that it integrates beautifully with
&lt;a href=&#34;https://github.com/intridea/omniauth&#34;&gt;omniauth&lt;/a&gt; making integration with a plethora of social services painless. However due to the fundamental changes we have made, omniauth integration requires jumping through a few extra hoops.&lt;/p&gt;

&lt;p&gt;We use Facebook login as an example below:&lt;/p&gt;

&lt;p&gt;Firstly, of course we need to create an application on &lt;a href=&#34;https://developers.facebook.com&#34;&gt;https://developers.facebook.com&lt;/a&gt;. Once we have created an application, and have obtained the API key and secret, we configure devise omniauth parameters:&lt;/p&gt;

&lt;p&gt;In Gemfile&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;n&#34;&gt;gem&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;omniauth&#39;&lt;/span&gt;
&lt;span class=&#34;n&#34;&gt;gem&lt;/span&gt; &lt;span class=&#34;s1&#34;&gt;&#39;omniauth-facebook&#39;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In config/initializers/devise.rb&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;no&#34;&gt;Devise&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;setup&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;do&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;|&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;config&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;omniauth&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:twitter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;application&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;secrets&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fb_app_id&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Rails&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;application&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;secrets&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;fb_app_secret&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In config/secrets.yml&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;yaml&#34;&gt;&lt;span class=&#34;l-Scalar-Plain&#34;&gt;development&lt;/span&gt;&lt;span class=&#34;p-Indicator&#34;&gt;:&lt;/span&gt;
  &lt;span class=&#34;l-Scalar-Plain&#34;&gt;fb_app_id&lt;/span&gt;&lt;span class=&#34;p-Indicator&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;l-Scalar-Plain&#34;&gt;&amp;lt;add api key here&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;l-Scalar-Plain&#34;&gt;fb_app_secret&lt;/span&gt;&lt;span class=&#34;p-Indicator&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;l-Scalar-Plain&#34;&gt;&amp;lt;add api secret here&amp;gt;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In app/models/user.rb&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;devise&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:omniauthable&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;omniauth_providers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:facebook&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;
  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In config/routes.rb&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;  &lt;span class=&#34;n&#34;&gt;devise_for&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:users&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;controllers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#123;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;omniauth_callbacks&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&#34;users/omniauth_callbacks&#34;&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;&amp;#125;&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;where &lt;code&gt;users/omniauth_callbacks&lt;/code&gt; is a controller we define to which facebook will redirect to after authenticating our application.&lt;/p&gt;

&lt;p&gt;If you have used omniauth with devise before, there is nothing out of the ordinary so far.&lt;/p&gt;

&lt;p&gt;Just like we wish to allow the user to sign up through multiple emails, we also wish to allow a user to sign up through multiple social networks. (s)he may be registered in different social networks with different emails. A simple and elegant way to represent a user&#39;s presence in multiple third party sites is through a separate &lt;code&gt;UserIdentity&lt;/code&gt; model.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;text language-text&#34; data-lang=&#34;text&#34;&gt;rails g model UserIdentity user_id:integer email_id:integer uid:string provider:string
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;UserIdentity&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;belongs_to&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;
  &lt;span class=&#34;n&#34;&gt;validates&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:uid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:provider&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;presence&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;kp&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;Our callback controller is intentially very simple. Depending on your use case you may want to check if the user is newly created and direct him/her to a profile completion page. For the sake of simplicity, we just redirect any user to the profile page.&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;Users&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;OmniauthCallbacksController&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Devise&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;OmniauthCallbacksController&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nf&#34;&gt;facebook&lt;/span&gt;
    &lt;span class=&#34;vi&#34;&gt;@user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;from_omniauth&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;request&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;env&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&#34;omniauth.auth&#34;&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
    &lt;span class=&#34;n&#34;&gt;sign_in_and_redirect&lt;/span&gt; &lt;span class=&#34;vi&#34;&gt;@user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:event&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&amp;gt;&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;:authentication&lt;/span&gt; &lt;span class=&#34;c1&#34;&gt;#this will throw if @user is not activated&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;In the &lt;code&gt;from_omniauth&lt;/code&gt; class method of user we need to identify user based on the auth parameters passed.
Luckily facebook provides us with the email, so we can use that to identify a user.&lt;/p&gt;

&lt;p&gt;Four scenarios are possible:&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User is signing up for the first time through facebook.&lt;/strong&gt;
In this case we just use the email obtained from facebook as the default email and register the user&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User already has an account and has chosen to login through facebook for the first time&lt;/strong&gt;
We can identify this situation if user&#39;s existing email is the same as the one he has used in Facebook. In this case we create a new UserIdentity for an existing user.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using the same email&lt;/strong&gt;
Nothing needs to be created. We just log the user in.&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using a different email&lt;/strong&gt;
We keep the existing email, but associate the user identity with the new email.&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;Here is our implementation&lt;/p&gt;

&lt;div class=&#34;highlight&#34;&gt;&lt;pre&gt;&lt;code class=&#34;ruby&#34;&gt;&lt;span class=&#34;k&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;User&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;&amp;lt;&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;ActiveRecord&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;Base&lt;/span&gt;

  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;

  &lt;span class=&#34;k&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;nc&#34;&gt;self&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nf&#34;&gt;from_omniauth&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Email&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;includes&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;:user&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;info&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first_or_initialize&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;UserIdentity&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;where&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;ss&#34;&gt;provider&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;provider&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt; &lt;span class=&#34;ss&#34;&gt;uid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;auth&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;uid&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;first_or_initialize&lt;/span&gt;

    &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;persisted?&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# Existing user, Existing social identity&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;if&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;!&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;persisted?&lt;/span&gt;
        &lt;span class=&#34;c1&#34;&gt;# Email changed on third party site&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;==&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
        &lt;span class=&#34;k&#34;&gt;raise&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Exceptions&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;::&lt;/span&gt;&lt;span class=&#34;no&#34;&gt;EmailConflict&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;
      &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;elsif&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;persisted?&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# Existing User, new identity&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;c1&#34;&gt;# New user new identity&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;User&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;new&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;
        &lt;span class=&#34;ss&#34;&gt;password&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;no&#34;&gt;Devise&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;friendly_token&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;0&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;&lt;span class=&#34;mi&#34;&gt;20&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;,&lt;/span&gt;
        &lt;span class=&#34;n&#34;&gt;default_email&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;:&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;email&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;email&lt;/span&gt;
      &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;save!&lt;/span&gt;
    &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;n&#34;&gt;ui&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;user&lt;/span&gt;
  &lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;o&#34;&gt;.&lt;/span&gt;

&lt;span class=&#34;k&#34;&gt;end&lt;/span&gt;
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;

&lt;p&gt;The code above raises an &lt;code&gt;EmailConflict&lt;/code&gt; exception if we end up in a scenario where an existing user is logging in and the email is associated with another account. Gracefully handling the error is left as an exercise for the reader. Also we assume that the social login provider will provide us with an email.
While this is true for many providers like Github, not all providers provide with emails. A prominent example is twitter. Since this is not intended to be a comprehensive tutorial on omniauth, for the sake of brevity we don&#39;t
elaborate on those scenarios. A good way to handle such a case would be to direct a user to a profile completion after login where he/she can enter the email and warn them if an account already exists for that email.&lt;/p&gt;

&lt;p&gt;So we conclude the post with a functional setup that allows a user to have multiple emails associated with a devise account. Feel free to bug me if you face any issues. Any comments and suggestions are also welcome.&lt;/p&gt;


 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2014/09/07/devise-multiple-emails.html</guid>
            <title>Allowing multiple emails for a user in Devise</title>
            <link>https://lorefnon.me/2014/09/07/devise-multiple-emails.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <category>Devise</category>
            <category>Integration</category>
            <pubDate>Sun, 07 Sep 2014 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;p&gt;&lt;a href=&#34;https://github.com/plataformatec/devise&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Devise&lt;/a&gt; is an incredibly popular authorization gem for Rails. Unfortunately allowing a user to log in through multiple emails is not as straightforward as one might expect. This post outlines a way to do just that.&lt;/p&gt;
&lt;p&gt;The code for this blog is available &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo.git&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;here&lt;/a&gt;. We start off with a rudimentary devise installation (you may want to checkout &lt;a href=&#34;https://github.com/lorefnon/devise_multi_email_demo/tree/3d5be26be7986aaf73c18497cffd67a9365e38cb&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Commit:3d5be26&lt;/a&gt; as a starting point - if you are not familiar with devise I suggest you take a look at the official documentation. As you may have noticed I am writing this post against Rails 4.2 Beta which Devise master does not support as of this writing. Luckily &lt;a href=&#34;https://github.com/lucasmazza&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;lucasmazza&lt;/a&gt; has already submitted a pull request for 4.2 compatibility and we just need to use the branch &lt;code&gt;lm-rails-4-2&lt;/code&gt;.&lt;/p&gt;
&lt;h2 id=&#34;Creating-Email-model&#34;&gt;&lt;a href=&#34;#Creating-Email-model&#34; class=&#34;headerlink&#34; title=&#34;Creating Email model&#34;&gt;&lt;/a&gt;Creating Email model&lt;/h2&gt;&lt;p&gt;First step is creating an email model.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g model email email:string user_id:integer
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;Next we setup the relationships between user and email:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Email&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;
  validates &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;presence:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;uniqueness:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The email format validation comes from &lt;a href=&#34;https://github.com/balexand/email_validator&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;email_validator&lt;/a&gt; gem.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# Include default devise modules. Others available are:&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# :confirmable, :lockable, :timeoutable and :omniauthable&lt;/span&gt;
  devise &lt;span class=&#34;hljs-symbol&#34;&gt;:database_authenticatable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:registerable&lt;/span&gt;,
         &lt;span class=&#34;hljs-symbol&#34;&gt;:recoverable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:rememberable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:trackable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:validatable&lt;/span&gt;

  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have done that, we can do away with the email field provided by devise. Instead of that, let us have a default email reference which may be used as a primary means of communication eg. for sending
newsletters, fetching gravatars etc. So here we go:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g migration add_default_email_to_users default_email_id:integer
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;In &lt;code&gt;db/migrate/20140907091858_add_default_email_to_users.rb&lt;/code&gt;&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;AddDefaultEmailToUsers&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Migration&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;change&lt;/span&gt;
    remove_column &lt;span class=&#34;hljs-symbol&#34;&gt;:users&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;
    add_column &lt;span class=&#34;hljs-symbol&#34;&gt;:users&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email_id&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:integer&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In user model:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;class_name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Email&amp;quot;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;Setting-up-the-registration-flow&#34;&gt;&lt;a href=&#34;#Setting-up-the-registration-flow&#34; class=&#34;headerlink&#34; title=&#34;Setting up the registration flow:&#34;&gt;&lt;/a&gt;Setting up the registration flow:&lt;/h2&gt;&lt;p&gt;At this point if we try visiting a devise sign up page, we will
get an obvious error because devise views expect an email field in
model.&lt;/p&gt;
&lt;image src=&#34;/images/devise_email_not_found.png&#34; /&gt;

&lt;p&gt;We resort to a simple hack rather than put in a lot of effort in rewiring Devise. We add email accessors which (as far as devise is concerned) behave just like the email field devise had generated, but internally act as proxy to default email. Duck typing FTW.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  devise &lt;span class=&#34;hljs-symbol&#34;&gt;:database_authenticatable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:registerable&lt;/span&gt;,
         &lt;span class=&#34;hljs-symbol&#34;&gt;:recoverable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:rememberable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:trackable&lt;/span&gt;

  has_many &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;dependent:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:destroy&lt;/span&gt;
  after_commit &lt;span class=&#34;hljs-symbol&#34;&gt;:save_default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;on:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:create&lt;/span&gt;

  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;class_name:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Email&amp;quot;&lt;/span&gt;
  validates &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;presence:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  default_scope &amp;#123; includes &lt;span class=&#34;hljs-symbol&#34;&gt;:default_email&lt;/span&gt; &amp;#125;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;email&lt;/span&gt;
    default_email.email &lt;span class=&#34;hljs-keyword&#34;&gt;rescue&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;email=&lt;/span&gt; email
    &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.default_email = emails.where(&lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; email).first_or_initialize
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  private

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;save_default_email&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; default_email.user.blank?
      default_email.user = &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; default_email.user != &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;
      raise Exceptions::EmailConflict
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    default_email.save!
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that we have removed &lt;code&gt;:validatable&lt;/code&gt; which is added by default
by devise. Also the after commit hook is required because when we are saving the user
for the first time, user id is nil when email is instantiated and hence will have to assign it once we have saved the user. An email conflict will be raised if the email
is already associated with another account. Handling that error gracefully is left as an exercise for the reader.&lt;/p&gt;
&lt;h2 id=&#34;Setting-up-the-login-flow&#34;&gt;&lt;a href=&#34;#Setting-up-the-login-flow&#34; class=&#34;headerlink&#34; title=&#34;Setting up the login flow:&#34;&gt;&lt;/a&gt;Setting up the login flow:&lt;/h2&gt;&lt;p&gt;While registration should work smoothly at this point, if we try to login we will run into trouble:&lt;/p&gt;
&lt;img src=&#34;/images/devise_login_flow_fail.png&#34;/&gt;

&lt;p&gt;The problem is obvious. Devise tries to search using email field which does not exist. So we need to
configure devise to find using the emails table we have created.&lt;/p&gt;
&lt;p&gt;This can be done by overriding the class method &lt;code&gt;find_first_by_auth_conditions&lt;/code&gt; :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.having_email email
    User
      .includes(&lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;)
      .joins(&lt;span class=&#34;hljs-symbol&#34;&gt;emails:&lt;/span&gt; &amp;#123;
        &lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt;  email
      &amp;#125;)
      .first
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.find_first_by_auth_conditions warden_conditions
    conditions = warden_conditions.dup
    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; email = conditions.delete(&lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;)
      having_email email
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;(warden_conditions)
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  private

  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have done that, login flow should as intended.&lt;/p&gt;
&lt;h2 id=&#34;Interface-for-managing-emails&#34;&gt;&lt;a href=&#34;#Interface-for-managing-emails&#34; class=&#34;headerlink&#34; title=&#34;Interface for managing emails&#34;&gt;&lt;/a&gt;Interface for managing emails&lt;/h2&gt;&lt;p&gt;At this point a user can login and signup but he can not manage the emails which are associated with his&amp;#x2F;her account. Let us take care of that.&lt;/p&gt;
&lt;p&gt;The default edit account view of devise looks something like this:&lt;/p&gt;
&lt;img src=&#34;/images/devise_default_edit.png&#34;/&gt;

&lt;p&gt;Note that this form works perfectly well - thanks to our email accessor hack. But users don&amp;#39;t have the ability to add new emails or delete existing emails.&lt;/p&gt;
&lt;p&gt;We will to augment this form to accept nested attributes for emails. For nested forms probably the most popular solution is &lt;a href=&#34;https://github.com/ryanb/nested_form&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;nested_form&lt;/a&gt; but it has been unmaintained for a while. So I resorted to &lt;a href=&#34;https://github.com/nathanvda/cocoon&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;cocoon&lt;/a&gt; which is more actively maintained. Both of them work in a similar fashion - through unobstructive javascript.&lt;/p&gt;
&lt;p&gt;First we have to configure our model to accept nested attributes for emails - this part is easy:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  accepts_nested_attributes_for &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;reject_if:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:all_blank&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;allow_destroy:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Nest we need to generate devise views using &lt;code&gt;rails g devise:views&lt;/code&gt; and edit the &lt;code&gt;app/views/devise/registrations/edit.html.erb&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;We edit the template to add nested form for emails:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;Edit &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; resource_name.to_s.humanize &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h2&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; form_for(resource, &lt;span class=&#34;hljs-symbol&#34;&gt;as:&lt;/span&gt; resource_name, &lt;span class=&#34;hljs-symbol&#34;&gt;url:&lt;/span&gt; registration_path(resource_name), &lt;span class=&#34;hljs-symbol&#34;&gt;html:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;method:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:put&lt;/span&gt; &amp;#125;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;f&lt;/span&gt;| &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; devise_error_messages! &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Default Email&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.email_field &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autofocus:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.fields_for &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;email_f&lt;/span&gt;| &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; render &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;email_fields&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;f:&lt;/span&gt; email_f &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;links&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to_add_association &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;Add Email&amp;#x27;&lt;/span&gt;, f, &lt;span class=&#34;hljs-symbol&#34;&gt;:emails&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; devise_mapping.confirmable? &amp;amp;&amp;amp; resource.pending_reconfirmation? &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;Currently waiting confirmation for: &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; resource.unconfirmed_email &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:password&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;(leave blank if you don&amp;#x27;t want to change it)&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.password_field &lt;span class=&#34;hljs-symbol&#34;&gt;:password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autocomplete:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;off&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:password_confirmation&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.password_field &lt;span class=&#34;hljs-symbol&#34;&gt;:password_confirmation&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autocomplete:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;off&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:current_password&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt; &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;(we need your current password to confirm your changes)&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;i&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;br&lt;/span&gt; /&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;    &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.password_field &lt;span class=&#34;hljs-symbol&#34;&gt;:current_password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;autocomplete:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;off&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.submit &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Update&amp;quot;&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt;&amp;gt;&lt;/span&gt;Cancel my account&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;h3&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;Unhappy? &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; button_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Cancel my account&amp;quot;&lt;/span&gt;, registration_path(resource_name), &lt;span class=&#34;hljs-symbol&#34;&gt;data:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;confirm:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Are you sure?&amp;quot;&lt;/span&gt; &amp;#125;, &lt;span class=&#34;hljs-symbol&#34;&gt;method:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:delete&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;p&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;Back&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:back&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Cocoon mandates a separate partial for email fields, which in our case is very simple:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs erb&#34;&gt;&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt; &lt;span class=&#34;hljs-attr&#34;&gt;class&lt;/span&gt;=&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;nested-fields&amp;quot;&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.label &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; f.email_field &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt; &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;      &amp;lt;%=&lt;/span&gt;&lt;span class=&#34;language-ruby&#34;&gt; link_to_remove_association &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;remove email&amp;quot;&lt;/span&gt;, f &lt;/span&gt;&lt;span class=&#34;language-xml&#34;&gt;%&amp;gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;  &lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;
&lt;span class=&#34;language-xml&#34;&gt;&lt;span class=&#34;hljs-tag&#34;&gt;&amp;lt;/&lt;span class=&#34;hljs-name&#34;&gt;div&lt;/span&gt;&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;At this point if we try saving the form, we will notice that email fields are not getting saved. The reason is that the strong parameters specified by devise does not include our email fields. Fortunately devise provides a way to configure that :&lt;/p&gt;
&lt;p&gt;In &lt;code&gt;ApplicationController&lt;/code&gt; :&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;ApplicationController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActionController::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# Prevent CSRF attacks by raising an exception.&lt;/span&gt;
  &lt;span class=&#34;hljs-comment&#34;&gt;# For APIs, you may want to use :null_session instead.&lt;/span&gt;

  protect_from_forgery &lt;span class=&#34;hljs-symbol&#34;&gt;with:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:exception&lt;/span&gt;
  before_action &lt;span class=&#34;hljs-symbol&#34;&gt;:configure_permitted_parameters&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;if:&lt;/span&gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:devise_controller?&lt;/span&gt;

  protected

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;configure_permitted_parameters&lt;/span&gt;
    devise_parameter_sanitizer.&lt;span class=&#34;hljs-keyword&#34;&gt;for&lt;/span&gt;(&lt;span class=&#34;hljs-symbol&#34;&gt;:account_update&lt;/span&gt;) &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;u&lt;/span&gt;|
      u.permit &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:password_confirmation&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:current_password&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;emails_attributes:&lt;/span&gt; [&lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:id&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:_destroy&lt;/span&gt;]
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Note that &lt;code&gt;:_destroy&lt;/code&gt; symbol in the attribute list. It is required because to destroy nested models, rails uses a virtual attribute called _destroy. When _destroy is set, the nested model will be deleted.&lt;/p&gt;
&lt;p&gt;If we try adding, removing and editing emails now, everything should work smoothly.
&lt;img src=&#34;/images/devise_nested_form_edit.png&#34;/&gt;&lt;/p&gt;
&lt;p&gt;In a production setting we will most certainly need to send out confirmation mails before activating the emails. We skip the additional steps for the sake of brevity.&lt;/p&gt;
&lt;h2 id=&#34;Omniauth-integration&#34;&gt;&lt;a href=&#34;#Omniauth-integration&#34; class=&#34;headerlink&#34; title=&#34;Omniauth integration:&#34;&gt;&lt;/a&gt;Omniauth integration:&lt;/h2&gt;&lt;p&gt;One of the things we all love about devise is that it integrates beautifully with
&lt;a href=&#34;https://github.com/intridea/omniauth&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;omniauth&lt;/a&gt; making integration with a plethora of social services painless. However due to the fundamental changes we have made, omniauth integration requires jumping through a few extra hoops.&lt;/p&gt;
&lt;p&gt;We use Facebook login as an example below:&lt;/p&gt;
&lt;p&gt;Firstly, of course we need to create an application on &lt;a href=&#34;https://developers.facebook.com/&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;https://developers.facebook.com&lt;/a&gt;. Once we have created an application, and have obtained the API key and secret, we configure devise omniauth parameters:&lt;/p&gt;
&lt;p&gt;In Gemfile&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;omniauth&amp;#x27;&lt;/span&gt;
gem &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;omniauth-facebook&amp;#x27;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In config&amp;#x2F;initializers&amp;#x2F;devise.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;Devise.setup &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;config&lt;/span&gt;|
  ...
  config.omniauth &lt;span class=&#34;hljs-symbol&#34;&gt;:twitter&lt;/span&gt;, Rails.application.secrets.fb_app_id, Rails.application.secrets.fb_app_secret
  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In config&amp;#x2F;secrets.yml&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs yaml&#34;&gt;&lt;span class=&#34;hljs-attr&#34;&gt;development:&lt;/span&gt;
  &lt;span class=&#34;hljs-attr&#34;&gt;fb_app_id:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;lt;add&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;api&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;key&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;here&amp;gt;&lt;/span&gt;
  &lt;span class=&#34;hljs-attr&#34;&gt;fb_app_secret:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;lt;add&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;api&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;secret&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;here&amp;gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In app&amp;#x2F;models&amp;#x2F;user.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  ...
  devise &lt;span class=&#34;hljs-symbol&#34;&gt;:omniauthable&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;omniauth_providers:&lt;/span&gt; [&lt;span class=&#34;hljs-symbol&#34;&gt;:facebook&lt;/span&gt;]
  ...
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In config&amp;#x2F;routes.rb&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;devise_for &lt;span class=&#34;hljs-symbol&#34;&gt;:users&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;controllers:&lt;/span&gt; &amp;#123; &lt;span class=&#34;hljs-symbol&#34;&gt;omniauth_callbacks:&lt;/span&gt; &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;users/omniauth_callbacks&amp;quot;&lt;/span&gt; &amp;#125;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;where &lt;code&gt;users/omniauth_callbacks&lt;/code&gt; is a controller we define to which facebook will redirect to after authenticating our application.&lt;/p&gt;
&lt;p&gt;If you have used omniauth with devise before, there is nothing out of the ordinary so far.&lt;/p&gt;
&lt;p&gt;Just like we wish to allow the user to sign up through multiple emails, we also wish to allow a user to sign up through multiple social networks. (s)he may be registered in different social networks with different emails. A simple and elegant way to represent a user&amp;#39;s presence in multiple third party sites is through a separate &lt;code&gt;UserIdentity&lt;/code&gt; model.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;rails g model UserIdentity user_id:integer email_id:integer uid:string provider:string
&lt;/code&gt;&lt;/pre&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;UserIdentity&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;
  belongs_to &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;
  validates &lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:email&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:uid&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:provider&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;presence:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Our callback controller is intentially very simple. Depending on your use case you may want to check if the user is newly created and direct him&amp;#x2F;her to a profile completion page. For the sake of simplicity, we just redirect any user to the profile page.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Users::OmniauthCallbacksController&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Devise::OmniauthCallbacksController&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;facebook&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@user&lt;/span&gt; = User.from_omniauth(request.env[&lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;omniauth.auth&amp;quot;&lt;/span&gt;])
    sign_in_and_redirect &lt;span class=&#34;hljs-variable&#34;&gt;@user&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;:event&lt;/span&gt; =&amp;gt; &lt;span class=&#34;hljs-symbol&#34;&gt;:authentication&lt;/span&gt; &lt;span class=&#34;hljs-comment&#34;&gt;#this will throw if &lt;span class=&#34;hljs-doctag&#34;&gt;@user&lt;/span&gt; is not activated&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;In the &lt;code&gt;from_omniauth&lt;/code&gt; class method of user we need to identify user based on the auth parameters passed.
Luckily facebook provides us with the email, so we can use that to identify a user.&lt;/p&gt;
&lt;p&gt;Four scenarios are possible:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User is signing up for the first time through facebook.&lt;/strong&gt;
In this case we just use the email obtained from facebook as the default email and register the user&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User already has an account and has chosen to login through facebook for the first time&lt;/strong&gt;
We can identify this situation if user&amp;#39;s existing email is the same as the one he has used in Facebook. In this case we create a new UserIdentity for an existing user.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using the same email&lt;/strong&gt;
Nothing needs to be created. We just log the user in.&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;&lt;strong&gt;User had logged in using facebook before, using a different email&lt;/strong&gt;
We keep the existing email, but associate the user identity with the new email.&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Here is our implementation&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  ...

  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.from_omniauth auth

    email = Email
      .includes(&lt;span class=&#34;hljs-symbol&#34;&gt;:user&lt;/span&gt;)
      .where(&lt;span class=&#34;hljs-symbol&#34;&gt;email:&lt;/span&gt; auth.info.email)
      .first_or_initialize

    ui = UserIdentity
      .where(&lt;span class=&#34;hljs-symbol&#34;&gt;provider:&lt;/span&gt; auth.provider, &lt;span class=&#34;hljs-symbol&#34;&gt;uid:&lt;/span&gt; auth.uid)
      .first_or_initialize

    &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ui.persisted?
      &lt;span class=&#34;hljs-comment&#34;&gt;# Existing user, Existing social identity&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; ! email.persisted?
        &lt;span class=&#34;hljs-comment&#34;&gt;# Email changed on third party site&lt;/span&gt;
        email.user = ui.user
        email.save!
        ui.email = email
      &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; email.user == ui.user
        ui.user
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        raise Exceptions::EmailConflict.new
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;elsif&lt;/span&gt; email.persisted?
      &lt;span class=&#34;hljs-comment&#34;&gt;# Existing User, new identity&lt;/span&gt;
      ui.user = email.user
      ui.save!
      ui.user
    &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
      &lt;span class=&#34;hljs-comment&#34;&gt;# New user new identity&lt;/span&gt;
      email.save!
      user = &lt;span class=&#34;hljs-title class_&#34;&gt;User&lt;/span&gt;.new(
        &lt;span class=&#34;hljs-symbol&#34;&gt;password:&lt;/span&gt; Devise.friendly_token[&lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;,&lt;span class=&#34;hljs-number&#34;&gt;20&lt;/span&gt;],
        &lt;span class=&#34;hljs-symbol&#34;&gt;default_email:&lt;/span&gt; email
      )
      user.save!
      ui.user = user
      ui.email = email
      ui.save!
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    ui.user
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  ...

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The code above raises an &lt;code&gt;EmailConflict&lt;/code&gt; exception if we end up in a scenario where an existing user is logging in and the email is associated with another account. Gracefully handling the error is left as an exercise for the reader. Also we assume that the social login provider will provide us with an email.
While this is true for many providers like Github, not all providers provide with emails. A prominent example is twitter. Since this is not intended to be a comprehensive tutorial on omniauth, for the sake of brevity we don&amp;#39;t
elaborate on those scenarios. A good way to handle such a case would be to direct a user to a profile completion after login where he&amp;#x2F;she can enter the email and warn them if an account already exists for that email.&lt;/p&gt;
&lt;p&gt;So we conclude the post with a functional setup that allows a user to have multiple emails associated with a devise account. Feel free to bug me if you face any issues. Any comments and suggestions are also welcome.&lt;/p&gt;
 ]]></description>
        </item>
        <item>
            <guid isPermalink="true">https://lorefnon.me/2014/07/27/optimizing-sti-columns.html</guid>
            <title>Optimizing space taken by type column in Rails STI</title>
            <link>https://lorefnon.me/2014/07/27/optimizing-sti-columns.html</link>
            <category>Ruby</category>
            <category>Rails</category>
            <category>ActiveRecord</category>
            <pubDate>Sun, 27 Jul 2014 00:00:00 +0000</pubDate>
            <description><![CDATA[ &lt;p&gt;The &lt;a href=&#34;http://api.rubyonrails.org/classes/ActiveRecord/Base.html#label-Single+table+inheritance&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Single Table Inheritance&lt;/a&gt;
facility in Rails is quite awesome in that it is simple, minimal and easy to understand.
However that simplicity comes with a small price - the type column stores the full name of the relevant class as a string.
This becomes especially unweildy if you scope your models inside a module.&lt;/p&gt;
&lt;p&gt;Let us illustrate this with an example:&lt;/p&gt;
&lt;p&gt;Let us say, we have a database of institutions. For non profit and commercial institutions we have two subclasses of &lt;code&gt;Institution::Base&lt;/code&gt; namely, &lt;code&gt;Institution::NonProfit&lt;/code&gt;, &lt;code&gt;Institution::Commercial&lt;/code&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-comment&#34;&gt;#app/models/institution.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; Institution
  &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;self&lt;/span&gt;.table_name_prefix
    &lt;span class=&#34;hljs-string&#34;&gt;&amp;#x27;institution_&amp;#x27;&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;# app/models/institution/base.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Base&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;#app/models/institution/non_profit.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::NonProfit&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Institution::Base&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-comment&#34;&gt;#app/models/institution/commercial.rb&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Commercial&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;Institution::Base&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;We deliberately keep the schema simple:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;create_table &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;institution_bases&amp;quot;&lt;/span&gt;, &lt;span class=&#34;hljs-symbol&#34;&gt;force:&lt;/span&gt; &lt;span class=&#34;hljs-literal&#34;&gt;true&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;do&lt;/span&gt; |&lt;span class=&#34;hljs-params&#34;&gt;t&lt;/span&gt;|
    t.string   &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;name&amp;quot;&lt;/span&gt;
    t.string   &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;type&amp;quot;&lt;/span&gt;
    t.datetime &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;created_at&amp;quot;&lt;/span&gt;
    t.datetime &lt;span class=&#34;hljs-string&#34;&gt;&amp;quot;updated_at&amp;quot;&lt;/span&gt;
 &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;The subclasses simply reuse the table and Rails distinguishes between them using the type column. If we  try to store some sample entries, we would notice that the value stored in type field contains the fully namespaces class name: &lt;code&gt;Institution::NonProfit&lt;/code&gt;, &lt;code&gt;Institution::Commercial&lt;/code&gt; etc.&lt;/p&gt;
&lt;p&gt;Since we know that our application will not store models from other namespace in this table, the extra space taken by the module name is wasteful. In fact storing the name in its entirety is wasteful. So this post highlights a simple approach to minimise the space taken by type column without sacrificing the ease of use of STI in rails.&lt;/p&gt;
&lt;p&gt;It turns out we can override the methods Rails uses to convert the table name to class name and vice versa:&lt;/p&gt;
&lt;p&gt;The relevant methods are &lt;code&gt;find_sti_class&lt;/code&gt; which is responsible for the translating the value stored in the type column to the respective ActiveRecord model and &lt;code&gt;sti_name&lt;/code&gt; which is responsible for retriving the value stored in type column given an ActiveRecord subclass.&lt;/p&gt;
&lt;p&gt;So we override the default implementations to the following:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Base&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;

  &lt;span class=&#34;hljs-variable constant_&#34;&gt;ALLOWED_CLASSES&lt;/span&gt; = &lt;span class=&#34;hljs-string&#34;&gt;%w[Institution::NonProfit Institution::Commercial]&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &amp;lt;&amp;lt; &lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;find_sti_class&lt;/span&gt; type_name
      idx = type_name.to_i
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
      &lt;span class=&#34;hljs-variable constant_&#34;&gt;ALLOWED_CLASSES&lt;/span&gt;[idx-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;].constantize
    &lt;span class=&#34;hljs-keyword&#34;&gt;rescue&lt;/span&gt; NameError, TypeError
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_name&lt;/span&gt;
      idx = &lt;span class=&#34;hljs-variable constant_&#34;&gt;ALLOWED_CLASSES&lt;/span&gt;.index(&lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.name)
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
        &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        idx + &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Once we have done this the STI subsystem of ActiveRecord will the use the &lt;code&gt;ALLOWED_CLASSES&lt;/code&gt; to infer the name Institution classes using the index stored in the database column.&lt;/p&gt;
&lt;p&gt;What is particularly nice is that if have any existing data, we don&amp;#39;t end up getting
any errors when trying to save or retrieve them since we delegate to default implementations. Although it would be a better option to write a migration to change the type column to integer.&lt;/p&gt;
&lt;p&gt;The eagle eyed among us might have noticed we are offsetting the index in the &lt;code&gt;ALLOWED_CLASSES&lt;/code&gt; index by 1. This is a basic precaution because calling &lt;code&gt;to_i&lt;/code&gt; on a string that is not a numeric string returns &lt;code&gt;0&lt;/code&gt; instead of raising an error. So delegating to default implementation incase of zero value allows us to retain legacy compatibility.&lt;/p&gt;
&lt;p&gt;You might want to ask why the array ALLOWED_CLASS_NAMES is a string array rather than an actual array of classes. Having an array of classes leads to RecursiveDependency errors while autoloading when fetching the entries from databases.&lt;/p&gt;
&lt;p&gt;While this is nice and good, this functionality is generic and doesn&amp;#39;t really belong to the &lt;code&gt;Institution::Base&lt;/code&gt; class. What if we need another module tomorrow which is unreleated but needs the same functionality?&lt;/p&gt;
&lt;p&gt;So in the spirit of reusability and separation of concerns we create a &lt;code&gt;concern&lt;/code&gt; for this:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; OptimallyInheritable
  extend ActiveSupport::Concern

  &lt;span class=&#34;hljs-keyword&#34;&gt;module&lt;/span&gt; ClassMethods
    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;support_sti_for&lt;/span&gt; cls_list
      &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt; = []
      &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt; += cls_list
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_cls_list&lt;/span&gt;
      &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;find_sti_class&lt;/span&gt; type_name
      idx = type_name.to_i
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt; &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx == &lt;span class=&#34;hljs-number&#34;&gt;0&lt;/span&gt;
      sti_cls_list[type_name.to_i-&lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;].constantize
    &lt;span class=&#34;hljs-keyword&#34;&gt;rescue&lt;/span&gt; NameError, TypeError
      &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

    &lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_name&lt;/span&gt;
      idx = sti_cls_list.index(&lt;span class=&#34;hljs-variable language_&#34;&gt;self&lt;/span&gt;.name)
      &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; idx.&lt;span class=&#34;hljs-literal&#34;&gt;nil&lt;/span&gt;?
        &lt;span class=&#34;hljs-variable language_&#34;&gt;super&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
        idx + &lt;span class=&#34;hljs-number&#34;&gt;1&lt;/span&gt;
      &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
    &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;

  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;And our &lt;code&gt;Institution::Base&lt;/code&gt; class just reduces to:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;class&lt;/span&gt; &lt;span class=&#34;hljs-title class_&#34;&gt;Institution::Base&lt;/span&gt; &amp;lt; &lt;span class=&#34;hljs-title class_ inherited__&#34;&gt;ActiveRecord::Base&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;include&lt;/span&gt; OptimallyInheritable
  support_sti_for &lt;span class=&#34;hljs-string&#34;&gt;%w[Institution::NonProfit Institution::Commercial]&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;All seems kosher, so we take our implementation for a test drive:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;&amp;gt; Institution::Base.all
Institution::Base Load (0.4ms)  SELECT `institution_bases`.* FROM `institution_bases`
=&amp;gt; #&amp;lt;ActiveRecord::Relation [#&amp;lt;Institution::Commercial id: 3, name: &amp;quot;loremipsum&amp;quot;, type: &amp;quot;2&amp;quot;, created_at: &amp;quot;2014-07-17 12:27:26&amp;quot;, updated_at: &amp;quot;2014-07-17 12:27:26&amp;quot;&amp;gt;]&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;While laoding instances of base class works well, we run into issues when we try to load all commercial
institutions:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;2.1.2 :005 &amp;gt; Institution::Commercial.all
NoMethodError: undefined method `index&amp;#39; for nil:NilClass
               from /Users/lorefnon/Workspace/sample/app/models/concerns/optimally_inheritable.rb:24:in `sti_name&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/inheritance.rb:170:in `block in type_condition&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/inheritance.rb:170:in `map&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/inheritance.rb:170:in `type_condition&amp;#39;
               from /Users/lorefnon/.rvm/gems/ruby-2.1.2@sample/gems/activerecord-4.1.4/lib/active_record/core.rb:170:in `relation&amp;#39;
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;The problem is obvious : the variable &lt;code&gt;sti_class_list&lt;/code&gt; is not available in subclasses.&lt;/p&gt;
&lt;p&gt;So we rectify our solution:&lt;/p&gt;
&lt;pre&gt;&lt;code class=&#34;hljs ruby&#34;&gt;&lt;span class=&#34;hljs-keyword&#34;&gt;def&lt;/span&gt; &lt;span class=&#34;hljs-title function_&#34;&gt;sti_cls_list&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;if&lt;/span&gt; superclass.respond_to? &lt;span class=&#34;hljs-symbol&#34;&gt;:sti_cls_list&lt;/span&gt;
    superclass.sti_cls_list
  &lt;span class=&#34;hljs-keyword&#34;&gt;else&lt;/span&gt;
    &lt;span class=&#34;hljs-variable&#34;&gt;@sti_cls_list&lt;/span&gt;
  &lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;
&lt;span class=&#34;hljs-keyword&#34;&gt;end&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;This resolves the aforementioned issues.&lt;/p&gt;
&lt;p&gt;Now that we have reached the end of the post, it would be a good time to highlight the drawbacks of our approach:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;Firstly, The array passed to &lt;code&gt;support_sti_for&lt;/code&gt; function will have to be kept in sync with the class names, if the name of any model class changes in future.&lt;/li&gt;
&lt;li&gt;Secondly, While it is safe to add new entries to supported classes, their order can not be arbitrarily changed without running a data correction script first.&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;This concludes our post. The full source code is available at &lt;a href=&#34;https://github.com/lorefnon/sti_optimization_demo.git&#34; target=&#34;_blank&#34; rel=&#34;noopener external nofollow noreferrer&#34;&gt;Github&lt;/a&gt;. As always, any criticism or feedback is welcome.&lt;/p&gt;
 ]]></description>
        </item>
    </channel>
</rss>
