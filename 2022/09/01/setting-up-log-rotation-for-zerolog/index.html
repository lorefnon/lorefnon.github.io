<!DOCTYPE html><html class="no-js"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="stylesheet" href="/css/blog.css"><title>Lorefnon | Blog | Setting up log-rotation for zerolog</title><meta property="og:title" content="Lorefnon | Blog | Setting up log-rotation for zerolog"><meta property="og:description" content="Ramblings on Web Development and software architecture"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon/favicon-16x16.png"><link rel="icon" href="/images/favicon/favicon.ico"><script data-goatcounter="https://analytics.lorefnon.com/count" async src="https://analytics.lorefnon.com/count.js"></script><script src="https://unpkg.com/htmx.org@1.7.0/dist/htmx.min.js" defer></script><script src="https://unpkg.com/dompurify@2.3.6/dist/purify.min.js" defer></script><script src="/js/blog.js" defer></script><meta name="generator" content="Hexo 6.2.0"></head><body class="blog-body" hx-boost="true"><div class="blog-summary"><a class="primary-link" href="/" hx-boost="false"><h1 class="header-text">Gaurab Paul</h1><h2 class="header-text">Polyglot software developer &amp; consultant passionate about web development, distributed systems and open source technologies</h2></a><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a></div></div></div><div class="blog-sidebar"><div class="blog-support"><div class="blog-support-cta-container"><a class="blog-support-btn" href="https://ko-fi.com/lorefnon" target="_blank" title="Support my work"></a><div class="blog-support-arrow"></div><p class="support-text body-text">Support my blog and open-source work</p></div></div><h1 class="header-text">Tags</h1><ul class="tag-list"><li class="body-text"><a class="tag-link" href="/tags/go/"><img src="/images/tag.svg">go</a></li><li class="body-text"><a class="tag-link" href="/tags/golang/"><img src="/images/tag.svg">golang</a></li><li class="body-text"><a class="tag-link" href="/tags/zerolog/"><img src="/images/tag.svg">zerolog</a></li></ul></div><div class="blog-header blog-post-header"><div class="blog-post-header-inner"><div class="header-text">Setting up log-rotation for zerolog</div><div class="posted-date sub-header-text" title="2022-09-01">Posted &nbsp;a year ago</div><hr class="blog-header-separator"></div></div><div class="blog-main"><div class="page-content"><p><a href="https://github.com/rs/zerolog" target="_blank" rel="noopener external nofollow noreferrer">Zerolog</a> is a popular structured logging library for go. This post is a quick recipie for configuring it to use log rotation. </p>
<p>Log rotation is a mechanism where instead of having a single log file which keeps growing forever, the application switches to a new log file when a time threshold or a size threshold is exceeded. Optionally files which are too old to be of significance can be deleted.</p>
<p>Now a days, it is a more common practice to log to a stream and have an external service manage it for you. This is indeed nice if you can embrace it. However, Log rotation can be useful for desktop applications or isolated deployments.</p>
<p><a href="https://github.com/natefinch/lumberjack" target="_blank" rel="noopener external nofollow noreferrer">Lumberjack</a> is a nice utility for go that supports log rotation. It is also easy to hook up with zerolog because a lumberjack logger implements io.Writer which zerolog can target.</p>
<pre><code class="hljs"><table class="hlcode-table"><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell"><span class="hljs-comment">/** Configuration options for log rotation */</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell"><span class="hljs-keyword">type</span> LoggerConfig <span class="hljs-keyword">struct</span> {
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-comment">/** Max size of the logfile before it&#x27;s rolled */</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	MaxSizeMB <span class="hljs-type">int</span> <span class="hljs-string">`json:&quot;max_size_mb,omitempty&quot;`</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-comment">/** Max number of rolled files to keep */</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	MaxBackupCount <span class="hljs-type">int</span> <span class="hljs-string">`json:&quot;max_backup_count,omitempty&quot;`</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-comment">/** Max age in days to keep a logfile */</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	MaxAgeDays <span class="hljs-type">int</span> <span class="hljs-string">`json:&quot;max_age_days,omitempty&quot;`</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">}
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initLogger</span><span class="hljs-params">(config *config.LoggerConfig)</span></span> *zerolog.Logger {
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-keyword">var</span> writers []io.Writer
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-comment">// Optional: Log to console</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	writers = <span class="hljs-built_in">append</span>(writers, zerolog.ConsoleWriter{Out: os.Stderr})
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-comment">// Log to rolling file</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	writers = <span class="hljs-built_in">append</span>(writers, initRollingFileLogger(config))
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-comment">// Multiwriter encapsulates multiple writers</span>
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	mw := io.MultiWriter(writers...)
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	logger := zerolog.New(mw).With().
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">		Timestamp().
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">		Logger()
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-keyword">return</span> &amp;logger
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">}
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">initRollingFileLogger</span><span class="hljs-params">(config *config.LoggerConfig)</span></span> *lumberjack.Logger {
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	loggerPath := filepath.Join(xdg.DataHome, <span class="hljs-string">&quot;example&quot;</span>, <span class="hljs-string">&quot;app.log&quot;</span>)
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	fmt.Printf(<span class="hljs-string">&quot;logging to file: %s\n&quot;</span>, loggerPath)
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	<span class="hljs-keyword">return</span> &amp;lumberjack.Logger{
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">		Filename:   loggerPath,
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">		MaxBackups: config.MaxBackupCount,
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">		MaxSize:    config.MaxSizeMB,
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">		MaxAge:     config.MaxAgeDays,
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">	}
</td></tr><tr style="border:none;" class="hlcode-line  " ><td style="border:none" class="hlcode-code-cell">}
</td></tr></table></code></pre>

<p>We can now use the logger returned by initLogger to write logs, and they will be written to a file which will be rotated by lumberjack.</p>
</div><div class="post-comments"><!-- .comments-target--></div><div class="post-comments" style="margin-top: 10px;"><div id="remark42"></div></div></div><div class="blog-footer body-text"><p class="copyright-container"><strong>© 2022 Gaurab Paul</strong></p><p>Unless otherwise mentioned in specific contexts, all code is licensed under the The MIT License and all content and artwork is licensed under CC BY-NC-SA.</p><p>The opinions expressed herein are author's personal viewpoints and may not be taken as professional recommendations from any of his previous or current employers.</p></div></body></html>